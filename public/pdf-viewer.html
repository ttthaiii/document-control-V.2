<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>PDF Viewer</title>
    
    <!-- ✅ ใช้ CDN แทนไฟล์ local เพื่อหลีกเลี่ยงปัญหา path -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/web/viewer.css">
    
    <style>
        /* ✅ ปรับแต่ง UI ให้เหมาะกับ Modal */
        #toolbarContainer {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        #sidebarContainer {
            background: #fff;
        }
        
        /* ซ่อน elements ที่ไม่ต้องการ */
        #secondaryToolbar,
        #presentationMode,
        #openFile,
        #secondaryOpenFile {
            display: none !important;
        }
        
        /* ปรับขนาดสำหรับมือถือ */
        @media (max-width: 768px) {
            .hiddenSmallView {
                display: none !important;
            }
            
            #toolbarViewerLeft,
            #toolbarViewerMiddle,
            #toolbarViewerRight {
                flex: 1;
            }
        }
        
        /* Loading overlay */
        #customLoading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="outerContainer">
        <!-- Loading Overlay -->
        <div id="customLoading">
            <div class="spinner"></div>
            <p>กำลังโหลดเอกสาร...</p>
        </div>
        
        <!-- Sidebar -->
        <div id="sidebarContainer">
            <div id="toolbarSidebar">
                <div id="toolbarSidebarLeft">
                    <div id="sidebarViewButtons" class="splitToolbarButton toggled" role="radiogroup">
                        <button id="viewThumbnail" class="toolbarButton toggled" title="แสดงภาพย่อ" tabindex="2" data-l10n-id="thumbs" role="radio" aria-checked="true">
                            <span data-l10n-id="thumbs_label">ภาพย่อ</span>
                        </button>
                        <button id="viewOutline" class="toolbarButton" title="แสดงเค้าโครง เอกสาร" tabindex="3" data-l10n-id="document_outline" role="radio" aria-checked="false">
                            <span data-l10n-id="document_outline_label">เค้าโครงเอกสาร</span>
                        </button>
                        <button id="viewAttachments" class="toolbarButton" title="แสดงไฟล์แนบ" tabindex="4" data-l10n-id="attachments" role="radio" aria-checked="false">
                            <span data-l10n-id="attachments_label">ไฟล์แนบ</span>
                        </button>
                    </div>
                </div>
            </div>
            <div id="sidebarContent">
                <div id="thumbnailView"></div>
                <div id="outlineView" class="hidden"></div>
                <div id="attachmentsView" class="hidden"></div>
            </div>
            <div id="sidebarResizer"></div>
        </div>

        <!-- Main container -->
        <div id="mainContainer">
            <div class="findbar hidden doorHanger" id="findbar">
                <div id="findbarInputContainer">
                    <span class="loadingInput start">
                        <input id="findInput" class="toolbarField" title="ค้นหา" placeholder="ค้นหาในเอกสาร…" tabindex="91" data-l10n-id="find_input" aria-invalid="false">
                    </span>
                    <div class="splitToolbarButton">
                        <button id="findPrevious" class="toolbarButton" title="หาวลีที่ปรากฏก่อนหน้านี้" tabindex="92" data-l10n-id="find_previous">
                            <span data-l10n-id="find_previous_label">ก่อนหน้า</span>
                        </button>
                        <div class="splitToolbarButtonSeparator"></div>
                        <button id="findNext" class="toolbarButton" title="หาวลีที่ปรากฏถัดไป" tabindex="93" data-l10n-id="find_next">
                            <span data-l10n-id="find_next_label">ถัดไป</span>
                        </button>
                    </div>
                </div>

                <div id="findbarOptionsOneContainer">
                    <input type="checkbox" id="findHighlightAll" class="toolbarField" tabindex="94">
                    <label for="findHighlightAll" class="toolbarLabel" data-l10n-id="find_highlight">เน้นทั้งหมด</label>
                    <input type="checkbox" id="findMatchCase" class="toolbarField" tabindex="95">
                    <label for="findMatchCase" class="toolbarLabel" data-l10n-id="find_match_case_label">ตัวพิมพ์ใหญ่-เล็ก</label>
                </div>
                <div id="findbarOptionsTwoContainer">
                    <input type="checkbox" id="findEntireWord" class="toolbarField" tabindex="96">
                    <label for="findEntireWord" class="toolbarLabel" data-l10n-id="find_entire_word_label">ทั้งคำ</label>
                    <span id="findResultsCount" class="toolbarLabel hidden"></span>
                </div>

                <div id="findbarMessageContainer">
                    <span id="findMsg" class="toolbarLabel"></span>
                </div>
            </div>

            <div class="toolbar">
                <div id="toolbarContainer">
                    <div id="toolbarViewer">
                        <div id="toolbarViewerLeft">
                            <button id="sidebarToggle" class="toolbarButton" title="สลับแถบข้าง" tabindex="11" data-l10n-id="toggle_sidebar" aria-expanded="false" aria-controls="sidebarContainer">
                                <span data-l10n-id="toggle_sidebar_label">สลับแถบข้าง</span>
                            </button>
                            <div class="toolbarButtonSpacer"></div>
                            <button id="viewFind" class="toolbarButton" title="ค้นหาในเอกสาร" tabindex="12" data-l10n-id="findbar" aria-expanded="false" aria-controls="findbar">
                                <span data-l10n-id="findbar_label">ค้นหา</span>
                            </button>
                            <div class="splitToolbarButton hiddenSmallView">
                                <button class="toolbarButton" title="หน้าก่อนหน้า" id="previous" tabindex="13" data-l10n-id="previous">
                                    <span data-l10n-id="previous_label">ก่อนหน้า</span>
                                </button>
                                <div class="splitToolbarButtonSeparator"></div>
                                <button class="toolbarButton" title="หน้าถัดไป" id="next" tabindex="14" data-l10n-id="next">
                                    <span data-l10n-id="next_label">ถัดไป</span>
                                </button>
                            </div>
                            <span class="loadingInput start">
                                <input type="number" id="pageNumber" class="toolbarField" title="หน้า" value="1" min="1" tabindex="15" data-l10n-id="page" autocomplete="off">
                            </span>
                            <span id="numPages" class="toolbarLabel"></span>
                        </div>
                        
                        <div id="toolbarViewerMiddle">
                            <div class="splitToolbarButton">
                                <button id="zoomOut" class="toolbarButton" title="ย่อ" tabindex="21" data-l10n-id="zoom_out">
                                    <span data-l10n-id="zoom_out_label">ย่อ</span>
                                </button>
                                <div class="splitToolbarButtonSeparator"></div>
                                <button id="zoomIn" class="toolbarButton" title="ขยาย" tabindex="22" data-l10n-id="zoom_in">
                                    <span data-l10n-id="zoom_in_label">ขยาย</span>
                                </button>
                            </div>
                            <span id="scaleSelectContainer" class="dropdownToolbarButton">
                                <select id="scaleSelect" title="ขยาย" tabindex="23" data-l10n-id="zoom">
                                    <option id="pageAutoOption" title="" value="auto" selected="selected" data-l10n-id="page_scale_auto">ขนาดอัตโนมัติ</option>
                                    <option id="pageActualOption" title="" value="page-actual" data-l10n-id="page_scale_actual">ขนาดจริง</option>
                                    <option id="pageFitOption" title="" value="page-fit" data-l10n-id="page_scale_fit">พอดีหน้า</option>
                                    <option id="pageWidthOption" title="" value="page-width" data-l10n-id="page_scale_width">พอดีความกว้าง</option>
                                    <option id="customScaleOption" title="" value="custom" disabled="disabled" hidden="true"></option>
                                    <option title="" value="0.5" data-l10n-id="page_scale_percent" data-l10n-args='{ "scale": 50 }'>50%</option>
                                    <option title="" value="0.75" data-l10n-id="page_scale_percent" data-l10n-args='{ "scale": 75 }'>75%</option>
                                    <option title="" value="1" data-l10n-id="page_scale_percent" data-l10n-args='{ "scale": 100 }'>100%</option>
                                    <option title="" value="1.25" data-l10n-id="page_scale_percent" data-l10n-args='{ "scale": 125 }'>125%</option>
                                    <option title="" value="1.5" data-l10n-id="page_scale_percent" data-l10n-args='{ "scale": 150 }'>150%</option>
                                    <option title="" value="2" data-l10n-id="page_scale_percent" data-l10n-args='{ "scale": 200 }'>200%</option>
                                    <option title="" value="3" data-l10n-id="page_scale_percent" data-l10n-args='{ "scale": 300 }'>300%</option>
                                    <option title="" value="4" data-l10n-id="page_scale_percent" data-l10n-args='{ "scale": 400 }'>400%</option>
                                </select>
                            </span>
                        </div>
                        
                        <div id="toolbarViewerRight">
                            <button id="download" class="toolbarButton hiddenMediumView" title="ดาวน์โหลด" tabindex="32" data-l10n-id="download">
                                <span data-l10n-id="download_label">ดาวน์โหลด</span>
                            </button>
                        </div>
                    </div>
                    <div id="loadingBar">
                        <div class="progress">
                            <div class="glimmer"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="viewerContainer" tabindex="0">
                <div id="viewer" class="pdfViewer"></div>
            </div>
        </div>

        <!-- Dialogs -->
        <div id="dialogContainer">
            <dialog id="passwordDialog">
                <div class="row">
                    <label for="password" id="passwordText" data-l10n-id="password_label">ป้อนรหัสผ่านเพื่อเปิดไฟล์ PDF นี้:</label>
                </div>
                <div class="row">
                    <input type="password" id="password" class="toolbarField">
                </div>
                <div class="buttonRow">
                    <button id="passwordCancel" class="dialogButton"><span data-l10n-id="password_cancel">ยกเลิก</span></button>
                    <button id="passwordSubmit" class="dialogButton"><span data-l10n-id="password_ok">ตกลง</span></button>
                </div>
            </dialog>
        </div>
    </div>

    <div id="printContainer"></div>
    
    <!-- ✅ ใช้ CDN สำหรับ PDF.js -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.mjs" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/web/viewer.mjs" type="module"></script>
    
    <script type="module">
        // ✅ กำหนดค่า PDF.js
        import { GlobalWorkerOptions, getDocument } from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.mjs';
        
        // กำหนด worker
        GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.worker.min.mjs';
        
        // ✅ ฟังก์ชันสำหรับซ่อน Loading
        function hideLoading() {
            const loadingEl = document.getElementById('customLoading');
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
        }
        
        // ✅ รอให้ viewer โหลดเสร็จ
        document.addEventListener('DOMContentLoaded', function() {
            // ดึง URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const fileUrl = urlParams.get('file');
            
            if (fileUrl) {
                // รอให้ PDFViewerApplication พร้อม
                if (window.PDFViewerApplication) {
                    initializeViewer(fileUrl);
                } else {
                    // รอให้ viewer script โหลดเสร็จ
                    document.addEventListener('webviewerloaded', function() {
                        initializeViewer(fileUrl);
                    });
                }
            } else {
                hideLoading();
                alert('ไม่พบ URL ของไฟล์ PDF');
            }
        });
        
        function initializeViewer(fileUrl) {
            try {
                if (window.PDFViewerApplication && window.PDFViewerApplication.open) {
                    window.PDFViewerApplication.open(fileUrl).then(() => {
                        hideLoading();
                    }).catch(error => {
                        console.error('Error loading PDF:', error);
                        hideLoading();
                        alert('ไม่สามารถโหลดไฟล์ PDF ได้');
                    });
                } else {
                    // Fallback method
                    setTimeout(() => initializeViewer(fileUrl), 100);
                }
            } catch (error) {
                console.error('Error initializing viewer:', error);
                hideLoading();
                alert('เกิดข้อผิดพลาดในการเปิดไฟล์ PDF');
            }
        }
    </script>
</body>
</html>