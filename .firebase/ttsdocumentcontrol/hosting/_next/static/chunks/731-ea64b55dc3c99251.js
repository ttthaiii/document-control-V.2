"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[731],{7649:function(e,r,t){t.d(r,{AuthProvider:function(){return E},a:function(){return u}});var s=t(7437),n=t(2265),i=t(2148),l=t(5978),o=t(7012),a=t(6855);let c=(0,n.createContext)({user:null,firebaseUser:null,loading:!0,error:null,logout:async()=>{},requestNotificationPermission:async()=>{}}),d=()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);function E(e){let{children:r}=e,[t,E]=(0,n.useState)(null),[u,N]=(0,n.useState)(null),[m,I]=(0,n.useState)(!0),[P,h]=(0,n.useState)(null),x=async(e,r)=>{if(a.Fw){if(!d()&&"SAVE"===r){console.log("\uD83D\uDCBB Desktop detected: Notifications are disabled for desktop devices.");return}try{if("SAVE"===r){let r=await Notification.requestPermission();if("granted"===r){let r=await (0,o.LP)(a.Fw,{vapidKey:"BJ13x_HEhi6a7lCuv73CZw78pcmHWQoLdNNZag8EZPcJSD-VNyb2ENgAt_KGnf30p6AzVrE89HckdU4wn4wq9wA"});r&&(await (0,l.r7)((0,l.JU)(a.db,"users",e),{fcmTokens:[r],lastLogin:new Date}),console.log("\uD83D\uDCF1 Mobile Notification Token Updated"))}}else"REMOVE"===r&&await (0,o.pQ)(a.Fw)}catch(e){console.error("FCM Token Error:",e)}}};(0,n.useEffect)(()=>{"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{console.log("✅ PWA Service Worker (sw.js) registered successfully:",e.scope)}).catch(e=>{console.error("❌ PWA Service Worker registration failed:",e)})},[]),(0,n.useEffect)(()=>{if(a.Fw&&d()){let e=(0,o.ps)(a.Fw,e=>{var r,t,s;console.log("\uD83D\uDCE9 Foreground Message Received:",e);let n=(null===(r=e.data)||void 0===r?void 0:r.title)||"การแจ้งเตือนใหม่",i=(null===(t=e.data)||void 0===t?void 0:t.body)||"",l=null===(s=e.data)||void 0===s?void 0:s.url;if("granted"===Notification.permission){let e=new Notification(n,{body:i,icon:"/favicon.ico"});e.onclick=()=>{l&&(window.location.href=l),e.close()}}});return()=>e()}},[]),(0,n.useEffect)(()=>{let e=null,r=(0,i.Aj)(a.I8,async r=>{if(I(!0),E(r),e&&(e(),e=null),r){let t=(0,l.JU)(a.db,"users",r.uid);e=(0,l.cf)(t,e=>{if(e.exists()){var t,s;let n=e.data();if("DISABLED"===n.status){(0,i.w7)(a.I8),N(null),h("บัญชีของคุณถูกระงับการใช้งาน");return}N({id:r.uid,email:r.email||"",role:n.role,sites:n.sites||[],status:n.status||"ACTIVE",createdFromInvitation:n.createdFromInvitation,createdAt:null===(t=n.createdAt)||void 0===t?void 0:t.toDate(),acceptedAt:null===(s=n.acceptedAt)||void 0===s?void 0:s.toDate()})}else N(null);I(!1)},e=>{console.error("Snapshot Error:",e),I(!1)}),x(r.uid,"SAVE")}else N(null),I(!1)});return()=>{r(),e&&e()}},[]);let D=async()=>{try{(null==u?void 0:u.id)&&await x(u.id,"REMOVE"),await (0,i.w7)(a.I8),N(null)}catch(e){throw console.error("Logout error:",e),e}},f=async()=>{if(!d()){alert("ระบบแจ้งเตือนรองรับเฉพาะการใช้งานบนโทรศัพท์มือถือเท่านั้น");return}(null==u?void 0:u.id)&&(await x(u.id,"SAVE"),alert("เปิดรับการแจ้งเตือนเรียบร้อยแล้ว"))};return(0,s.jsx)(c.Provider,{value:{user:u,firebaseUser:t,loading:m,error:P,logout:D,requestNotificationPermission:f},children:r})}function u(){return(0,n.useContext)(c)}},731:function(e,r,t){t.d(r,{AuthGuard:function(){return a}});var s=t(7437),n=t(7649),i=t(9376),l=t(2265);t(453);let o=()=>(0,s.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,s.jsxs)("div",{className:"animate-pulse",children:[(0,s.jsx)("div",{className:"bg-white shadow",children:(0,s.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,s.jsxs)("div",{className:"flex justify-between items-center py-6",children:[(0,s.jsx)("div",{className:"h-8 bg-gray-200 rounded w-32"}),(0,s.jsx)("div",{className:"h-8 bg-gray-200 rounded w-24"})]})})}),(0,s.jsxs)("div",{className:"flex",children:[(0,s.jsx)("div",{className:"w-64 bg-white border-r border-gray-200 min-h-screen",children:(0,s.jsx)("div",{className:"p-4 space-y-3",children:[...Array(6)].map((e,r)=>(0,s.jsx)("div",{className:"h-10 bg-gray-100 rounded"},r))})}),(0,s.jsx)("div",{className:"flex-1 p-8",children:(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsx)("div",{className:"h-8 bg-gray-200 rounded w-1/3"}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[void 0,void 0,void 0].map((e,r)=>(0,s.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow",children:[(0,s.jsx)("div",{className:"h-4 bg-gray-200 rounded mb-2"}),(0,s.jsx)("div",{className:"h-8 bg-gray-200 rounded mb-4"}),(0,s.jsx)("div",{className:"h-4 bg-gray-200 rounded w-2/3"})]},r))})]})})]})]})});function a(e){let{children:r,requiredRoles:t=[],requiredSiteAccess:a=[],fallback:c,redirectTo:d="/login"}=e,{user:E,loading:u,error:N}=(0,n.a)(),m=(0,i.useRouter)();return((0,l.useEffect)(()=>{u||E||m.push(d)},[E,u,m,d]),u)?(0,s.jsx)(o,{}):N?(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,s.jsx)("div",{className:"text-center max-w-md mx-auto",children:(0,s.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-red-800 mb-2",children:"เกิดข้อผิดพลาด"}),(0,s.jsx)("p",{className:"text-red-600 mb-4",children:N}),(0,s.jsx)("button",{onClick:()=>window.location.reload(),className:"bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors",children:"ลองใหม่"})]})})}):E?t.length>0&&!t.includes(E.role)?(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,s.jsx)("div",{className:"text-center max-w-md mx-auto",children:(0,s.jsxs)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-6",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-yellow-800 mb-2",children:"ไม่มีสิทธิ์เข้าถึง"}),(0,s.jsx)("p",{className:"text-yellow-700 mb-2",children:"คุณไม่มีสิทธิ์เข้าถึงหน้านี้"}),(0,s.jsxs)("p",{className:"text-sm text-yellow-600 mb-4",children:["ต้องการสิทธิ์: ",t.join(", ")," | สิทธิ์ปัจจุบัน: ",E.role]}),(0,s.jsx)("button",{onClick:()=>m.back(),className:"bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 transition-colors",children:"ย้อนกลับ"})]})})}):a.length>0&&"Admin"!==E.role&&!a.some(e=>{var r;return null===(r=E.sites)||void 0===r?void 0:r.includes(e)})?(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,s.jsx)("div",{className:"text-center max-w-md mx-auto",children:(0,s.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-red-800 mb-2",children:"ไม่มีสิทธิ์เข้าถึงโครงการ"}),(0,s.jsx)("p",{className:"text-red-600 mb-4",children:"คุณไม่มีสิทธิ์เข้าถึงโครงการที่ต้องการ"}),(0,s.jsx)("button",{onClick:()=>m.back(),className:"bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors",children:"ย้อนกลับ"})]})})}):(0,s.jsx)(s.Fragment,{children:r}):c?(0,s.jsx)(s.Fragment,{children:c}):(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"กรุณาเข้าสู่ระบบ"}),(0,s.jsx)("p",{className:"text-gray-600 mb-4",children:"คุณต้องเข้าสู่ระบบเพื่อเข้าถึงหน้านี้"}),(0,s.jsx)("button",{onClick:()=>m.push(d),className:"bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition-colors",children:"เข้าสู่ระบบ"})]})})}},453:function(e,r,t){t.d(r,{$p:function(){return a},Ge:function(){return d},K$:function(){return s},NK:function(){return E},c9:function(){return o},gf:function(){return l},n$:function(){return c},oU:function(){return i},uc:function(){return n},yh:function(){return u}});let s={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},n=[s.BIM,s.ME,s.SN,s.ADMIN],i=[s.SITE_ADMIN,s.ADMIN_SITE_2,s.OE,s.PE,s.ADMIN],l=[s.CM,s.PD,s.ADMIN];s.PM,s.ADMIN,s.SE,s.FM;let o=[s.PE,s.OE,s.ADMIN],a=[s.PD,s.PM,s.ADMIN],c={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},d={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},E={[c.PENDING_REVIEW]:"รอตรวจสอบ",[c.PENDING_CM_APPROVAL]:"ส่ง CM",[c.REVISION_REQUIRED]:"แก้ไข",[c.APPROVED]:"อนุมัติ",[c.APPROVED_WITH_COMMENTS]:"อนุมัติตามคอมเมนต์ (ไม่แก้ไข)",[c.APPROVED_REVISION_REQUIRED]:"อนุมัติตามคอมเมนต์ (ต้องแก้ไข)",[c.REJECTED]:"ไม่อนุมัติ",[c.PENDING_FINAL_APPROVAL]:"รอ SITE อนุมัติขั้นสุดท้าย",[d.DRAFT]:"รออนุมัติ (PM)",[d.REJECTED_BY_PM]:"ไม่อนุมัติ (PM)",[d.PENDING_BIM]:"รอ BIM รับงาน",[d.IN_PROGRESS]:"BIM กำลังดำเนินการ",[d.PENDING_ACCEPTANCE]:"รอตรวจรับ (Site)",[d.REVISION_REQUESTED]:"ขอแก้ไข (WR)",[d.COMPLETED]:"เสร็จสิ้น"},u={[c.PENDING_REVIEW]:"#0088FE",[c.PENDING_CM_APPROVAL]:"#00C49F",[c.REVISION_REQUIRED]:"#FFBB28",[c.APPROVED]:"#28A745",[c.REJECTED]:"#DC3545",[c.APPROVED_WITH_COMMENTS]:"#2f3e3aff",[c.APPROVED_REVISION_REQUIRED]:"#FD7E14",[d.DRAFT]:"#6c757d",[d.REJECTED_BY_PM]:"#DC3545",[d.PENDING_BIM]:"#0088FE",[d.IN_PROGRESS]:"#FFBB28",[d.PENDING_ACCEPTANCE]:"#AF19FF",[d.REVISION_REQUESTED]:"#FD7E14",[d.COMPLETED]:"#28A745"}},6855:function(e,r,t){t.d(r,{Fw:function(){return d},I8:function(){return a},db:function(){return c}});var s=t(738),n=t(2148),i=t(5978),l=t(7012);let o=(0,s.C6)().length>0?(0,s.Mq)():(0,s.ZF)({apiKey:"AIzaSyAsayb-DEOBE0zi0qh-dPBfihClgXrX1sY",authDomain:"ttsdocumentcontrol.firebaseapp.com",projectId:"ttsdocumentcontrol",storageBucket:"ttsdocumentcontrol.firebasestorage.app",messagingSenderId:"48440915675",appId:"1:48440915675:web:f11611895bfb52d4d27efe"}),a=(0,n.v0)(o),c=(0,i.ad)(o),d=null;(0,l.Gb)().then(e=>{e&&(d=(0,l.KL)(o))});try{(0,i.ST)(c).then(()=>{console.log("✅ Firestore offline persistence enabled.")}).catch(e=>{"failed-precondition"==e.code?console.warn("Firestore persistence failed: Multiple tabs open."):"unimplemented"==e.code&&console.warn("Firestore persistence is not supported in this browser.")})}catch(e){console.error("An error occurred while enabling Firestore persistence:",e)}}}]);