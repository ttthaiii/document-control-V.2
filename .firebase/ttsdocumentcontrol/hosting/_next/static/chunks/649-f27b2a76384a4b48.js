"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[649],{7649:function(e,t,o){o.d(t,{AuthProvider:function(){return d},a:function(){return f}});var n=o(7437),r=o(2265),i=o(2148),l=o(5978),s=o(7012),a=o(6855);let c=(0,r.createContext)({user:null,firebaseUser:null,loading:!0,error:null,logout:async()=>{},requestNotificationPermission:async()=>{}}),u=()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);function d(e){let{children:t}=e,[o,d]=(0,r.useState)(null),[f,w]=(0,r.useState)(null),[p,v]=(0,r.useState)(!0),[g,b]=(0,r.useState)(null),m=(0,r.useCallback)(async(e,t)=>{if(a.Fw){if(!u()&&"SAVE"===t){console.log("\uD83D\uDCBB Desktop detected: Notifications are disabled for desktop devices.");return}try{if("SAVE"===t){let t=await Notification.requestPermission();if("granted"===t){let t=await (0,s.LP)(a.Fw,{vapidKey:"BJ13x_HEhi6a7lCuv73CZw78pcmHWQoLdNNZag8EZPcJSD-VNyb2ENgAt_KGnf30p6AzVrE89HckdU4wn4wq9wA"});t&&(await (0,l.pl)((0,l.JU)(a.db,"users",e),{fcmTokens:[t],lastLogin:new Date},{merge:!0}),console.log("\uD83D\uDCF1 Mobile Notification Token Updated"))}}else"REMOVE"===t&&await (0,s.pQ)(a.Fw)}catch(e){console.error("FCM Token Error:",e)}}},[]);(0,r.useEffect)(()=>{"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{console.log("✅ PWA Service Worker (sw.js) registered successfully:",e.scope)}).catch(e=>{console.error("❌ PWA Service Worker registration failed:",e)})},[]),(0,r.useEffect)(()=>{if(a.Fw&&u()){let e=(0,s.ps)(a.Fw,e=>{var t,o,n;console.log("\uD83D\uDCE9 Foreground Message Received:",e);let r=(null===(t=e.data)||void 0===t?void 0:t.title)||"การแจ้งเตือนใหม่",i=(null===(o=e.data)||void 0===o?void 0:o.body)||"",l=null===(n=e.data)||void 0===n?void 0:n.url;if("granted"===Notification.permission){let e=new Notification(r,{body:i,icon:"/favicon.ico"});e.onclick=()=>{l&&(window.location.href=l),e.close()}}});return()=>e()}},[]),(0,r.useEffect)(()=>{let e=null,t=!0,o=(0,i.Aj)(a.I8,async o=>{if(t&&(v(!0),d(o),b(null)),e&&(e(),e=null),o){let n=(0,l.JU)(a.db,"users",o.uid);try{(await (0,l.QT)(n)).exists()||(console.log("\uD83D\uDCDD User doc not found, creating new one..."),await (0,l.pl)(n,{email:o.email,role:"BIM",status:"ACTIVE",sites:[],createdAt:new Date,updatedAt:new Date,fcmTokens:[]}),console.log("✅ New user document created successfully"))}catch(e){if(console.error("❌ Error checking/creating user doc:",e.code,e.message),"permission-denied"===e.code){t&&(b("ไม่สามารถเข้าถึงข้อมูลผู้ใช้ได้ กรุณาติดต่อผู้ดูแลระบบ"),w(null),v(!1));return}}e=(0,l.cf)(n,e=>{if(t){if(e.exists()){var n,r,l,s;let t=e.data();if("DISABLED"===t.status){console.warn("⚠️ User account is disabled"),(0,i.w7)(a.I8),w(null),b("บัญชีของคุณถูกระงับการใช้งาน"),v(!1);return}w({id:o.uid,email:o.email||"",role:t.role,sites:t.sites||[],status:t.status||"ACTIVE",createdFromInvitation:t.createdFromInvitation,createdAt:(null===(r=t.createdAt)||void 0===r?void 0:null===(n=r.toDate)||void 0===n?void 0:n.call(r))||t.createdAt,acceptedAt:(null===(s=t.acceptedAt)||void 0===s?void 0:null===(l=s.toDate)||void 0===l?void 0:l.call(s))||t.acceptedAt}),b(null)}else console.warn("⚠️ User document does not exist"),w(null);v(!1)}},e=>{t&&(console.error("❌ Snapshot Error:",e.code,e.message),"permission-denied"===e.code?b("ไม่สามารถเข้าถึงข้อมูลผู้ใช้ได้"):b("เกิดข้อผิดพลาดในการโหลดข้อมูล"),w(null),v(!1))}),m(o.uid,"SAVE")}else t&&(w(null),b(null),v(!1))});return()=>{t=!1,o(),e&&e()}},[m]);let A=(0,r.useCallback)(async()=>{try{(null==f?void 0:f.id)&&await m(f.id,"REMOVE"),await (0,i.w7)(a.I8),w(null),b(null)}catch(e){throw console.error("Logout error:",e),e}},[null==f?void 0:f.id,m]),E=(0,r.useCallback)(async()=>{if(!u()){alert("ระบบแจ้งเตือนรองรับเฉพาะการใช้งานบนโทรศัพท์มือถือเท่านั้น");return}(null==f?void 0:f.id)&&(await m(f.id,"SAVE"),alert("เปิดรับการแจ้งเตือนเรียบร้อยแล้ว"))},[null==f?void 0:f.id,m]);return(0,n.jsx)(c.Provider,{value:{user:f,firebaseUser:o,loading:p,error:g,logout:A,requestNotificationPermission:E},children:t})}function f(){return(0,r.useContext)(c)}},6855:function(e,t,o){o.d(t,{Fw:function(){return u},I8:function(){return a},db:function(){return c}});var n=o(738),r=o(2148),i=o(5978),l=o(7012);let s=(0,n.C6)().length>0?(0,n.Mq)():(0,n.ZF)({apiKey:"AIzaSyAsayb-DEOBE0zi0qh-dPBfihClgXrX1sY",authDomain:"ttsdocumentcontrol.firebaseapp.com",projectId:"ttsdocumentcontrol",storageBucket:"ttsdocumentcontrol.firebasestorage.app",messagingSenderId:"48440915675",appId:"1:48440915675:web:f11611895bfb52d4d27efe"}),a=(0,r.v0)(s),c=(0,i.ad)(s),u=null;(0,l.Gb)().then(e=>{e&&(u=(0,l.KL)(s))});try{(0,i.ST)(c).then(()=>{console.log("✅ Firestore offline persistence enabled.")}).catch(e=>{"failed-precondition"==e.code?console.warn("Firestore persistence failed: Multiple tabs open."):"unimplemented"==e.code&&console.warn("Firestore persistence is not supported in this browser.")})}catch(e){console.error("An error occurred while enabling Firestore persistence:",e)}}}]);