(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3],{9852:function(e,t,r){Promise.resolve().then(r.bind(r,8031))},5946:function(e,t,r){"use strict";r.d(t,{AuthProvider:function(){return o},a:function(){return c}});var s=r(2265),a=r(2148),n=r(5978),l=r(6855);let i=(0,s.createContext)({user:null,firebaseUser:null,loading:!0,error:null,refetch:async()=>{},logout:async()=>{}});function o(e){let{children:t}=e,[r,o]=(0,s.useState)(null),[c,d]=(0,s.useState)(null),[u,m]=(0,s.useState)(!0),[x,h]=(0,s.useState)(null),b=async e=>{try{h(null);let s=await (0,n.QT)((0,n.JU)(l.db,"users",e.uid));if(s.exists()){var t,r;let a=s.data();d({id:e.uid,email:e.email||"",role:a.role,sites:a.sites||[],status:a.status||"ACTIVE",createdFromInvitation:a.createdFromInvitation,createdAt:null===(t=a.createdAt)||void 0===t?void 0:t.toDate(),acceptedAt:null===(r=a.acceptedAt)||void 0===r?void 0:r.toDate()})}else h("ไม่พบข้อมูลผู้ใช้ในระบบ"),d(null)}catch(e){console.error("Error fetching user data:",e),h("เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้"),d(null)}},f=async()=>{r&&await b(r)};(0,s.useEffect)(()=>{let e=(0,a.Aj)(l.I,async e=>{try{m(!0),o(e),e?await b(e):(d(null),h(null))}catch(e){console.error("Auth state change error:",e),h("เกิดข้อผิดพลาดในการตรวจสอบสิทธิ์")}finally{m(!1)}});return()=>e()},[]);let p=async()=>{try{await (0,a.w7)(l.I),d(null),o(null),h(null)}catch(e){throw console.error("Logout error:",e),e}};return s.createElement(i.Provider,{value:{user:c,firebaseUser:r,loading:u,error:x,refetch:f,logout:p}},t)}function c(){return(0,s.useContext)(i)}},8031:function(e,t,r){"use strict";r.d(t,{InviteUserForm:function(){return i}});var s=r(7437),a=r(2265),n=r(9501),l=r(5946);function i(){let{firebaseUser:e}=(0,l.a)(),[t,r]=(0,a.useState)(!1),[i,o]=(0,a.useState)(null),[c,d]=(0,a.useState)([]),[u,m]=(0,a.useState)(!0),{register:x,handleSubmit:h,reset:b,formState:{errors:f}}=(0,n.cI)({defaultValues:{sites:[]}});(0,a.useEffect)(()=>{(async()=>{if(e)try{let t=await e.getIdToken(),r=await fetch("/api/sites",{headers:{Authorization:"Bearer ".concat(t)}}),s=await r.json();s.success&&d(s.sites)}catch(e){console.error("Failed to fetch sites",e)}finally{m(!1)}})()},[e]);let p=async e=>{r(!0),o(null);try{let t=await fetch("/api/admin/invite",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();r.success?(o({success:!0,invitationUrl:r.invitationUrl}),b()):o({success:!1,error:r.error||"Failed to create invitation"})}catch(e){o({success:!1,error:"Network error occurred"})}finally{r(!1)}};return(0,s.jsxs)("div",{className:"max-w-md mx-auto bg-white p-6 rounded-lg shadow-lg",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold mb-6 text-center text-gray-800",children:"เชิญผู้ใช้ใหม่"}),(0,s.jsxs)("form",{onSubmit:h(p),className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"อีเมล"}),(0,s.jsx)("input",{type:"email",...x("email",{required:"กรุณาใส่อีเมล"}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"user@company.com"}),f.email&&(0,s.jsx)("p",{className:"text-red-500 text-sm mt-1",children:f.email.message})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"ตำแหน่งงาน"}),(0,s.jsxs)("select",{...x("role",{required:"กรุณาเลือกตำแหน่งงาน"}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[(0,s.jsx)("option",{value:"",children:"-- เลือกตำแหน่งงาน --"}),(0,s.jsx)("option",{value:"BIM",children:"BIM"}),(0,s.jsx)("option",{value:"Site Admin",children:"Site Admin"}),(0,s.jsx)("option",{value:"CM",children:"CM"}),(0,s.jsx)("option",{value:"ME",children:"ME (Mechanical/Electrical Engineer)"}),(0,s.jsx)("option",{value:"SN",children:"SN (Sanitary Engineer)"})]}),f.role&&(0,s.jsx)("p",{className:"text-red-500 text-sm mt-1",children:f.role.message})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"โครงการที่ให้เข้าถึง"}),u?(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"Loading sites..."}):(0,s.jsx)("div",{className:"mt-2 p-3 border border-gray-200 rounded-md space-y-2 max-h-40 overflow-y-auto",children:c.map(e=>(0,s.jsxs)("label",{className:"flex items-center",children:[(0,s.jsx)("input",{type:"checkbox",...x("sites",{required:"กรุณาเลือกอย่างน้อย 1 โครงการ"}),value:e.id,className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),(0,s.jsx)("span",{className:"ml-2 text-sm text-gray-700",children:e.name})]},e.id))}),f.sites&&(0,s.jsx)("p",{className:"text-red-500 text-sm mt-1",children:f.sites.message})]}),(0,s.jsx)("button",{type:"submit",disabled:t||u,className:"w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed transition-colors",children:t?"กำลังสร้างคำเชิญ...":"สร้างคำเชิญ"})]}),i&&(0,s.jsx)("div",{className:"mt-6",children:i.success?(0,s.jsxs)("div",{className:"bg-green-50 border border-green-200 rounded-md p-4",children:[(0,s.jsx)("h3",{className:"text-green-800 font-medium mb-2",children:"✅ สร้างคำเชิญสำเร็จ!"}),(0,s.jsx)("p",{className:"text-green-700 text-sm mb-3",children:"ส่ง link นี้ให้ผู้ใช้:"}),(0,s.jsx)("div",{className:"bg-white border rounded p-2",children:(0,s.jsx)("code",{className:"text-xs break-all text-gray-800",children:i.invitationUrl})}),(0,s.jsx)("button",{onClick:()=>navigator.clipboard.writeText(i.invitationUrl),className:"mt-2 text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700",children:"\uD83D\uDCCB Copy Link"})]}):(0,s.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:[(0,s.jsx)("h3",{className:"text-red-800 font-medium mb-1",children:"❌ เกิดข้อผิดพลาด"}),(0,s.jsx)("p",{className:"text-red-700 text-sm",children:i.error})]})})]})}},6855:function(e,t,r){"use strict";r.d(t,{I:function(){return i},db:function(){return o}});var s=r(996),a=r(2148),n=r(5978);let l=(0,s.C6)().length>0?(0,s.C6)()[0]:(0,s.ZF)({apiKey:"AIzaSyAsayb-DEOBE0zi0qh-dPBfihClgXrX1sY",authDomain:"ttsdocumentcontrol.firebaseapp.com",projectId:"ttsdocumentcontrol",storageBucket:"ttsdocumentcontrol.firebasestorage.app",messagingSenderId:"48440915675",appId:"1:48440915675:web:f11611895bfb52d4d27efe"}),i=(0,a.v0)(l),o=(0,n.ad)(l)}},function(e){e.O(0,[609,15,351,501,971,117,744],function(){return e(e.s=9852)}),_N_E=e.O()}]);