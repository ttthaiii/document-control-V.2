(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[223],{5750:function(e,t,s){Promise.resolve().then(s.bind(s,9580))},9205:function(e,t,s){"use strict";s.d(t,{Z:function(){return u}});var a=s(2265);let r=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),l=e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,s)=>s?s.toUpperCase():t.toLowerCase()),n=e=>{let t=l(e);return t.charAt(0).toUpperCase()+t.slice(1)},i=function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return t.filter((e,t,s)=>!!e&&""!==e.trim()&&s.indexOf(e)===t).join(" ").trim()},c=e=>{for(let t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0};var o={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let d=(0,a.forwardRef)((e,t)=>{let{color:s="currentColor",size:r=24,strokeWidth:l=2,absoluteStrokeWidth:n,className:d="",children:u,iconNode:m,...x}=e;return(0,a.createElement)("svg",{ref:t,...o,width:r,height:r,stroke:s,strokeWidth:n?24*Number(l)/Number(r):l,className:i("lucide",d),...!u&&!c(x)&&{"aria-hidden":"true"},...x},[...m.map(e=>{let[t,s]=e;return(0,a.createElement)(t,s)}),...Array.isArray(u)?u:[u]])}),u=(e,t)=>{let s=(0,a.forwardRef)((s,l)=>{let{className:c,...o}=s;return(0,a.createElement)(d,{ref:l,iconNode:t,className:i("lucide-".concat(r(n(e))),"lucide-".concat(e),c),...o})});return s.displayName=n(e),s}},2735:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("download",[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]])},8736:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("file-text",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]])},5621:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("history",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]])},6980:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("paperclip",[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]])},9397:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},7168:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("refresh-cw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]])},7157:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("thumbs-down",[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z",key:"m61m77"}]])},1810:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("thumbs-up",[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]])},2489:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])},9580:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return Z}});var a=s(7437),r=s(2265),l=s(9376),n=s(7649),i=s(731),c=s(9761),o=s(8736),d=s(1810),u=s(7157),m=s(453);let x=e=>{if(!e)return"N/A";if("function"==typeof e.toDate)return e.toDate().toLocaleDateString("th-TH",{day:"2-digit",month:"short",year:"numeric"});let t=new Date(e);return isNaN(t.getTime())?"Invalid Date":t.toLocaleDateString("th-TH",{day:"2-digit",month:"short",year:"numeric"})},h=e=>{let t=m.NK[e]||e,s=m.yh[e]||"#6c757d",a="text-gray-800",r="bg-gray-100";return"#0088FE"===s?(r="bg-blue-100",a="text-blue-800"):"#FFBB28"===s?(r="bg-yellow-100",a="text-yellow-800"):"#AF19FF"===s?(r="bg-purple-100",a="text-purple-800"):"#FD7E14"===s?(r="bg-orange-100",a="text-orange-800"):"#28A745"===s?(r="bg-green-100",a="text-green-800"):"#6c757d"===s?(r="bg-gray-100",a="text-gray-800"):"#DC3545"===s&&(r="bg-red-100",a="text-red-800"),{text:t,colorClasses:"".concat(r," ").concat(a)}};function p(e){let{documents:t,isLoading:s,onDocumentClick:l,selectedIds:i,onSelectionChange:p,onApproveRejectClick:f}=e,{user:N}=(0,n.a)(),g=N&&m.$p.includes(N.role),E=(e,t)=>{t?p([...i,e]):p(i.filter(t=>t!==e))},b=e=>{e?p(y.filter(e=>e.status===m.Ge.DRAFT).map(e=>e.id)):p([])},y=(0,r.useMemo)(()=>{if(!N)return[];let e=N.role;return e===m.K$.ADMIN||m.$p.includes(e)?t:e===m.K$.BIM?t.filter(e=>e.status!==m.Ge.DRAFT&&e.status!==m.Ge.REJECTED_BY_PM):m.c9.includes(e)&&N.sites&&N.sites.length>0?t.filter(e=>e.createdBy===N.id||e.status!==m.Ge.DRAFT&&e.status!==m.Ge.REJECTED_BY_PM):t.filter(e=>e.status!==m.Ge.DRAFT&&e.status!==m.Ge.REJECTED_BY_PM)},[t,N]),j=(0,r.useMemo)(()=>y.filter(e=>e.status===m.Ge.DRAFT),[y]),v=j.length>0&&i.length===j.length;return s?(0,a.jsx)("div",{className:"w-full h-96 flex justify-center items-center bg-white rounded-lg shadow",children:(0,a.jsx)(c.Z,{})}):t&&0!==t.length?(0,a.jsx)("div",{className:"bg-white rounded-lg shadow overflow-hidden h-full flex flex-col",children:(0,a.jsx)("div",{className:"overflow-auto flex-1 relative",children:(0,a.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,a.jsx)("thead",{className:"bg-gray-50 sticky top-0 z-10",children:(0,a.jsxs)("tr",{children:[g&&(0,a.jsx)("th",{className:"px-4 py-3 text-left",children:(0,a.jsx)("input",{type:"checkbox",className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500",checked:v,onChange:e=>b(e.target.checked),disabled:0===j.length})}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"เลขที่เอกสาร"}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"หัวข้อเรื่อง"}),(0,a.jsx)("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"โครงการ"}),(0,a.jsx)("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"สถานะ"}),(0,a.jsx)("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"อัปเดตล่าสุด"}),g&&(0,a.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),(0,a.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:y.map(e=>{var t;let s=h(e.status),r=e.status===m.Ge.DRAFT,n=i.includes(e.id);return(0,a.jsxs)("tr",{className:"hover:bg-gray-50 ".concat(r?"bg-yellow-50 hover:bg-yellow-100":""),onClick:t=>{let s=t.target;"INPUT"===s.tagName||s.closest("button")||l(e)},children:[g&&(0,a.jsxs)("td",{className:"px-4 py-4",children:[r?(0,a.jsx)("input",{type:"checkbox",className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer",checked:n,onChange:t=>E(e.id,t.target.checked),onClick:e=>e.stopPropagation()}):null," "]}),(0,a.jsx)("td",{className:"px-6 py-4",children:(0,a.jsx)("p",{className:"text-sm font-semibold text-blue-600",children:e.documentNumber})}),(0,a.jsx)("td",{className:"px-6 py-4",children:(0,a.jsx)("p",{className:"text-sm text-gray-800 line-clamp-2",children:e.taskName})}),(0,a.jsx)("td",{className:"px-6 py-4 text-center",children:(0,a.jsx)("p",{className:"text-sm text-gray-600",children:(null===(t=e.site)||void 0===t?void 0:t.name)||"N/A"})}),(0,a.jsx)("td",{className:"px-6 py-4 text-center",children:(0,a.jsx)("span",{className:"inline-flex items-center justify-center px-2.5 py-1 rounded-full text-xs font-semibold ".concat(s.colorClasses),children:s.text})}),(0,a.jsx)("td",{className:"px-6 py-4 text-center",children:(0,a.jsx)("span",{className:"text-sm text-gray-600",children:x(e.updatedAt)})}),g&&(0,a.jsx)("td",{className:"px-4 py-4 text-center whitespace-nowrap",children:r&&f&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{onClick:t=>{t.stopPropagation(),f("APPROVE_DRAFT",e.id)},className:"text-green-600 hover:text-green-800 p-1 rounded hover:bg-green-100 mx-1 disabled:opacity-50",title:"อนุมัติ",children:(0,a.jsx)(d.Z,{size:16})}),(0,a.jsx)("button",{onClick:t=>{t.stopPropagation(),f("REJECT_DRAFT",e.id)},className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 mx-1 disabled:opacity-50",title:"ไม่อนุมัติ",children:(0,a.jsx)(u.Z,{size:16})})]})})]},e.id)})})]})})}):(0,a.jsxs)("div",{className:"w-full h-96 flex flex-col justify-center items-center bg-white rounded-lg shadow text-center border-2 border-dashed",children:[(0,a.jsx)(o.Z,{className:"w-16 h-16 text-gray-300 mb-4"}),(0,a.jsx)("h3",{className:"text-xl font-semibold text-gray-700",children:"ไม่พบ Work Request"}),(0,a.jsx)("p",{className:"text-gray-500 mt-1",children:"ยังไม่มีการสร้างคำร้องของานในโครงการนี้"})]})}var f=s(5621),N=s(2489),g=s(6980),E=s(2735),b=s(9205);let y=(0,b.Z)("corner-up-left",[["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}],["path",{d:"M9 14 4 9l5-5",key:"102s5s"}]]);var j=s(401),v=s(7689),R=s(6865),w=s(4743);let A=(0,b.Z)("square-pen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);var I=s(4001);let k=e=>{if(!e)return"0 B";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["B","KB","MB","GB"][t]},P=function(e){let t,s=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(!e)return"N/A";if(isNaN((t=new Date(e&&"object"==typeof e&&"_seconds"in e?1e3*e._seconds:e)).getTime()))return"Invalid Date";let a={day:"2-digit",month:"short",year:"numeric"};return s&&(a.hour="2-digit",a.minute="2-digit"),t.toLocaleString("th-TH",a)},M=e=>({text:m.NK[e]||e,color:m.yh[e]||"#6c757d"}),D=e=>{let{workflow:t,onClose:s}=e;return(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center p-4 border-b",children:[(0,a.jsxs)("h3",{className:"text-lg font-bold text-gray-800 flex items-center",children:[(0,a.jsx)(f.Z,{size:20,className:"mr-2"}),"ประวัติ Work Request"]}),(0,a.jsx)("button",{onClick:s,className:"text-gray-400 hover:text-gray-600",children:(0,a.jsx)(N.Z,{size:24})})]}),(0,a.jsx)("div",{className:"p-6 overflow-y-auto",children:(0,a.jsx)("div",{className:"border-l-2 border-gray-200 ml-2",children:t.length>0?t.map((e,t)=>(0,a.jsxs)("div",{className:"relative pl-6 pb-8 last:pb-0",children:[(0,a.jsx)("div",{className:"absolute -left-[9px] top-1 w-4 h-4 bg-blue-500 rounded-full border-2 border-white"}),(0,a.jsx)("p",{className:"font-semibold text-gray-800",children:M(e.status).text}),(0,a.jsxs)("p",{className:"text-sm text-gray-600",children:["โดย: ",e.userName," (",e.role,")"]}),(0,a.jsx)("time",{className:"text-xs text-gray-400",children:P(e.timestamp)}),e.comments&&(0,a.jsx)("div",{className:"mt-2 p-2 bg-gray-50 rounded-md text-xs italic",children:(0,a.jsxs)("p",{className:"text-gray-600",children:['"',e.comments,'"']})})]},t)):(0,a.jsx)("p",{className:"text-sm text-gray-500 pl-6",children:"ไม่มีประวัติ"})})})]})})};function _(e){var t;let{documentId:s,onClose:l,onUpdate:i}=e,{user:x,firebaseUser:h}=(0,n.a)(),{showNotification:p}=(0,I.l)(),[b,_]=(0,r.useState)(null),[T,S]=(0,r.useState)(!0),[C,O]=(0,r.useState)(!1),[F,K]=(0,r.useState)(""),[V,$]=(0,r.useState)([]),[Z,B]=(0,r.useState)(!1),[W,G]=(0,r.useState)(""),[z,U]=(0,r.useState)([]),[L,J]=(0,r.useState)(!1),[q,H]=(0,r.useState)(!1),[Q,Y]=(0,r.useState)(null),[X,ee]=(0,r.useState)(null),[et,es]=(0,r.useState)(""),ea=(null==x?void 0:x.role)===m.K$.BIM&&(null==b?void 0:b.status)===m.Ge.IN_PROGRESS,er=x&&m.oU.includes(x.role)&&(null==b?void 0:b.status)===m.Ge.PENDING_ACCEPTANCE,el=(null==x?void 0:x.role)===m.K$.BIM&&(null==b?void 0:b.status)===m.Ge.REVISION_REQUESTED,en=x&&m.$p.includes(x.role)&&(null==b?void 0:b.status)===m.Ge.DRAFT,ei=(0,r.useMemo)(()=>((null==b?void 0:b.revisionNumber)||0)+1,[b]),ec=(0,r.useMemo)(()=>b?"".concat(b.documentNumber.split("-REV")[0],"-REV").concat(String(ei).padStart(2,"0")):"",[b,ei]);(0,r.useEffect)(()=>{(async()=>{if(s&&h){S(!0);try{let e=await h.getIdToken(),t=await fetch("/api/work-request/".concat(s),{headers:{Authorization:"Bearer ".concat(e)}}),a=await t.json();if(a.success)_(a.document);else throw Error(a.error)}catch(e){p("error","เกิดข้อผิดพลาด","ไม่สามารถโหลดข้อมูลเอกสารได้"),l()}finally{S(!1)}}})()},[s,h,p,l]),(0,r.useEffect)(()=>{el&&h&&b&&(async()=>{var e,t;if(!(null===(e=b.site)||void 0===e?void 0:e.name)||!b.documentNumber||!(null===(t=b.taskData)||void 0===t?void 0:t.taskName)){Y("ข้อมูลเอกสารไม่สมบูรณ์ ไม่สามารถตรวจสอบ Task ได้");return}J(!0),H(!1),Y(null),ee(null);try{let e=await h.getIdToken(),t=await fetch("/api/bim-tracking/verify-task",{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},body:JSON.stringify({documentNumber:b.documentNumber.split("-REV")[0],projectName:b.site.name,rev:ei,taskName:b.taskData.taskName})}),s=await t.json();if(t.ok&&s.success)s.exists?(H(!0),ee(s.taskId)):Y("กรุณาสร้าง Task สำหรับ Revision นี้ในระบบ BIM Tracking ก่อน");else throw Error(s.error||"ไม่สามารถตรวจสอบ Task ได้")}catch(e){Y(e.message)}finally{J(!1)}})()},[el,b,h,ei]);let eo=async e=>{try{if(!h)throw Error("กรุณาล็อกอินก่อนอัปโหลดไฟล์");let t=await h.getIdToken(),s=new FormData;s.append("file",e);let a=await fetch("/api/rfa/upload-temp-file",{method:"POST",headers:{Authorization:"Bearer ".concat(t)},body:s}),r=await a.json();if(r.success)return{status:"success",uploadedData:r.fileData};throw Error(r.error||"อัปโหลดล้มเหลว")}catch(e){return{status:"error",error:e instanceof Error?e.message:"เกิดข้อผิดพลาด"}}},ed=async(e,t)=>{let s=Array.from(e.target.files||[]);if(!s.length)return;let a=s.map(e=>({id:"".concat(e.name,"-").concat(Date.now()),file:e,status:"pending"})),r="revision"===t?U:$;for(let e of(r(e=>[...e,...a]),a)){r(t=>t.map(t=>t.id===e.id?{...t,status:"uploading"}:t));let t=await eo(e.file);r(s=>s.map(s=>s.id===e.id?{...s,...t}:s))}e.target.value=""},eu=(e,t)=>{("revision"===t?U:$)(t=>t.filter(t=>t.id!==e))},em=async e=>{if(b&&h){O(!0);try{let t=await h.getIdToken(),s=V.filter(e=>"success"===e.status);if(0===s.length){p("warning","กรุณาแนบไฟล์","ต้องแนบไฟล์ผลงานอย่างน้อย 1 ไฟล์"),O(!1);return}let a={action:e,payload:{comments:F,files:s.map(e=>e.uploadedData)}},r=await fetch("/api/work-request/".concat(b.id,"/update"),{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify(a)}),n=await r.json();if(n.success)p("success","ดำเนินการสำเร็จ","สถานะถูกเปลี่ยนเป็น: ".concat(M(n.newStatus).text)),i(),l();else throw Error(n.error)}catch(e){p("error","เกิดข้อผิดพลาด",e instanceof Error?e.message:"Unknown error")}finally{O(!1)}}},ex=async e=>{if(b&&h){O(!0);try{let t=await h.getIdToken(),s=await fetch("/api/work-request/".concat(b.id,"/update"),{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({action:e,payload:{comments:F}})}),a=await s.json();if(a.success)p("success","ดำเนินการสำเร็จ","สถานะถูกเปลี่ยนเป็น: ".concat(M(a.newStatus).text)),i(),l();else throw Error(a.error)}catch(e){p("error","เกิดข้อผิดพลาด",e instanceof Error?e.message:"Failed to perform action")}finally{O(!1)}}},eh=async()=>{let e=z.filter(e=>"success"===e.status);if(0===e.length){p("warning","กรุณาแนบไฟล์","ต้องแนบไฟล์ฉบับแก้ไขอย่างน้อย 1 ไฟล์");return}if(!X){p("error","Task ไม่ถูกต้อง","ไม่พบ Task ID ที่ตรวจสอบแล้ว");return}O(!0);try{let t=await (null==h?void 0:h.getIdToken()),s={originalDocId:b.id,uploadedFiles:e.map(e=>e.uploadedData),comments:W,verifiedTaskId:X},a=await fetch("/api/work-request/create_revision",{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify(s)}),r=await a.json();if(r.success)p("success","สร้าง Revision สำเร็จ!","เอกสารฉบับใหม่ ".concat(r.newDocumentNumber," ถูกส่งให้ Site ตรวจสอบแล้ว")),i(),l();else throw Error(r.error||"เกิดข้อผิดพลาดในการสร้าง Revision")}catch(e){p("error","เกิดข้อผิดพลาด",e instanceof Error?e.message:"Unknown error")}finally{O(!1)}},ep=async e=>{if(b&&h){if("REJECT_DRAFT"===e&&!et.trim()){p("warning","กรุณากรอกเหตุผล","ต้องระบุเหตุผลในการไม่อนุมัติ");return}O(!0);try{let t=await h.getIdToken(),s=await fetch("/api/work-request/".concat(b.id,"/update"),{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({action:e,payload:{comments:et}})}),a=await s.json();if(a.success)p("success","ดำเนินการสำเร็จ","สถานะถูกเปลี่ยนเป็น: ".concat(M(a.newStatus).text)),i(),l();else throw Error(a.error||"เกิดข้อผิดพลาดในการดำเนินการ")}catch(e){p("error","เกิดข้อผิดพลาด",e instanceof Error?e.message:"Unknown error")}finally{O(!1)}}};if(T)return(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center",children:(0,a.jsx)(c.Z,{className:"w-12 h-12 text-white"})});if(!b)return null;let ef=M(b.status);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start p-4 border-b",children:[(0,a.jsx)("div",{children:(0,a.jsxs)("div",{className:"flex items-baseline space-x-3",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-blue-600",children:b.documentNumber}),(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-800",children:b.taskName})]})}),(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsxs)("button",{onClick:()=>B(!0),className:"flex items-center text-sm text-gray-500 hover:text-blue-600",children:[(0,a.jsx)(f.Z,{size:16,className:"mr-1"})," ดูประวัติ"]}),(0,a.jsx)("button",{onClick:l,className:"text-gray-400 hover:text-gray-600",children:(0,a.jsx)(N.Z,{size:24})})]})]}),(0,a.jsxs)("div",{className:"p-6 overflow-y-auto space-y-6",children:[(0,a.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{className:"text-gray-500 block mb-1",children:"สถานะ:"}),(0,a.jsx)("span",{className:"px-3 py-1 text-xs font-bold text-white rounded-full",style:{backgroundColor:ef.color},children:ef.text})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{className:"text-gray-500 block",children:"โครงการ:"}),(0,a.jsx)("span",{children:(null===(t=b.site)||void 0===t?void 0:t.name)||"N/A"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{className:"text-gray-500 block",children:"วันที่เริ่ม (แผน):"}),(0,a.jsx)("span",{children:P(b.planStartDate,!1)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{className:"text-gray-500 block",children:"วันที่กำหนดส่ง:"}),(0,a.jsx)("span",{children:P(b.dueDate,!1)})]})]}),b.description&&(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsx)("strong",{className:"text-gray-500 block text-sm",children:"รายละเอียด:"}),(0,a.jsx)("div",{className:"text-gray-700 whitespace-pre-wrap bg-white p-3 rounded-md mt-1 border",children:(0,a.jsxs)("p",{className:"italic",children:['"',b.description,'"']})})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("h4",{className:"text-md font-semibold mb-2 flex items-center text-slate-800",children:[(0,a.jsx)(g.Z,{size:16,className:"mr-2"})," ไฟล์แนบ"]}),(0,a.jsx)("ul",{className:"space-y-2",children:b.files.length>0?b.files.map((e,t)=>(0,a.jsx)("li",{children:(0,a.jsxs)("a",{href:e.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"flex items-center justify-between p-2 bg-slate-100 border border-slate-200 rounded-md hover:bg-slate-200 transition-colors group",children:[(0,a.jsxs)("div",{className:"flex items-center min-w-0",children:[(0,a.jsx)(o.Z,{className:"w-5 h-5 text-gray-500 mr-3 flex-shrink-0"}),(0,a.jsxs)("div",{className:"flex flex-col min-w-0",children:[(0,a.jsx)("span",{className:"text-sm font-medium text-blue-600 group-hover:underline truncate",children:e.fileName}),(0,a.jsx)("span",{className:"text-xs text-gray-500",children:k(e.fileSize||e.size)})]})]}),(0,a.jsx)(E.Z,{className:"w-5 h-5 text-gray-400 group-hover:text-gray-600 ml-4 flex-shrink-0"})]})},t)):(0,a.jsx)("p",{className:"text-sm text-gray-500 italic",children:"ไม่มีไฟล์แนบ"})})]})]}),(0,a.jsxs)("div",{className:"p-4 border-t bg-slate-50",children:[en&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-slate-800",children:"ดำเนินการ (สำหรับ PM/PD)"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"เหตุผลในการไม่อนุมัติ (ถ้ามี)"}),(0,a.jsx)("textarea",{value:et,onChange:e=>es(e.target.value),rows:3,placeholder:"กรอกเหตุผลที่ไม่อนุมัติ...",className:"w-full p-2 border rounded-md"})]}),(0,a.jsxs)("div",{className:"flex justify-end gap-3 pt-2",children:[(0,a.jsxs)("button",{onClick:()=>ep("REJECT_DRAFT"),disabled:C,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:bg-red-300 disabled:cursor-not-allowed",children:[(0,a.jsx)(u.Z,{size:16,className:"mr-2"}),C?"กำลังดำเนินการ...":"ไม่อนุมัติ"]}),(0,a.jsxs)("button",{onClick:()=>ep("APPROVE_DRAFT"),disabled:C,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed",children:[(0,a.jsx)(d.Z,{size:16,className:"mr-2"}),C?"กำลังอนุมัติ...":"อนุมัติ (ส่งให้ BIM)"]})]})]}),er&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-slate-800",children:"ดำเนินการ (สำหรับ Site)"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"หมายเหตุ / คอมเมนต์ (ถ้ามี)"}),(0,a.jsx)("textarea",{value:F,onChange:e=>K(e.target.value),rows:3,placeholder:"หากต้องการให้แก้ไข กรุณาใส่รายละเอียด...",className:"w-full p-2 border rounded-md"})]}),(0,a.jsxs)("div",{className:"flex justify-end gap-3 pt-2",children:[(0,a.jsxs)("button",{onClick:()=>ex("REQUEST_REVISION"),disabled:C,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-orange-600 rounded-lg hover:bg-orange-700 disabled:bg-orange-300",children:[(0,a.jsx)(y,{size:16,className:"mr-2"}),C?"กำลังส่ง...":"ส่งกลับให้แก้ไข"]}),(0,a.jsxs)("button",{onClick:()=>ex("COMPLETE"),disabled:C,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-green-300",children:[(0,a.jsx)(j.Z,{size:16,className:"mr-2"}),C?"กำลังปิดงาน...":"ตรวจรับและปิดงาน"]})]})]}),ea&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-slate-800",children:"ส่งมอบงาน (Submit Work)"}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["แนบไฟล์ผลงาน ",(0,a.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,a.jsxs)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[(0,a.jsx)("input",{type:"file",multiple:!0,onChange:e=>ed(e,"action"),id:"submit-file-upload",className:"hidden"}),(0,a.jsxs)("label",{htmlFor:"submit-file-upload",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[(0,a.jsx)(v.Z,{size:16,className:"mr-2"})," คลิกเพื่อเลือกไฟล์"]})]}),V.length>0&&(0,a.jsx)("div",{className:"mt-2 space-y-2",children:V.map(e=>(0,a.jsxs)("div",{className:"flex items-center text-sm p-2 bg-gray-100 rounded",children:[(0,a.jsx)(o.Z,{className:"w-4 h-4 mr-3 text-gray-500"}),(0,a.jsx)("span",{className:"flex-1 truncate",children:e.file.name}),(0,a.jsxs)("div",{className:"flex items-center ml-3",children:["uploading"===e.status&&(0,a.jsx)(c.Z,{className:"w-4 h-4"}),"success"===e.status&&(0,a.jsx)(j.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&(0,a.jsx)("span",{title:e.error,children:(0,a.jsx)(R.Z,{className:"w-4 h-4 text-red-500"})}),(0,a.jsx)("button",{type:"button",onClick:()=>eu(e.id,"action"),className:"ml-3 text-gray-500 hover:text-red-600",children:(0,a.jsx)(N.Z,{size:16})})]})]},e.id))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"หมายเหตุ / คอมเมนต์ (ถ้ามี)"}),(0,a.jsx)("textarea",{value:F,onChange:e=>K(e.target.value),rows:3,placeholder:"อธิบายรายละเอียดการทำงาน...",className:"w-full p-2 border rounded-md"})]}),(0,a.jsx)("div",{className:"flex justify-end pt-2",children:(0,a.jsxs)("button",{onClick:()=>em("SUBMIT_WORK"),disabled:0===V.filter(e=>"success"===e.status).length||C,className:"flex items-center px-6 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-green-300",children:[C?(0,a.jsx)(c.Z,{className:"w-5 h-5 mr-2"}):(0,a.jsx)(w.Z,{size:16,className:"mr-2"}),C?"กำลังส่งงาน...":"ส่งงานให้ Site ตรวจรับ"]})})]}),el&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-slate-800",children:"สร้างเอกสารฉบับแก้ไข (Create Revision)"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"เอกสารเดิม:"})," ",b.documentNumber]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"เอกสารใหม่:"})," ",ec]})]}),(L||Q)&&(0,a.jsxs)("div",{className:"p-3 rounded-md text-sm font-medium flex items-center border bg-white",children:[L&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(c.Z,{className:"w-4 h-4 mr-3 text-gray-500"})," ",(0,a.jsx)("span",{className:"text-gray-600",children:"กำลังตรวจสอบ Task ในระบบ BIM Tracking..."})]}),Q&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(R.Z,{className:"w-4 h-4 mr-3 text-red-500"})," ",(0,a.jsx)("span",{className:"text-red-600 font-semibold",children:Q})]})]}),q&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["แนบไฟล์ที่แก้ไขแล้ว ",(0,a.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,a.jsxs)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[(0,a.jsx)("input",{type:"file",multiple:!0,onChange:e=>ed(e,"revision"),id:"revision-file-upload",className:"hidden"}),(0,a.jsxs)("label",{htmlFor:"revision-file-upload",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[(0,a.jsx)(v.Z,{size:16,className:"mr-2"})," คลิกเพื่อเลือกไฟล์"]})]}),z.length>0&&(0,a.jsx)("div",{className:"mt-2 space-y-2",children:z.map(e=>(0,a.jsxs)("div",{className:"flex items-center text-sm p-2 bg-gray-100 rounded",children:[(0,a.jsx)(o.Z,{className:"w-4 h-4 mr-3 text-gray-500"}),(0,a.jsx)("span",{className:"flex-1 truncate",children:e.file.name}),(0,a.jsxs)("div",{className:"flex items-center ml-3",children:["uploading"===e.status&&(0,a.jsx)(c.Z,{className:"w-4 h-4"}),"success"===e.status&&(0,a.jsx)(j.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&(0,a.jsx)("span",{title:e.error,children:(0,a.jsx)(R.Z,{className:"w-4 h-4 text-red-500"})}),(0,a.jsx)("button",{type:"button",onClick:()=>eu(e.id,"revision"),className:"ml-3 text-gray-500 hover:text-red-600",children:(0,a.jsx)(N.Z,{size:16})})]})]},e.id))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"หมายเหตุ / คอมเมนต์ (ถ้ามี)"}),(0,a.jsx)("textarea",{value:W,onChange:e=>G(e.target.value),rows:3,placeholder:"อธิบายรายละเอียดการแก้ไข...",className:"w-full p-2 border rounded-md"})]}),(0,a.jsx)("div",{className:"flex justify-end pt-2",children:(0,a.jsxs)("button",{onClick:eh,disabled:0===z.filter(e=>"success"===e.status).length||C||!q,className:"flex items-center px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-blue-300",children:[C?(0,a.jsx)(c.Z,{className:"w-5 h-5 mr-2"}):(0,a.jsx)(A,{size:16,className:"mr-2"}),C?"กำลังส่ง...":"ส่งเอกสารฉบับแก้ไข"]})})]})]})]})]})}),Z&&(0,a.jsx)(D,{workflow:b.workflow||[],onClose:()=>B(!1)})]})}var T=s(5861),S=s(7168),C=s(9397),O=s(6855),F=s(5978),K=s(1550);let V=e=>{let{isOpen:t,onClose:s,onSubmit:l,isSubmitting:n}=e,[i,o]=(0,r.useState)(""),[d,m]=(0,r.useState)("");return t?(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-[70] flex items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center p-4 border-b",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-gray-800",children:"เหตุผลในการไม่อนุมัติ"}),(0,a.jsx)("button",{onClick:s,disabled:n,className:"text-gray-400 hover:text-gray-600 disabled:opacity-50",children:(0,a.jsx)(N.Z,{size:24})})]}),(0,a.jsxs)("div",{className:"p-6 space-y-4",children:[(0,a.jsx)("textarea",{value:i,onChange:e=>{o(e.target.value),m("")},rows:4,placeholder:"กรุณาระบุเหตุผล...",className:"w-full p-2 border rounded-md ".concat(d?"border-red-500":"border-gray-300"),disabled:n}),d&&(0,a.jsx)("p",{className:"text-red-500 text-sm",children:d})]}),(0,a.jsxs)("div",{className:"flex justify-end gap-4 p-4 border-t bg-gray-50",children:[(0,a.jsx)("button",{onClick:s,disabled:n,className:"px-4 py-2 text-sm text-gray-700 bg-white border rounded-lg hover:bg-gray-100 disabled:opacity-50",children:"ยกเลิก"}),(0,a.jsxs)("button",{onClick:()=>{if(!i.trim()){m("กรุณากรอกเหตุผล");return}l(i)},disabled:n,className:"flex items-center px-4 py-2 text-sm text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:bg-red-300",children:[n?(0,a.jsx)(c.Z,{className:"w-4 h-4 mr-2"}):(0,a.jsx)(u.Z,{size:16,className:"mr-2"}),"ยืนยันไม่อนุมัติ"]})]})]})}):null};function $(){let{user:e,firebaseUser:t}=(0,n.a)();(0,l.useRouter)();let[s,i]=(0,r.useState)([]),[o,x]=(0,r.useState)([]),[h,f]=(0,r.useState)(!0),[N,g]=(0,r.useState)(null),[E,b]=(0,r.useState)(!1),{showNotification:y}=(0,I.l)(),[j,v]=(0,r.useState)([]),[R,w]=(0,r.useState)(!1),[A,k]=(0,r.useState)(!1),[P,M]=(0,r.useState)(null);(0,r.useEffect)(()=>{(async()=>{if(t)try{if((null==e?void 0:e.sites)&&e.sites.length>0){let t=(0,F.IO)((0,F.hJ)(O.db,"sites"),(0,F.ar)((0,F.Jm)(),"in",e.sites));(0,F.cf)(t,e=>{let t=e.docs.map(e=>({id:e.id,name:e.data().name,userOverrides:e.data().userOverrides}));x(t)})}}catch(e){console.error("Failed to fetch sites",e)}})()},[t,e]),(0,r.useEffect)(()=>{if(!t||!(null==e?void 0:e.sites)||0===e.sites.length){f(!1);return}f(!0);let s=(0,F.IO)((0,F.hJ)(O.db,"workRequests"),(0,F.ar)("siteId","in",e.sites),(0,F.Xo)("updatedAt","desc")),a=(0,F.cf)(s,e=>{let t=[];e.forEach(e=>{let s=e.data();t.push({id:e.id,documentNumber:s.documentNumber||"",runningNumber:s.runningNumber||"",taskName:s.taskName||"",description:s.description||"",status:s.status,createdAt:s.createdAt,updatedAt:s.updatedAt,createdBy:s.createdBy||"",assignedTo:s.assignedTo||void 0,planStartDate:s.planStartDate,dueDate:s.dueDate,taskData:s.taskData||null,revisionNumber:s.revisionNumber||0,isLatest:s.isLatest||!1,parentWorkRequestId:s.parentWorkRequestId||void 0,files:s.files||[],workflow:s.workflow||[],usersInfo:s.usersInfo||{},site:{id:s.siteId,name:"..."}})}),i(t),f(!1)},e=>{console.error("Failed to fetch real-time work requests:",e),f(!1)});return()=>a()},[t,e]);let D=(0,r.useMemo)(()=>{if(0===o.length)return s;let e=new Map(o.map(e=>[e.id,e.name]));return s.map(t=>({...t,site:{id:t.site.id,name:e.get(t.site.id)||"Unknown Site"}}))},[s,o]),$=(0,r.useMemo)(()=>{if(!e)return!1;let t="WR.".concat(K.S4.WORK_REQUEST.CREATE),[s,a]=t.split("."),r=(K.yB[t]||[]).includes(e.role);return o.some(t=>{var l,n,i;let c=null===(i=t.userOverrides)||void 0===i?void 0:null===(n=i[e.id])||void 0===n?void 0:null===(l=n[s])||void 0===l?void 0:l[a];return void 0!==c?!0===c:r})},[e,o]);e&&m.c9.includes(e.role);let Z=e&&m.$p.includes(e.role),B=(0,r.useCallback)(async(e,s)=>{let a=P?[P]:j;if(0!==a.length){w(!0);try{if(!t)throw Error("กรุณาล็อกอินก่อน");let r=await t.getIdToken(),l=await fetch("/api/work-request/batch-update",{method:"POST",headers:{Authorization:"Bearer ".concat(r),"Content-Type":"application/json"},body:JSON.stringify({ids:a,action:e,payload:{comments:s||""}})}),n=await l.json();if(n.success)y("success","ดำเนินการสำเร็จ!","".concat("APPROVE_DRAFT"===e?"อนุมัติ":"ไม่อนุมัติ"," ").concat(n.updatedCount," รายการเรียบร้อยแล้ว")),v([]),k(!1),M(null);else throw Error(n.error||"เกิดข้อผิดพลาดในการ ".concat(e))}catch(e){y("error","เกิดข้อผิดพลาด",e instanceof Error?e.message:"Unknown error")}finally{w(!1)}}},[t,j,P,y]),W=(0,r.useCallback)(async(e,s,a)=>{w(!0);try{if(!t)throw Error("กรุณาล็อกอินก่อน");let r=await t.getIdToken(),l=await fetch("/api/work-request/".concat(s,"/update"),{method:"POST",headers:{Authorization:"Bearer ".concat(r),"Content-Type":"application/json"},body:JSON.stringify({action:e,payload:{comments:a||""}})}),n=await l.json();if(n.success)y("success","ดำเนินการสำเร็จ!","".concat("APPROVE_DRAFT"===e?"อนุมัติ":"ไม่อนุมัติ","เอกสารเรียบร้อยแล้ว")),k(!1),M(null);else throw Error(n.error||"เกิดข้อผิดพลาดในการ ".concat(e))}catch(e){y("error","เกิดข้อผิดพลาด",e instanceof Error?e.message:"Unknown error")}finally{w(!1)}},[t,y]),G=e=>{W("APPROVE_DRAFT",e)},z=e=>{M(e),k(!0)};return(0,a.jsxs)("div",{className:"max-w-screen-2xl mx-auto flex flex-col h-full",children:[(0,a.jsx)("div",{children:(0,a.jsxs)("div",{className:"mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl lg:text-3xl font-bold text-gray-900",children:"✍️ Work Requests"}),(0,a.jsx)("p",{className:"text-gray-600 mt-1",children:"รายการคำร้องของานทั้งหมด (Real-time)"})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-3 mt-4 sm:mt-0",children:[(0,a.jsxs)("button",{className:"flex items-center px-3 py-2 bg-gray-100 text-gray-700 rounded-lg cursor-default",disabled:!0,children:[(0,a.jsx)(S.Z,{className:"w-4 h-4 mr-2 ".concat(h?"animate-spin":"")}),"Real-time Sync"]}),$&&(0,a.jsxs)("button",{onClick:()=>b(!0),className:"flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[(0,a.jsx)(C.Z,{className:"w-4 h-4 mr-2"}),"สร้าง Work Request"]})]})]})}),Z&&(0,a.jsxs)("div",{className:"bg-white p-3 rounded-lg shadow border border-gray-200 flex items-center space-x-3",children:[(0,a.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:["รายการที่เลือก (",j.length,"):"]}),(0,a.jsxs)("button",{onClick:()=>{0!==j.length&&B("APPROVE_DRAFT")},disabled:0===j.length||R,className:"flex items-center px-3 py-1.5 text-xs font-medium text-white bg-green-600 rounded-md hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed",children:[R?(0,a.jsx)(c.Z,{className:"w-4 h-4 mr-1"}):(0,a.jsx)(d.Z,{size:14,className:"mr-1"})," อนุมัติ"]}),(0,a.jsxs)("button",{onClick:()=>{0!==j.length&&(M(null),k(!0))},disabled:0===j.length||R,className:"flex items-center px-3 py-1.5 text-xs font-medium text-white bg-red-600 rounded-md hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed",children:[R?(0,a.jsx)(c.Z,{className:"w-4 h-4 mr-1"}):(0,a.jsx)(u.Z,{size:14,className:"mr-1"})," ไม่อนุมัติ"]}),R&&(0,a.jsx)("span",{className:"text-xs text-gray-500 italic",children:"กำลังดำเนินการ..."})]}),(0,a.jsx)("div",{className:"flex-1 min-h-0",children:(0,a.jsx)(p,{documents:D,isLoading:h,onDocumentClick:e=>{g(e.id)},selectedIds:j,onSelectionChange:v,onApproveRejectClick:(e,t)=>{"APPROVE_DRAFT"===e?G(t):"REJECT_DRAFT"===e&&z(t)}})}),N&&(0,a.jsx)(_,{documentId:N,onClose:()=>{g(null)},onUpdate:()=>{}}),E&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",children:(0,a.jsx)("div",{className:"w-full max-w-4xl bg-white rounded-lg shadow-xl p-6",children:(0,a.jsx)(T.Z,{onClose:()=>{b(!1)},userProp:e||void 0})})}),(0,a.jsx)(V,{isOpen:A,onClose:()=>{k(!1),M(null)},onSubmit:P?e=>{P&&W("REJECT_DRAFT",P,e)}:e=>{B("REJECT_DRAFT",e)},isSubmitting:R})]})}function Z(){return(0,a.jsx)(i.AuthGuard,{requiredRoles:[m.K$.ADMIN,m.K$.SITE_ADMIN,m.K$.BIM,...m.c9,...m.$p],children:(0,a.jsx)(r.Suspense,{fallback:(0,a.jsx)("div",{className:"text-center p-8",children:"Loading Page..."}),children:(0,a.jsx)($,{})})})}},9761:function(e,t,s){"use strict";var a=s(7437);s(2265),t.Z=e=>{let{className:t}=e;return(0,a.jsx)("div",{className:"\n    inline-block h-8 w-8 animate-spin rounded-full \n    border-4 border-solid border-current border-e-transparent \n    align-[-0.125em] text-gray-400 motion-reduce:animate-[spin_1.5s_linear_infinite]\n    ".concat(t||"","\n  ").trim(),role:"status",children:(0,a.jsx)("span",{className:"!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]",children:"Loading..."})})}},1550:function(e,t,s){"use strict";s.d(t,{S4:function(){return r},l8:function(){return i},yB:function(){return n}});var a=s(453);let r={RFA:{VIEW_SHOP:"view_shop",CREATE_SHOP:"create_shop",VIEW_GEN:"view_gen",CREATE_GEN:"create_gen",VIEW_MAT:"view_mat",CREATE_MAT:"create_mat",APPROVE:"can_approve"},WORK_REQUEST:{VIEW:"view_wr",CREATE:"create_wr",APPROVE:"approve_wr",VERIFY:"verify_wr"}};a.K$.ADMIN,a.K$.PD,a.K$.PM,a.K$.SE,a.K$.FM,a.K$.BIM,a.K$.SITE_ADMIN,a.K$.CM,a.K$.ME,a.K$.SN,a.K$.OE,a.K$.PE;let l=[a.K$.ADMIN,a.K$.PD,a.K$.PM,a.K$.BIM,a.K$.SITE_ADMIN,a.K$.CM,a.K$.ME,a.K$.SN,a.K$.OE,a.K$.PE],n={["RFA.".concat(r.RFA.VIEW_SHOP)]:l,["RFA.".concat(r.RFA.CREATE_SHOP)]:[a.K$.BIM,a.K$.ME,a.K$.SN,a.K$.SITE_ADMIN,a.K$.ADMIN,a.K$.PM,a.K$.PE,a.K$.OE],["RFA.".concat(r.RFA.VIEW_GEN)]:l,["RFA.".concat(r.RFA.CREATE_GEN)]:[a.K$.BIM,a.K$.ME,a.K$.SN,a.K$.SITE_ADMIN,a.K$.ADMIN,a.K$.PM,a.K$.PE,a.K$.OE],["RFA.".concat(r.RFA.VIEW_MAT)]:l,["RFA.".concat(r.RFA.CREATE_MAT)]:[a.K$.SITE_ADMIN,a.K$.ADMIN,a.K$.PM,a.K$.PE,a.K$.OE],["RFA.".concat(r.RFA.APPROVE)]:[a.K$.CM,a.K$.ADMIN,a.K$.SITE_ADMIN,a.K$.PM,a.K$.PE,a.K$.OE],["WR.".concat(r.WORK_REQUEST.VIEW)]:l,["WR.".concat(r.WORK_REQUEST.CREATE)]:[a.K$.PE,a.K$.OE,a.K$.ADMIN],["WR.".concat(r.WORK_REQUEST.APPROVE)]:[a.K$.PM,a.K$.ADMIN],["WR.".concat(r.WORK_REQUEST.VERIFY)]:[a.K$.SITE_ADMIN,a.K$.ADMIN,a.K$.BIM]},i=[{title:"RFA - Shop Drawing",permissions:[{key:"RFA.".concat(r.RFA.VIEW_SHOP),label:"เข้าดู (View)"},{key:"RFA.".concat(r.RFA.CREATE_SHOP),label:"สร้าง (Create)"}]},{title:"RFA - General",permissions:[{key:"RFA.".concat(r.RFA.VIEW_GEN),label:"เข้าดู (View)"},{key:"RFA.".concat(r.RFA.CREATE_GEN),label:"สร้าง (Create)"}]},{title:"RFA - Material",permissions:[{key:"RFA.".concat(r.RFA.VIEW_MAT),label:"เข้าดู (View)"},{key:"RFA.".concat(r.RFA.CREATE_MAT),label:"สร้าง (Create)"}]},{title:"RFA - Approval",permissions:[{key:"RFA.".concat(r.RFA.APPROVE),label:"อนุมัติเอกสาร (Approve)"}]},{title:"Work Request",permissions:[{key:"WR.".concat(r.WORK_REQUEST.VIEW),label:"เข้าดู (View)"},{key:"WR.".concat(r.WORK_REQUEST.CREATE),label:"สร้างใบคำขอ (Create)"},{key:"WR.".concat(r.WORK_REQUEST.APPROVE),label:"อนุมัติใบคำขอ (PM)"},{key:"WR.".concat(r.WORK_REQUEST.VERIFY),label:"ตรวจรับงาน (Site)"}]}]},453:function(e,t,s){"use strict";s.d(t,{$p:function(){return i},Ge:function(){return o},K$:function(){return a},NK:function(){return d},c9:function(){return n},gf:function(){return l},n$:function(){return c},oU:function(){return r},yh:function(){return u}});let a={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"};a.BIM,a.ME,a.SN,a.SITE_ADMIN,a.ADMIN,a.PM,a.PE,a.OE;let r=[a.SITE_ADMIN,a.ADMIN_SITE_2,a.OE,a.PE,a.ADMIN],l=[a.CM,a.ADMIN,a.SITE_ADMIN,a.PM,a.PE,a.OE];a.PM,a.ADMIN,a.SE,a.FM;let n=[a.PE,a.OE,a.ADMIN],i=[a.PM,a.ADMIN];a.PD,a.SE,a.FM;let c={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},o={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},d={[c.PENDING_REVIEW]:"รอตรวจสอบ",[c.PENDING_CM_APPROVAL]:"รออนุมัติ (CM/Approver)",[c.REVISION_REQUIRED]:"แก้ไข",[c.APPROVED]:"อนุมัติ",[c.APPROVED_WITH_COMMENTS]:"อนุมัติตามคอมเมนต์ (ไม่แก้ไข)",[c.APPROVED_REVISION_REQUIRED]:"อนุมัติตามคอมเมนต์ (ต้องแก้ไข)",[c.REJECTED]:"ไม่อนุมัติ",[c.PENDING_FINAL_APPROVAL]:"รอ SITE อนุมัติขั้นสุดท้าย",[o.DRAFT]:"รออนุมัติ (PM)",[o.REJECTED_BY_PM]:"ไม่อนุมัติ (PM)",[o.PENDING_BIM]:"รอ BIM รับงาน",[o.IN_PROGRESS]:"BIM กำลังดำเนินการ",[o.PENDING_ACCEPTANCE]:"รอตรวจรับ (Site)",[o.REVISION_REQUESTED]:"ขอแก้ไข (WR)",[o.COMPLETED]:"เสร็จสิ้น"},u={[c.PENDING_REVIEW]:"#0088FE",[c.PENDING_CM_APPROVAL]:"#00C49F",[c.REVISION_REQUIRED]:"#FFBB28",[c.APPROVED]:"#28A745",[c.REJECTED]:"#DC3545",[c.APPROVED_WITH_COMMENTS]:"#2f3e3aff",[c.APPROVED_REVISION_REQUIRED]:"#FD7E14",[o.DRAFT]:"#6c757d",[o.REJECTED_BY_PM]:"#DC3545",[o.PENDING_BIM]:"#0088FE",[o.IN_PROGRESS]:"#FFBB28",[o.PENDING_ACCEPTANCE]:"#AF19FF",[o.REVISION_REQUESTED]:"#FD7E14",[o.COMPLETED]:"#28A745"}}},function(e){e.O(0,[609,15,134,649,933,971,997,744],function(){return e(e.s=5750)}),_N_E=e.O()}]);