(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[571],{1417:function(e,s,t){Promise.resolve().then(t.bind(t,49025))},49025:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return ne}});var a=t(57437),r=t(2265),l=t(99376),n=t(47649),i=t(20731),c=t(20265),o=t(15051),d=t(48736),m=t(60044),x=t(62720),u=t(92369),h=t(31047),p=t(91723),f=t(453),g=t(99761);const N=[f.n$.PENDING_REVIEW,f.n$.PENDING_CM_APPROVAL,f.n$.PENDING_FINAL_APPROVAL,f.n$.REVISION_REQUIRED,f.n$.APPROVED_REVISION_REQUIRED,f.n$.REJECTED],b=e=>{if(!e)return null;if("function"===typeof e.toDate)return e.toDate();if(e._seconds)return new Date(1e3*e._seconds);const s=new Date(e);return isNaN(s.getTime())?null:s};function j(e){let{documents:s,isLoading:t,onDocumentClick:l,getStatusColor:n,statusLabels:i,getRFATypeColor:j}=e;const[y,v]=(0,r.useState)(!1),[w,E]=(0,r.useState)({key:"updatedAt",direction:"descending"});(0,r.useEffect)((()=>{const e=()=>v(window.innerWidth<=768);return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)}),[]);const R=e=>{switch(e.status){case f.n$.PENDING_REVIEW:case f.n$.PENDING_FINAL_APPROVAL:return{name:"Site",role:"Site"};case f.n$.PENDING_CM_APPROVAL:return{name:"CM",role:"CM"};case f.n$.REVISION_REQUIRED:case f.n$.APPROVED_REVISION_REQUIRED:var s,t;return{name:(null===(s=e.createdByInfo)||void 0===s?void 0:s.role)||"Creator",role:(null===(t=e.createdByInfo)||void 0===t?void 0:t.role)||"Creator"};case f.n$.REJECTED:var a,r;return e.isLatest?{name:(null===(a=e.createdByInfo)||void 0===a?void 0:a.role)||"Creator",role:(null===(r=e.createdByInfo)||void 0===r?void 0:r.role)||"Creator"}:{name:"\u0e40\u0e2a\u0e23\u0e47\u0e08\u0e2a\u0e34\u0e49\u0e19",role:"Completed"};case f.n$.APPROVED:case f.n$.APPROVED_WITH_COMMENTS:return{name:"\u0e40\u0e2a\u0e23\u0e47\u0e08\u0e2a\u0e34\u0e49\u0e19",role:"Completed"};default:return{name:"N/A",role:"N/A"}}},A=e=>{const s=b(e.updatedAt);if(!s)return 0;const t=new Date;t.setHours(0,0,0,0);const a=new Date(s);a.setHours(0,0,0,0);const r=t.getTime()-a.getTime(),l=Math.floor(r/864e5);return Math.max(0,l)},I=(0,r.useMemo)((()=>{let e=[...s];return null!==w&&e.sort(((e,s)=>{const t=(e,s)=>s.split(".").reduce(((e,s)=>e?e[s]:void 0),e);let a,r;if("pendingDays"===w.key){const t=N.includes(e.status),l=N.includes(s.status);a=t?A(e):-1,r=l?A(s):-1}else if("responsibleParty"===w.key)a=R(e).name,r=R(s).name;else if("updatedAt"===w.key){var l,n;a=(null===(l=b(e.updatedAt))||void 0===l?void 0:l.getTime())||0,r=(null===(n=b(s.updatedAt))||void 0===n?void 0:n.getTime())||0}else a=t(e,w.key),r=t(s,w.key);return a<r?"ascending"===w.direction?-1:1:a>r?"ascending"===w.direction?1:-1:0})),e}),[s,w]),C=e=>{let s="ascending";w&&w.key===e&&"ascending"===w.direction&&(s="descending"),E({key:e,direction:s})},k=e=>{let{columnKey:s}=e;return w&&w.key===s?(0,a.jsx)("span",{className:"ml-2",children:"ascending"===w.direction?(0,a.jsx)(c.Z,{size:14}):(0,a.jsx)(o.Z,{size:14})}):(0,a.jsx)("span",{className:"w-4 h-4 ml-2"})};if(t)return(0,a.jsx)("div",{className:"w-full h-96 flex justify-center items-center bg-white rounded-lg shadow",children:(0,a.jsx)(g.Z,{})});if(!I||0===I.length)return(0,a.jsxs)("div",{className:"w-full h-96 flex flex-col justify-center items-center bg-white rounded-lg shadow text-center",children:[(0,a.jsx)(d.Z,{className:"w-16 h-16 text-gray-300 mb-4"}),(0,a.jsx)("h3",{className:"text-xl font-semibold text-gray-700",children:"\u0e44\u0e21\u0e48\u0e1e\u0e1a\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23"}),(0,a.jsx)("p",{className:"text-gray-500 mt-1",children:"\u0e25\u0e2d\u0e07\u0e40\u0e1b\u0e25\u0e35\u0e48\u0e22\u0e19\u0e15\u0e31\u0e27\u0e01\u0e23\u0e2d\u0e07\u0e2b\u0e23\u0e37\u0e2d\u0e2a\u0e23\u0e49\u0e32\u0e07\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e43\u0e2b\u0e21\u0e48"})]});const T=e=>{const s=b(e);return s?s.toLocaleDateString("th-TH",{day:"2-digit",month:"2-digit",year:"numeric"}):"Invalid Date"};return y?(0,a.jsx)("div",{className:"space-y-4",children:s.map((e=>{var s,t;const r=R(e),c=A(e);return(0,a.jsxs)("div",{onClick:()=>l(e),className:"bg-white rounded-lg shadow border p-4 cursor-pointer",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2 mb-1",children:[(0,a.jsx)("span",{className:"inline-flex px-2 py-1 rounded-full text-xs font-medium ".concat(j(e.rfaType)),children:e.rfaType}),(0,a.jsxs)("span",{className:"inline-flex items-center px-2 py-1 bg-gray-200 text-gray-800 rounded-full text-xs font-semibold",children:["REV-",String(e.revisionNumber).padStart(2,"0")]})]}),(0,a.jsx)("h3",{className:"font-medium text-gray-900 text-sm mb-1 truncate",children:e.documentNumber}),(0,a.jsx)("p",{className:"text-sm text-gray-600 line-clamp-2",children:e.title})]}),(0,a.jsx)("div",{className:"flex flex-col items-end space-y-1 flex-shrink-0 ml-2",children:(0,a.jsx)("span",{className:"inline-flex items-center justify-center px-2 py-1 rounded-full text-xs font-medium ".concat(n(e.status)),children:i[e.status]||e.status})})]}),(0,a.jsxs)("div",{className:"space-y-2 text-xs text-gray-600",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)(m.Z,{className:"w-3 h-3 mr-2"}),(0,a.jsx)("span",{children:(null===(s=e.site)||void 0===s?void 0:s.name)||"N/A"})]}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)(x.Z,{className:"w-3 h-3 mr-2"}),(0,a.jsx)("span",{children:(null===(t=e.category)||void 0===t?void 0:t.categoryCode)||"N/A"})]}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)(u.Z,{className:"w-3 h-3 mr-2"}),(0,a.jsxs)("span",{children:["\u0e1c\u0e39\u0e49\u0e23\u0e31\u0e1a\u0e1c\u0e34\u0e14\u0e0a\u0e2d\u0e1a: ",r.name]})]}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)(h.Z,{className:"w-3 h-3 mr-2"}),(0,a.jsxs)("span",{children:["\u0e2d\u0e31\u0e1b\u0e40\u0e14\u0e15: ",T(e.updatedAt)]})]}),N.includes(e.status)&&c>0&&(0,a.jsxs)("div",{className:"flex items-center text-orange-600",children:[(0,a.jsx)(p.Z,{className:"w-3 h-3 mr-2"}),(0,a.jsxs)("span",{children:["\u0e04\u0e49\u0e32\u0e07\u0e14\u0e33\u0e40\u0e19\u0e34\u0e19\u0e01\u0e32\u0e23: ",c," \u0e27\u0e31\u0e19"]})]})]})]},e.id)}))}):(0,a.jsx)("div",{className:"sticky top-16 bg-white rounded-lg shadow overflow-hidden h-[calc(100vh-12rem)] flex flex-col",children:(0,a.jsx)("div",{className:"overflow-auto flex-1",children:(0,a.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,a.jsx)("thead",{className:"bg-gray-50 sticky top-0 z-10",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:(0,a.jsxs)("button",{onClick:()=>C("runningNumber"),className:"flex items-center justify-center w-full",children:["System No. ",(0,a.jsx)(k,{columnKey:"runningNumber"})]})}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:(0,a.jsxs)("button",{onClick:()=>C("site.name"),className:"flex items-center w-full",children:["\u0e42\u0e04\u0e23\u0e07\u0e01\u0e32\u0e23 ",(0,a.jsx)(k,{columnKey:"site.name"})]})}),(0,a.jsx)("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:(0,a.jsxs)("button",{onClick:()=>C("category.categoryCode"),className:"flex items-center justify-center w-full",children:["\u0e2b\u0e21\u0e27\u0e14\u0e2b\u0e21\u0e39\u0e48 ",(0,a.jsx)(k,{columnKey:"category.categoryCode"})]})}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23"}),(0,a.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Rev."}),(0,a.jsx)("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50",children:(0,a.jsxs)("button",{onClick:()=>C("pendingDays"),className:"flex items-center justify-center w-full",children:["\u0e2a\u0e16\u0e32\u0e19\u0e30 ",(0,a.jsx)(k,{columnKey:"pendingDays"})]})}),(0,a.jsx)("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:(0,a.jsxs)("button",{onClick:()=>C("responsibleParty"),className:"flex items-center justify-center w-full",children:["\u0e1c\u0e39\u0e49\u0e23\u0e31\u0e1a\u0e1c\u0e34\u0e14\u0e0a\u0e2d\u0e1a ",(0,a.jsx)(k,{columnKey:"responsibleParty"})]})}),(0,a.jsx)("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:(0,a.jsxs)("button",{onClick:()=>C("updatedAt"),className:"flex items-center justify-center w-full",children:["\u0e27\u0e31\u0e19\u0e17\u0e35\u0e48\u0e2d\u0e31\u0e1b\u0e40\u0e14\u0e15\u0e25\u0e48\u0e32\u0e2a\u0e38\u0e14 ",(0,a.jsx)(k,{columnKey:"updatedAt"})]})})]})}),(0,a.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:I.map((e=>{var s,t;const r=R(e),c=A(e);return(0,a.jsxs)("tr",{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>l(e),children:[(0,a.jsx)("td",{className:"px-6 py-4",children:(0,a.jsx)("p",{className:"text-sm font-semibold text-blue-600 text-center",children:e.runningNumber||"N/A"})}),(0,a.jsx)("td",{className:"px-6 py-4",children:(0,a.jsx)("p",{className:"text-sm text-gray-800",children:(null===(s=e.site)||void 0===s?void 0:s.name)||"N/A"})}),(0,a.jsx)("td",{className:"px-6 py-4",children:(0,a.jsx)("div",{className:"text-sm",children:(0,a.jsx)("p",{className:"text-gray-600 text-center",children:(null===(t=e.category)||void 0===t?void 0:t.categoryCode)||"N/A"})})}),(0,a.jsx)("td",{className:"px-6 py-4",children:(0,a.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.documentNumber}),(0,a.jsx)("p",{className:"text-sm text-gray-600 line-clamp-2",children:e.title})]})}),(0,a.jsx)("td",{className:"px-4 py-4 text-center",children:(0,a.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-gray-200 text-gray-800",children:String(e.revisionNumber).padStart(2,"0")})}),(0,a.jsx)("td",{className:"px-6 py-4",children:(0,a.jsxs)("div",{className:"flex flex-col space-y-1 items-center",children:[(0,a.jsx)("span",{className:"inline-flex items-center justify-center px-2 py-1 rounded-full text-xs font-medium ".concat(n(e.status)),children:i[e.status]||e.status}),N.includes(e.status)&&c>0&&(0,a.jsx)("span",{className:"text-xs text-orange-600 text-center",children:"\u0e04\u0e49\u0e32\u0e07 ".concat(c," \u0e27\u0e31\u0e19")})]})}),(0,a.jsx)("td",{className:"px-6 py-4 text-center",children:(0,a.jsxs)("div",{className:"flex items-center justify-center",children:[(0,a.jsx)(u.Z,{className:"w-4 h-4 text-gray-400 mr-2"}),(0,a.jsx)("div",{className:"text-sm",children:(0,a.jsx)("p",{className:"text-gray-900",children:r.name})})]})}),(0,a.jsx)("td",{className:"px-6 py-4",children:(0,a.jsx)("div",{className:"text-sm text-gray-600 text-center",children:(0,a.jsx)("span",{children:T(e.updatedAt)})})})]},e.id)}))})]})})})}var y=t(81211),v=t(62663),w=t(33862),E=t(20407),R=t(78155),A=t(53250);const I=e=>{let{active:s,payload:t}=e;if(s&&t&&t.length){const e=t[0];return(0,a.jsx)("div",{className:"p-3 bg-white/90 backdrop-blur-sm shadow-lg rounded-lg border border-gray-200 z-50",children:(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("div",{style:{width:12,height:12,backgroundColor:e.payload.color,marginRight:8,borderRadius:"50%"}}),(0,a.jsx)("p",{className:"text-sm text-gray-700 font-medium",children:"".concat(e.name,": ").concat(e.value)})]})})}return null},C=["#0088FE","#00C49F","#FFBB28","#FF8042","#AF19FF","#FF6363","#BC5090","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40","#8AC926","#1982C4","#6A4C93","#F15BB5","#FEE440","#00B4D8","#90BE6D","#F94144"],k={SITE:"#3B82F6",CM:"#8B5CF6",BIM:"#F59E0B",APPROVED:"#10B981",REJECTED:"#EF4444"};var T=e=>{let{allDocuments:s,onChartFilter:t,activeFilters:l,categories:n}=e;const[i,c]=(0,r.useState)(!1);(0,r.useEffect)((()=>{const e=()=>c(window.innerWidth<1280);return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)}),[]);const o=(0,r.useMemo)((()=>{const e={},t={};for(const r of s){var a;e[r.status]=(e[r.status]||0)+1;const s=(null===(a=r.category)||void 0===a?void 0:a.id)||"N/A";"N/A"!==s&&(t[s]=(t[s]||0)+1)}return{statusCounts:e,categoryCounts:t}}),[s]),d=(0,r.useMemo)((()=>{if(!o)return[];const e={PENDING_REVIEW:"SITE",PENDING_FINAL_APPROVAL:"SITE",PENDING_CM_APPROVAL:"CM",REVISION_REQUIRED:"BIM",APPROVED_REVISION_REQUIRED:"BIM",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED",REJECTED:"REJECTED"};return Object.entries(o.statusCounts).map((s=>{let[t,a]=s;const r=f.NK[t];return r?{name:r,value:a,statusKey:t,color:k[e[t]||"SITE"]||"#999"}:null})).filter((e=>null!==e&&e.value>0))}),[o]),m=(0,r.useMemo)((()=>{if(!o)return[];return Object.entries(o.categoryCounts).sort(((e,s)=>s[1]-e[1])).map(((e,s)=>{let[t,a]=e;const r=n.find((e=>e.id===t));return{id:t,name:(null===r||void 0===r?void 0:r.categoryCode)||t,value:a,color:C[s%C.length]}})).filter((e=>e.value>0))}),[o,n]),{displayData:x,total:u}=(0,r.useMemo)((()=>{const e=d.reduce(((e,s)=>e+s.value),0);return{displayData:d,total:e}}),[d]),{displayData:h,total:p}=(0,r.useMemo)((()=>{const e=m.reduce(((e,s)=>e+s.value),0);return{displayData:m,total:e}}),[m]);if(0===s.length)return(0,a.jsx)("div",{className:"text-center p-8 text-gray-500 bg-white rounded-lg shadow border border-gray-100",children:"\u0e44\u0e21\u0e48\u0e21\u0e35\u0e02\u0e49\u0e2d\u0e21\u0e39\u0e25\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23"});const g=e=>{var s;const a=(null===(s=e.payload)||void 0===s?void 0:s.statusKey)||e.statusKey;a&&t("status",l.status===a?"ALL":a)},N=e=>{var s;const a=(null===(s=e.payload)||void 0===s?void 0:s.id)||e.id;a&&t("categoryId",l.categoryId===a?"ALL":a)},b=i?80:100,j=i?110:135;return(0,a.jsxs)("div",{className:"relative grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8",children:[(0,a.jsx)("div",{children:(0,a.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow h-full border border-gray-100",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-800 mb-4 text-center",children:"\u0e2a\u0e16\u0e32\u0e19\u0e30\u0e15\u0e32\u0e21\u0e1c\u0e39\u0e49\u0e23\u0e31\u0e1a\u0e1c\u0e34\u0e14\u0e0a\u0e2d\u0e1a"}),(0,a.jsxs)("div",{className:"relative w-full h-[380px]",children:[(0,a.jsx)(y.h,{children:(0,a.jsxs)(v.u,{children:[(0,a.jsx)(w.b,{data:x,isAnimationActive:!1,cx:"50%",cy:"50%",innerRadius:b,outerRadius:j,dataKey:"value",nameKey:"name",onClick:g,className:"cursor-pointer",paddingAngle:2,children:x.map((e=>(0,a.jsx)(E.b,{fill:e.color,stroke:"none",style:{opacity:"ALL"===l.status||l.status===e.statusKey?1:.3}},"cell-".concat(e.name))))}),(0,a.jsx)(R.u,{content:(0,a.jsx)(I,{})}),(0,a.jsx)(A.D,{iconType:"circle",onClick:g,layout:"horizontal",verticalAlign:"bottom",align:"center",wrapperStyle:{paddingTop:"20px",fontSize:"13px"},className:"cursor-pointer"})]})}),(0,a.jsxs)("div",{className:"absolute flex flex-col items-center justify-center pointer-events-none",style:{top:"50%",left:"50%",transform:"translate(-50%, -60%)"},children:[(0,a.jsx)("span",{className:"text-xs text-gray-400 font-medium uppercase tracking-wider",children:"TOTAL"}),(0,a.jsx)("span",{className:"text-3xl font-bold text-gray-800",children:u})]})]})]})}),(0,a.jsx)("div",{children:(0,a.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow h-full border border-gray-100",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-800 mb-4 text-center",children:"\u0e2a\u0e16\u0e32\u0e19\u0e30\u0e15\u0e32\u0e21\u0e2b\u0e21\u0e27\u0e14\u0e2b\u0e21\u0e39\u0e48"}),(0,a.jsxs)("div",{className:"relative w-full h-[380px]",children:[(0,a.jsx)(y.h,{children:(0,a.jsxs)(v.u,{children:[(0,a.jsx)(w.b,{data:h,isAnimationActive:!1,cx:"50%",cy:"50%",innerRadius:b,outerRadius:j,dataKey:"value",nameKey:"name",onClick:N,className:"cursor-pointer",paddingAngle:2,children:h.map((e=>(0,a.jsx)(E.b,{fill:e.color,stroke:"none",style:{opacity:"ALL"===l.categoryId||l.categoryId===e.id?1:.3}},"cell-".concat(e.name))))}),(0,a.jsx)(R.u,{content:(0,a.jsx)(I,{})}),(0,a.jsx)(A.D,{iconType:"circle",onClick:N,layout:"horizontal",verticalAlign:"bottom",align:"center",wrapperStyle:{paddingTop:"20px",fontSize:"13px"},className:"cursor-pointer"})]})}),(0,a.jsxs)("div",{className:"absolute flex flex-col items-center justify-center pointer-events-none",style:{top:"50%",left:"50%",transform:"translate(-50%, -60%)"},children:[(0,a.jsx)("span",{className:"text-xs text-gray-400 font-medium uppercase tracking-wider",children:"TOTAL"}),(0,a.jsx)("span",{className:"text-3xl font-bold text-gray-800",children:p})]})]})]})})]})},S=t(3900),P=t(43044),_=t(82431),D=t(99397),F=t(5978),M=t(6855),O=t(65621),$=t(32489),L=t(76980),K=t(76865),V=t(17689),Z=t(30401),B=t(2207),z=t(44743),W=t(37157),U=t(53417),G=t(31810),Q=t(57576),H=t(54001);const J=e=>{if(0===e)return"0 B";const s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(1))+" "+["B","KB","MB","GB"][s]},Y=e=>{let{workflow:s,onClose:t,userRole:l}=e;const n=(0,r.useMemo)((()=>{if(l&&f.gf.includes(l)){const e=[f.n$.PENDING_REVIEW,f.n$.REVISION_REQUIRED];return s.filter((s=>!e.includes(s.status)))}return s}),[s,l]);return(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center p-4 border-b",children:[(0,a.jsxs)("h3",{className:"text-lg font-bold text-gray-800 flex items-center",children:[(0,a.jsx)(O.Z,{size:20,className:"mr-2"}),"\u0e1b\u0e23\u0e30\u0e27\u0e31\u0e15\u0e34\u0e01\u0e32\u0e23\u0e14\u0e33\u0e40\u0e19\u0e34\u0e19\u0e07\u0e32\u0e19"]}),(0,a.jsx)("button",{onClick:t,className:"text-gray-400 hover:text-gray-600",children:(0,a.jsx)($.Z,{size:24})})]}),(0,a.jsx)("div",{className:"p-6 overflow-y-auto",children:(0,a.jsx)("div",{className:"border-l-2 border-gray-200 ml-2",children:n.length>0?n.map(((e,s)=>{return(0,a.jsxs)("div",{className:"relative pl-6 pb-8 last:pb-0",children:[(0,a.jsx)("div",{className:"absolute -left-[9px] top-1 w-4 h-4 bg-blue-500 rounded-full border-2 border-white"}),(0,a.jsx)("p",{className:"font-semibold text-gray-800",children:f.NK[e.status]||e.status}),(0,a.jsxs)("p",{className:"text-sm text-gray-600",children:["\u0e42\u0e14\u0e22: ",e.userName," (",e.role,")"]}),(0,a.jsx)("time",{className:"text-xs text-gray-400",children:(t=e.timestamp,t?new Date(t).toLocaleString("th-TH",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A")}),e.comments&&(0,a.jsx)("div",{className:"mt-2 p-2 bg-gray-50 rounded-md text-xs italic",children:(0,a.jsxs)("p",{className:"text-gray-600",children:['"',e.comments,'"']})}),e.files&&e.files.length>0&&(0,a.jsxs)("div",{className:"mt-2 pl-2 border-l-2 border-gray-100",children:[(0,a.jsx)("p",{className:"text-xs font-semibold text-gray-500 mb-1",children:"\u0e44\u0e1f\u0e25\u0e4c\u0e41\u0e19\u0e1a \u0e13 \u0e02\u0e31\u0e49\u0e19\u0e15\u0e2d\u0e19\u0e19\u0e35\u0e49:"}),(0,a.jsx)("ul",{className:"space-y-1",children:e.files.map(((e,s)=>(0,a.jsxs)("li",{className:"flex items-center text-xs text-gray-600",children:[(0,a.jsx)(d.Z,{size:12,className:"mr-2 flex-shrink-0"}),(0,a.jsx)("a",{href:e.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"truncate hover:underline",title:e.fileName,children:e.fileName})]},s)))})]})]},s);var t})):(0,a.jsx)("p",{className:"text-sm text-gray-500 pl-6",children:"\u0e44\u0e21\u0e48\u0e21\u0e35\u0e1b\u0e23\u0e30\u0e27\u0e31\u0e15\u0e34"})})})]})})};function q(e){let{document:s,onClose:t,onUpdate:l,showOverlay:i=!0}=e;var c;const{user:o,firebaseUser:m}=(0,n.a)(),{showNotification:x}=(0,H.l)(),[u,h]=(0,r.useState)(s),[p,N]=(0,r.useState)(!0),[b,j]=(0,r.useState)(!1),[y,v]=(0,r.useState)(!1),[w,E]=(0,r.useState)(""),[R,A]=(0,r.useState)([]),[I,C]=(0,r.useState)(""),[k,T]=(0,r.useState)([]),[S,P]=(0,r.useState)(null),[_,D]=(0,r.useState)(!1),[F,M]=(0,r.useState)(!1),[q,X]=(0,r.useState)(null),[ee,se]=(0,r.useState)(null),[te,ae]=(0,r.useState)("");(0,r.useEffect)((()=>{(async()=>{if(s&&m){N(!0);try{const e=await m.getIdToken(),t=await fetch("/api/rfa/".concat(s.id),{headers:{Authorization:"Bearer ".concat(e)}}),a=await t.json();a.success?h(a.document):h(s)}catch(e){h(s)}finally{N(!1)}}else N(!1)})()}),[s,m]);const re=(0,r.useMemo)((()=>{if(!u)return[];if(!u.workflow||0===u.workflow.length)return u.files||[];const e=[...u.workflow].reverse().find((e=>e.files&&e.files.length>0));return(null===e||void 0===e?void 0:e.files)||u.files||[]}),[u]),le=(0,r.useMemo)((()=>(null===u||void 0===u?void 0:u.workflow)&&0!==u.workflow.length?[...u.workflow].reverse().find((e=>e.comments&&""!==e.comments.trim())):null),[null===u||void 0===u?void 0:u.workflow]),ne=(null===u||void 0===u?void 0:u.createdBy)===(null===o||void 0===o?void 0:o.id),ie=(null===u||void 0===u?void 0:u.status)===f.n$.REJECTED&&ne&&(null===u||void 0===u?void 0:u.isLatest),ce=(0,r.useMemo)((()=>{if(!u||!o)return!1;const{status:e}=u,s=u.permissions||{},t=o.role,a=f.oU.includes(t)&&e===f.n$.PENDING_REVIEW,r=s.canApprove,l=e===f.n$.REVISION_REQUIRED&&u.createdBy===o.id,n=e===f.n$.REJECTED&&u.createdBy===o.id&&u.isLatest;return e!==f.n$.APPROVED&&e!==f.n$.APPROVED_WITH_COMMENTS&&(!!a||(!!r||(!!l||!!n)))}),[u,o]);if((0,r.useEffect)((()=>{if(ie&&"BIM"===(null===u||void 0===u?void 0:u.creatorRole)&&m&&u){const e=async()=>{var e,s;if((null===(e=u.site)||void 0===e?void 0:e.name)&&u.documentNumber&&(null===(s=u.taskData)||void 0===s?void 0:s.taskName)){D(!0),M(!1),X(null),se(null);try{const e=await m.getIdToken(),s=(u.revisionNumber||0)+1,t=await fetch("/api/bim-tracking/verify-task",{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},body:JSON.stringify({documentNumber:u.documentNumber.split("-REV")[0],projectName:u.site.name,rev:s,taskName:u.taskData.taskName})}),a=await t.json();if(!t.ok||!a.success)throw new Error(a.error||"\u0e44\u0e21\u0e48\u0e2a\u0e32\u0e21\u0e32\u0e23\u0e16\u0e15\u0e23\u0e27\u0e08\u0e2a\u0e2d\u0e1a Task \u0e44\u0e14\u0e49");a.exists?(M(!0),se(a.taskId)):X("\u0e01\u0e23\u0e38\u0e13\u0e32\u0e2a\u0e23\u0e49\u0e32\u0e07 Task \u0e2a\u0e33\u0e2b\u0e23\u0e31\u0e1a Revision \u0e19\u0e35\u0e49\u0e43\u0e19\u0e23\u0e30\u0e1a\u0e1a BIM Tracking \u0e01\u0e48\u0e2d\u0e19")}catch(t){X(t.message)}finally{D(!1)}}else X("\u0e02\u0e49\u0e2d\u0e21\u0e39\u0e25\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e44\u0e21\u0e48\u0e2a\u0e21\u0e1a\u0e39\u0e23\u0e13\u0e4c \u0e44\u0e21\u0e48\u0e2a\u0e32\u0e21\u0e32\u0e23\u0e16\u0e15\u0e23\u0e27\u0e08\u0e2a\u0e2d\u0e1a Task \u0e44\u0e14\u0e49")};e()}}),[ie,u,m]),p)return(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center",children:(0,a.jsx)(g.Z,{className:"h-12 w-12 text-white"})});if(!u)return null;const oe=u.permissions||{},de=u.status===f.n$.REVISION_REQUIRED&&ne,me=(u.revisionNumber||0)+1,xe="".concat(u.documentNumber.split("-REV")[0],"-REV").concat(String(me).padStart(2,"0")),ue=(null===le||void 0===le?void 0:le.comments)||u.description,he=le?"\u0e04\u0e27\u0e32\u0e21\u0e04\u0e34\u0e14\u0e40\u0e2b\u0e47\u0e19\u0e25\u0e48\u0e32\u0e2a\u0e38\u0e14":"\u0e23\u0e32\u0e22\u0e25\u0e30\u0e40\u0e2d\u0e35\u0e22\u0e14\u0e40\u0e1e\u0e34\u0e48\u0e21\u0e40\u0e15\u0e34\u0e21",{role:pe}=o||{},{status:fe}=u,ge=f.oU.includes(pe)&&fe===f.n$.PENDING_REVIEW,Ne=oe.canApprove,be=async e=>{try{if(!m)throw new Error("\u0e01\u0e23\u0e38\u0e13\u0e32\u0e25\u0e47\u0e2d\u0e01\u0e2d\u0e34\u0e19\u0e01\u0e48\u0e2d\u0e19\u0e2d\u0e31\u0e1b\u0e42\u0e2b\u0e25\u0e14\u0e44\u0e1f\u0e25\u0e4c");const s=await m.getIdToken(),t=new FormData;t.append("file",e);const a=await fetch("/api/rfa/upload-temp-file",{method:"POST",headers:{Authorization:"Bearer ".concat(s)},body:t}),r=await a.json();if(r.success)return{status:"success",progress:100,uploadedData:r.fileData};throw new Error(r.error||"\u0e2d\u0e31\u0e1b\u0e42\u0e2b\u0e25\u0e14\u0e25\u0e49\u0e21\u0e40\u0e2b\u0e25\u0e27")}catch(s){return{status:"error",error:s instanceof Error?s.message:"\u0e40\u0e01\u0e34\u0e14\u0e02\u0e49\u0e2d\u0e1c\u0e34\u0e14\u0e1e\u0e25\u0e32\u0e14"}}},je=(e,s)=>{const t=Array.from(e.target.files||[]);if(!t.length)return;const a=t.map((e=>({id:"".concat(e.name,"-").concat(Date.now()),file:e,status:"pending",progress:0}))),r="revision"===s?T:A;r((e=>[...e,...a])),a.forEach((async e=>{r((s=>s.map((s=>s.id===e.id?{...s,status:"uploading"}:s))));const s=await be(e.file);r((t=>t.map((t=>t.id===e.id?{...t,...s}:t))))})),e.target.value=""},ye=async(e,s)=>{var t;const a="revision"===s?T:A,r=("revision"===s?k:R)[e];if("success"===r.status&&(null===(t=r.uploadedData)||void 0===t?void 0:t.filePath))try{const e=await(null===m||void 0===m?void 0:m.getIdToken());await fetch("/api/rfa/delete-temp-file",{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},body:JSON.stringify({filePath:r.uploadedData.filePath})})}catch(l){console.error("Failed to delete temp file:",l)}a((s=>s.filter(((s,t)=>t!==e))))},ve=async e=>{if(["REQUEST_REVISION","SEND_TO_CM","SUBMIT_REVISION"].includes(e)&&0===R.filter((e=>"success"===e.status)).length)alert("\u0e01\u0e23\u0e38\u0e13\u0e32\u0e41\u0e19\u0e1a\u0e44\u0e1f\u0e25\u0e4c\u0e1b\u0e23\u0e30\u0e01\u0e2d\u0e1a\u0e01\u0e32\u0e23\u0e14\u0e33\u0e40\u0e19\u0e34\u0e19\u0e01\u0e32\u0e23");else{j(!0);try{const s=await(null===m||void 0===m?void 0:m.getIdToken()),a={action:e,comments:w,newFiles:R.filter((e=>"success"===e.status)).map((e=>e.uploadedData))};Re&&te.trim()&&(a.documentNumber=te.trim());const r=await fetch("/api/rfa/".concat(u.id),{method:"PUT",headers:{Authorization:"Bearer ".concat(s),"Content-Type":"application/json"},body:JSON.stringify(a)}),l=await r.json();if(!l.success)throw new Error(l.error||"\u0e40\u0e01\u0e34\u0e14\u0e02\u0e49\u0e2d\u0e1c\u0e34\u0e14\u0e1e\u0e25\u0e32\u0e14");x("success","\u0e14\u0e33\u0e40\u0e19\u0e34\u0e19\u0e01\u0e32\u0e23\u0e2a\u0e33\u0e40\u0e23\u0e47\u0e08!",l.message),t()}catch(s){const e=s instanceof Error?s.message:"Unknown error";x("error","\u0e40\u0e01\u0e34\u0e14\u0e02\u0e49\u0e2d\u0e1c\u0e34\u0e14\u0e1e\u0e25\u0e32\u0e14",e)}finally{j(!1)}}},we=i?"bg-black bg-opacity-50":"",Ee=b||0===R.filter((e=>"success"===e.status)).length,Re=ge&&!u.documentNumber;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 ".concat(we),children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start p-4 border-b",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-baseline space-x-3",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-blue-600",children:u.documentNumber}),(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-800",children:u.title})]}),(0,a.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:u.runningNumber||"RFA Document"})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsxs)("button",{onClick:()=>v(!0),className:"flex items-center text-sm text-gray-500 hover:text-blue-600",children:[(0,a.jsx)(O.Z,{size:16,className:"mr-1"})," \u0e14\u0e39\u0e1b\u0e23\u0e30\u0e27\u0e31\u0e15\u0e34"]}),(0,a.jsx)("button",{onClick:t,className:"text-gray-400 hover:text-gray-600",children:(0,a.jsx)($.Z,{size:24})})]})]}),(0,a.jsxs)("div",{className:"p-6 overflow-y-auto space-y-6",children:[(0,a.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[" ",(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{className:"text-gray-700 font-semibold block mb-1",children:"\u0e2a\u0e16\u0e32\u0e19\u0e30:"}),(0,a.jsx)("span",{className:"px-3 py-1 text-xs font-bold text-white rounded-full shadow-sm",style:{backgroundColor:f.yh[u.status]||"#6c757d"},children:f.NK[u.status]||u.status})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{className:"text-gray-700 font-semibold block",children:"\u0e2b\u0e21\u0e27\u0e14\u0e07\u0e32\u0e19:"}),(0,a.jsx)("span",{className:"text-gray-900 font-medium",children:u.category.categoryCode})," "]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{className:"text-gray-700 font-semibold block",children:"\u0e42\u0e04\u0e23\u0e07\u0e01\u0e32\u0e23:"}),(0,a.jsx)("span",{className:"text-gray-900 font-medium",children:(null===(c=u.site)||void 0===c?void 0:c.name)||"N/A"})]})]}),ue&&""!==ue.trim()&&(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsxs)("strong",{className:"text-gray-700 font-semibold block text-sm",children:[he,":"]}),(0,a.jsx)("div",{className:"text-gray-900 whitespace-pre-wrap bg-white p-3 rounded-md mt-1 border border-gray-300 shadow-sm",children:(0,a.jsxs)("p",{className:"",children:['"',ue,'"']})})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("h4",{className:"text-md font-semibold mb-2 flex items-center text-slate-800",children:[(0,a.jsx)(L.Z,{size:16,className:"mr-2"})," \u0e44\u0e1f\u0e25\u0e4c\u0e41\u0e19\u0e1a (\u0e09\u0e1a\u0e31\u0e1a\u0e25\u0e48\u0e32\u0e2a\u0e38\u0e14)"]}),(0,a.jsx)("ul",{className:"space-y-2",children:re.length>0?re.map(((e,s)=>{const t="application/pdf"===e.contentType||e.fileName.toLowerCase().endsWith(".pdf"),r=()=>(0,a.jsxs)("div",{className:"flex items-center min-w-0",children:[(0,a.jsx)(d.Z,{className:"w-5 h-5 text-gray-500 mr-3 flex-shrink-0"}),(0,a.jsxs)("div",{className:"flex flex-col min-w-0",children:[(0,a.jsx)("span",{className:"text-sm font-medium text-blue-600 group-hover:text-blue-800 group-hover:underline truncate",children:e.fileName}),(0,a.jsx)("span",{className:"text-xs text-gray-500",children:J(e.fileSize)})]})]});return(0,a.jsx)("li",{className:"bg-slate-50 border border-slate-200 rounded-md",children:t?(0,a.jsx)("button",{onClick:()=>P(e),className:"w-full text-left p-2 rounded-md hover:bg-blue-100 group transition-colors duration-200",title:"\u0e14\u0e39\u0e15\u0e31\u0e27\u0e2d\u0e22\u0e48\u0e32\u0e07\u0e44\u0e1f\u0e25\u0e4c ".concat(e.fileName),children:(0,a.jsx)(r,{})}):(0,a.jsx)("a",{href:e.fileUrl,download:e.fileName,target:"_blank",rel:"noopener noreferrer",className:"w-full text-left p-2 rounded-md hover:bg-blue-100 group transition-colors duration-200 flex",title:"\u0e14\u0e32\u0e27\u0e19\u0e4c\u0e42\u0e2b\u0e25\u0e14 ".concat(e.fileName),children:(0,a.jsx)(r,{})})},s)})):(0,a.jsx)("p",{className:"text-sm text-slate-500",children:"\u0e44\u0e21\u0e48\u0e21\u0e35\u0e44\u0e1f\u0e25\u0e4c\u0e41\u0e19\u0e1a\u0e43\u0e19\u0e09\u0e1a\u0e31\u0e1a\u0e25\u0e48\u0e32\u0e2a\u0e38\u0e14"})})]})]}),(0,a.jsxs)("div",{className:"p-4 border-t bg-slate-50",children:[ge&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-slate-800",children:"\u0e14\u0e33\u0e40\u0e19\u0e34\u0e19\u0e01\u0e32\u0e23 (Site)"}),Re&&(0,a.jsxs)("div",{className:"p-4 bg-yellow-50 border-l-4 border-yellow-400",children:[(0,a.jsxs)("label",{className:"text-sm font-bold text-yellow-800 mb-2 block",children:[(0,a.jsx)(K.Z,{size:16,className:"inline mr-2"}),"\u0e01\u0e23\u0e38\u0e13\u0e32\u0e23\u0e30\u0e1a\u0e38\u0e40\u0e25\u0e02\u0e17\u0e35\u0e48\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23 (Required)"]}),(0,a.jsx)("input",{type:"text",value:te,onChange:e=>ae(e.target.value),placeholder:"\u0e01\u0e23\u0e2d\u0e01\u0e40\u0e25\u0e02\u0e17\u0e35\u0e48\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e17\u0e35\u0e48\u0e19\u0e35\u0e48...",className:"w-full p-2 border rounded-md text-sm border-yellow-300 focus:ring-yellow-500 focus:border-yellow-500 bg-white text-gray-900"}),(0,a.jsx)("p",{className:"text-xs text-yellow-700 mt-1",children:"\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e19\u0e35\u0e49\u0e22\u0e31\u0e07\u0e44\u0e21\u0e48\u0e21\u0e35\u0e40\u0e25\u0e02\u0e17\u0e35\u0e48\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23 \u0e04\u0e38\u0e13\u0e15\u0e49\u0e2d\u0e07\u0e01\u0e33\u0e2b\u0e19\u0e14\u0e01\u0e48\u0e2d\u0e19\u0e2a\u0e48\u0e07\u0e15\u0e48\u0e2d\u0e44\u0e1b\u0e22\u0e31\u0e07 CM"})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:["\u0e41\u0e19\u0e1a\u0e44\u0e1f\u0e25\u0e4c ",(0,a.jsx)("span",{className:"text-red-700",children:"*"})]}),(0,a.jsxs)("div",{className:"border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[(0,a.jsx)("input",{type:"file",multiple:!0,onChange:e=>je(e,"action"),className:"hidden",id:"action-file-upload"}),(0,a.jsxs)("label",{htmlFor:"action-file-upload",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[(0,a.jsx)(V.Z,{size:16,className:"mr-2"}),"\u0e04\u0e25\u0e34\u0e01\u0e40\u0e1e\u0e37\u0e48\u0e2d\u0e40\u0e25\u0e37\u0e2d\u0e01\u0e44\u0e1f\u0e25\u0e4c"]})]}),(0,a.jsx)("div",{className:"mt-2 space-y-2",children:R.map(((e,s)=>(0,a.jsxs)("div",{className:"flex items-center text-sm p-2 bg-slate-100 rounded",children:[(0,a.jsx)(d.Z,{className:"w-4 h-4 mr-2 text-slate-500"}),(0,a.jsx)("span",{className:"flex-1 truncate",children:e.file.name}),"uploading"===e.status&&(0,a.jsx)(g.Z,{className:"w-4 h-4 mr-2"}),"success"===e.status&&(0,a.jsx)(Z.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&(0,a.jsx)("span",{title:e.error,children:(0,a.jsx)(K.Z,{className:"w-4 h-4 text-red-500"})}),(0,a.jsx)("button",{onClick:()=>ye(s,"action"),className:"ml-2 text-gray-500 hover:text-red-600",children:(0,a.jsx)($.Z,{size:16})})]},e.id)))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"\u0e41\u0e2a\u0e14\u0e07\u0e04\u0e27\u0e32\u0e21\u0e04\u0e34\u0e14\u0e40\u0e2b\u0e47\u0e19 (Optional)"}),(0,a.jsx)("textarea",{value:w,onChange:e=>E(e.target.value),placeholder:"\u0e40\u0e1e\u0e34\u0e48\u0e21\u0e04\u0e27\u0e32\u0e21\u0e04\u0e34\u0e14\u0e40\u0e2b\u0e47\u0e19...",className:"w-full p-2 border rounded-md text-sm bg-white text-gray-900",rows:2})]}),(0,a.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[(0,a.jsxs)("button",{onClick:()=>ve("REQUEST_REVISION"),disabled:Ee||Re&&!te.trim(),className:"flex items-center px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-100 disabled:bg-slate-200 disabled:cursor-not-allowed",children:[(0,a.jsx)(B.Z,{size:16,className:"mr-2"})," \u0e02\u0e2d\u0e41\u0e01\u0e49\u0e44\u0e02"]}),(0,a.jsxs)("button",{onClick:()=>ve("SEND_TO_CM"),disabled:Ee||Re&&!te.trim(),className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed",children:[(0,a.jsx)(z.Z,{size:16,className:"mr-2"})," \u0e2a\u0e48\u0e07\u0e43\u0e2b\u0e49 CM"]})]})]}),de&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-slate-800",children:"\u0e2a\u0e48\u0e07\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e17\u0e35\u0e48\u0e41\u0e01\u0e49\u0e44\u0e02"}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:["\u0e41\u0e19\u0e1a\u0e44\u0e1f\u0e25\u0e4c\u0e17\u0e35\u0e48\u0e41\u0e01\u0e49\u0e44\u0e02\u0e41\u0e25\u0e49\u0e27 ",(0,a.jsx)("span",{className:"text-red-700",children:"*"})]}),(0,a.jsxs)("div",{className:"border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[(0,a.jsx)("input",{type:"file",multiple:!0,onChange:e=>je(e,"resubmission"),className:"hidden",id:"resubmit-file-upload"}),(0,a.jsxs)("label",{htmlFor:"resubmit-file-upload",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[(0,a.jsx)(V.Z,{size:16,className:"mr-2"}),"\u0e04\u0e25\u0e34\u0e01\u0e40\u0e1e\u0e37\u0e48\u0e2d\u0e40\u0e25\u0e37\u0e2d\u0e01\u0e44\u0e1f\u0e25\u0e4c"]})]}),(0,a.jsx)("div",{className:"mt-2 space-y-2",children:R.map(((e,s)=>(0,a.jsxs)("div",{className:"flex items-center text-sm p-2 bg-slate-100 rounded",children:[(0,a.jsx)(d.Z,{className:"w-4 h-4 mr-2 text-slate-500"}),(0,a.jsx)("span",{className:"flex-1 truncate",children:e.file.name}),"uploading"===e.status&&(0,a.jsx)(g.Z,{className:"w-4 h-4 mr-2"}),"success"===e.status&&(0,a.jsx)(Z.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&(0,a.jsx)("span",{title:e.error,children:(0,a.jsx)(K.Z,{className:"w-4 h-4 text-red-500"})}),(0,a.jsx)("button",{onClick:()=>ye(s,"resubmission"),className:"ml-2 text-gray-500 hover:text-red-600",children:(0,a.jsx)($.Z,{size:16})})]},e.id)))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"\u0e2b\u0e21\u0e32\u0e22\u0e40\u0e2b\u0e15\u0e38\u0e01\u0e32\u0e23\u0e41\u0e01\u0e49\u0e44\u0e02"}),(0,a.jsx)("textarea",{value:w,onChange:e=>E(e.target.value),placeholder:"\u0e40\u0e0a\u0e48\u0e19 \u0e41\u0e01\u0e49\u0e44\u0e02\u0e15\u0e32\u0e21 Comment \u0e08\u0e32\u0e01 CM...",className:"w-full p-2 border rounded-md text-sm bg-white text-gray-900",rows:2})]}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsxs)("button",{onClick:async()=>{await ve("SUBMIT_REVISION")},disabled:b||0===R.filter((e=>"success"===e.status)).length,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-gray-300",children:[b?(0,a.jsx)(g.Z,{className:"w-4 h-4 mr-2"}):(0,a.jsx)(z.Z,{size:16,className:"mr-2"}),"\u0e2a\u0e48\u0e07\u0e01\u0e25\u0e31\u0e1a\u0e44\u0e1b\u0e15\u0e23\u0e27\u0e08\u0e2a\u0e2d\u0e1a"]})})]}),u.status===f.n$.REJECTED&&!u.isLatest&&(0,a.jsxs)("div",{className:"p-4 bg-red-50 text-red-800 rounded-lg flex items-center",children:[(0,a.jsx)(K.Z,{size:24,className:"mr-3 flex-shrink-0 text-red-600"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"font-bold",children:"\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e09\u0e1a\u0e31\u0e1a\u0e19\u0e35\u0e49\u0e16\u0e39\u0e01\u0e41\u0e17\u0e19\u0e17\u0e35\u0e48\u0e41\u0e25\u0e49\u0e27"}),(0,a.jsxs)("p",{className:"text-sm text-red-700",children:["\u0e44\u0e14\u0e49\u0e21\u0e35\u0e01\u0e32\u0e23\u0e2a\u0e23\u0e49\u0e32\u0e07\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e09\u0e1a\u0e31\u0e1a\u0e43\u0e2b\u0e21\u0e48 ",(0,a.jsxs)("strong",{children:["(REV-",String((u.revisionNumber||0)+1).padStart(2,"0"),")"]})," \u0e08\u0e32\u0e01\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e09\u0e1a\u0e31\u0e1a\u0e19\u0e35\u0e49\u0e41\u0e25\u0e49\u0e27"]})]})]}),ie&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-slate-800 mb-4",children:"\u0e2a\u0e23\u0e49\u0e32\u0e07\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e09\u0e1a\u0e31\u0e1a\u0e41\u0e01\u0e49\u0e44\u0e02 (Create New Revision)"}),"BIM"===u.creatorRole&&(_||q)&&(0,a.jsxs)("div",{className:"mb-4 p-3 rounded-md text-sm font-medium flex items-center border bg-white",children:[_&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(g.Z,{className:"w-4 h-4 mr-3 text-gray-500"}),(0,a.jsx)("span",{className:"text-gray-600",children:"\u0e01\u0e33\u0e25\u0e31\u0e07\u0e15\u0e23\u0e27\u0e08\u0e2a\u0e2d\u0e1a Task \u0e43\u0e19\u0e23\u0e30\u0e1a\u0e1a BIM Tracking..."})]}),q&&(0,a.jsx)("span",{className:"text-red-600 font-semibold",children:q})]}),("BIM"!==u.creatorRole||F)&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e40\u0e14\u0e34\u0e21:"})," ",u.documentNumber]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e43\u0e2b\u0e21\u0e48:"})," ",xe]})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:["\u0e41\u0e19\u0e1a\u0e44\u0e1f\u0e25\u0e4c\u0e17\u0e35\u0e48\u0e41\u0e01\u0e49\u0e44\u0e02\u0e41\u0e25\u0e49\u0e27 ",(0,a.jsx)("span",{className:"text-red-700",children:"*"})]}),(0,a.jsxs)("div",{className:"border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[(0,a.jsx)("input",{type:"file",multiple:!0,onChange:e=>je(e,"revision"),className:"hidden",id:"revision-file-upload"}),(0,a.jsxs)("label",{htmlFor:"revision-file-upload",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[(0,a.jsx)(V.Z,{size:16,className:"mr-2"}),"\u0e04\u0e25\u0e34\u0e01\u0e40\u0e1e\u0e37\u0e48\u0e2d\u0e40\u0e25\u0e37\u0e2d\u0e01\u0e44\u0e1f\u0e25\u0e4c"]})]}),(0,a.jsx)("div",{className:"mt-2 space-y-2",children:k.map(((e,s)=>(0,a.jsxs)("div",{className:"flex items-center text-sm p-2 bg-slate-100 rounded",children:[(0,a.jsx)(d.Z,{className:"w-4 h-4 mr-2 text-slate-500"}),(0,a.jsx)("span",{className:"flex-1 truncate",children:e.file.name}),"uploading"===e.status&&(0,a.jsx)(g.Z,{className:"w-4 h-4 mr-2"}),"success"===e.status&&(0,a.jsx)(Z.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&(0,a.jsx)("span",{title:e.error,children:(0,a.jsx)(K.Z,{className:"w-4 h-4 text-red-500"})}),(0,a.jsx)("button",{onClick:()=>ye(s,"revision"),className:"ml-2 text-gray-500 hover:text-red-600",children:(0,a.jsx)($.Z,{size:16})})]},e.id)))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"\u0e2b\u0e21\u0e32\u0e22\u0e40\u0e2b\u0e15\u0e38\u0e01\u0e32\u0e23\u0e41\u0e01\u0e49\u0e44\u0e02 (Optional)"}),(0,a.jsx)("textarea",{value:I,onChange:e=>C(e.target.value),placeholder:"\u0e40\u0e0a\u0e48\u0e19 \u0e41\u0e01\u0e49\u0e44\u0e02\u0e15\u0e32\u0e21 Comment \u0e08\u0e32\u0e01 CM...",className:"w-full p-2 border rounded-md text-sm bg-white text-gray-900",rows:2})]}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsxs)("button",{onClick:async()=>{const e=k.filter((e=>"success"===e.status));if(0!==e.length){j(!0);try{const s=await(null===m||void 0===m?void 0:m.getIdToken()),a={originalDocId:u.id,uploadedFiles:e.map((e=>e.uploadedData)),comments:I,verifiedTaskId:ee},r=await fetch("/api/rfa/create_revision",{method:"POST",headers:{Authorization:"Bearer ".concat(s),"Content-Type":"application/json"},body:JSON.stringify(a)}),l=await r.json();if(!l.success)throw new Error(l.error||"\u0e40\u0e01\u0e34\u0e14\u0e02\u0e49\u0e2d\u0e1c\u0e34\u0e14\u0e1e\u0e25\u0e32\u0e14\u0e43\u0e19\u0e01\u0e32\u0e23\u0e2a\u0e23\u0e49\u0e32\u0e07 Revision");x("success","\u0e2a\u0e23\u0e49\u0e32\u0e07 Revision \u0e2a\u0e33\u0e40\u0e23\u0e47\u0e08!","\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e09\u0e1a\u0e31\u0e1a\u0e43\u0e2b\u0e21\u0e48 ".concat(xe," \u0e16\u0e39\u0e01\u0e2a\u0e23\u0e49\u0e32\u0e07\u0e41\u0e25\u0e49\u0e27")),t()}catch(s){const e=s instanceof Error?s.message:"Unknown error";x("error","\u0e40\u0e01\u0e34\u0e14\u0e02\u0e49\u0e2d\u0e1c\u0e34\u0e14\u0e1e\u0e25\u0e32\u0e14",e)}finally{j(!1)}}else alert("\u0e01\u0e23\u0e38\u0e13\u0e32\u0e41\u0e19\u0e1a\u0e44\u0e1f\u0e25\u0e4c\u0e09\u0e1a\u0e31\u0e1a\u0e41\u0e01\u0e49\u0e44\u0e02\u0e2d\u0e22\u0e48\u0e32\u0e07\u0e19\u0e49\u0e2d\u0e22 1 \u0e44\u0e1f\u0e25\u0e4c")},disabled:b||0===k.filter((e=>"success"===e.status)).length||"BIM"===u.creatorRole&&!F,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed",children:[b?(0,a.jsx)(g.Z,{className:"w-4 h-4 mr-2"}):(0,a.jsx)(z.Z,{size:16,className:"mr-2"}),"\u0e2a\u0e48\u0e07\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e09\u0e1a\u0e31\u0e1a\u0e41\u0e01\u0e49\u0e44\u0e02"]})})]})]}),Ne&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-slate-800",children:"\u0e01\u0e32\u0e23\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (Approval)"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"\u0e41\u0e19\u0e1a\u0e44\u0e1f\u0e25\u0e4c (Optional)"}),(0,a.jsxs)("div",{className:"border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[(0,a.jsx)("input",{type:"file",multiple:!0,onChange:e=>je(e,"action"),className:"hidden",id:"action-file-upload-final"}),(0,a.jsxs)("label",{htmlFor:"action-file-upload-final",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[(0,a.jsx)(V.Z,{size:16,className:"mr-2"}),"\u0e04\u0e25\u0e34\u0e01\u0e40\u0e1e\u0e37\u0e48\u0e2d\u0e40\u0e25\u0e37\u0e2d\u0e01\u0e44\u0e1f\u0e25\u0e4c"]})]}),(0,a.jsx)("div",{className:"mt-2 space-y-2",children:R.map(((e,s)=>(0,a.jsxs)("div",{className:"flex items-center text-sm p-2 bg-slate-100 rounded",children:[(0,a.jsx)(d.Z,{className:"w-4 h-4 mr-2 text-slate-500"}),(0,a.jsx)("span",{className:"flex-1 truncate",children:e.file.name}),"uploading"===e.status&&(0,a.jsx)(g.Z,{className:"w-4 h-4 mr-2"}),"success"===e.status&&(0,a.jsx)(Z.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&(0,a.jsx)("span",{title:e.error,children:(0,a.jsx)(K.Z,{className:"w-4 h-4 text-red-500"})}),(0,a.jsx)("button",{onClick:()=>ye(s,"action"),className:"ml-2 text-gray-500 hover:text-red-600",children:(0,a.jsx)($.Z,{size:16})})]},e.id)))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"\u0e41\u0e2a\u0e14\u0e07\u0e04\u0e27\u0e32\u0e21\u0e04\u0e34\u0e14\u0e40\u0e2b\u0e47\u0e19 (Optional)"}),(0,a.jsx)("textarea",{value:w,onChange:e=>E(e.target.value),placeholder:"\u0e40\u0e1e\u0e34\u0e48\u0e21\u0e04\u0e27\u0e32\u0e21\u0e04\u0e34\u0e14\u0e40\u0e2b\u0e47\u0e19/\u0e40\u0e2b\u0e15\u0e38\u0e1c\u0e25\u0e1b\u0e23\u0e30\u0e01\u0e2d\u0e1a...",className:"w-full p-2 border rounded-md text-sm bg-white text-gray-900",rows:2})]}),(0,a.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[(0,a.jsxs)("button",{onClick:()=>ve("REJECT"),disabled:b,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed",children:[(0,a.jsx)(W.Z,{size:16,className:"mr-2"})," \u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34"]}),(0,a.jsxs)("button",{onClick:()=>ve("APPROVE_REVISION_REQUIRED"),disabled:b,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-orange-500 rounded-lg hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed",children:[(0,a.jsx)(B.Z,{size:16,className:"mr-2"})," \u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (\u0e15\u0e49\u0e2d\u0e07\u0e41\u0e01\u0e49\u0e44\u0e02)"]}),(0,a.jsxs)("button",{onClick:()=>ve("APPROVE_WITH_COMMENTS"),disabled:b,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700 disabled:bg-gray-300 disabled:cursor-not-allowed",children:[(0,a.jsx)(U.Z,{size:16,className:"mr-2"})," \u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c)"]}),(0,a.jsxs)("button",{onClick:()=>ve("APPROVE"),disabled:b,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed",children:[(0,a.jsx)(G.Z,{size:16,className:"mr-2"})," \u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34"]})]})]})]})]})}),y&&(0,a.jsx)(Y,{workflow:u.workflow||[],onClose:()=>v(!1),userRole:null===o||void 0===o?void 0:o.role}),(0,a.jsx)(Q.Z,{isOpen:!!S,file:S,onClose:()=>P(null),allowEdit:ce,onSave:async e=>{let s="action";de?s="resubmission":ie&&(s="revision");const t="revision"===s?T:A,a={id:"edited-".concat(Date.now()),file:e,status:"uploading",progress:0};t((e=>[...e,a]));try{const s=await be(e);if("success"!==s.status||!s.uploadedData)throw new Error("Upload failed");t((e=>e.map((e=>e.id===a.id?{...e,...s}:e)))),x("success","\u0e1a\u0e31\u0e19\u0e17\u0e36\u0e01\u0e44\u0e1f\u0e25\u0e4c\u0e2a\u0e33\u0e40\u0e23\u0e47\u0e08","\u0e44\u0e1f\u0e25\u0e4c\u0e17\u0e35\u0e48\u0e41\u0e01\u0e49\u0e44\u0e02\u0e16\u0e39\u0e01\u0e41\u0e19\u0e1a\u0e40\u0e23\u0e35\u0e22\u0e1a\u0e23\u0e49\u0e2d\u0e22\u0e41\u0e25\u0e49\u0e27")}catch(r){t((e=>e.map((e=>e.id===a.id?{...e,status:"error",error:"Upload Failed"}:e)))),x("error","\u0e1a\u0e31\u0e19\u0e17\u0e36\u0e01\u0e44\u0e1f\u0e25\u0e4c\u0e25\u0e49\u0e21\u0e40\u0e2b\u0e25\u0e27","\u0e44\u0e21\u0e48\u0e2a\u0e32\u0e21\u0e32\u0e23\u0e16\u0e2d\u0e31\u0e1b\u0e42\u0e2b\u0e25\u0e14\u0e44\u0e1f\u0e25\u0e4c\u0e17\u0e35\u0e48\u0e41\u0e01\u0e49\u0e44\u0e02\u0e44\u0e14\u0e49")}}})]})}function X(e){let{documentId:s,onClose:t}=e;(0,l.useRouter)();const n=(0,l.useSearchParams)(),[i,c]=(0,r.useState)(null);return(0,r.useEffect)((()=>{if(!s)return void c(null);(async()=>{const e=(0,F.JU)(M.db,"rfaDocuments",s),a=await(0,F.QT)(e);a.exists()?c({id:a.id,...a.data()}):(alert("Error: \u0e44\u0e21\u0e48\u0e1e\u0e1a\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e17\u0e35\u0e48\u0e04\u0e38\u0e13\u0e15\u0e49\u0e2d\u0e07\u0e01\u0e32\u0e23"),t())})()}),[s,t]),(0,r.useEffect)((()=>{const e=n.toString(),a="/dashboard/rfa?".concat(e.replace(/&?docId=[^&]*/,""),"&docId=").concat(s),r=e=>{t()};return s&&(window.history.pushState({docId:s},"",a),window.addEventListener("popstate",r)),()=>{window.removeEventListener("popstate",r)}}),[s,t,n]),s?(0,a.jsx)(q,{document:i,onClose:t,onUpdate:c}):null}var ee=t(73247);const se="w-full mt-1 h-10 px-3 border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-blue-500 outline-none";var te=e=>{let{filters:s,handleFilterChange:t,searchTerm:r,setSearchTerm:l,resetFilters:n,sites:i,categories:c,availableStatuses:o,availableResponsibleParties:d}=e;return(0,a.jsx)("div",{className:"bg-white rounded-lg shadow p-4",children:(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-4 items-end",children:[(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{htmlFor:"site-filter",className:"text-sm font-medium text-gray-700",children:"\u0e42\u0e04\u0e23\u0e07\u0e01\u0e32\u0e23"}),(0,a.jsxs)("select",{id:"site-filter",value:s.siteId,onChange:e=>t("siteId",e.target.value),className:se,children:[(0,a.jsx)("option",{value:"ALL",children:"\u0e17\u0e38\u0e01\u0e42\u0e04\u0e23\u0e07\u0e01\u0e32\u0e23"}),i.map((e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id)))]})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{htmlFor:"search-filter",className:"text-sm font-medium text-gray-700",children:"\u0e04\u0e49\u0e19\u0e2b\u0e32"}),(0,a.jsxs)("div",{className:"relative mt-1",children:[(0,a.jsx)(ee.Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),(0,a.jsx)("input",{id:"search-filter",type:"text",placeholder:"\u0e40\u0e25\u0e02\u0e17\u0e35\u0e48, \u0e0a\u0e37\u0e48\u0e2d\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23...",value:r,onChange:e=>l(e.target.value),className:"w-full h-10 pl-10 pr-4 border border-gray-300 rounded-lg bg-white text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 outline-none"})]})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{htmlFor:"status-filter",className:"text-sm font-medium text-gray-700",children:"\u0e2a\u0e16\u0e32\u0e19\u0e30"}),(0,a.jsxs)("select",{id:"status-filter",value:s.status,onChange:e=>t("status",e.target.value),className:se,children:[(0,a.jsx)("option",{value:"ALL",children:"\u0e17\u0e38\u0e01\u0e2a\u0e16\u0e32\u0e19\u0e30"}),o.map((e=>(0,a.jsx)("option",{value:e,children:f.NK[e]||e},e)))]})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{htmlFor:"responsible-party-filter",className:"text-sm font-medium text-gray-700",children:"\u0e1c\u0e39\u0e49\u0e23\u0e31\u0e1a\u0e1c\u0e34\u0e14\u0e0a\u0e2d\u0e1a"}),(0,a.jsx)("select",{id:"responsible-party-filter",value:s.responsibleParty,onChange:e=>t("responsibleParty",e.target.value),className:se,children:d.map((e=>(0,a.jsx)("option",{value:e.value,children:e.label},e.value)))})]}),(0,a.jsxs)("div",{className:"md:col-span-2",children:[(0,a.jsx)("label",{htmlFor:"category-filter",className:"text-sm font-medium text-gray-700",children:"\u0e2b\u0e21\u0e27\u0e14\u0e07\u0e32\u0e19"}),(0,a.jsxs)("select",{id:"category-filter",className:se,value:s.categoryId,onChange:e=>t("categoryId",e.target.value),children:[(0,a.jsx)("option",{value:"ALL",children:"\u0e17\u0e38\u0e01\u0e2b\u0e21\u0e27\u0e14\u0e07\u0e32\u0e19"}),c.map((e=>(0,a.jsx)("option",{value:e.id,children:e.categoryCode},e.id)))]})]}),(0,a.jsxs)("div",{className:"md:col-span-1 flex items-center h-10",children:[(0,a.jsx)("input",{id:"show-all-revisions",type:"checkbox",checked:s.showAllRevisions,onChange:e=>t("showAllRevisions",e.target.checked),className:"h-4 w-4 rounded border-gray-300 text-blue-600"}),(0,a.jsx)("label",{htmlFor:"show-all-revisions",className:"ml-2 text-sm text-gray-700",children:"\u0e17\u0e38\u0e01\u0e09\u0e1a\u0e31\u0e1a"})]}),(0,a.jsx)("div",{className:"md:col-span-1",children:(0,a.jsxs)("button",{onClick:n,className:"w-full h-10 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium",children:[" ","\u0e23\u0e35\u0e40\u0e0b\u0e47\u0e15"]})})]})})},ae=t(71550);const re={"RFA-SHOP":"Shop Drawing","RFA-GEN":"General","RFA-MAT":"Material"};function le(){const{user:e,firebaseUser:s}=(0,n.a)(),t=(0,l.useRouter)(),c=(0,l.useSearchParams)(),[o,d]=(0,r.useState)([]),[m,x]=(0,r.useState)(!0),[u,h]=(0,r.useState)(null),[p,g]=(0,r.useState)(""),[N,b]=(0,r.useState)([]),[y,v]=(0,r.useState)(!1),[w,E]=(0,r.useState)([]),[R,A]=(0,r.useState)({rfaType:c.get("type")||"ALL",status:"ALL",siteId:"ALL",showAllRevisions:!1,categoryId:"ALL",responsibleParty:"ALL"});(0,r.useEffect)((()=>{const e=c.get("docId");e&&h(e)}),[c]),(0,r.useEffect)((()=>{const e=c.get("type")||"ALL";e!==R.rfaType&&C("rfaType",e)}),[c,R.rfaType]),(0,r.useEffect)((()=>{if(!(null===e||void 0===e?void 0:e.sites)||0===e.sites.length)return E([]),void b([]);const s=(0,F.IO)((0,F.hJ)(M.db,"sites"),(0,F.ar)((0,F.Jm)(),"in",e.sites)),t=(0,F.cf)(s,(e=>{const s=e.docs.map((e=>({id:e.id,...e.data()})));E(s)})),a=(0,F.IO)((0,F.B$)(M.db,"categories"),(0,F.ar)("siteId","in",e.sites)),r=(0,F.cf)(a,(e=>{const s=e.docs.map((e=>({id:e.id,...e.data()}))),t=Array.from(new Map(s.map((e=>[e.id,e]))).values());b(t)}));return()=>{t(),r()}}),[e]);const I=(0,r.useMemo)((()=>{if(!e||"ALL"===R.rfaType)return!1;let s="";if("RFA-SHOP"===R.rfaType)s="RFA.".concat(ae.S4.RFA.CREATE_SHOP);else if("RFA-GEN"===R.rfaType)s="RFA.".concat(ae.S4.RFA.CREATE_GEN);else{if("RFA-MAT"!==R.rfaType)return!1;s="RFA.".concat(ae.S4.RFA.CREATE_MAT)}const[t,a]=s.split("."),r=(ae.yB[s]||[]).includes(e.role);return w.some((s=>{var l,n,i;const c=null===(i=s.userOverrides)||void 0===i||null===(n=i[e.id])||void 0===n||null===(l=n[t])||void 0===l?void 0:l[a];return void 0!==c?!0===c:r}))}),[e,R.rfaType,w]);(0,r.useEffect)((()=>{if(!s||!(null===e||void 0===e?void 0:e.sites)||0===e.sites.length)return void x(!1);x(!0);const t=(0,F.IO)((0,F.hJ)(M.db,"rfaDocuments"),(0,F.ar)("siteId","in",e.sites),(0,F.Xo)("updatedAt","desc")),a=(0,F.cf)(t,(e=>{const s=[];e.forEach((e=>{var t,a,r,l,n;const i=e.data();s.push({id:e.id,...i,site:{id:i.siteId,name:i.siteName||"N/A"},category:{id:i.categoryId,categoryCode:(null===(t=i.taskData)||void 0===t?void 0:t.taskCategory)||i.categoryId||"N/A",categoryName:""},createdByInfo:{email:(null===(r=i.workflow)||void 0===r||null===(a=r[0])||void 0===a?void 0:a.userName)||"N/A",role:(null===(n=i.workflow)||void 0===n||null===(l=n[0])||void 0===l?void 0:l.role)||"N/A"},permissions:{}})})),d(s),x(!1)}),(e=>{console.error("Error fetching realtime documents:",e),x(!1)}));return()=>a()}),[s,e]);const C=(e,s)=>{A((t=>({...t,[e]:s})))},k=(0,r.useMemo)((()=>[{value:"ALL",label:"\u0e17\u0e38\u0e01\u0e04\u0e19"}]),[]),O=(0,r.useMemo)((()=>Object.values(f.n$)),[]),$=(0,r.useMemo)((()=>{const e=new Map(w.map((e=>[e.id,e.name])));let s=o.map((s=>({...s,site:{...s.site,name:e.get(s.site.id)||"N/A"}})));if("ALL"!==R.rfaType&&(s=s.filter((e=>e.rfaType===R.rfaType))),"ALL"!==R.status&&(s=s.filter((e=>e.status===R.status))),"ALL"!==R.siteId&&(s=s.filter((e=>e.site.id===R.siteId))),"ALL"!==R.categoryId&&(s=s.filter((e=>{var s;return(null===(s=e.category)||void 0===s?void 0:s.id)===R.categoryId}))),p.trim()){const e=p.toLowerCase();s=s.filter((s=>s.documentNumber.toLowerCase().includes(e)||s.title.toLowerCase().includes(e)))}return s}),[o,R,e,p,w]);return e?(0,a.jsx)(i.AuthGuard,{children:(0,a.jsxs)("div",{className:"max-w-screen-2xl mx-auto",children:[(0,a.jsxs)("div",{className:"mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[(0,a.jsx)("div",{children:(0,a.jsxs)("h1",{className:"text-2xl lg:text-3xl font-bold text-gray-900 flex items-center gap-3",children:[(0,a.jsx)(P.Z,{className:"text-blue-600",size:32}),"RFA Documents",R.rfaType&&"ALL"!==R.rfaType&&(0,a.jsxs)("span",{className:"text-orange-600",children:[" - ",re[R.rfaType]]})]})}),(0,a.jsxs)("div",{className:"flex items-center space-x-3 mt-4 sm:mt-0",children:[(0,a.jsxs)("button",{onClick:()=>{},className:"flex items-center px-3 py-2 bg-gray-100 text-gray-700 rounded-lg",disabled:m,children:[(0,a.jsx)(_.Z,{className:"w-4 h-4 mr-2 ".concat(m?"animate-spin":"")}),m?"Syncing...":"Real-time"]}),"ALL"!==R.rfaType&&I&&(0,a.jsxs)("button",{onClick:()=>{v(!0)},className:"flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[(0,a.jsx)(D.Z,{className:"w-4 h-4 mr-2"}),"\u0e2a\u0e23\u0e49\u0e32\u0e07 ",re[R.rfaType]]})]})]}),(0,a.jsx)(T,{allDocuments:$,onChartFilter:(e,s)=>{A((t=>({...t,[e]:s})))},activeFilters:R,categories:N}),(0,a.jsx)("div",{className:"mb-6",children:(0,a.jsx)(te,{filters:R,handleFilterChange:C,searchTerm:p,setSearchTerm:g,resetFilters:()=>{const e=R.rfaType;A({rfaType:e,status:"ALL",siteId:"ALL",showAllRevisions:!1,categoryId:"ALL",responsibleParty:"ALL"}),g("")},sites:w,categories:N,availableStatuses:O,availableResponsibleParties:k})}),(0,a.jsx)("div",{className:"mt-6",children:m?(0,a.jsx)("div",{className:"text-center p-8 h-full flex items-center justify-center bg-white rounded-lg shadow",children:"\u0e01\u0e33\u0e25\u0e31\u0e07\u0e42\u0e2b\u0e25\u0e14\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23..."}):(0,a.jsx)(j,{documents:$,isLoading:m,onDocumentClick:e=>{h(e.id)},getStatusColor:e=>{switch(e){case f.n$.PENDING_REVIEW:return"bg-blue-100 text-blue-800";case f.n$.PENDING_CM_APPROVAL:return"bg-violet-100 text-violet-800";case f.n$.REVISION_REQUIRED:case f.n$.APPROVED_REVISION_REQUIRED:return"bg-amber-100 text-amber-800";case f.n$.APPROVED:return"bg-green-100 text-green-800";case f.n$.APPROVED_WITH_COMMENTS:return"bg-emerald-100 text-emerald-800";case f.n$.REJECTED:return"bg-red-100 text-red-800";case f.n$.PENDING_FINAL_APPROVAL:return"bg-indigo-100 text-indigo-800";default:return"bg-gray-100 text-gray-800"}},statusLabels:f.NK,getRFATypeColor:e=>{switch(e){case"RFA-SHOP":return"bg-blue-50 text-blue-700 border border-blue-100";case"RFA-GEN":return"bg-green-50 text-green-700 border border-green-100";case"RFA-MAT":return"bg-orange-50 text-orange-700 border border-orange-100";default:return"bg-gray-50 text-gray-700 border border-gray-200"}}})}),y&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",children:(0,a.jsx)(S.Z,{onClose:()=>{v(!1)},isModal:!0,userProp:e?{id:e.id,email:e.email,role:e.role,sites:e.sites||[]}:void 0,presetRfaType:"ALL"!==R.rfaType?R.rfaType:void 0})}),(0,a.jsx)(X,{documentId:u,onClose:()=>{h(null),t.push("/dashboard/rfa?".concat(new URLSearchParams(window.location.search).toString().replace(/&?docId=[^&]*/,"")),{scroll:!1})}})]})}):null}function ne(){return(0,a.jsx)(r.Suspense,{fallback:(0,a.jsx)("div",{children:"Loading Page..."}),children:(0,a.jsx)(le,{})})}},71550:function(e,s,t){"use strict";t.d(s,{S4:function(){return r},l8:function(){return i},yB:function(){return n}});var a=t(453);const r={RFA:{VIEW_SHOP:"view_shop",CREATE_SHOP:"create_shop",VIEW_GEN:"view_gen",CREATE_GEN:"create_gen",VIEW_MAT:"view_mat",CREATE_MAT:"create_mat",APPROVE:"can_approve"},WORK_REQUEST:{VIEW:"view_wr",CREATE:"create_wr",APPROVE:"approve_wr",VERIFY:"verify_wr"}},l=(a.K$.ADMIN,a.K$.PD,a.K$.PM,a.K$.SE,a.K$.FM,a.K$.BIM,a.K$.SITE_ADMIN,a.K$.CM,a.K$.ME,a.K$.SN,a.K$.OE,a.K$.PE,[a.K$.ADMIN,a.K$.PD,a.K$.PM,a.K$.BIM,a.K$.SITE_ADMIN,a.K$.CM,a.K$.ME,a.K$.SN,a.K$.OE,a.K$.PE]),n={["RFA.".concat(r.RFA.VIEW_SHOP)]:l,["RFA.".concat(r.RFA.CREATE_SHOP)]:[a.K$.BIM,a.K$.ME,a.K$.SN,a.K$.SITE_ADMIN,a.K$.ADMIN,a.K$.PM,a.K$.PE,a.K$.OE],["RFA.".concat(r.RFA.VIEW_GEN)]:l,["RFA.".concat(r.RFA.CREATE_GEN)]:[a.K$.BIM,a.K$.ME,a.K$.SN,a.K$.SITE_ADMIN,a.K$.ADMIN,a.K$.PM,a.K$.PE,a.K$.OE],["RFA.".concat(r.RFA.VIEW_MAT)]:l,["RFA.".concat(r.RFA.CREATE_MAT)]:[a.K$.SITE_ADMIN,a.K$.ADMIN,a.K$.PM,a.K$.PE,a.K$.OE],["RFA.".concat(r.RFA.APPROVE)]:[a.K$.CM,a.K$.ADMIN,a.K$.SITE_ADMIN,a.K$.PM,a.K$.PE,a.K$.OE],["WR.".concat(r.WORK_REQUEST.VIEW)]:l,["WR.".concat(r.WORK_REQUEST.CREATE)]:[a.K$.PE,a.K$.OE,a.K$.ADMIN],["WR.".concat(r.WORK_REQUEST.APPROVE)]:[a.K$.PM,a.K$.ADMIN],["WR.".concat(r.WORK_REQUEST.VERIFY)]:[a.K$.SITE_ADMIN,a.K$.ADMIN,a.K$.BIM]},i=[{title:"RFA - Shop Drawing",permissions:[{key:"RFA.".concat(r.RFA.VIEW_SHOP),label:"\u0e40\u0e02\u0e49\u0e32\u0e14\u0e39 (View)"},{key:"RFA.".concat(r.RFA.CREATE_SHOP),label:"\u0e2a\u0e23\u0e49\u0e32\u0e07 (Create)"}]},{title:"RFA - General",permissions:[{key:"RFA.".concat(r.RFA.VIEW_GEN),label:"\u0e40\u0e02\u0e49\u0e32\u0e14\u0e39 (View)"},{key:"RFA.".concat(r.RFA.CREATE_GEN),label:"\u0e2a\u0e23\u0e49\u0e32\u0e07 (Create)"}]},{title:"RFA - Material",permissions:[{key:"RFA.".concat(r.RFA.VIEW_MAT),label:"\u0e40\u0e02\u0e49\u0e32\u0e14\u0e39 (View)"},{key:"RFA.".concat(r.RFA.CREATE_MAT),label:"\u0e2a\u0e23\u0e49\u0e32\u0e07 (Create)"}]},{title:"RFA - Approval",permissions:[{key:"RFA.".concat(r.RFA.APPROVE),label:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23 (Approve)"}]},{title:"Work Request",permissions:[{key:"WR.".concat(r.WORK_REQUEST.VIEW),label:"\u0e40\u0e02\u0e49\u0e32\u0e14\u0e39 (View)"},{key:"WR.".concat(r.WORK_REQUEST.CREATE),label:"\u0e2a\u0e23\u0e49\u0e32\u0e07\u0e43\u0e1a\u0e04\u0e33\u0e02\u0e2d (Create)"},{key:"WR.".concat(r.WORK_REQUEST.APPROVE),label:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e43\u0e1a\u0e04\u0e33\u0e02\u0e2d (PM)"},{key:"WR.".concat(r.WORK_REQUEST.VERIFY),label:"\u0e15\u0e23\u0e27\u0e08\u0e23\u0e31\u0e1a\u0e07\u0e32\u0e19 (Site)"}]}]}},function(e){e.O(0,[609,15,788,134,958,184,649,478,552,971,997,744],(function(){return s=1417,e(e.s=s);var s}));var s=e.O();_N_E=s}]);