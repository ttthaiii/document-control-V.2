(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[403],{8480:function(e,t,s){Promise.resolve().then(s.bind(s,4843))},401:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]])},4743:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]])},6865:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},7689:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]])},4843:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return j}});var a=s(7437),r=s(731),l=s(1313),i=s(2265),n=s(7649),o=s(9556),d=s(9761),c=s(7689),u=s(8736),m=s(401),h=s(6865),x=s(2489),f=s(4743);function p(e){let{onClose:t,userProp:s}=e,{firebaseUser:r}=(0,n.aC)(),[l,p]=(0,i.useState)([]),[g,N]=(0,i.useState)(""),[b,j]=(0,i.useState)(""),[y,v]=(0,i.useState)(""),[k,w]=(0,i.useState)(o.O.NORMAL),[E,S]=(0,i.useState)([]),[I,O]=(0,i.useState)(!1),[C,R]=(0,i.useState)(!1),[T,D]=(0,i.useState)({});(0,i.useEffect)(()=>{(async()=>{if(r){O(!0);try{let e=await r.getIdToken(),t=await fetch("/api/sites",{headers:{Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();p(e.sites||[])}}catch(e){console.error("Error loading sites:",e),D(e=>({...e,form:"ไม่สามารถโหลดรายชื่อโครงการได้"}))}finally{O(!1)}}})()},[r]);let A=async e=>{try{if(!r)throw Error("กรุณาล็อกอินก่อนอัปโหลดไฟล์");let t=await r.getIdToken(),s=new FormData;s.append("file",e);let a=await fetch("/api/rfa/upload-temp-file",{method:"POST",headers:{Authorization:"Bearer ".concat(t)},body:s}),l=await a.json();if(l.success)return{status:"success",progress:100,uploadedData:l.fileData};throw Error(l.error||"อัปโหลดล้มเหลว")}catch(e){return{status:"error",error:e instanceof Error?e.message:"เกิดข้อผิดพลาด"}}},P=async e=>{try{if(!r)return;let t=await r.getIdToken();await fetch("/api/rfa/delete-temp-file",{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({filePath:e})})}catch(e){console.error("Failed to delete temp file:",e)}},M=async e=>{let t=Array.from(e.target.files||[]);if(!t.length)return;let s=t.map(e=>({id:"".concat(e.name,"-").concat(Date.now()),file:e,status:"pending",progress:0}));for(let e of(S(e=>[...e,...s]),s)){S(t=>t.map(t=>t.id===e.id?{...t,status:"uploading"}:t));let t=await A(e.file);S(s=>s.map(s=>s.id===e.id?{...s,...t}:s))}e.target.value=""},Z=e=>{var t;let s=E[e];(null===(t=s.uploadedData)||void 0===t?void 0:t.filePath)&&P(s.uploadedData.filePath),S(t=>t.filter((t,s)=>s!==e))},_=()=>{let e={};return g||(e.site="กรุณาเลือกโครงการ"),b.trim()||(e.taskName="กรุณาใส่หัวข้องาน"),D(e),0===Object.keys(e).length},G=async e=>{if(e.preventDefault(),_()){R(!0),D({});try{if(!r)throw Error("กรุณาล็อกอินก่อนส่งคำขอ");let e=await r.getIdToken(),s={siteId:g,taskName:b,description:y,priority:k,files:E.filter(e=>"success"===e.status&&e.uploadedData).map(e=>e.uploadedData)},a=await fetch("/api/work-request/create",{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},body:JSON.stringify(s)}),l=await a.json();if(!a.ok||!l.success)throw Error(l.error||l.details||"เกิดข้อผิดพลาดในการสร้าง Work Request");alert("สร้าง Work Request สำเร็จ!\nเลขที่เอกสาร: ".concat(l.documentNumber)),t()}catch(e){console.error("Submit Error:",e),D({form:e instanceof Error?e.message:"เกิดข้อผิดพลาดที่ไม่รู้จัก"})}finally{R(!1)}}};return(0,a.jsxs)("form",{onSubmit:G,className:"space-y-6",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"site",className:"block text-sm font-medium text-gray-700 mb-1",children:"โครงการ"}),(0,a.jsxs)("select",{id:"site",value:g,onChange:e=>N(e.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",disabled:I,children:[(0,a.jsx)("option",{value:"",children:I?"กำลังโหลด...":"-- เลือกโครงการ --"}),l.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))]}),T.site&&(0,a.jsx)("p",{className:"text-red-600 text-sm mt-1",children:T.site})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"priority",className:"block text-sm font-medium text-gray-700 mb-1",children:"ระดับความสำคัญ"}),(0,a.jsxs)("select",{id:"priority",value:k,onChange:e=>w(e.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[(0,a.jsx)("option",{value:o.O.NORMAL,children:"ปกติ"}),(0,a.jsx)("option",{value:o.O.HIGH,children:"ด่วน"}),(0,a.jsx)("option",{value:o.O.URGENT,children:"ด่วนที่สุด"})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"taskName",className:"block text-sm font-medium text-gray-700 mb-1",children:"หัวข้องาน (Task Name)"}),(0,a.jsx)("input",{id:"taskName",type:"text",value:b,onChange:e=>j(e.target.value),placeholder:"เช่น ขอแก้ไขโมเดลโครงสร้างอาคาร A",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"}),T.taskName&&(0,a.jsx)("p",{className:"text-red-600 text-sm mt-1",children:T.taskName})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 mb-1",children:["รายละเอียด ",(0,a.jsx)("span",{className:"text-gray-400 font-normal",children:"(Optional)"})]}),(0,a.jsx)("textarea",{id:"description",value:y,onChange:e=>v(e.target.value),rows:5,placeholder:"อธิบายรายละเอียดเพิ่มเติม (ถ้ามี)...",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"แนบไฟล์ (ถ้ามี)"}),(0,a.jsxs)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors",children:[(0,a.jsx)("input",{type:"file",multiple:!0,onChange:M,id:"file-upload",className:"hidden"}),(0,a.jsxs)("label",{htmlFor:"file-upload",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[(0,a.jsx)(c.Z,{size:18,className:"mr-2"}),"คลิกเพื่อเลือกไฟล์"]})]}),E.length>0&&(0,a.jsx)("div",{className:"mt-4 space-y-2",children:E.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center text-sm p-2 bg-gray-100 rounded",children:[(0,a.jsx)(u.Z,{className:"w-4 h-4 mr-3 text-gray-500"}),(0,a.jsx)("span",{className:"flex-1 truncate",children:e.file.name}),(0,a.jsxs)("div",{className:"flex items-center ml-3",children:["uploading"===e.status&&(0,a.jsx)(d.Z,{className:"w-4 h-4"}),"success"===e.status&&(0,a.jsx)(m.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&(0,a.jsx)("span",{title:e.error,children:(0,a.jsx)(h.Z,{className:"w-4 h-4 text-red-500"})}),(0,a.jsx)("button",{type:"button",onClick:()=>Z(t),className:"ml-3 text-gray-500 hover:text-red-600",children:(0,a.jsx)(x.Z,{size:16})})]})]},e.id))})]}),T.form&&(0,a.jsx)("p",{className:"text-red-600 text-sm text-center bg-red-50 p-3 rounded-lg",children:T.form}),(0,a.jsxs)("div",{className:"flex justify-end gap-4 pt-4 border-t",children:[(0,a.jsx)("button",{type:"button",onClick:t,className:"px-6 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200",children:"ยกเลิก"}),(0,a.jsxs)("button",{type:"submit",disabled:C,className:"flex items-center px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-blue-300",children:[C?(0,a.jsx)(d.Z,{className:"w-5 h-5 mr-2"}):(0,a.jsx)(f.Z,{className:"w-5 h-5 mr-2"}),C?"กำลังส่ง...":"ส่งคำขอ"]})]})]})}var g=s(9376),N=s(453);function b(){let e=(0,g.useRouter)(),{user:t}=(0,n.aC)(),s=t?{id:t.id,email:t.email,role:t.role,sites:t.sites||[],status:t.status}:void 0;return(0,a.jsx)(l.Z,{children:(0,a.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2 mb-2",children:[(0,a.jsx)("span",{className:"text-2xl",children:"✍️"}),(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Create New Work Request"})]}),(0,a.jsx)("p",{className:"text-gray-600",children:"ส่งคำร้องของานไปยังทีม BIM สำหรับงานเร่งด่วนหรืองานที่ไม่ได้วางแผน"})]}),(0,a.jsx)("div",{className:"bg-white rounded-lg shadow-sm border p-6",children:(0,a.jsx)(p,{onClose:()=>{e.push("/dashboard/work-request")},userProp:s})})]})})}function j(){return(0,a.jsx)(r.AuthGuard,{requiredRoles:[N.K$.SITE_ADMIN,N.K$.ADMIN],children:(0,a.jsx)(i.Suspense,{fallback:(0,a.jsx)("div",{className:"text-center p-8",children:"Loading Form..."}),children:(0,a.jsx)(b,{})})})}},9556:function(e,t,s){"use strict";var a,r,l,i;s.d(t,{O:function(){return a},P:function(){return r}}),(l=a||(a={})).NORMAL="NORMAL",l.HIGH="HIGH",l.URGENT="URGENT",(i=r||(r={})).PENDING_BIM="PENDING_BIM",i.IN_PROGRESS="IN_PROGRESS",i.PENDING_ACCEPTANCE="PENDING_ACCEPTANCE",i.REVISION_REQUESTED="REVISION_REQUESTED",i.COMPLETED="COMPLETED"}},function(e){e.O(0,[609,15,783,227,731,313,971,117,744],function(){return e(e.s=8480)}),_N_E=e.O()}]);