"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[649],{7649:function(e,t,r){r.d(t,{AuthProvider:function(){return d},a:function(){return f}});var o=r(7437),i=r(2265),n=r(2148),a=r(5978),l=r(7012),s=r(6855);let c=(0,i.createContext)({user:null,firebaseUser:null,loading:!0,error:null,logout:async()=>{},requestNotificationPermission:async()=>{}}),u=()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);function d(e){let{children:t}=e,[r,d]=(0,i.useState)(null),[f,v]=(0,i.useState)(null),[g,p]=(0,i.useState)(!0),[w,m]=(0,i.useState)(null),E=(0,i.useCallback)(async(e,t)=>{if(u())try{let r=await (0,s.vI)();if(!r){console.log("❌ FCM not supported on this device");return}if("SAVE"===t){let t;let o=Notification.permission;if("granted"!==o){console.log("⚠️ Notification permission not granted yet. Waiting for user gesture.");return}try{"serviceWorker"in navigator&&(t=await navigator.serviceWorker.ready)}catch(e){console.error("❌ Service Worker not ready:",e)}let i=await (0,l.LP)(r,{vapidKey:"BJ13x_HEhi6a7lCuv73CZw78pcmHWQoLdNNZag8EZPcJSD-VNyb2ENgAt_KGnf30p6AzVrE89HckdU4wn4wq9wA",serviceWorkerRegistration:t});i&&(await (0,a.pl)((0,a.JU)(s.db,"users",e),{fcmTokens:[i],lastLogin:new Date},{merge:!0}),console.log("✅ FCM Token Updated"))}else"REMOVE"===t&&await (0,l.pQ)(r)}catch(e){console.error("\uD83D\uDD25 FCM Token Error:",e)}},[]);(0,i.useEffect)(()=>{"serviceWorker"in navigator&&navigator.serviceWorker.register("/firebase-messaging-sw.js").then(e=>{console.log("✅ Service Worker registered:",e.scope)}).catch(e=>{console.error("❌ Service Worker registration failed:",e)})},[]),(0,i.useEffect)(()=>{let e=null;return(async()=>{if(!u())return;let t=await (0,s.vI)();t&&(e=(0,l.ps)(t,e=>{var t,r,o,i,n;console.log("\uD83D\uDCE9 Foreground Message Received:",e);let a=(null===(t=e.notification)||void 0===t?void 0:t.title)||(null===(r=e.data)||void 0===r?void 0:r.title)||"การแจ้งเตือนใหม่",l=(null===(o=e.notification)||void 0===o?void 0:o.body)||(null===(i=e.data)||void 0===i?void 0:i.body)||"",s=null===(n=e.data)||void 0===n?void 0:n.url;if("granted"===Notification.permission){let e=new Notification(a,{body:l,icon:"/icons/icon-192x192.png"});e.onclick=()=>{s&&(window.location.href=s),e.close()}}}))})(),()=>{e&&e()}},[]),(0,i.useEffect)(()=>{let e=null,t=!0,r=(0,n.Aj)(s.I8,async r=>{if(t&&(p(!0),d(r),m(null)),e&&(e(),e=null),r){let o=(0,a.JU)(s.db,"users",r.uid);try{(await (0,a.QT)(o)).exists()||(console.log("\uD83D\uDCDD User doc not found, creating new one..."),await (0,a.pl)(o,{email:r.email,role:"BIM",status:"ACTIVE",sites:[],createdAt:new Date,updatedAt:new Date,fcmTokens:[]}))}catch(e){if(console.error("❌ Error checking/creating user doc:",e.code,e.message),"permission-denied"===e.code){t&&(m("ไม่สามารถเข้าถึงข้อมูลผู้ใช้ได้ กรุณาติดต่อผู้ดูแลระบบ"),v(null),p(!1));return}}e=(0,a.cf)(o,e=>{if(t){if(e.exists()){var o,i,a,l;let t=e.data();if("DISABLED"===t.status){console.warn("⚠️ User account is disabled"),(0,n.w7)(s.I8),v(null),m("บัญชีของคุณถูกระงับการใช้งาน"),p(!1);return}v({id:r.uid,email:r.email||"",role:t.role,sites:t.sites||[],status:t.status||"ACTIVE",createdFromInvitation:t.createdFromInvitation,createdAt:(null===(i=t.createdAt)||void 0===i?void 0:null===(o=i.toDate)||void 0===o?void 0:o.call(i))||t.createdAt,acceptedAt:(null===(l=t.acceptedAt)||void 0===l?void 0:null===(a=l.toDate)||void 0===a?void 0:a.call(l))||t.acceptedAt}),m(null)}else console.warn("⚠️ User document does not exist"),v(null);p(!1)}},e=>{t&&(console.error("❌ Snapshot Error:",e.code,e.message),"permission-denied"===e.code?m("ไม่สามารถเข้าถึงข้อมูลผู้ใช้ได้"):m("เกิดข้อผิดพลาดในการโหลดข้อมูล"),v(null),p(!1))}),E(r.uid,"SAVE")}else t&&(v(null),m(null),p(!1))});return()=>{t=!1,r(),e&&e()}},[E]);let y=(0,i.useCallback)(async()=>{try{(null==f?void 0:f.id)&&await E(f.id,"REMOVE"),await (0,n.w7)(s.I8),v(null),m(null)}catch(e){throw console.error("Logout error:",e),e}},[null==f?void 0:f.id,E]),h=(0,i.useCallback)(async()=>{if(!u()){alert("ระบบแจ้งเตือนรองรับเฉพาะการใช้งานบนโทรศัพท์มือถือเท่านั้น");return}try{let e=await Notification.requestPermission();"granted"===e?(null==f?void 0:f.id)&&(await E(f.id,"SAVE"),alert("✅ เปิดรับการแจ้งเตือนเรียบร้อยแล้ว")):alert("❌ คุณไม่อนุญาตให้แจ้งเตือน กรุณาไปตั้งค่าที่ Settings ของมือถือ")}catch(e){console.error("Request Permission Error:",e),alert("เกิดข้อผิดพลาดในการขอสิทธิ์")}},[null==f?void 0:f.id,E]);return(0,o.jsx)(c.Provider,{value:{user:f,firebaseUser:r,loading:g,error:w,logout:y,requestNotificationPermission:h},children:t})}function f(){return(0,i.useContext)(c)}},6855:function(e,t,r){r.d(t,{I8:function(){return s},db:function(){return c},vI:function(){return u}});var o=r(738),i=r(2148),n=r(5978),a=r(7012);let l=(0,o.C6)().length>0?(0,o.Mq)():(0,o.ZF)({apiKey:"AIzaSyAsayb-DEOBE0zi0qh-dPBfihClgXrX1sY",authDomain:"ttsdocumentcontrol.firebaseapp.com",projectId:"ttsdocumentcontrol",storageBucket:"ttsdocumentcontrol.firebasestorage.app",messagingSenderId:"48440915675",appId:"1:48440915675:web:f11611895bfb52d4d27efe"}),s=(0,i.v0)(l),c=(0,n.ad)(l),u=async()=>{try{if(await (0,a.Gb)())return(0,a.KL)(l)}catch(e){console.error("Error checking messaging support:",e)}return null}}}]);