"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[649],{47649:function(e,o,t){t.d(o,{AuthProvider:function(){return u},a:function(){return v}});var r=t(57437),n=t(2265),i=t(82148),a=t(5978),s=t(27012),l=t(6855);const c=(0,n.createContext)({user:null,firebaseUser:null,loading:!0,error:null,logout:async()=>{},requestNotificationPermission:async()=>{}}),d=()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);function u(e){let{children:o}=e;const[t,u]=(0,n.useState)(null),[v,f]=(0,n.useState)(null),[g,p]=(0,n.useState)(!0),[w,m]=(0,n.useState)(null),E=(0,n.useCallback)((async(e,o)=>{if(d())try{const r=await(0,l.vI)();if(!r)return void console.log("\u274c FCM not supported on this device");if("SAVE"===o){if("granted"!==Notification.permission)return void console.log("\u26a0\ufe0f Notification permission not granted yet. Waiting for user gesture.");let o;try{"serviceWorker"in navigator&&(o=await navigator.serviceWorker.ready)}catch(t){console.error("\u274c Service Worker not ready:",t)}const n=await(0,s.LP)(r,{vapidKey:"BJ13x_HEhi6a7lCuv73CZw78pcmHWQoLdNNZag8EZPcJSD-VNyb2ENgAt_KGnf30p6AzVrE89HckdU4wn4wq9wA",serviceWorkerRegistration:o});n&&(await(0,a.pl)((0,a.JU)(l.db,"users",e),{fcmTokens:[n],lastLogin:new Date},{merge:!0}),console.log("\u2705 FCM Token Updated"))}else"REMOVE"===o&&await(0,s.pQ)(r)}catch(r){console.error("\ud83d\udd25 FCM Token Error:",r)}}),[]);(0,n.useEffect)((()=>{"serviceWorker"in navigator&&navigator.serviceWorker.register("/firebase-messaging-sw.js").then((e=>{console.log("\u2705 Service Worker registered:",e.scope)})).catch((e=>{console.error("\u274c Service Worker registration failed:",e)}))}),[]),(0,n.useEffect)((()=>{let e=null;return(async()=>{if(!d())return;const o=await(0,l.vI)();o&&(e=(0,s.ps)(o,(e=>{var o,t,r,n,i;console.log("\ud83d\udce9 Foreground Message Received:",e);const a=(null===(o=e.notification)||void 0===o?void 0:o.title)||(null===(t=e.data)||void 0===t?void 0:t.title)||"\u0e01\u0e32\u0e23\u0e41\u0e08\u0e49\u0e07\u0e40\u0e15\u0e37\u0e2d\u0e19\u0e43\u0e2b\u0e21\u0e48",s=(null===(r=e.notification)||void 0===r?void 0:r.body)||(null===(n=e.data)||void 0===n?void 0:n.body)||"",l=null===(i=e.data)||void 0===i?void 0:i.url;if("granted"===Notification.permission){const e=new Notification(a,{body:s,icon:"/icons/icon-192x192.png"});e.onclick=()=>{l&&(window.location.href=l),e.close()}}})))})(),()=>{e&&e()}}),[]),(0,n.useEffect)((()=>{let e=null,o=!0;const t=(0,i.Aj)(l.I8,(async t=>{if(o&&(p(!0),u(t),m(null)),e&&(e(),e=null),t){const n=(0,a.JU)(l.db,"users",t.uid);try{(await(0,a.QT)(n)).exists()||(console.log("\ud83d\udcdd User doc not found, creating new one..."),await(0,a.pl)(n,{email:t.email,role:"BIM",status:"ACTIVE",sites:[],createdAt:new Date,updatedAt:new Date,fcmTokens:[]}))}catch(r){const e=r;if(console.error("\u274c Error checking/creating user doc:",e.code,e.message),"permission-denied"===e.code)return void(o&&(m("\u0e44\u0e21\u0e48\u0e2a\u0e32\u0e21\u0e32\u0e23\u0e16\u0e40\u0e02\u0e49\u0e32\u0e16\u0e36\u0e07\u0e02\u0e49\u0e2d\u0e21\u0e39\u0e25\u0e1c\u0e39\u0e49\u0e43\u0e0a\u0e49\u0e44\u0e14\u0e49 \u0e01\u0e23\u0e38\u0e13\u0e32\u0e15\u0e34\u0e14\u0e15\u0e48\u0e2d\u0e1c\u0e39\u0e49\u0e14\u0e39\u0e41\u0e25\u0e23\u0e30\u0e1a\u0e1a"),f(null),p(!1)))}e=(0,a.cf)(n,(e=>{if(o){if(e.exists()){var r,n,a,s;const o=e.data();if("DISABLED"===o.status)return console.warn("\u26a0\ufe0f User account is disabled"),(0,i.w7)(l.I8),f(null),m("\u0e1a\u0e31\u0e0d\u0e0a\u0e35\u0e02\u0e2d\u0e07\u0e04\u0e38\u0e13\u0e16\u0e39\u0e01\u0e23\u0e30\u0e07\u0e31\u0e1a\u0e01\u0e32\u0e23\u0e43\u0e0a\u0e49\u0e07\u0e32\u0e19"),void p(!1);f({id:t.uid,email:t.email||"",role:o.role,sites:o.sites||[],status:o.status||"ACTIVE",createdFromInvitation:o.createdFromInvitation,createdAt:(null===(n=o.createdAt)||void 0===n||null===(r=n.toDate)||void 0===r?void 0:r.call(n))||o.createdAt,acceptedAt:(null===(s=o.acceptedAt)||void 0===s||null===(a=s.toDate)||void 0===a?void 0:a.call(s))||o.acceptedAt}),m(null)}else console.warn("\u26a0\ufe0f User document does not exist"),f(null);p(!1)}}),(e=>{o&&(console.error("\u274c Snapshot Error:",e.code,e.message),"permission-denied"===e.code?m("\u0e44\u0e21\u0e48\u0e2a\u0e32\u0e21\u0e32\u0e23\u0e16\u0e40\u0e02\u0e49\u0e32\u0e16\u0e36\u0e07\u0e02\u0e49\u0e2d\u0e21\u0e39\u0e25\u0e1c\u0e39\u0e49\u0e43\u0e0a\u0e49\u0e44\u0e14\u0e49"):m("\u0e40\u0e01\u0e34\u0e14\u0e02\u0e49\u0e2d\u0e1c\u0e34\u0e14\u0e1e\u0e25\u0e32\u0e14\u0e43\u0e19\u0e01\u0e32\u0e23\u0e42\u0e2b\u0e25\u0e14\u0e02\u0e49\u0e2d\u0e21\u0e39\u0e25"),f(null),p(!1))})),E(t.uid,"SAVE")}else o&&(f(null),m(null),p(!1))}));return()=>{o=!1,t(),e&&e()}}),[E]);const h=(0,n.useCallback)((async()=>{try{(null===v||void 0===v?void 0:v.id)&&await E(v.id,"REMOVE"),await(0,i.w7)(l.I8),f(null),m(null)}catch(e){throw console.error("Logout error:",e),e}}),[null===v||void 0===v?void 0:v.id,E]),y=(0,n.useCallback)((async()=>{if(d())try{"granted"===await Notification.requestPermission()?(null===v||void 0===v?void 0:v.id)&&(await E(v.id,"SAVE"),alert("\u2705 \u0e40\u0e1b\u0e34\u0e14\u0e23\u0e31\u0e1a\u0e01\u0e32\u0e23\u0e41\u0e08\u0e49\u0e07\u0e40\u0e15\u0e37\u0e2d\u0e19\u0e40\u0e23\u0e35\u0e22\u0e1a\u0e23\u0e49\u0e2d\u0e22\u0e41\u0e25\u0e49\u0e27")):alert("\u274c \u0e04\u0e38\u0e13\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e0d\u0e32\u0e15\u0e43\u0e2b\u0e49\u0e41\u0e08\u0e49\u0e07\u0e40\u0e15\u0e37\u0e2d\u0e19 \u0e01\u0e23\u0e38\u0e13\u0e32\u0e44\u0e1b\u0e15\u0e31\u0e49\u0e07\u0e04\u0e48\u0e32\u0e17\u0e35\u0e48 Settings \u0e02\u0e2d\u0e07\u0e21\u0e37\u0e2d\u0e16\u0e37\u0e2d")}catch(w){console.error("Request Permission Error:",w),alert("\u0e40\u0e01\u0e34\u0e14\u0e02\u0e49\u0e2d\u0e1c\u0e34\u0e14\u0e1e\u0e25\u0e32\u0e14\u0e43\u0e19\u0e01\u0e32\u0e23\u0e02\u0e2d\u0e2a\u0e34\u0e17\u0e18\u0e34\u0e4c")}else alert("\u0e23\u0e30\u0e1a\u0e1a\u0e41\u0e08\u0e49\u0e07\u0e40\u0e15\u0e37\u0e2d\u0e19\u0e23\u0e2d\u0e07\u0e23\u0e31\u0e1a\u0e40\u0e09\u0e1e\u0e32\u0e30\u0e01\u0e32\u0e23\u0e43\u0e0a\u0e49\u0e07\u0e32\u0e19\u0e1a\u0e19\u0e42\u0e17\u0e23\u0e28\u0e31\u0e1e\u0e17\u0e4c\u0e21\u0e37\u0e2d\u0e16\u0e37\u0e2d\u0e40\u0e17\u0e48\u0e32\u0e19\u0e31\u0e49\u0e19")}),[null===v||void 0===v?void 0:v.id,E]);return(0,r.jsx)(c.Provider,{value:{user:v,firebaseUser:t,loading:g,error:w,logout:h,requestNotificationPermission:y},children:o})}function v(){return(0,n.useContext)(c)}},6855:function(e,o,t){t.d(o,{I8:function(){return l},db:function(){return c},vI:function(){return d}});var r=t(738),n=t(82148),i=t(5978),a=t(27012);const s=(0,r.C6)().length>0?(0,r.Mq)():(0,r.ZF)({apiKey:"AIzaSyAsayb-DEOBE0zi0qh-dPBfihClgXrX1sY",authDomain:"ttsdocumentcontrol.firebaseapp.com",projectId:"ttsdocumentcontrol",storageBucket:"ttsdocumentcontrol.firebasestorage.app",messagingSenderId:"48440915675",appId:"1:48440915675:web:f11611895bfb52d4d27efe"}),l=(0,n.v0)(s),c=(0,i.ad)(s),d=async()=>{try{if(await(0,a.Gb)())return(0,a.KL)(s)}catch(e){console.error("Error checking messaging support:",e)}return null}}}]);