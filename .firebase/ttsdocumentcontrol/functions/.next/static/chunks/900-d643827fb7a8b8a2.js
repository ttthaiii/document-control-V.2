"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[900],{3900:function(e,t,a){a.d(t,{Z:function(){return h}});var s=a(7437),l=a(2265),r=a(2489),i=a(1817),o=a(8736),d=a(401),n=a(6865),c=a(5946);let m=()=>{let[e,t]=(0,l.useState)(!1),[a,s]=(0,l.useState)(null),{firebaseUser:r}=(0,c.a)(),i=(0,l.useCallback)(async(e,t)=>{if(!r)throw Error("User not authenticated");let a=await r.getIdToken(),s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a)},body:JSON.stringify(t)}),l=await s.json();if(!l.success)throw Error(l.error||"Request failed");return l.data},[r]);return{loading:e,error:a,getProjects:(0,l.useCallback)(async e=>{t(!0),s(null);try{return(await i("/api/google-sheets/projects",e)).projects}catch(e){throw s(e.message),e}finally{t(!1)}},[i]),getCategories:(0,l.useCallback)(async(e,a,l)=>{t(!0),s(null);try{return(await i("/api/google-sheets/categories",{...e,projectName:a,rfaType:l})).categories}catch(e){throw s(e.message),e}finally{t(!1)}},[i]),getTasks:(0,l.useCallback)(async(e,a,l)=>{t(!0),s(null);try{return(await i("/api/google-sheets/tasks",{...e,projectName:a,category:l})).tasks}catch(e){throw s(e.message),e}finally{t(!1)}},[i]),clearError:()=>s(null)}},u={rfaType:"",categoryId:"",documentNumber:"",title:"",description:"",revisionNumber:"00",uploadedFiles:[],selectedProject:"",selectedCategory:"",selectedTask:null},x={"RFA-SHOP":{title:"RFA-SHOP",subtitle:"Shop Drawing Approval",icon:"\uD83C\uDFD7️",description:"สำหรับการขออนุมัติ Shop Drawing",workflow:"ผู้สร้าง → Site Admin → CM",allowedRoles:["BIM","ME","SN","Admin"],color:"blue"},"RFA-GEN":{title:"RFA-GEN",subtitle:"General Submission",icon:"\uD83D\uDCCB",description:"สำหรับการส่งเอกสารทั่วไป",workflow:"ผู้สร้าง → CM",allowedRoles:["BIM","Site Admin","Admin","ME","SN"],color:"green"},"RFA-MAT":{title:"RFA-MAT",subtitle:"Material Approval",icon:"\uD83E\uDDF1",description:"สำหรับการขออนุมัติวัสดุ",workflow:"Site Admin → CM",allowedRoles:["Site Admin","Admin"],color:"orange"}};function h(e){var t,a;let{onClose:h,isModal:p=!1,userProp:g,presetRfaType:f}=e,y=f?2:1,[b,j]=(0,l.useState)(y),[N,v]=(0,l.useState)({...u,rfaType:f||""}),[w,k]=(0,l.useState)(!1),[C,T]=(0,l.useState)({}),[F,S]=(0,l.useState)(!1),[D,I]=(0,l.useState)([]),[A,E]=(0,l.useState)([]),[R,P]=(0,l.useState)([]),[M,O]=(0,l.useState)(""),{firebaseUser:z}=(0,c.a)(),{loading:B,error:Z,getCategories:U,getTasks:G}=m(),[_,H]=(0,l.useState)(""),[J,L]=(0,l.useState)([]),q=g&&("ME"===g.role||"SN"===g.role);(0,l.useEffect)(()=>{f&&(K({rfaType:f}),j(2))},[f]),(0,l.useEffect)(()=>{(async()=>{if(z){k(!0);try{let e=await z.getIdToken(),t=await fetch("/api/sites",{headers:{Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();I(e.sites||[])}}catch(e){console.error("Error loading sites:",e)}finally{k(!1)}}})()},[z]),(0,l.useEffect)(()=>()=>{N.uploadedFiles.forEach(e=>{var t;(null===(t=e.uploadedData)||void 0===t?void 0:t.filePath)&&X(e.uploadedData.filePath)})},[]);let K=e=>{v(t=>({...t,...e}));let t={...C};Object.keys(e).forEach(e=>delete t[e]),T(t)},Q=e=>{let t={};switch(e){case 1:if(N.rfaType){let e=x[N.rfaType];g&&!e.allowedRoles.includes(g.role)&&(t.rfaType="คุณไม่มีสิทธิ์สร้าง ".concat(N.rfaType))}else t.rfaType="กรุณาเลือกประเภท RFA";break;case 2:N.title.trim()||(t.title="กรุณาใส่หัวข้อเอกสาร"),N.revisionNumber.trim()||(t.revisionNumber="กรุณาใส่ Rev. No."),N.documentNumber.trim()||(t.documentNumber="กรุณาใส่เลขที่เอกสาร"),M||(t.site="กรุณาเลือกโครงการ"),q?N.categoryId.trim()||(t.categoryId="กรุณากรอกหมวดงาน"):N.selectedTask||(t.task="กรุณาเลือกงานจาก Google Sheets");break;case 3:0===N.uploadedFiles.filter(e=>"success"===e.status).length&&(t.files="กรุณาอัปโหลดไฟล์ให้สำเร็จก่อน")}return T(t),0===Object.keys(t).length},V=async()=>{if(Q(3)){S(!0);try{var e;if(!z)throw Error("กรุณาล็อกอินก่อน");let t=await z.getIdToken(),a=N.uploadedFiles.filter(e=>"success"===e.status&&e.uploadedData);if(0===a.length)throw Error("กรุณาอัปโหลดไฟล์ให้สำเร็จอย่างน้อย 1 ไฟล์");let s=q?N.categoryId:null===(e=N.selectedTask)||void 0===e?void 0:e.taskCategory,l=q?null:N.selectedTask;if(!s)throw Error("ไม่สามารถระบุ Category ID ได้ กรุณาตรวจสอบข้อมูล");let r={rfaType:N.rfaType,title:N.title,description:N.description,siteId:M,documentNumber:N.documentNumber,revisionNumber:parseInt(N.revisionNumber,10)||0,uploadedFiles:a.map(e=>({fileName:e.uploadedData.fileName,fileUrl:e.uploadedData.fileUrl,filePath:e.uploadedData.filePath,fileSize:e.uploadedData.size,fileType:e.uploadedData.contentType})),categoryId:s,taskData:l},i=await fetch("/api/rfa/create",{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({payload:r})}),o=await i.json();if(!i.ok)throw Error(o.error||"HTTP error! status: ".concat(i.status));if(o.success)alert("สร้าง RFA สำเร็จ! หมายเลขเอกสาร: ".concat(o.runningNumber)),h&&h();else throw Error(o.error||"เกิดข้อผิดพลาดในการสร้างเอกสาร")}catch(e){console.error("Submit Error:",e),T({general:e instanceof Error?e.message:"เกิดข้อผิดพลาดที่ไม่รู้จัก"})}finally{S(!1)}}},W=async e=>{let t={id:"".concat(e.name,"-").concat(Date.now()),file:e,status:"uploading",progress:0,retryCount:0};try{if(!z)throw Error("User not authenticated");let a=await z.getIdToken(),s=new FormData;s.append("file",e);let l=await fetch("/api/rfa/upload-temp-file",{method:"POST",headers:{Authorization:"Bearer ".concat(a)},body:s}),r=await l.json();if(r.success)return{...t,status:"success",progress:100,uploadedData:r.fileData};throw Error(r.error||"Upload failed")}catch(e){return{...t,status:"error",error:e instanceof Error?e.message:"Upload error"}}},X=async e=>{try{if(!z)return;let t=await z.getIdToken();await fetch("/api/rfa/delete-temp-file",{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({filePath:e})})}catch(e){console.error("Failed to delete temp file:",e)}},Y=async e=>{let t=Array.from(e.target.files||[]);if(!t.length)return;let a=t.map(e=>({id:"".concat(e.name,"-").concat(Date.now()),file:e,status:"pending",progress:0,retryCount:0}));for(let e of(v(e=>({...e,uploadedFiles:[...e.uploadedFiles,...a]})),a)){v(t=>({...t,uploadedFiles:t.uploadedFiles.map(t=>t.id===e.id?{...t,status:"uploading"}:t)}));let t=await W(e.file);v(a=>({...a,uploadedFiles:a.uploadedFiles.map(a=>a.id===e.id?{...a,...t}:a)}))}e.target.value=""},$=e=>{var t;let a=N.uploadedFiles[e];(null===(t=a.uploadedData)||void 0===t?void 0:t.filePath)&&X(a.uploadedData.filePath),K({uploadedFiles:N.uploadedFiles.filter((t,a)=>a!==e)})},ee=async e=>{if(O(e),K({categoryId:"",selectedCategory:"",selectedTask:null}),L([]),E([]),P([]),H(""),!e)return;let t=D.find(t=>t.id===e);if(t){if(q){if(z){k(!0);try{let t=await z.getIdToken(),a=await fetch("/api/sites/".concat(e,"/categories"),{headers:{Authorization:"Bearer ".concat(t)}}),s=await a.json();s.success&&L(s.categories)}catch(e){console.error("Failed to fetch site categories:",e),T(e=>({...e,site:"ไม่สามารถโหลดหมวดงานได้"}))}finally{k(!1)}}}else{if(K({selectedProject:t.name}),!t.sheetId){T(e=>({...e,site:"โครงการนี้ยังไม่ได้ตั้งค่า Google Sheet ID"}));return}try{let e=await U({sheetId:t.sheetId},t.name,N.rfaType);E(e)}catch(e){console.error(e)}}}},et=async e=>{K({selectedCategory:e,selectedTask:null}),P([]);let t=D.find(e=>e.id===M);if(t&&t.sheetId&&N.selectedProject)try{let a=await G({sheetId:t.sheetId},N.selectedProject,e);P(a)}catch(e){console.error(e)}},ea=e=>{K({selectedTask:e,title:"".concat(e.taskName," - RFA")}),H(e.taskName)},es=(0,l.useMemo)(()=>_?R.filter(e=>e.taskName.toLowerCase().includes(_.toLowerCase())):R.slice(0,20),[R,_]);return(0,s.jsxs)("div",{className:"".concat(p?"max-w-4xl w-full mx-auto":""," bg-white rounded-lg shadow-xl flex flex-col h-full max-h-[95vh]"),children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-6 border-b bg-gray-50",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("h2",{className:"text-2xl font-bold text-gray-900",children:["สร้าง RFA Document",f&&x[f]&&(0,s.jsxs)("span",{className:"font-medium text-gray-600",children:[" - ",x[f].subtitle]})]}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:g&&"โดย ".concat(g.email," (").concat(g.role,")")})]}),h&&(0,s.jsx)("button",{onClick:h,className:"text-gray-400 hover:text-gray-600",children:(0,s.jsx)(r.Z,{})})]}),(0,s.jsxs)("div",{className:"flex-1 p-6 overflow-y-auto",children:[1===b&&(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:Object.entries(x).map(e=>{let[t,a]=e,l=a.allowedRoles.includes((null==g?void 0:g.role)||"");return(0,s.jsxs)("div",{onClick:()=>l&&K({rfaType:t}),className:"p-6 border-2 rounded-lg text-center cursor-pointer ".concat(N.rfaType===t?"border-blue-500 bg-blue-50":l?"border-gray-200 hover:border-gray-300":"border-gray-100 bg-gray-50 opacity-60 cursor-not-allowed"),children:[(0,s.jsx)("div",{className:"text-4xl mb-2",children:a.icon}),(0,s.jsx)("h4",{className:"font-semibold",children:a.title}),(0,s.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:a.description})]},t)})}),2===b&&(0,s.jsxs)("div",{className:"space-y-6 max-w-2xl mx-auto",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"โครงการ"}),(0,s.jsxs)("select",{value:M,onChange:e=>ee(e.target.value),className:"w-full p-3 border rounded-lg",children:[(0,s.jsx)("option",{value:"",children:"-- เลือกโครงการ --"}),D.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]}),C.site&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.site})]}),q?(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"category-manual-input",className:"block text-sm font-medium text-gray-700 mb-2",children:"หมวดงาน"}),(0,s.jsx)("input",{id:"category-manual-input",type:"text",list:"category-list",value:N.categoryId,onChange:e=>K({categoryId:e.target.value}),placeholder:"พิมพ์เพื่อค้นหา หรือกรอกหมวดงานใหม่",className:"w-full p-3 border rounded-lg",disabled:!M}),(0,s.jsx)("datalist",{id:"category-list",children:J.map(e=>(0,s.jsx)("option",{value:e.categoryCode},e.id))}),C.categoryId&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.categoryId})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center",children:["หมวดงาน (จาก Google Sheets)",B&&(0,s.jsx)(i.Z,{className:"w-4 h-4 ml-2 animate-spin text-gray-400"})]}),(0,s.jsxs)("select",{value:N.selectedCategory,onChange:e=>et(e.target.value),className:"w-full p-3 border rounded-lg disabled:bg-gray-100",disabled:!M||B,children:[(0,s.jsx)("option",{value:"",children:B?"กำลังโหลด...":"-- เลือกหมวดงาน --"}),A.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),Z&&(0,s.jsxs)("p",{className:"text-red-600 text-sm mt-1",children:["Error: ",Z]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ค้นหางาน"}),(0,s.jsx)("input",{type:"text",placeholder:"ค้นหา...",value:_,onChange:e=>H(e.target.value),className:"w-full p-3 border rounded-lg",disabled:!N.selectedCategory||B}),(0,s.jsx)("div",{className:"mt-2 max-h-48 overflow-y-auto border rounded-lg",children:es.map(e=>{var t;return(0,s.jsx)("div",{onClick:()=>ea(e),className:"p-2 cursor-pointer hover:bg-gray-100 ".concat((null===(t=N.selectedTask)||void 0===t?void 0:t.taskName)===e.taskName?"bg-blue-50":""),children:e.taskName},e.taskUid||e.taskName)})}),C.task&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.task})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[(0,s.jsxs)("div",{className:"sm:col-span-2",children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"เลขที่เอกสาร"}),(0,s.jsx)("input",{type:"text",value:N.documentNumber,onChange:e=>K({documentNumber:e.target.value}),className:"w-full p-3 border rounded-lg"}),C.documentNumber&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.documentNumber})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Rev. No."}),(0,s.jsx)("input",{type:"text",value:N.revisionNumber,onChange:e=>K({revisionNumber:e.target.value}),className:"w-full p-3 border rounded-lg"}),C.revisionNumber&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.revisionNumber})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"หัวข้อเอกสาร"}),(0,s.jsx)("input",{type:"text",value:N.title,onChange:e=>K({title:e.target.value}),className:"w-full p-3 border rounded-lg"}),C.title&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.title})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"รายละเอียด"}),(0,s.jsx)("textarea",{value:N.description,onChange:e=>K({description:e.target.value}),rows:3,className:"w-full p-3 border rounded-lg"})]})]}),3===b&&(0,s.jsxs)("div",{className:"space-y-6 max-w-2xl mx-auto",children:[(0,s.jsxs)("div",{className:"border-2 border-dashed rounded-lg p-8 text-center",children:[(0,s.jsx)("input",{type:"file",multiple:!0,onChange:Y,id:"file-upload",className:"hidden"}),(0,s.jsx)("label",{htmlFor:"file-upload",className:"cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg",children:"เลือกไฟล์"})]}),N.uploadedFiles.length>0&&(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"font-medium text-gray-800 mb-2",children:"ไฟล์ที่อัปโหลด"}),(0,s.jsx)("div",{className:"space-y-2",children:N.uploadedFiles.map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center text-sm p-2 bg-gray-100 rounded",children:[(0,s.jsx)(o.Z,{className:"w-4 h-4 mr-3 text-gray-500 flex-shrink-0"}),(0,s.jsx)("span",{className:"flex-1 truncate",title:e.file.name,children:e.file.name}),(0,s.jsxs)("div",{className:"flex items-center ml-3",children:["uploading"===e.status&&(0,s.jsx)(i.Z,{className:"w-4 h-4 animate-spin text-blue-500"}),"success"===e.status&&(0,s.jsx)(d.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&(0,s.jsx)("span",{title:e.error,children:(0,s.jsx)(n.Z,{className:"w-4 h-4 text-red-500"})}),(0,s.jsx)("button",{onClick:()=>$(t),className:"ml-3 text-gray-500 hover:text-red-600",children:(0,s.jsx)(r.Z,{size:16})})]})]},e.id))})]}),C.files&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.files})]}),4===b&&(0,s.jsxs)("div",{className:"space-y-4 max-w-2xl mx-auto",children:[(0,s.jsx)("h3",{className:"text-xl font-semibold text-center text-gray-800",children:"ตรวจสอบข้อมูล"}),(0,s.jsxs)("div",{className:"p-6 bg-gray-50 rounded-lg border border-gray-200 space-y-4",children:[(0,s.jsxs)("div",{className:"space-y-2 text-base",children:[(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"โครงการ:"}),(0,s.jsx)("span",{className:"font-semibold text-gray-800",children:null===(t=D.find(e=>e.id===M))||void 0===t?void 0:t.name})]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"ประเภท:"}),(0,s.jsx)("span",{className:"font-semibold text-gray-800",children:N.rfaType})]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"หมวดงาน:"}),(0,s.jsx)("span",{className:"font-semibold text-gray-800",children:q?N.categoryId:null===(a=N.selectedTask)||void 0===a?void 0:a.taskCategory})]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"เลขที่เอกสาร:"}),(0,s.jsx)("span",{className:"font-semibold text-gray-800",children:N.documentNumber})]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"Rev.:"}),(0,s.jsx)("span",{className:"font-semibold text-gray-800",children:N.revisionNumber})]})]}),(0,s.jsxs)("div",{className:"pt-4 border-t border-gray-200",children:[(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"หัวข้อ:"}),(0,s.jsx)("p",{className:"text-base font-semibold text-gray-800 mt-1 break-words",children:N.title})]}),(0,s.jsxs)("div",{className:"pt-4 border-t border-gray-200",children:[(0,s.jsxs)("h4",{className:"text-sm font-medium text-gray-500",children:["ไฟล์แนบ (",N.uploadedFiles.filter(e=>"success"===e.status).length," ไฟล์):"]}),(0,s.jsx)("ul",{className:"list-disc list-inside mt-2 space-y-1 text-base",children:N.uploadedFiles.filter(e=>"success"===e.status).map(e=>(0,s.jsx)("li",{className:"truncate text-gray-800",title:e.file.name,children:e.file.name},e.id))})]})]})]})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center p-6 border-t bg-gray-50",children:[(0,s.jsx)("button",{onClick:()=>b>1&&j(b-1),disabled:b===y||F,className:"px-4 py-2 rounded-lg bg-gray-200 disabled:opacity-50 ".concat(b===y?"invisible":"visible"),children:"ย้อนกลับ"}),b<4?(0,s.jsx)("button",{onClick:()=>b<4&&Q(b)&&j(b+1),disabled:F,className:"px-4 py-2 rounded-lg bg-blue-600 text-white disabled:opacity-50",children:"ถัดไป"}):(0,s.jsx)("button",{onClick:V,disabled:F||0===N.uploadedFiles.filter(e=>"success"===e.status).length,className:"px-6 py-2 rounded-lg bg-green-600 text-white disabled:bg-gray-300 disabled:cursor-not-allowed",children:F?"กำลังสร้าง...":"สร้างเอกสาร"})]})]})}}}]);