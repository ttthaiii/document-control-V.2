(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[702],{3529:function(e,t,s){Promise.resolve().then(s.bind(s,6845))},2735:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("download",[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]])},6845:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return w}});var a=s(7437),r=s(2265),l=s(731),n=s(7649),i=s(3247),c=s(44),d=s(2720);let o=(0,s(9205).Z)("eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);var x=s(2735),u=s(8736),m=s(9761),h=s(7576),f=s(6855),p=s(5978),y=s(453);let g=e=>{if(!e)return"N/A";if(e.seconds)return new Date(1e3*e.seconds).toLocaleDateString("th-TH",{year:"numeric",month:"short",day:"numeric"});let t=new Date(e);return isNaN(t.getTime())?"Invalid Date":t.toLocaleDateString("th-TH",{year:"numeric",month:"short",day:"numeric"})},j=()=>{let[e,t]=(0,r.useState)(!1);return(0,r.useEffect)(()=>{let e=()=>t(window.innerWidth<768);return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),e};function b(){let{user:e,firebaseUser:t}=(0,n.a)(),s=j(),[l,b]=(0,r.useState)([]),[N,w]=(0,r.useState)([]),[v,L]=(0,r.useState)(""),[k,E]=(0,r.useState)("ALL"),[A,C]=(0,r.useState)("ALL"),[D,S]=(0,r.useState)([]),[Z,z]=(0,r.useState)(!0),[_,I]=(0,r.useState)(null),[O,P]=(0,r.useState)(null);(0,r.useEffect)(()=>{(async()=>{if(t)try{let e=await t.getIdToken(),[s,a]=await Promise.all([fetch("/api/sites",{headers:{Authorization:"Bearer ".concat(e)}}),fetch("/api/rfa/categories?rfaType=ALL",{headers:{Authorization:"Bearer ".concat(e)}})]);if(!s.ok||!a.ok)throw Error("Failed to fetch filter data");let r=await s.json(),l=await a.json();b(r.sites||[]);let n=Array.from(new Map(l.categories.map(e=>[e.categoryCode,e])).values());w(n)}catch(e){I("ไม่สามารถโหลดข้อมูล Filter ได้"),console.error(e)}})()},[t]),(0,r.useEffect)(()=>{(async()=>{if(!(null==e?void 0:e.sites)||0===e.sites.length){z(!1);return}z(!0),I(null);try{let t=(0,p.IO)((0,p.hJ)(f.db,"rfaDocuments"),(0,p.ar)("siteId","in",e.sites),(0,p.ar)("isLatest","==",!0),(0,p.ar)("status","in",[y.n$.APPROVED,y.n$.APPROVED_WITH_COMMENTS,y.n$.APPROVED_REVISION_REQUIRED]),(0,p.Xo)("updatedAt","desc"));"ALL"!==k&&(t=(0,p.IO)(t,(0,p.ar)("siteId","==",k))),"ALL"!==A&&(t=(0,p.IO)(t,(0,p.ar)("categoryId","==",A)));let s=(await (0,p.PL)(t)).docs.map(e=>({id:e.id,...e.data()}));S(s)}catch(e){I(e instanceof Error?e.message:"ไม่สามารถโหลดข้อมูลเอกสารได้"),console.error(e)}finally{z(!1)}})()},[e,k,A]);let T=(0,r.useMemo)(()=>{if(!v)return D;let e=v.toLowerCase();return D.filter(t=>t.title.toLowerCase().includes(e)||t.documentNumber&&t.documentNumber.toLowerCase().includes(e))},[v,D]),M=e=>{"application/pdf"===e.contentType||e.fileName.toLowerCase().endsWith(".pdf")?P(e):window.open(e.fileUrl,"_blank")};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow flex flex-col h-full",children:[(0,a.jsxs)("div",{className:"p-4 border-b",children:[(0,a.jsx)("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"\uD83D\uDCDA คลังเอกสารอนุมัติ (Approved Document Library)"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 items-end",children:[(0,a.jsxs)("div",{className:"relative md:col-span-1",children:[(0,a.jsx)(i.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"}),(0,a.jsx)("input",{type:"text",placeholder:"ค้นหา...",className:"w-full pl-10 pr-4 py-2 border rounded-lg",value:v,onChange:e=>L(e.target.value)})]}),(0,a.jsxs)("div",{className:"relative md:col-span-1",children:[(0,a.jsx)(c.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"}),(0,a.jsxs)("select",{className:"w-full pl-10 pr-4 py-2 border rounded-lg appearance-none truncate",value:k,onChange:e=>E(e.target.value),children:[(0,a.jsx)("option",{value:"ALL",children:"ทุกโครงการ"}),l.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,a.jsxs)("div",{className:"relative md:col-span-1",children:[(0,a.jsx)(d.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"}),(0,a.jsxs)("select",{className:"w-full pl-10 pr-4 py-2 border rounded-lg appearance-none",value:A,onChange:e=>C(e.target.value),children:[(0,a.jsx)("option",{value:"ALL",children:"ทุกหมวดงาน"}),N.map(e=>(0,a.jsx)("option",{value:e.id,children:e.categoryCode},e.id))]})]}),(0,a.jsx)("div",{className:"md:col-span-1",children:(0,a.jsx)("button",{onClick:()=>{L(""),E("ALL"),C("ALL")},className:"w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors",children:"รีเซ็ต"})})]}),_&&(0,a.jsx)("p",{className:"text-red-500 text-sm mt-2",children:_})]}),(0,a.jsx)("div",{className:"p-4 flex-1 min-h-0 overflow-y-auto",children:Z?(0,a.jsx)("div",{className:"text-center py-16",children:(0,a.jsx)(m.Z,{})}):0===T.length?(0,a.jsx)("div",{className:"text-center py-16 border-2 border-dashed rounded-lg",children:(0,a.jsx)("p",{className:"text-gray-500",children:"ไม่พบเอกสารที่อนุมัติแล้ว"})}):s?(0,a.jsx)("div",{className:"space-y-3",children:T.map(e=>(0,a.jsxs)("div",{className:"bg-gray-50 border rounded-lg p-4 space-y-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-semibold text-gray-800 truncate",children:e.documentNumber}),(0,a.jsx)("p",{className:"text-sm text-gray-600 line-clamp-2 mt-1",children:e.title})]}),e.files&&e.files.length>0&&(0,a.jsxs)("button",{onClick:()=>M(e.files[0]),className:"w-full flex items-center justify-center text-sm bg-white border border-gray-300 rounded-md p-2 hover:bg-gray-100 transition-colors",children:[e.files[0].fileName.toLowerCase().endsWith(".pdf")?(0,a.jsx)(o,{className:"w-4 h-4 mr-2 text-red-500"}):(0,a.jsx)(x.Z,{className:"w-4 h-4 mr-2 text-blue-500"}),(0,a.jsx)("span",{className:"truncate",children:e.files[0].fileName})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center pt-2 border-t text-xs text-gray-500",children:[(0,a.jsx)("span",{className:"px-2 py-1 bg-green-100 text-green-800 rounded font-medium",children:y.NK[e.status]||e.status}),(0,a.jsx)("span",{children:g(e.updatedAt)})]})]},e.id))}):(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,a.jsx)("thead",{className:"bg-gray-50",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"เลขที่เอกสาร"}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"หัวข้อเรื่อง"}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"ไฟล์แนบ"}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"สถานะ"}),(0,a.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"วันที่อนุมัติ"})]})}),(0,a.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:T.map(e=>(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800",children:e.documentNumber}),(0,a.jsx)("td",{className:"px-6 py-4 text-sm text-gray-700",children:e.title}),(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:e.files&&e.files.length>0?(0,a.jsxs)("button",{onClick:()=>M(e.files[0]),className:"flex items-center text-blue-600 hover:text-blue-800 hover:underline",title:e.files[0].fileName,children:[(0,a.jsx)(u.Z,{className:"w-4 h-4 mr-2 flex-shrink-0"}),(0,a.jsx)("span",{className:"truncate max-w-[250px]",children:e.files[0].fileName})]}):(0,a.jsx)("span",{className:"text-gray-400",children:"-"})}),(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:(0,a.jsx)("span",{className:"px-2 py-1 bg-green-100 text-green-800 rounded font-medium",children:y.NK[e.status]||e.status})}),(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:g(e.updatedAt)})]},e.id))})]})})})]}),(0,a.jsx)(h.Z,{isOpen:!!O,file:O,onClose:()=>P(null)})]})}function N(){return(0,a.jsx)("div",{className:"h-full flex flex-col",children:(0,a.jsx)(b,{})})}function w(){return(0,a.jsx)(l.AuthGuard,{children:(0,a.jsx)(r.Suspense,{fallback:(0,a.jsx)("div",{className:"p-8 text-center",children:"Loading Dashboard..."}),children:(0,a.jsx)(N,{})})})}},7576:function(e,t,s){"use strict";s.d(t,{Z:function(){return o}});var a=s(7437),r=s(29),l=s.n(r),n=s(2265),i=s(4415),c=s(5884),d=s(2489);function o(e){let{isOpen:t,file:s,onClose:r}=e,[o,x]=(0,n.useState)(!1),[u,m]=(0,n.useState)(!1),[h]=(0,n.useState)("mozilla");if((0,n.useEffect)(()=>{let e=()=>{m(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),(0,n.useEffect)(()=>{let e=e=>{"Escape"===e.key&&t&&r()};return t&&(document.addEventListener("keydown",e),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",e),document.body.style.overflow="unset"}},[t,r]),!t||!s)return null;let f=o?"w-full h-full max-w-full max-h-full rounded-none":u?"w-full h-full max-w-full max-h-full rounded-none":"w-full max-w-6xl h-[95vh] rounded-lg";return(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-80 z-[60] flex items-center justify-center",children:(0,a.jsxs)("div",{className:"bg-white shadow-xl flex flex-col transition-all duration-300 ".concat(f),children:[(0,a.jsxs)("div",{className:"flex justify-between items-center p-3 border-b bg-gray-50 flex-shrink-0",children:[(0,a.jsx)("div",{className:"flex items-center space-x-3 flex-1 min-w-0",children:(0,a.jsx)("h3",{className:"text-sm sm:text-base font-semibold text-gray-800 truncate",title:s.fileName,children:s.fileName})}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[!u&&(0,a.jsx)("button",{onClick:()=>x(!o),className:"text-gray-500 hover:text-gray-800 p-2 rounded-md hover:bg-gray-200 transition-colors",title:o?"ออกจากโหมดเต็มจอ":"โหมดเต็มจอ",children:o?(0,a.jsx)(i.Z,{size:16}):(0,a.jsx)(c.Z,{size:16})}),(0,a.jsx)("button",{onClick:r,className:"text-gray-500 hover:text-gray-800 p-2 rounded-md hover:bg-gray-200 transition-colors",title:"ปิด",children:(0,a.jsx)(d.Z,{size:16})})]})]}),(0,a.jsxs)("div",{className:"jsx-c9fb4320352222b7 flex-1 relative overflow-hidden bg-gray-100",children:[(0,a.jsx)("iframe",{src:(()=>{let e=encodeURIComponent(s.fileUrl);return"https://mozilla.github.io/pdf.js/web/viewer.html?file=".concat(e,"#toolbar=1&navpanes=0&scrollbar=1")})(),title:"PDF Viewer - ".concat(s.fileName),allow:"fullscreen",loading:"lazy",style:{backgroundColor:"#ffffff",filter:"none"},className:"jsx-c9fb4320352222b7 w-full h-full border-0"}),(0,a.jsx)(l(),{id:"c9fb4320352222b7",children:"iframe.jsx-c9fb4320352222b7{}"})]}),u&&(0,a.jsx)("div",{className:"p-2 bg-gray-50 border-t text-center text-xs text-gray-600",children:"\uD83D\uDCA1 ใช้นิ้วสองนิ้วเพื่อซูม หรือแตะสองครั้งเพื่อซูมอัตโนมัติ"})]})})}},9761:function(e,t,s){"use strict";var a=s(7437);s(2265),t.Z=e=>{let{className:t}=e;return(0,a.jsx)("div",{className:"\n    inline-block h-8 w-8 animate-spin rounded-full \n    border-4 border-solid border-current border-e-transparent \n    align-[-0.125em] text-gray-400 motion-reduce:animate-[spin_1.5s_linear_infinite]\n    ".concat(t||"","\n  ").trim(),role:"status",children:(0,a.jsx)("span",{className:"!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]",children:"Loading..."})})}}},function(e){e.O(0,[609,15,134,184,731,971,997,744],function(){return e(e.s=3529)}),_N_E=e.O()}]);