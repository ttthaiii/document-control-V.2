"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[731],{7649:function(e,r,s){s.d(r,{AuthProvider:function(){return o},aC:function(){return E}});var t=s(7437),n=s(2265),l=s(2148),i=s(5978),a=s(6855);let c=null,d=(0,n.createContext)({user:null,firebaseUser:null,loading:!0,error:null,refetch:async()=>{},logout:async()=>{}});function o(e){let{children:r}=e,[s,o]=(0,n.useState)(null),[E,u]=(0,n.useState)(null),[N,m]=(0,n.useState)(!0),[I,h]=(0,n.useState)(null),x=async e=>{try{if(h(null),c&&c.firebaseUserId===e.uid&&Date.now()-c.timestamp<3e5){console.log("\uD83D\uDCCB Using cached user data for: ".concat(e.email)),u(c.user);return}console.log("\uD83D\uDD04 Fetching fresh user data for: ".concat(e.email));let t=(0,i.JU)(a.db,"users",e.uid),n=await (0,i.QT)(t);if(n.exists()){var r,s;let t=n.data(),l={id:e.uid,email:e.email||"",role:t.role,sites:t.sites||[],status:t.status||"ACTIVE",createdFromInvitation:t.createdFromInvitation,createdAt:null===(r=t.createdAt)||void 0===r?void 0:r.toDate(),acceptedAt:null===(s=t.acceptedAt)||void 0===s?void 0:s.toDate()};c={user:l,timestamp:Date.now(),firebaseUserId:e.uid},u(l)}else h("ไม่พบข้อมูลผู้ใช้ในระบบ"),u(null)}catch(e){console.error("Error fetching user data:",e),h("เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้"),u(null)}},P=async()=>{s&&(c=null,await x(s))};(0,n.useEffect)(()=>{let e=(0,l.Aj)(a.I,async e=>{(null==e?void 0:e.uid)===(null==s?void 0:s.uid)&&E||(m(!0),o(e),e?await x(e):(u(null),h(null),c=null),m(!1))});return()=>e()},[]);let D=async()=>{try{await (0,l.w7)(a.I),c=null,u(null),o(null),h(null)}catch(e){throw console.error("Logout error:",e),e}};return(0,t.jsx)(d.Provider,{value:{user:E,firebaseUser:s,loading:N,error:I,refetch:P,logout:D},children:r})}function E(){return(0,n.useContext)(d)}},731:function(e,r,s){s.d(r,{AuthGuard:function(){return c}});var t=s(7437),n=s(7649),l=s(9376),i=s(2265);s(453);let a=()=>(0,t.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,t.jsxs)("div",{className:"animate-pulse",children:[(0,t.jsx)("div",{className:"bg-white shadow",children:(0,t.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,t.jsxs)("div",{className:"flex justify-between items-center py-6",children:[(0,t.jsx)("div",{className:"h-8 bg-gray-200 rounded w-32"}),(0,t.jsx)("div",{className:"h-8 bg-gray-200 rounded w-24"})]})})}),(0,t.jsxs)("div",{className:"flex",children:[(0,t.jsx)("div",{className:"w-64 bg-white border-r border-gray-200 min-h-screen",children:(0,t.jsx)("div",{className:"p-4 space-y-3",children:[...Array(6)].map((e,r)=>(0,t.jsx)("div",{className:"h-10 bg-gray-100 rounded"},r))})}),(0,t.jsx)("div",{className:"flex-1 p-8",children:(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsx)("div",{className:"h-8 bg-gray-200 rounded w-1/3"}),(0,t.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[void 0,void 0,void 0].map((e,r)=>(0,t.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow",children:[(0,t.jsx)("div",{className:"h-4 bg-gray-200 rounded mb-2"}),(0,t.jsx)("div",{className:"h-8 bg-gray-200 rounded mb-4"}),(0,t.jsx)("div",{className:"h-4 bg-gray-200 rounded w-2/3"})]},r))})]})})]})]})});function c(e){let{children:r,requiredRoles:s=[],requiredSiteAccess:c=[],fallback:d,redirectTo:o="/login"}=e,{user:E,loading:u,error:N}=(0,n.aC)(),m=(0,l.useRouter)();return((0,i.useEffect)(()=>{u||E||m.push(o)},[E,u,m,o]),u)?(0,t.jsx)(a,{}):N?(0,t.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,t.jsx)("div",{className:"text-center max-w-md mx-auto",children:(0,t.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold text-red-800 mb-2",children:"เกิดข้อผิดพลาด"}),(0,t.jsx)("p",{className:"text-red-600 mb-4",children:N}),(0,t.jsx)("button",{onClick:()=>window.location.reload(),className:"bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors",children:"ลองใหม่"})]})})}):E?s.length>0&&!s.includes(E.role)?(0,t.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,t.jsx)("div",{className:"text-center max-w-md mx-auto",children:(0,t.jsxs)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-6",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold text-yellow-800 mb-2",children:"ไม่มีสิทธิ์เข้าถึง"}),(0,t.jsx)("p",{className:"text-yellow-700 mb-2",children:"คุณไม่มีสิทธิ์เข้าถึงหน้านี้"}),(0,t.jsxs)("p",{className:"text-sm text-yellow-600 mb-4",children:["ต้องการสิทธิ์: ",s.join(", ")," | สิทธิ์ปัจจุบัน: ",E.role]}),(0,t.jsx)("button",{onClick:()=>m.back(),className:"bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 transition-colors",children:"ย้อนกลับ"})]})})}):c.length>0&&"Admin"!==E.role&&!c.some(e=>{var r;return null===(r=E.sites)||void 0===r?void 0:r.includes(e)})?(0,t.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,t.jsx)("div",{className:"text-center max-w-md mx-auto",children:(0,t.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold text-red-800 mb-2",children:"ไม่มีสิทธิ์เข้าถึงโครงการ"}),(0,t.jsx)("p",{className:"text-red-600 mb-4",children:"คุณไม่มีสิทธิ์เข้าถึงโครงการที่ต้องการ"}),(0,t.jsx)("button",{onClick:()=>m.back(),className:"bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors",children:"ย้อนกลับ"})]})})}):(0,t.jsx)(t.Fragment,{children:r}):d?(0,t.jsx)(t.Fragment,{children:d}):(0,t.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"กรุณาเข้าสู่ระบบ"}),(0,t.jsx)("p",{className:"text-gray-600 mb-4",children:"คุณต้องเข้าสู่ระบบเพื่อเข้าถึงหน้านี้"}),(0,t.jsx)("button",{onClick:()=>m.push(o),className:"bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition-colors",children:"เข้าสู่ระบบ"})]})})}},453:function(e,r,s){s.d(r,{$p:function(){return c},Ge:function(){return o},K$:function(){return t},NK:function(){return E},c9:function(){return a},gf:function(){return i},n$:function(){return d},oU:function(){return l},uc:function(){return n},yh:function(){return u}});let t={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",ADMIN_SITE_2:"Adminsite2"},n=[t.BIM,t.ME,t.SN],l=[t.SITE_ADMIN,t.ADMIN_SITE_2,t.OE,t.PE],i=[t.CM,t.PD];t.PM,t.SE;let a=[t.PE,t.OE,t.ADMIN],c=[t.PD,t.PM,t.ADMIN],d={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},o={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},E={[d.PENDING_REVIEW]:"รอตรวจสอบ",[d.PENDING_CM_APPROVAL]:"ส่ง CM",[d.REVISION_REQUIRED]:"แก้ไข",[d.APPROVED]:"อนุมัติ",[d.APPROVED_WITH_COMMENTS]:"อนุมัติตามคอมเมนต์ (ไม่แก้ไข)",[d.APPROVED_REVISION_REQUIRED]:"อนุมัติตามคอมเมนต์ (ต้องแก้ไข)",[d.REJECTED]:"ไม่อนุมัติ",[d.PENDING_FINAL_APPROVAL]:"รอ SITE อนุมัติขั้นสุดท้าย",[o.DRAFT]:"รออนุมัติ (PM)",[o.REJECTED_BY_PM]:"ไม่อนุมัติ (PM)",[o.PENDING_BIM]:"รอ BIM รับงาน",[o.IN_PROGRESS]:"BIM กำลังดำเนินการ",[o.PENDING_ACCEPTANCE]:"รอตรวจรับ (Site)",[o.REVISION_REQUESTED]:"ขอแก้ไข (WR)",[o.COMPLETED]:"เสร็จสิ้น"},u={[d.PENDING_REVIEW]:"#0088FE",[d.PENDING_CM_APPROVAL]:"#00C49F",[d.REVISION_REQUIRED]:"#FFBB28",[d.APPROVED]:"#28A745",[d.REJECTED]:"#DC3545",[d.APPROVED_WITH_COMMENTS]:"#2f3e3aff",[d.APPROVED_REVISION_REQUIRED]:"#FD7E14",[o.DRAFT]:"#6c757d",[o.REJECTED_BY_PM]:"#DC3545",[o.PENDING_BIM]:"#0088FE",[o.IN_PROGRESS]:"#FFBB28",[o.PENDING_ACCEPTANCE]:"#AF19FF",[o.REVISION_REQUESTED]:"#FD7E14",[o.COMPLETED]:"#28A745"}},6855:function(e,r,s){s.d(r,{I:function(){return a},db:function(){return c}});var t=s(738),n=s(2148),l=s(5978);let i=(0,t.C6)().length>0?(0,t.C6)()[0]:(0,t.ZF)({apiKey:"AIzaSyAsayb-DEOBE0zi0qh-dPBfihClgXrX1sY",authDomain:"ttsdocumentcontrol.firebaseapp.com",projectId:"ttsdocumentcontrol",storageBucket:"ttsdocumentcontrol.firebasestorage.app",messagingSenderId:"48440915675",appId:"1:48440915675:web:f11611895bfb52d4d27efe"}),a=(0,n.v0)(i),c=(0,l.ad)(i);try{(0,l.ST)(c).then(()=>{console.log("✅ Firestore offline persistence enabled.")}).catch(e=>{"failed-precondition"==e.code?console.warn("Firestore persistence failed: Multiple tabs open. Persistence will be enabled in one tab only."):"unimplemented"==e.code&&console.warn("Firestore persistence is not supported in this browser.")})}catch(e){console.error("An error occurred while enabling Firestore persistence:",e)}}}]);