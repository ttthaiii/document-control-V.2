"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[476],{401:function(e,s,t){t.d(s,{Z:function(){return a}});let a=(0,t(9205).Z)("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]])},1817:function(e,s,t){t.d(s,{Z:function(){return a}});let a=(0,t(9205).Z)("loader-circle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},6865:function(e,s,t){t.d(s,{Z:function(){return a}});let a=(0,t(9205).Z)("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},2476:function(e,s,t){t.r(s),t.d(s,{default:function(){return T}});var a=t(7437),l=t(2265),r=t(9376),i=t(5978),n=t(6855),c=t(1313),d=t(9205);let o=(0,d.Z)("history",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]);var m=t(2489),x=t(8736),u=t(1817);let h=(0,d.Z)("paperclip",[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]]),f=(0,d.Z)("download",[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]]),p=(0,d.Z)("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]]);var g=t(401),b=t(6865);let j=(0,d.Z)("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]),N=(0,d.Z)("pen-line",[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]),y=(0,d.Z)("thumbs-up",[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]]),v=(0,d.Z)("message-square",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]]),w=(0,d.Z)("thumbs-down",[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z",key:"m61m77"}]]);var k=t(5946),E=t(453);let Z=e=>e?new Date(e).toLocaleString("th-TH",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A",C=e=>{if(0===e)return"0 B";let s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(1))+" "+["B","KB","MB","GB"][s]},z=e=>{let{workflow:s,onClose:t,userRole:r}=e,i=(0,l.useMemo)(()=>{if(r&&E.gf.includes(r)){let e=[E.n$.PENDING_REVIEW,E.n$.REVISION_REQUIRED];return s.filter(s=>!e.includes(s.status))}return s},[s,r]);return(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center p-4 border-b",children:[(0,a.jsxs)("h3",{className:"text-lg font-bold text-gray-800 flex items-center",children:[(0,a.jsx)(o,{size:20,className:"mr-2"}),"ประวัติการดำเนินงาน"]}),(0,a.jsx)("button",{onClick:t,className:"text-gray-400 hover:text-gray-600",children:(0,a.jsx)(m.Z,{size:24})})]}),(0,a.jsx)("div",{className:"p-6 overflow-y-auto",children:(0,a.jsx)("div",{className:"border-l-2 border-gray-200 ml-2",children:i.length>0?i.map((e,s)=>(0,a.jsxs)("div",{className:"relative pl-6 pb-8 last:pb-0",children:[(0,a.jsx)("div",{className:"absolute -left-[9px] top-1 w-4 h-4 bg-blue-500 rounded-full border-2 border-white"}),(0,a.jsx)("p",{className:"font-semibold text-gray-800",children:E.NK[e.status]||e.status}),(0,a.jsxs)("p",{className:"text-sm text-gray-600",children:["โดย: ",e.userName," (",e.role,")"]}),(0,a.jsx)("time",{className:"text-xs text-gray-400",children:Z(e.timestamp)}),e.comments&&(0,a.jsx)("div",{className:"mt-2 p-2 bg-gray-50 rounded-md text-xs italic",children:(0,a.jsxs)("p",{className:"text-gray-600",children:['"',e.comments,'"']})}),e.files&&e.files.length>0&&(0,a.jsxs)("div",{className:"mt-2 pl-2 border-l-2 border-gray-100",children:[(0,a.jsx)("p",{className:"text-xs font-semibold text-gray-500 mb-1",children:"ไฟล์แนบ ณ ขั้นตอนนี้:"}),(0,a.jsx)("ul",{className:"space-y-1",children:e.files.map((e,s)=>(0,a.jsxs)("li",{className:"flex items-center text-xs text-gray-600",children:[(0,a.jsx)(x.Z,{size:12,className:"mr-2 flex-shrink-0"}),(0,a.jsx)("a",{href:e.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"truncate hover:underline",title:e.fileName,children:e.fileName})]},s))})]})]},s)):(0,a.jsx)("p",{className:"text-sm text-gray-500 pl-6",children:"ไม่มีประวัติ"})})})]})})};function S(e){let{document:s,onClose:t,onUpdate:r,showOverlay:i=!0}=e,{user:n,firebaseUser:c}=(0,k.a)(),[d,Z]=(0,l.useState)(s),[S,M]=(0,l.useState)(!0),[R,T]=(0,l.useState)(!1),[I,D]=(0,l.useState)(!1),[O,A]=(0,l.useState)(""),[_,P]=(0,l.useState)([]),[V,B]=(0,l.useState)(""),[F,U]=(0,l.useState)([]);(0,l.useEffect)(()=>{(async()=>{if(!s||!c){M(!1);return}M(!0);try{let e=await c.getIdToken(),t=await fetch("/api/rfa/".concat(s.id),{headers:{Authorization:"Bearer ".concat(e)}}),a=await t.json();a.success?Z(a.document):(console.error("Failed to fetch full document:",a.error),Z(s))}catch(e){console.error("Error fetching full document:",e),Z(s)}finally{M(!1)}})()},[s,c]);let H=(0,l.useMemo)(()=>(null==d?void 0:d.workflow)&&0!==d.workflow.length?[...d.workflow].reverse().find(e=>e.comments&&""!==e.comments.trim()):null,[null==d?void 0:d.workflow]);if(S)return(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center",children:(0,a.jsx)(u.Z,{className:"w-12 h-12 text-white animate-spin"})});if(!d)return null;let L=d.permissions||{},J=d.files||[],q=d.createdBy===(null==n?void 0:n.id),Q=d.status===E.n$.REVISION_REQUIRED&&q,$=d.status===E.n$.REJECTED&&q&&d.isLatest,K=(d.revisionNumber||0)+1,G="".concat(d.documentNumber.split("-REV")[0],"-REV").concat(String(K).padStart(2,"0")),W=(null==H?void 0:H.comments)||d.description,X=async e=>{try{if(!c)throw Error("กรุณาล็อกอินก่อนอัปโหลดไฟล์");let s=await c.getIdToken(),t=new FormData;t.append("file",e);let a=await fetch("/api/rfa/upload-temp-file",{method:"POST",headers:{Authorization:"Bearer ".concat(s)},body:t}),l=await a.json();if(l.success)return{status:"success",progress:100,uploadedData:l.fileData};throw Error(l.error||"อัปโหลดล้มเหลว")}catch(e){return{status:"error",error:e instanceof Error?e.message:"เกิดข้อผิดพลาด"}}},Y=(e,s)=>{let t=Array.from(e.target.files||[]);if(!t.length)return;let a=t.map(e=>({id:"".concat(e.name,"-").concat(Date.now()),file:e,status:"pending",progress:0})),l="revision"===s?U:P;l(e=>[...e,...a]),a.forEach(async e=>{l(s=>s.map(s=>s.id===e.id?{...s,status:"uploading"}:s));let s=await X(e.file);l(t=>t.map(t=>t.id===e.id?{...t,...s}:t))}),e.target.value=""},ee=async(e,s)=>{var t;let a=("revision"===s?F:_)[e];if("success"===a.status&&(null===(t=a.uploadedData)||void 0===t?void 0:t.filePath))try{let e=await (null==c?void 0:c.getIdToken());await fetch("/api/rfa/delete-temp-file",{method:"POST",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},body:JSON.stringify({filePath:a.uploadedData.filePath})})}catch(e){console.error("Failed to delete temp file:",e)}("revision"===s?U:P)(s=>s.filter((s,t)=>t!==e))},es=async e=>{let s=_.filter(e=>"success"===e.status);if(0===s.length){alert("กรุณาแนบไฟล์ใหม่สำหรับขั้นตอนนี้ก่อนดำเนินการ");return}T(!0);try{let a=await (null==c?void 0:c.getIdToken()),l={action:e,comments:O,newFiles:s.map(e=>e.uploadedData)},r=await fetch("/api/rfa/".concat(d.id),{method:"PUT",headers:{Authorization:"Bearer ".concat(a),"Content-Type":"application/json"},body:JSON.stringify(l)}),i=await r.json();if(i.success)alert('ดำเนินการ "'.concat(e,'" สำเร็จ!')),t();else throw Error(i.error||"เกิดข้อผิดพลาด")}catch(e){alert("เกิดข้อผิดพลาด: ".concat(e instanceof Error?e.message:"Unknown error"))}finally{T(!1)}},et=async()=>{let e=F.filter(e=>"success"===e.status);if(0===e.length){alert("กรุณาแนบไฟล์ฉบับแก้ไขอย่างน้อย 1 ไฟล์");return}T(!0);try{let s=await (null==c?void 0:c.getIdToken()),a={originalDocId:d.id,uploadedFiles:e.map(e=>e.uploadedData),comments:V},l=await fetch("/api/rfa/create_revision",{method:"POST",headers:{Authorization:"Bearer ".concat(s),"Content-Type":"application/json"},body:JSON.stringify(a)}),r=await l.json();if(r.success)alert("สร้างเอกสารฉบับแก้ไข ".concat(G," สำเร็จ!")),t();else throw Error(r.error||"เกิดข้อผิดพลาดในการสร้าง Revision")}catch(e){alert("เกิดข้อผิดพลาด: ".concat(e instanceof Error?e.message:"Unknown error"))}finally{T(!1)}},ea=async()=>{await es("SUBMIT_REVISION")};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 ".concat(i?"bg-black bg-opacity-50":""),children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center p-4 border-b",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-blue-600",children:d.runningNumber||"RFA Document"}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:d.documentNumber})]}),(0,a.jsxs)("button",{onClick:()=>D(!0),className:"flex items-center text-sm text-gray-500 hover:text-blue-600",children:[(0,a.jsx)(o,{size:16,className:"mr-1"})," ดูประวัติ"]})]}),(0,a.jsx)("button",{onClick:t,className:"text-gray-400 hover:text-gray-600",children:(0,a.jsx)(m.Z,{size:24})})]}),(0,a.jsxs)("div",{className:"p-6 overflow-y-auto space-y-6",children:[(0,a.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:d.title}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{className:"text-gray-500 block",children:"สถานะ:"}),(0,a.jsx)("span",{className:"font-semibold",children:E.NK[d.status]||d.status})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{className:"text-gray-500 block",children:"หมวดงาน:"}),(0,a.jsx)("span",{children:d.category.categoryCode})]})]}),W&&""!==W.trim()&&(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsxs)("strong",{className:"text-gray-500 block text-sm",children:[H?"ความคิดเห็นล่าสุด":"รายละเอียดเพิ่มเติม",":"]}),(0,a.jsx)("div",{className:"text-gray-700 whitespace-pre-wrap bg-white p-3 rounded-md mt-1 border",children:(0,a.jsxs)("p",{className:"italic",children:['"',W,'"']})})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("h4",{className:"text-md font-semibold mb-2 flex items-center",children:[(0,a.jsx)(h,{size:16,className:"mr-2"})," ไฟล์แนบ (ฉบับล่าสุด) (",J.length,")"]}),(0,a.jsx)("ul",{className:"space-y-2",children:J.length>0?J.map((e,s)=>(0,a.jsxs)("li",{className:"flex items-center justify-between bg-gray-50 p-2 rounded-md",children:[(0,a.jsxs)("div",{className:"flex items-center min-w-0",children:[(0,a.jsx)(x.Z,{className:"w-5 h-5 text-gray-500 mr-3 flex-shrink-0"}),(0,a.jsxs)("div",{className:"flex flex-col min-w-0",children:[(0,a.jsx)("span",{className:"text-sm font-medium text-gray-800 truncate",children:e.fileName}),(0,a.jsx)("span",{className:"text-xs text-gray-500",children:C(e.size)})]})]}),(0,a.jsx)("a",{href:e.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-100 flex-shrink-0 ml-2",children:(0,a.jsx)(f,{size:18})})]},s)):(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"ไม่มีไฟล์แนบในฉบับล่าสุด"})})]})]}),(0,a.jsxs)("div",{className:"p-4 border-t bg-gray-50 rounded-b-lg",children:[Q&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-blue-800",children:"ส่งเอกสารที่แก้ไข (Submit Revision)"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"แสดงความคิดเห็น (Optional)"}),(0,a.jsx)("textarea",{value:O,onChange:e=>A(e.target.value),placeholder:"เพิ่มความคิดเห็น/เหตุผลประกอบ...",className:"w-full p-2 border rounded-md text-sm",rows:2})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"แนบไฟล์ที่แก้ไขแล้ว (จำเป็น)"}),(0,a.jsxs)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[(0,a.jsx)("input",{type:"file",multiple:!0,onChange:e=>Y(e,"resubmission"),className:"hidden",id:"resubmit-file-upload"}),(0,a.jsxs)("label",{htmlFor:"resubmit-file-upload",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[(0,a.jsx)(p,{size:16,className:"mr-2"}),"คลิกเพื่อเลือกไฟล์"]})]}),(0,a.jsx)("div",{className:"mt-2 space-y-2",children:_.map((e,s)=>(0,a.jsxs)("div",{className:"flex items-center text-sm p-2 bg-gray-100 rounded",children:[(0,a.jsx)(x.Z,{className:"w-4 h-4 mr-2 text-gray-500"}),(0,a.jsx)("span",{className:"flex-1 truncate",children:e.file.name}),"uploading"===e.status&&(0,a.jsx)(u.Z,{className:"w-4 h-4 animate-spin text-blue-500"}),"success"===e.status&&(0,a.jsx)(g.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&(0,a.jsx)("span",{title:e.error,children:(0,a.jsx)(b.Z,{className:"w-4 h-4 text-red-500"})}),(0,a.jsx)("button",{onClick:()=>ee(s,"resubmission"),className:"ml-2 text-gray-500 hover:text-red-600",children:(0,a.jsx)(m.Z,{size:16})})]},e.id))})]}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsxs)("button",{onClick:ea,disabled:R||0===_.filter(e=>"success"===e.status).length,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-gray-300",children:[R?(0,a.jsx)(u.Z,{className:"animate-spin mr-2"}):(0,a.jsx)(j,{size:16,className:"mr-2"}),"ส่งกลับไปตรวจสอบ"]})})]}),d.status===E.n$.REJECTED&&!d.isLatest&&(0,a.jsxs)("div",{className:"p-4 bg-red-50 text-red-800 rounded-lg flex items-center",children:[(0,a.jsx)(b.Z,{size:24,className:"mr-3 flex-shrink-0 text-red-600"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"font-bold",children:"เอกสารฉบับนี้ถูกแทนที่แล้ว"}),(0,a.jsxs)("p",{className:"text-sm text-red-700",children:["ได้มีการสร้างเอกสารฉบับใหม่ ",(0,a.jsxs)("strong",{children:["(REV-",String((d.revisionNumber||0)+1).padStart(2,"0"),")"]})," จากเอกสารฉบับนี้แล้ว"]})]})]}),$&&(0,a.jsxs)("div",{className:"p-4 border-t bg-yellow-50 rounded-b-lg",children:[(0,a.jsx)("h3",{className:"text-lg font-bold text-yellow-800 mb-4",children:"สร้างเอกสารฉบับแก้ไข (Create New Revision)"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"เอกสารเดิม:"})," ",d.documentNumber]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"เอกสารใหม่:"})," ",G]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"แนบไฟล์ที่แก้ไขแล้ว (จำเป็น)"}),(0,a.jsxs)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[(0,a.jsx)("input",{type:"file",multiple:!0,onChange:e=>Y(e,"revision"),className:"hidden",id:"revision-file-upload"}),(0,a.jsxs)("label",{htmlFor:"revision-file-upload",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[(0,a.jsx)(p,{size:16,className:"mr-2"}),"คลิกเพื่อเลือกไฟล์"]})]}),(0,a.jsx)("div",{className:"mt-2 space-y-2",children:F.map((e,s)=>(0,a.jsxs)("div",{className:"flex items-center text-sm p-2 bg-gray-100 rounded",children:[(0,a.jsx)(x.Z,{className:"w-4 h-4 mr-2 text-gray-500"}),(0,a.jsx)("span",{className:"flex-1 truncate",children:e.file.name}),"uploading"===e.status&&(0,a.jsx)(u.Z,{className:"w-4 h-4 animate-spin text-blue-500"}),"success"===e.status&&(0,a.jsx)(g.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&(0,a.jsx)("span",{title:e.error,children:(0,a.jsx)(b.Z,{className:"w-4 h-4 text-red-500"})}),(0,a.jsx)("button",{onClick:()=>ee(s,"revision"),className:"ml-2 text-gray-500 hover:text-red-600",children:(0,a.jsx)(m.Z,{size:16})})]},e.id))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"หมายเหตุการแก้ไข (Optional)"}),(0,a.jsx)("textarea",{value:V,onChange:e=>B(e.target.value),placeholder:"เช่น แก้ไขตาม Comment จาก CM...",className:"w-full p-2 border rounded-md text-sm",rows:2})]}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsxs)("button",{onClick:et,disabled:R||0===F.filter(e=>"success"===e.status).length,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-gray-300",children:[R?(0,a.jsx)(u.Z,{className:"animate-spin mr-2"}):(0,a.jsx)(j,{size:16,className:"mr-2"}),"ส่งเอกสารฉบับแก้ไข"]})})]})]}),!$&&!Q&&(L.canSendToCm||L.canApprove)&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"แสดงความคิดเห็น (Optional)"}),(0,a.jsx)("textarea",{value:O,onChange:e=>A(e.target.value),placeholder:"เพิ่มความคิดเห็น/เหตุผลประกอบ...",className:"w-full p-2 border rounded-md text-sm",rows:2})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium text-gray-700 mb-1 block",children:"แนบไฟล์ใหม่ (จำเป็น)"}),(0,a.jsxs)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[(0,a.jsx)("input",{type:"file",multiple:!0,onChange:e=>Y(e,"action"),className:"hidden",id:"action-file-upload"}),(0,a.jsxs)("label",{htmlFor:"action-file-upload",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[(0,a.jsx)(p,{size:16,className:"mr-2"}),"คลิกเพื่อเลือกไฟล์"]})]}),(0,a.jsx)("div",{className:"mt-2 space-y-2",children:_.map((e,s)=>(0,a.jsxs)("div",{className:"flex items-center text-sm p-2 bg-gray-100 rounded",children:[(0,a.jsx)(x.Z,{className:"w-4 h-4 mr-2 text-gray-500"}),(0,a.jsx)("span",{className:"flex-1 truncate",children:e.file.name}),"uploading"===e.status&&(0,a.jsx)(u.Z,{className:"w-4 h-4 animate-spin text-blue-500"}),"success"===e.status&&(0,a.jsx)(g.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&(0,a.jsx)("span",{title:e.error,children:(0,a.jsx)(b.Z,{className:"w-4 h-4 text-red-500"})}),(0,a.jsx)("button",{onClick:()=>ee(s,"action"),className:"ml-2 text-gray-500 hover:text-red-600",children:(0,a.jsx)(m.Z,{size:16})})]},e.id))})]}),L.canSendToCm&&(0,a.jsxs)("div",{className:"flex justify-end space-x-3",children:[(0,a.jsxs)("button",{onClick:()=>es("REQUEST_REVISION"),disabled:R||0===_.filter(e=>"success"===e.status).length,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-yellow-500 rounded-lg hover:bg-yellow-600 disabled:bg-gray-300",children:[(0,a.jsx)(N,{size:16,className:"mr-2"}),"ขอแก้ไข"]}),(0,a.jsxs)("button",{onClick:()=>es("SEND_TO_CM"),disabled:R||0===_.filter(e=>"success"===e.status).length,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-gray-300",children:[(0,a.jsx)(j,{size:16,className:"mr-2"}),"ส่งให้ CM"]})]}),L.canApprove&&(0,a.jsxs)("div",{className:"flex flex-wrap justify-end gap-3",children:[(0,a.jsxs)("button",{onClick:()=>es("APPROVE"),disabled:R||0===_.filter(e=>"success"===e.status).length,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-gray-300",children:[(0,a.jsx)(y,{size:16,className:"mr-2"}),"อนุมัติ (Approve)"]}),(0,a.jsxs)("button",{onClick:()=>es("APPROVE_WITH_COMMENTS"),disabled:R||0===_.filter(e=>"success"===e.status).length,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700 disabled:bg-gray-300",children:[(0,a.jsx)(v,{size:16,className:"mr-2"}),"อนุมัติตามคอมเมนต์"]}),(0,a.jsxs)("button",{onClick:()=>es("APPROVE_REVISION_REQUIRED"),disabled:R||0===_.filter(e=>"success"===e.status).length,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-orange-500 rounded-lg hover:bg-orange-600 disabled:bg-gray-300",children:[(0,a.jsx)(N,{size:16,className:"mr-2"}),"อนุมัติแต่ต้องแก้ไข"]}),(0,a.jsxs)("button",{onClick:()=>es("REJECT"),disabled:R||0===_.filter(e=>"success"===e.status).length,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:bg-gray-300",children:[(0,a.jsx)(w,{size:16,className:"mr-2"}),"ไม่อนุมัติ (Reject)"]})]})]})]})]})}),I&&(0,a.jsx)(z,{workflow:d.workflow||[],onClose:()=>D(!1),userRole:null==n?void 0:n.role})]})}var M=t(731);function R(){let e=(0,r.useRouter)(),s=(0,r.useParams)(),[t,d]=(0,l.useState)(null),[o,m]=(0,l.useState)(!0),[x,u]=(0,l.useState)(null),h=s.id;return(0,l.useEffect)(()=>{h&&(async()=>{m(!0);try{let e=(0,i.JU)(n.db,"rfaDocuments",h),s=await (0,i.QT)(e);s.exists()?d({id:s.id,...s.data()}):u("ไม่พบเอกสาร")}catch(e){u("เกิดข้อผิดพลาดในการโหลดข้อมูล")}finally{m(!1)}})()},[h]),(0,a.jsx)(c.Z,{children:(0,a.jsx)(S,{document:t,onClose:()=>e.back(),onUpdate:e=>d(e)})})}function T(){return(0,a.jsx)(l.Suspense,{fallback:(0,a.jsx)("div",{children:"Loading Page..."}),children:(0,a.jsx)(M.a1,{children:(0,a.jsx)(R,{})})})}}}]);