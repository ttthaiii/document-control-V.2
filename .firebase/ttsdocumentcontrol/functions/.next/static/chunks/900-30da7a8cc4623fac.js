"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[900],{3900:function(e,t,a){a.d(t,{Z:function(){return p}});var s=a(7437),l=a(2265),r=a(2489),i=a(8736),o=a(401),d=a(6865),c=a(7649);let n=()=>{let[e,t]=(0,l.useState)(!1),[a,s]=(0,l.useState)(null),{firebaseUser:r}=(0,c.aC)(),i=(0,l.useCallback)(async(e,t)=>{if(!r)throw Error("User not authenticated");let a=await r.getIdToken(),s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a)},body:JSON.stringify(t)}),l=await s.json();if(!l.success)throw Error(l.error||"Request failed");return l.data},[r]);return{loading:e,error:a,getProjects:(0,l.useCallback)(async e=>{t(!0),s(null);try{return(await i("/api/google-sheets/projects",e)).projects}catch(e){throw s(e.message),e}finally{t(!1)}},[i]),getCategories:(0,l.useCallback)(async(e,a,l)=>{t(!0),s(null);try{return(await i("/api/google-sheets/categories",{...e,projectName:a,rfaType:l})).categories}catch(e){throw s(e.message),e}finally{t(!1)}},[i]),getTasks:(0,l.useCallback)(async(e,a,l)=>{t(!0),s(null);try{return(await i("/api/google-sheets/tasks",{...e,projectName:a,category:l})).tasks}catch(e){throw s(e.message),e}finally{t(!1)}},[i]),clearError:()=>s(null)}};var u=a(9761),m=a(453);let x={rfaType:"",categoryId:"",documentNumber:"",title:"",description:"",revisionNumber:"00",uploadedFiles:[],selectedProject:"",selectedCategory:"",selectedTask:null},h={"RFA-SHOP":{title:"RFA-SHOP",subtitle:"Shop Drawing Approval",icon:"\uD83C\uDFD7️",description:"สำหรับการขออนุมัติ Shop Drawing",workflow:"ผู้สร้าง → Site Admin → CM",allowedRoles:[m.K$.BIM,m.K$.ME,m.K$.SN,m.K$.SITE_ADMIN,m.K$.ADMIN],color:"blue"},"RFA-GEN":{title:"RFA-GEN",subtitle:"General Submission",icon:"\uD83D\uDCCB",description:"สำหรับการส่งเอกสารทั่วไป",workflow:"ผู้สร้าง → CM",allowedRoles:[m.K$.BIM,m.K$.SITE_ADMIN,m.K$.ADMIN,m.K$.ME,m.K$.SN],color:"green"},"RFA-MAT":{title:"RFA-MAT",subtitle:"Material Approval",icon:"\uD83E\uDDF1",description:"สำหรับการขออนุมัติวัสดุ",workflow:"Site Admin → CM",allowedRoles:[m.K$.SITE_ADMIN,m.K$.ADMIN],color:"orange"}};function p(e){var t,a;let{onClose:p,isModal:g=!1,userProp:f,presetRfaType:y}=e,b=y?2:1,[N,j]=(0,l.useState)(b),[v,w]=(0,l.useState)({...x,rfaType:y||""}),[k,T]=(0,l.useState)(!1),[C,F]=(0,l.useState)({}),[I,S]=(0,l.useState)(!1),[D,E]=(0,l.useState)([]),[A,M]=(0,l.useState)([]),[R,P]=(0,l.useState)([]),[K,$]=(0,l.useState)(""),{firebaseUser:O}=(0,c.aC)(),{loading:B,error:z,getCategories:Z,getTasks:U}=n(),[_,G]=(0,l.useState)(""),[H,J]=(0,l.useState)([]),L=f&&(f.role===m.K$.ME||f.role===m.K$.SN);(0,l.useEffect)(()=>{y&&(q({rfaType:y}),j(2))},[y]),(0,l.useEffect)(()=>{(async()=>{if(O){T(!0);try{let e=await O.getIdToken(),t=await fetch("/api/sites",{headers:{Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();E(e.sites||[])}}catch(e){console.error("Error loading sites:",e)}finally{T(!1)}}})()},[O]),(0,l.useEffect)(()=>()=>{v.uploadedFiles.forEach(e=>{var t;(null===(t=e.uploadedData)||void 0===t?void 0:t.filePath)&&X(e.uploadedData.filePath)})},[]);let q=e=>{w(t=>({...t,...e}));let t={...C};Object.keys(e).forEach(e=>delete t[e]),F(t)},Q=e=>{let t={};switch(e){case 1:if(v.rfaType){let e=h[v.rfaType];f&&!e.allowedRoles.includes(f.role)&&(t.rfaType="คุณไม่มีสิทธิ์สร้าง ".concat(v.rfaType))}else t.rfaType="กรุณาเลือกประเภท RFA";break;case 2:v.title.trim()||(t.title="กรุณาใส่หัวข้อเอกสาร"),v.revisionNumber.trim()||(t.revisionNumber="กรุณาใส่ Rev. No."),v.documentNumber.trim()||(t.documentNumber="กรุณาใส่เลขที่เอกสาร"),K||(t.site="กรุณาเลือกโครงการ"),L?v.categoryId.trim()||(t.categoryId="กรุณากรอกหมวดงาน"):v.selectedTask||(t.task="กรุณาเลือกงานจาก Google Sheets");break;case 3:0===v.uploadedFiles.filter(e=>"success"===e.status).length&&(t.files="กรุณาอัปโหลดไฟล์ให้สำเร็จก่อน")}return F(t),0===Object.keys(t).length},V=async()=>{if(Q(3)){S(!0);try{var e;if(!O)throw Error("กรุณาล็อกอินก่อน");let t=await O.getIdToken(),a=v.uploadedFiles.filter(e=>"success"===e.status&&e.uploadedData);if(0===a.length)throw Error("กรุณาอัปโหลดไฟล์ให้สำเร็จอย่างน้อย 1 ไฟล์");let s=L?v.categoryId:null===(e=v.selectedTask)||void 0===e?void 0:e.taskCategory,l=L?null:v.selectedTask;if(!s)throw Error("ไม่สามารถระบุ Category ID ได้ กรุณาตรวจสอบข้อมูล");let r={rfaType:v.rfaType,title:v.title,description:v.description,siteId:K,documentNumber:v.documentNumber,revisionNumber:parseInt(v.revisionNumber,10)||0,uploadedFiles:a.map(e=>({fileName:e.uploadedData.fileName,fileUrl:e.uploadedData.fileUrl,filePath:e.uploadedData.filePath,fileSize:e.uploadedData.size,fileType:e.uploadedData.contentType})),categoryId:s,taskData:l},i=await fetch("/api/rfa/create",{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({payload:r})}),o=await i.json();if(!i.ok)throw Error(o.error||"HTTP error! status: ".concat(i.status));if(o.success)alert("สร้าง RFA สำเร็จ! หมายเลขเอกสาร: ".concat(o.runningNumber)),p&&p();else throw Error(o.error||"เกิดข้อผิดพลาดในการสร้างเอกสาร")}catch(e){console.error("Submit Error:",e),F({general:e instanceof Error?e.message:"เกิดข้อผิดพลาดที่ไม่รู้จัก"})}finally{S(!1)}}},W=async e=>{let t={id:"".concat(e.name,"-").concat(Date.now()),file:e,status:"uploading",progress:0,retryCount:0};try{if(!O)throw Error("User not authenticated");let a=await O.getIdToken(),s=new FormData;s.append("file",e);let l=await fetch("/api/rfa/upload-temp-file",{method:"POST",headers:{Authorization:"Bearer ".concat(a)},body:s}),r=await l.json();if(r.success)return{...t,status:"success",progress:100,uploadedData:r.fileData};throw Error(r.error||"Upload failed")}catch(e){return{...t,status:"error",error:e instanceof Error?e.message:"Upload error"}}},X=async e=>{try{if(!O)return;let t=await O.getIdToken();await fetch("/api/rfa/delete-temp-file",{method:"POST",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"},body:JSON.stringify({filePath:e})})}catch(e){console.error("Failed to delete temp file:",e)}},Y=async e=>{let t=Array.from(e.target.files||[]);if(!t.length)return;let a=t.map(e=>({id:"".concat(e.name,"-").concat(Date.now()),file:e,status:"pending",progress:0,retryCount:0}));for(let e of(w(e=>({...e,uploadedFiles:[...e.uploadedFiles,...a]})),a)){w(t=>({...t,uploadedFiles:t.uploadedFiles.map(t=>t.id===e.id?{...t,status:"uploading"}:t)}));let t=await W(e.file);w(a=>({...a,uploadedFiles:a.uploadedFiles.map(a=>a.id===e.id?{...a,...t}:a)}))}e.target.value=""},ee=e=>{var t;let a=v.uploadedFiles[e];(null===(t=a.uploadedData)||void 0===t?void 0:t.filePath)&&X(a.uploadedData.filePath),q({uploadedFiles:v.uploadedFiles.filter((t,a)=>a!==e)})},et=async e=>{if($(e),q({categoryId:"",selectedCategory:"",selectedTask:null}),J([]),M([]),P([]),G(""),!e)return;let t=D.find(t=>t.id===e);if(t){if(L){if(O){T(!0);try{let t=await O.getIdToken(),a=await fetch("/api/sites/".concat(e,"/categories"),{headers:{Authorization:"Bearer ".concat(t)}}),s=await a.json();s.success&&J(s.categories)}catch(e){console.error("Failed to fetch site categories:",e),F(e=>({...e,site:"ไม่สามารถโหลดหมวดงานได้"}))}finally{T(!1)}}}else{q({selectedProject:t.name});try{let e=await Z({sheetId:t.sheetId||""},t.name,v.rfaType);M(e)}catch(e){console.error("Failed to fetch categories from BIM-Tracking:",e),F(e=>({...e,site:"ไม่สามารถโหลดหมวดงานจากระบบ BIM-Tracking ได้"}))}}}},ea=async e=>{q({selectedCategory:e,selectedTask:null}),P([]);let t=D.find(e=>e.id===K);if(t&&v.selectedProject)try{let a=await U({sheetId:t.sheetId||""},v.selectedProject,e);P(a)}catch(e){console.error(e)}},es=e=>{q({selectedTask:e,title:"".concat(e.taskName," - RFA")}),G(e.taskName)},el=(0,l.useMemo)(()=>_?R.filter(e=>e.taskName.toLowerCase().includes(_.toLowerCase())):R.slice(0,20),[R,_]);return(0,s.jsxs)("div",{className:"".concat(g?"max-w-4xl w-full mx-auto":""," bg-white rounded-lg shadow-xl flex flex-col h-full max-h-[95vh]"),children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-6 border-b bg-gray-50",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("h2",{className:"text-2xl font-bold text-gray-900",children:["สร้าง RFA Document",y&&h[y]&&(0,s.jsxs)("span",{className:"font-medium text-gray-600",children:[" - ",h[y].subtitle]})]}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:f&&"โดย ".concat(f.email," (").concat(f.role,")")})]}),p&&(0,s.jsx)("button",{onClick:p,className:"text-gray-400 hover:text-gray-600",children:(0,s.jsx)(r.Z,{})})]}),(0,s.jsxs)("div",{className:"flex-1 p-6 overflow-y-auto",children:[1===N&&(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:Object.entries(h).map(e=>{let[t,a]=e,l=!!f&&a.allowedRoles.includes(f.role);return(0,s.jsxs)("div",{onClick:()=>l&&q({rfaType:t}),className:"p-6 border-2 rounded-lg text-center cursor-pointer ".concat(v.rfaType===t?"border-blue-500 bg-blue-50":l?"border-gray-200 hover:border-gray-300":"border-gray-100 bg-gray-50 opacity-60 cursor-not-allowed"),children:[(0,s.jsx)("div",{className:"text-4xl mb-2",children:a.icon}),(0,s.jsx)("h4",{className:"font-semibold",children:a.title}),(0,s.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:a.description})]},t)})}),2===N&&(0,s.jsxs)("div",{className:"space-y-6 max-w-2xl mx-auto",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"โครงการ"}),(0,s.jsxs)("select",{value:K,onChange:e=>et(e.target.value),className:"w-full p-3 border rounded-lg",children:[(0,s.jsx)("option",{value:"",children:"-- เลือกโครงการ --"}),D.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]}),C.site&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.site})]}),L?(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"category-manual-input",className:"block text-sm font-medium text-gray-700 mb-2",children:"หมวดงาน"}),(0,s.jsx)("input",{id:"category-manual-input",type:"text",list:"category-list",value:v.categoryId,onChange:e=>q({categoryId:e.target.value}),placeholder:"พิมพ์เพื่อค้นหา หรือกรอกหมวดงานใหม่",className:"w-full p-3 border rounded-lg",disabled:!K}),(0,s.jsx)("datalist",{id:"category-list",children:H.map(e=>(0,s.jsx)("option",{value:e.categoryCode},e.id))}),C.categoryId&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.categoryId})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center",children:["หมวดงาน",B&&(0,s.jsx)(u.Z,{className:"w-4 h-4 ml-2"})]}),(0,s.jsxs)("select",{value:v.selectedCategory,onChange:e=>ea(e.target.value),className:"w-full p-3 border rounded-lg disabled:bg-gray-100",disabled:!K||B,children:[(0,s.jsx)("option",{value:"",children:B?"กำลังโหลด...":"-- เลือกหมวดงาน --"}),A.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),z&&(0,s.jsxs)("p",{className:"text-red-600 text-sm mt-1",children:["Error: ",z]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ค้นหางาน"}),(0,s.jsx)("input",{type:"text",placeholder:"ค้นหา...",value:_,onChange:e=>G(e.target.value),className:"w-full p-3 border rounded-lg",disabled:!v.selectedCategory||B}),(0,s.jsx)("div",{className:"mt-2 max-h-48 overflow-y-auto border rounded-lg",children:el.map(e=>{var t;return(0,s.jsx)("div",{onClick:()=>es(e),className:"p-2 cursor-pointer hover:bg-gray-100 ".concat((null===(t=v.selectedTask)||void 0===t?void 0:t.taskName)===e.taskName?"bg-blue-50":""),children:e.taskName},e.taskUid||e.taskName)})}),C.task&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.task})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[(0,s.jsxs)("div",{className:"sm:col-span-2",children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"เลขที่เอกสาร"}),(0,s.jsx)("input",{type:"text",value:v.documentNumber,onChange:e=>q({documentNumber:e.target.value}),className:"w-full p-3 border rounded-lg"}),C.documentNumber&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.documentNumber})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Rev. No."}),(0,s.jsx)("input",{type:"text",value:v.revisionNumber,onChange:e=>q({revisionNumber:e.target.value}),className:"w-full p-3 border rounded-lg"}),C.revisionNumber&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.revisionNumber})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"หัวข้อเอกสาร"}),(0,s.jsx)("input",{type:"text",value:v.title,onChange:e=>q({title:e.target.value}),className:"w-full p-3 border rounded-lg"}),C.title&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.title})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"รายละเอียด"}),(0,s.jsx)("textarea",{value:v.description,onChange:e=>q({description:e.target.value}),rows:3,className:"w-full p-3 border rounded-lg"})]})]}),3===N&&(0,s.jsxs)("div",{className:"space-y-6 max-w-2xl mx-auto",children:[(0,s.jsxs)("div",{className:"border-2 border-dashed rounded-lg p-8 text-center",children:[(0,s.jsx)("input",{type:"file",multiple:!0,onChange:Y,id:"file-upload",className:"hidden"}),(0,s.jsx)("label",{htmlFor:"file-upload",className:"cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg",children:"เลือกไฟล์"})]}),v.uploadedFiles.length>0&&(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"font-medium text-gray-800 mb-2",children:"ไฟล์ที่อัปโหลด"}),(0,s.jsx)("div",{className:"space-y-2",children:v.uploadedFiles.map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center text-sm p-2 bg-gray-100 rounded",children:[(0,s.jsx)(i.Z,{className:"w-4 h-4 mr-3 text-gray-500 flex-shrink-0"}),(0,s.jsx)("span",{className:"flex-1 truncate",title:e.file.name,children:e.file.name}),(0,s.jsxs)("div",{className:"flex items-center ml-3",children:["uploading"===e.status&&(0,s.jsx)(u.Z,{className:"w-4 h-4"}),"success"===e.status&&(0,s.jsx)(o.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&(0,s.jsx)("span",{title:e.error,children:(0,s.jsx)(d.Z,{className:"w-4 h-4 text-red-500"})}),(0,s.jsx)("button",{onClick:()=>ee(t),className:"ml-3 text-gray-500 hover:text-red-600",children:(0,s.jsx)(r.Z,{size:16})})]})]},e.id))})]}),C.files&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1",children:C.files})]}),4===N&&(0,s.jsxs)("div",{className:"space-y-4 max-w-2xl mx-auto",children:[(0,s.jsx)("h3",{className:"text-xl font-semibold text-center text-gray-800",children:"ตรวจสอบข้อมูล"}),(0,s.jsxs)("div",{className:"p-6 bg-gray-50 rounded-lg border border-gray-200 space-y-4",children:[(0,s.jsxs)("div",{className:"space-y-2 text-base",children:[(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"โครงการ:"}),(0,s.jsx)("span",{className:"font-semibold text-gray-800",children:null===(t=D.find(e=>e.id===K))||void 0===t?void 0:t.name})]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"ประเภท:"}),(0,s.jsx)("span",{className:"font-semibold text-gray-800",children:v.rfaType})]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"หมวดงาน:"}),(0,s.jsx)("span",{className:"font-semibold text-gray-800",children:L?v.categoryId:null===(a=v.selectedTask)||void 0===a?void 0:a.taskCategory})]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"เลขที่เอกสาร:"}),(0,s.jsx)("span",{className:"font-semibold text-gray-800",children:v.documentNumber})]}),(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"Rev.:"}),(0,s.jsx)("span",{className:"font-semibold text-gray-800",children:v.revisionNumber})]})]}),(0,s.jsxs)("div",{className:"pt-4 border-t border-gray-200",children:[(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"หัวข้อ:"}),(0,s.jsx)("p",{className:"text-base font-semibold text-gray-800 mt-1 break-words",children:v.title})]}),(0,s.jsxs)("div",{className:"pt-4 border-t border-gray-200",children:[(0,s.jsxs)("h4",{className:"text-sm font-medium text-gray-500",children:["ไฟล์แนบ (",v.uploadedFiles.filter(e=>"success"===e.status).length," ไฟล์):"]}),(0,s.jsx)("ul",{className:"list-disc list-inside mt-2 space-y-1 text-base",children:v.uploadedFiles.filter(e=>"success"===e.status).map(e=>(0,s.jsx)("li",{className:"truncate text-gray-800",title:e.file.name,children:e.file.name},e.id))})]})]})]})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center p-6 border-t bg-gray-50",children:[(0,s.jsx)("button",{onClick:()=>N>1&&j(N-1),disabled:N===b||I,className:"px-4 py-2 rounded-lg bg-gray-200 disabled:opacity-50 ".concat(N===b?"invisible":"visible"),children:"ย้อนกลับ"}),N<4?(0,s.jsx)("button",{onClick:()=>N<4&&Q(N)&&j(N+1),disabled:I,className:"px-4 py-2 rounded-lg bg-blue-600 text-white disabled:opacity-50",children:"ถัดไป"}):(0,s.jsx)("button",{onClick:V,disabled:I||0===v.uploadedFiles.filter(e=>"success"===e.status).length,className:"px-6 py-2 rounded-lg bg-green-600 text-white disabled:bg-gray-300 disabled:cursor-not-allowed",children:I?"กำลังสร้าง...":"สร้างเอกสาร"})]})]})}}}]);