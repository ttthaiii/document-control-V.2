(()=>{var e={};e.id=5223,e.ids=[5223],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},84770:e=>{"use strict";e.exports=require("crypto")},80665:e=>{"use strict";e.exports=require("dns")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},32694:e=>{"use strict";e.exports=require("http2")},98216:e=>{"use strict";e.exports=require("net")},19801:e=>{"use strict";e.exports=require("os")},55315:e=>{"use strict";e.exports=require("path")},35816:e=>{"use strict";e.exports=require("process")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},3477:(e,s,t)=>{"use strict";t.r(s),t.d(s,{GlobalError:()=>i.a,__next_app__:()=>m,originalPathname:()=>x,pages:()=>o,routeModule:()=>u,tree:()=>c}),t(32848),t(22834),t(96868),t(35866);var r=t(23191),a=t(88716),l=t(37922),i=t.n(l),n=t(95231),d={};for(let e in n)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(d[e]=()=>n[e]);t.d(s,d);let c=["",{children:["dashboard",{children:["work-request",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(t.bind(t,32848)),"D:\\ttsdoc-v2\\src\\app\\dashboard\\work-request\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(t.bind(t,22834)),"D:\\ttsdoc-v2\\src\\app\\dashboard\\layout.tsx"]}]},{layout:[()=>Promise.resolve().then(t.bind(t,96868)),"D:\\ttsdoc-v2\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(t.t.bind(t,35866,23)),"next/dist/client/components/not-found-error"]}],o=["D:\\ttsdoc-v2\\src\\app\\dashboard\\work-request\\page.tsx"],x="/dashboard/work-request/page",m={require:t,loadChunk:()=>Promise.resolve()},u=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/dashboard/work-request/page",pathname:"/dashboard/work-request",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:c}})},14669:(e,s,t)=>{Promise.resolve().then(t.bind(t,7022))},44011:(e,s,t)=>{Promise.resolve().then(t.bind(t,77303))},31540:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(62881).Z)("download",[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]])},70717:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(62881).Z)("history",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]])},56418:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(62881).Z)("paperclip",[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]])},83855:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(62881).Z)("plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},21405:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(62881).Z)("refresh-cw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]])},687:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(62881).Z)("thumbs-down",[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z",key:"m61m77"}]])},59593:(e,s,t)=>{"use strict";t.d(s,{Z:()=>r});let r=(0,t(62881).Z)("thumbs-up",[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]])},7022:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>i});var r=t(10326),a=t(17577),l=t(28882);function i({children:e}){return r.jsx(a.Suspense,{fallback:r.jsx("div",{className:"min-h-screen bg-gray-100 flex items-center justify-center",children:r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}),children:r.jsx(l.Z,{children:e})})}},77303:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>F});var r=t(10326),a=t(17577),l=t(35047),i=t(26107),n=t(32875),d=t(79821),c=t(36283),o=t(59593),x=t(687),m=t(7619);let u=e=>{if(!e)return"N/A";if("function"==typeof e.toDate)return e.toDate().toLocaleDateString("th-TH",{day:"2-digit",month:"short",year:"numeric"});let s=new Date(e);return isNaN(s.getTime())?"Invalid Date":s.toLocaleDateString("th-TH",{day:"2-digit",month:"short",year:"numeric"})},h=e=>{let s=m.NK[e]||e,t=m.yh[e]||"#6c757d",r="text-gray-800",a="bg-gray-100";return"#0088FE"===t?(a="bg-blue-100",r="text-blue-800"):"#FFBB28"===t?(a="bg-yellow-100",r="text-yellow-800"):"#AF19FF"===t?(a="bg-purple-100",r="text-purple-800"):"#FD7E14"===t?(a="bg-orange-100",r="text-orange-800"):"#28A745"===t?(a="bg-green-100",r="text-green-800"):"#6c757d"===t?(a="bg-gray-100",r="text-gray-800"):"#DC3545"===t&&(a="bg-red-100",r="text-red-800"),{text:s,colorClasses:`${a} ${r}`}};function p({documents:e,isLoading:s,onDocumentClick:t,selectedIds:l,onSelectionChange:n,onApproveRejectClick:p}){let{user:g}=(0,i.a)(),b=g&&m.$p.includes(g.role),f=(e,s)=>{s?n([...l,e]):n(l.filter(s=>s!==e))},j=e=>{e?n(y.filter(e=>e.status===m.Ge.DRAFT).map(e=>e.id)):n([])},y=(0,a.useMemo)(()=>{if(!g)return[];let s=g.role;return s===m.K$.ADMIN||m.$p.includes(s)?e:s===m.K$.BIM?e.filter(e=>e.status!==m.Ge.DRAFT&&e.status!==m.Ge.REJECTED_BY_PM):m.c9.includes(s)&&g.sites&&g.sites.length>0?e.filter(e=>e.createdBy===g.id||e.status!==m.Ge.DRAFT&&e.status!==m.Ge.REJECTED_BY_PM):e.filter(e=>e.status!==m.Ge.DRAFT&&e.status!==m.Ge.REJECTED_BY_PM)},[e,g]),N=(0,a.useMemo)(()=>y.filter(e=>e.status===m.Ge.DRAFT),[y]),v=N.length>0&&l.length===N.length;return s?r.jsx("div",{className:"w-full h-96 flex justify-center items-center bg-white rounded-lg shadow",children:r.jsx(d.Z,{})}):e&&0!==e.length?r.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden h-full flex flex-col",children:r.jsx("div",{className:"overflow-auto flex-1 relative",children:(0,r.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[r.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:(0,r.jsxs)("tr",{children:[b&&r.jsx("th",{className:"px-4 py-3 text-left",children:r.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500",checked:v,onChange:e=>j(e.target.checked),disabled:0===N.length})}),r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"เลขที่เอกสาร"}),r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"หัวข้อเรื่อง"}),r.jsx("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"โครงการ"}),r.jsx("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"สถานะ"}),r.jsx("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"อัปเดตล่าสุด"}),b&&r.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),r.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:y.map(e=>{let s=h(e.status),a=e.status===m.Ge.DRAFT,i=l.includes(e.id);return(0,r.jsxs)("tr",{className:`hover:bg-gray-50 ${a?"bg-yellow-50 hover:bg-yellow-100":""}`,onClick:s=>{let r=s.target;"INPUT"===r.tagName||r.closest("button")||t(e)},children:[b&&(0,r.jsxs)("td",{className:"px-4 py-4",children:[a?r.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer",checked:i,onChange:s=>f(e.id,s.target.checked),onClick:e=>e.stopPropagation()}):null," "]}),r.jsx("td",{className:"px-6 py-4",children:r.jsx("p",{className:"text-sm font-semibold text-blue-600",children:e.documentNumber})}),r.jsx("td",{className:"px-6 py-4",children:r.jsx("p",{className:"text-sm text-gray-800 line-clamp-2",children:e.taskName})}),r.jsx("td",{className:"px-6 py-4 text-center",children:r.jsx("p",{className:"text-sm text-gray-600",children:e.site?.name||"N/A"})}),r.jsx("td",{className:"px-6 py-4 text-center",children:r.jsx("span",{className:`inline-flex items-center justify-center px-2.5 py-1 rounded-full text-xs font-semibold ${s.colorClasses}`,children:s.text})}),r.jsx("td",{className:"px-6 py-4 text-center",children:r.jsx("span",{className:"text-sm text-gray-600",children:u(e.updatedAt)})}),b&&r.jsx("td",{className:"px-4 py-4 text-center whitespace-nowrap",children:a&&p&&(0,r.jsxs)(r.Fragment,{children:[r.jsx("button",{onClick:s=>{s.stopPropagation(),p("APPROVE_DRAFT",e.id)},className:"text-green-600 hover:text-green-800 p-1 rounded hover:bg-green-100 mx-1 disabled:opacity-50",title:"อนุมัติ",children:r.jsx(o.Z,{size:16})}),r.jsx("button",{onClick:s=>{s.stopPropagation(),p("REJECT_DRAFT",e.id)},className:"text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-100 mx-1 disabled:opacity-50",title:"ไม่อนุมัติ",children:r.jsx(x.Z,{size:16})})]})})]},e.id)})})]})})}):(0,r.jsxs)("div",{className:"w-full h-96 flex flex-col justify-center items-center bg-white rounded-lg shadow text-center border-2 border-dashed",children:[r.jsx(c.Z,{className:"w-16 h-16 text-gray-300 mb-4"}),r.jsx("h3",{className:"text-xl font-semibold text-gray-700",children:"ไม่พบ Work Request"}),r.jsx("p",{className:"text-gray-500 mt-1",children:"ยังไม่มีการสร้างคำร้องของานในโครงการนี้"})]})}var g=t(70717),b=t(94019),f=t(56418),j=t(31540),y=t(62881);let N=(0,y.Z)("corner-up-left",[["path",{d:"M20 20v-7a4 4 0 0 0-4-4H4",key:"1nkjon"}],["path",{d:"M9 14 4 9l5-5",key:"102s5s"}]]);var v=t(32933),w=t(63685),k=t(50949),S=t(69436);let E=(0,y.Z)("square-pen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);var T=t(31469);let C=e=>{if(!e)return"0 B";let s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(1))+" "+["B","KB","MB","GB"][s]},Z=(e,s=!0)=>{let t;if(!e)return"N/A";if(isNaN((t=new Date(e&&"object"==typeof e&&"_seconds"in e?1e3*e._seconds:e)).getTime()))return"Invalid Date";let r={day:"2-digit",month:"short",year:"numeric"};return s&&(r.hour="2-digit",r.minute="2-digit"),t.toLocaleString("th-TH",r)},R=e=>({text:m.NK[e]||e,color:m.yh[e]||"#6c757d"}),D=({workflow:e,onClose:s})=>r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center p-4 border-b",children:[(0,r.jsxs)("h3",{className:"text-lg font-bold text-gray-800 flex items-center",children:[r.jsx(g.Z,{size:20,className:"mr-2"}),"ประวัติ Work Request"]}),r.jsx("button",{onClick:s,className:"text-gray-400 hover:text-gray-600",children:r.jsx(b.Z,{size:24})})]}),r.jsx("div",{className:"p-6 overflow-y-auto",children:r.jsx("div",{className:"border-l-2 border-gray-200 ml-2",children:e.length>0?e.map((e,s)=>(0,r.jsxs)("div",{className:"relative pl-6 pb-8 last:pb-0",children:[r.jsx("div",{className:"absolute -left-[9px] top-1 w-4 h-4 bg-blue-500 rounded-full border-2 border-white"}),r.jsx("p",{className:"font-semibold text-gray-800",children:R(e.status).text}),(0,r.jsxs)("p",{className:"text-sm text-gray-600",children:["โดย: ",e.userName," (",e.role,")"]}),r.jsx("time",{className:"text-xs text-gray-400",children:Z(e.timestamp)}),e.comments&&r.jsx("div",{className:"mt-2 p-2 bg-gray-50 rounded-md text-xs italic",children:(0,r.jsxs)("p",{className:"text-gray-600",children:['"',e.comments,'"']})})]},s)):r.jsx("p",{className:"text-sm text-gray-500 pl-6",children:"ไม่มีประวัติ"})})})]})});function A({documentId:e,onClose:s,onUpdate:t}){let{user:l,firebaseUser:n}=(0,i.a)(),{showNotification:u}=(0,T.l)(),[h,p]=(0,a.useState)(null),[y,A]=(0,a.useState)(!0),[P,M]=(0,a.useState)(!1),[q,_]=(0,a.useState)(""),[$,F]=(0,a.useState)([]),[z,I]=(0,a.useState)(!1),[O,B]=(0,a.useState)(""),[G,J]=(0,a.useState)([]),[U,V]=(0,a.useState)(!1),[K,L]=(0,a.useState)(!1),[H,W]=(0,a.useState)(null),[Y,Q]=(0,a.useState)(null),[X,ee]=(0,a.useState)(""),es=l?.role===m.K$.BIM&&h?.status===m.Ge.IN_PROGRESS,et=l&&m.oU.includes(l.role)&&h?.status===m.Ge.PENDING_ACCEPTANCE,er=l?.role===m.K$.BIM&&h?.status===m.Ge.REVISION_REQUESTED,ea=l&&m.$p.includes(l.role)&&h?.status===m.Ge.DRAFT,el=(0,a.useMemo)(()=>(h?.revisionNumber||0)+1,[h]),ei=(0,a.useMemo)(()=>h?`${h.documentNumber.split("-REV")[0]}-REV${String(el).padStart(2,"0")}`:"",[h,el]),en=async e=>{try{if(!n)throw Error("กรุณาล็อกอินก่อนอัปโหลดไฟล์");let s=await n.getIdToken(),t=new FormData;t.append("file",e);let r=await fetch("/api/rfa/upload-temp-file",{method:"POST",headers:{Authorization:`Bearer ${s}`},body:t}),a=await r.json();if(a.success)return{status:"success",uploadedData:a.fileData};throw Error(a.error||"อัปโหลดล้มเหลว")}catch(e){return{status:"error",error:e instanceof Error?e.message:"เกิดข้อผิดพลาด"}}},ed=async(e,s)=>{let t=Array.from(e.target.files||[]);if(!t.length)return;let r=t.map(e=>({id:`${e.name}-${Date.now()}`,file:e,status:"pending"})),a="revision"===s?J:F;for(let e of(a(e=>[...e,...r]),r)){a(s=>s.map(s=>s.id===e.id?{...s,status:"uploading"}:s));let s=await en(e.file);a(t=>t.map(t=>t.id===e.id?{...t,...s}:t))}e.target.value=""},ec=(e,s)=>{("revision"===s?J:F)(s=>s.filter(s=>s.id!==e))},eo=async e=>{if(h&&n){M(!0);try{let r=await n.getIdToken(),a=$.filter(e=>"success"===e.status);if(0===a.length){u("warning","กรุณาแนบไฟล์","ต้องแนบไฟล์ผลงานอย่างน้อย 1 ไฟล์"),M(!1);return}let l={action:e,payload:{comments:q,files:a.map(e=>e.uploadedData)}},i=await fetch(`/api/work-request/${h.id}/update`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify(l)}),d=await i.json();if(d.success)u("success","ดำเนินการสำเร็จ",`สถานะถูกเปลี่ยนเป็น: ${R(d.newStatus).text}`),t(),s();else throw Error(d.error)}catch(e){u("error","เกิดข้อผิดพลาด",e instanceof Error?e.message:"Unknown error")}finally{M(!1)}}},ex=async e=>{if(h&&n){M(!0);try{let r=await n.getIdToken(),a=await fetch(`/api/work-request/${h.id}/update`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({action:e,payload:{comments:q}})}),l=await a.json();if(l.success)u("success","ดำเนินการสำเร็จ",`สถานะถูกเปลี่ยนเป็น: ${R(l.newStatus).text}`),t(),s();else throw Error(l.error)}catch(e){u("error","เกิดข้อผิดพลาด",e instanceof Error?e.message:"Failed to perform action")}finally{M(!1)}}},em=async()=>{let e=G.filter(e=>"success"===e.status);if(0===e.length){u("warning","กรุณาแนบไฟล์","ต้องแนบไฟล์ฉบับแก้ไขอย่างน้อย 1 ไฟล์");return}if(!Y){u("error","Task ไม่ถูกต้อง","ไม่พบ Task ID ที่ตรวจสอบแล้ว");return}M(!0);try{let r=await n?.getIdToken(),a={originalDocId:h.id,uploadedFiles:e.map(e=>e.uploadedData),comments:O,verifiedTaskId:Y},l=await fetch("/api/work-request/create_revision",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify(a)}),i=await l.json();if(i.success)u("success","สร้าง Revision สำเร็จ!",`เอกสารฉบับใหม่ ${i.newDocumentNumber} ถูกส่งให้ Site ตรวจสอบแล้ว`),t(),s();else throw Error(i.error||"เกิดข้อผิดพลาดในการสร้าง Revision")}catch(e){u("error","เกิดข้อผิดพลาด",e instanceof Error?e.message:"Unknown error")}finally{M(!1)}},eu=async e=>{if(h&&n){if("REJECT_DRAFT"===e&&!X.trim()){u("warning","กรุณากรอกเหตุผล","ต้องระบุเหตุผลในการไม่อนุมัติ");return}M(!0);try{let r=await n.getIdToken(),a=await fetch(`/api/work-request/${h.id}/update`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({action:e,payload:{comments:X}})}),l=await a.json();if(l.success)u("success","ดำเนินการสำเร็จ",`สถานะถูกเปลี่ยนเป็น: ${R(l.newStatus).text}`),t(),s();else throw Error(l.error||"เกิดข้อผิดพลาดในการดำเนินการ")}catch(e){u("error","เกิดข้อผิดพลาด",e instanceof Error?e.message:"Unknown error")}finally{M(!1)}}};if(y)return r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center",children:r.jsx(d.Z,{className:"w-12 h-12 text-white"})});if(!h)return null;let eh=R(h.status);return(0,r.jsxs)(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col",children:[(0,r.jsxs)("div",{className:"flex justify-between items-start p-4 border-b",children:[r.jsx("div",{children:(0,r.jsxs)("div",{className:"flex items-baseline space-x-3",children:[r.jsx("h3",{className:"text-lg font-bold text-blue-600",children:h.documentNumber}),r.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:h.taskName})]})}),(0,r.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,r.jsxs)("button",{onClick:()=>I(!0),className:"flex items-center text-sm text-gray-500 hover:text-blue-600",children:[r.jsx(g.Z,{size:16,className:"mr-1"})," ดูประวัติ"]}),r.jsx("button",{onClick:s,className:"text-gray-400 hover:text-gray-600",children:r.jsx(b.Z,{size:24})})]})]}),(0,r.jsxs)("div",{className:"p-6 overflow-y-auto space-y-6",children:[(0,r.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm",children:[(0,r.jsxs)("div",{children:[r.jsx("strong",{className:"text-gray-500 block mb-1",children:"สถานะ:"}),r.jsx("span",{className:"px-3 py-1 text-xs font-bold text-white rounded-full",style:{backgroundColor:eh.color},children:eh.text})]}),(0,r.jsxs)("div",{children:[r.jsx("strong",{className:"text-gray-500 block",children:"โครงการ:"}),r.jsx("span",{children:h.site?.name||"N/A"})]}),(0,r.jsxs)("div",{children:[r.jsx("strong",{className:"text-gray-500 block",children:"วันที่เริ่ม (แผน):"}),r.jsx("span",{children:Z(h.planStartDate,!1)})]}),(0,r.jsxs)("div",{children:[r.jsx("strong",{className:"text-gray-500 block",children:"วันที่กำหนดส่ง:"}),r.jsx("span",{children:Z(h.dueDate,!1)})]})]}),h.description&&(0,r.jsxs)("div",{className:"mt-4",children:[r.jsx("strong",{className:"text-gray-500 block text-sm",children:"รายละเอียด:"}),r.jsx("div",{className:"text-gray-700 whitespace-pre-wrap bg-white p-3 rounded-md mt-1 border",children:(0,r.jsxs)("p",{className:"italic",children:['"',h.description,'"']})})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h4",{className:"text-md font-semibold mb-2 flex items-center text-slate-800",children:[r.jsx(f.Z,{size:16,className:"mr-2"})," ไฟล์แนบ"]}),r.jsx("ul",{className:"space-y-2",children:h.files.length>0?h.files.map((e,s)=>r.jsx("li",{children:(0,r.jsxs)("a",{href:e.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"flex items-center justify-between p-2 bg-slate-100 border border-slate-200 rounded-md hover:bg-slate-200 transition-colors group",children:[(0,r.jsxs)("div",{className:"flex items-center min-w-0",children:[r.jsx(c.Z,{className:"w-5 h-5 text-gray-500 mr-3 flex-shrink-0"}),(0,r.jsxs)("div",{className:"flex flex-col min-w-0",children:[r.jsx("span",{className:"text-sm font-medium text-blue-600 group-hover:underline truncate",children:e.fileName}),r.jsx("span",{className:"text-xs text-gray-500",children:C(e.fileSize||e.size)})]})]}),r.jsx(j.Z,{className:"w-5 h-5 text-gray-400 group-hover:text-gray-600 ml-4 flex-shrink-0"})]})},s)):r.jsx("p",{className:"text-sm text-gray-500 italic",children:"ไม่มีไฟล์แนบ"})})]})]}),(0,r.jsxs)("div",{className:"p-4 border-t bg-slate-50",children:[ea&&(0,r.jsxs)("div",{className:"space-y-4",children:[r.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"ดำเนินการ (สำหรับ PM/PD)"}),(0,r.jsxs)("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"เหตุผลในการไม่อนุมัติ (ถ้ามี)"}),r.jsx("textarea",{value:X,onChange:e=>ee(e.target.value),rows:3,placeholder:"กรอกเหตุผลที่ไม่อนุมัติ...",className:"w-full p-2 border rounded-md"})]}),(0,r.jsxs)("div",{className:"flex justify-end gap-3 pt-2",children:[(0,r.jsxs)("button",{onClick:()=>eu("REJECT_DRAFT"),disabled:P,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:bg-red-300 disabled:cursor-not-allowed",children:[r.jsx(x.Z,{size:16,className:"mr-2"}),P?"กำลังดำเนินการ...":"ไม่อนุมัติ"]}),(0,r.jsxs)("button",{onClick:()=>eu("APPROVE_DRAFT"),disabled:P,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed",children:[r.jsx(o.Z,{size:16,className:"mr-2"}),P?"กำลังอนุมัติ...":"อนุมัติ (ส่งให้ BIM)"]})]})]}),et&&(0,r.jsxs)("div",{className:"space-y-4",children:[r.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"ดำเนินการ (สำหรับ Site)"}),(0,r.jsxs)("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"หมายเหตุ / คอมเมนต์ (ถ้ามี)"}),r.jsx("textarea",{value:q,onChange:e=>_(e.target.value),rows:3,placeholder:"หากต้องการให้แก้ไข กรุณาใส่รายละเอียด...",className:"w-full p-2 border rounded-md"})]}),(0,r.jsxs)("div",{className:"flex justify-end gap-3 pt-2",children:[(0,r.jsxs)("button",{onClick:()=>ex("REQUEST_REVISION"),disabled:P,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-orange-600 rounded-lg hover:bg-orange-700 disabled:bg-orange-300",children:[r.jsx(N,{size:16,className:"mr-2"}),P?"กำลังส่ง...":"ส่งกลับให้แก้ไข"]}),(0,r.jsxs)("button",{onClick:()=>ex("COMPLETE"),disabled:P,className:"flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-green-300",children:[r.jsx(v.Z,{size:16,className:"mr-2"}),P?"กำลังปิดงาน...":"ตรวจรับและปิดงาน"]})]})]}),es&&(0,r.jsxs)("div",{className:"space-y-4",children:[r.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"ส่งมอบงาน (Submit Work)"}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["แนบไฟล์ผลงาน ",r.jsx("span",{className:"text-red-500",children:"*"})]}),(0,r.jsxs)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[r.jsx("input",{type:"file",multiple:!0,onChange:e=>ed(e,"action"),id:"submit-file-upload",className:"hidden"}),(0,r.jsxs)("label",{htmlFor:"submit-file-upload",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[r.jsx(w.Z,{size:16,className:"mr-2"})," คลิกเพื่อเลือกไฟล์"]})]}),$.length>0&&r.jsx("div",{className:"mt-2 space-y-2",children:$.map(e=>(0,r.jsxs)("div",{className:"flex items-center text-sm p-2 bg-gray-100 rounded",children:[r.jsx(c.Z,{className:"w-4 h-4 mr-3 text-gray-500"}),r.jsx("span",{className:"flex-1 truncate",children:e.file.name}),(0,r.jsxs)("div",{className:"flex items-center ml-3",children:["uploading"===e.status&&r.jsx(d.Z,{className:"w-4 h-4"}),"success"===e.status&&r.jsx(v.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&r.jsx("span",{title:e.error,children:r.jsx(k.Z,{className:"w-4 h-4 text-red-500"})}),r.jsx("button",{type:"button",onClick:()=>ec(e.id,"action"),className:"ml-3 text-gray-500 hover:text-red-600",children:r.jsx(b.Z,{size:16})})]})]},e.id))})]}),(0,r.jsxs)("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"หมายเหตุ / คอมเมนต์ (ถ้ามี)"}),r.jsx("textarea",{value:q,onChange:e=>_(e.target.value),rows:3,placeholder:"อธิบายรายละเอียดการทำงาน...",className:"w-full p-2 border rounded-md"})]}),r.jsx("div",{className:"flex justify-end pt-2",children:(0,r.jsxs)("button",{onClick:()=>eo("SUBMIT_WORK"),disabled:0===$.filter(e=>"success"===e.status).length||P,className:"flex items-center px-6 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-green-300",children:[P?r.jsx(d.Z,{className:"w-5 h-5 mr-2"}):r.jsx(S.Z,{size:16,className:"mr-2"}),P?"กำลังส่งงาน...":"ส่งงานให้ Site ตรวจรับ"]})})]}),er&&(0,r.jsxs)("div",{className:"space-y-4",children:[r.jsx("h3",{className:"text-lg font-bold text-slate-800",children:"สร้างเอกสารฉบับแก้ไข (Create Revision)"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,r.jsxs)("p",{children:[r.jsx("strong",{children:"เอกสารเดิม:"})," ",h.documentNumber]}),(0,r.jsxs)("p",{children:[r.jsx("strong",{children:"เอกสารใหม่:"})," ",ei]})]}),(U||H)&&(0,r.jsxs)("div",{className:"p-3 rounded-md text-sm font-medium flex items-center border bg-white",children:[U&&(0,r.jsxs)(r.Fragment,{children:[r.jsx(d.Z,{className:"w-4 h-4 mr-3 text-gray-500"})," ",r.jsx("span",{className:"text-gray-600",children:"กำลังตรวจสอบ Task ในระบบ BIM Tracking..."})]}),H&&(0,r.jsxs)(r.Fragment,{children:[r.jsx(k.Z,{className:"w-4 h-4 mr-3 text-red-500"})," ",r.jsx("span",{className:"text-red-600 font-semibold",children:H})]})]}),K&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["แนบไฟล์ที่แก้ไขแล้ว ",r.jsx("span",{className:"text-red-500",children:"*"})]}),(0,r.jsxs)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[r.jsx("input",{type:"file",multiple:!0,onChange:e=>ed(e,"revision"),id:"revision-file-upload",className:"hidden"}),(0,r.jsxs)("label",{htmlFor:"revision-file-upload",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[r.jsx(w.Z,{size:16,className:"mr-2"})," คลิกเพื่อเลือกไฟล์"]})]}),G.length>0&&r.jsx("div",{className:"mt-2 space-y-2",children:G.map(e=>(0,r.jsxs)("div",{className:"flex items-center text-sm p-2 bg-gray-100 rounded",children:[r.jsx(c.Z,{className:"w-4 h-4 mr-3 text-gray-500"}),r.jsx("span",{className:"flex-1 truncate",children:e.file.name}),(0,r.jsxs)("div",{className:"flex items-center ml-3",children:["uploading"===e.status&&r.jsx(d.Z,{className:"w-4 h-4"}),"success"===e.status&&r.jsx(v.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&r.jsx("span",{title:e.error,children:r.jsx(k.Z,{className:"w-4 h-4 text-red-500"})}),r.jsx("button",{type:"button",onClick:()=>ec(e.id,"revision"),className:"ml-3 text-gray-500 hover:text-red-600",children:r.jsx(b.Z,{size:16})})]})]},e.id))})]}),(0,r.jsxs)("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"หมายเหตุ / คอมเมนต์ (ถ้ามี)"}),r.jsx("textarea",{value:O,onChange:e=>B(e.target.value),rows:3,placeholder:"อธิบายรายละเอียดการแก้ไข...",className:"w-full p-2 border rounded-md"})]}),r.jsx("div",{className:"flex justify-end pt-2",children:(0,r.jsxs)("button",{onClick:em,disabled:0===G.filter(e=>"success"===e.status).length||P||!K,className:"flex items-center px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-blue-300",children:[P?r.jsx(d.Z,{className:"w-5 h-5 mr-2"}):r.jsx(E,{size:16,className:"mr-2"}),P?"กำลังส่ง...":"ส่งเอกสารฉบับแก้ไข"]})})]})]})]})]})}),z&&r.jsx(D,{workflow:h.workflow||[],onClose:()=>I(!1)})]})}var P=t(80191),M=t(21405),q=t(83855);t(67967),t(76);let _=({isOpen:e,onClose:s,onSubmit:t,isSubmitting:l})=>{let[i,n]=(0,a.useState)(""),[c,o]=(0,a.useState)("");return e?r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-[70] flex items-center justify-center p-4",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-md",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center p-4 border-b",children:[r.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"เหตุผลในการไม่อนุมัติ"}),r.jsx("button",{onClick:s,disabled:l,className:"text-gray-400 hover:text-gray-600 disabled:opacity-50",children:r.jsx(b.Z,{size:24})})]}),(0,r.jsxs)("div",{className:"p-6 space-y-4",children:[r.jsx("textarea",{value:i,onChange:e=>{n(e.target.value),o("")},rows:4,placeholder:"กรุณาระบุเหตุผล...",className:`w-full p-2 border rounded-md ${c?"border-red-500":"border-gray-300"}`,disabled:l}),c&&r.jsx("p",{className:"text-red-500 text-sm",children:c})]}),(0,r.jsxs)("div",{className:"flex justify-end gap-4 p-4 border-t bg-gray-50",children:[r.jsx("button",{onClick:s,disabled:l,className:"px-4 py-2 text-sm text-gray-700 bg-white border rounded-lg hover:bg-gray-100 disabled:opacity-50",children:"ยกเลิก"}),(0,r.jsxs)("button",{onClick:()=>{if(!i.trim()){o("กรุณากรอกเหตุผล");return}t(i)},disabled:l,className:"flex items-center px-4 py-2 text-sm text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:bg-red-300",children:[l?r.jsx(d.Z,{className:"w-4 h-4 mr-2"}):r.jsx(x.Z,{size:16,className:"mr-2"}),"ยืนยันไม่อนุมัติ"]})]})]})}):null};function $(){let{user:e,firebaseUser:s}=(0,i.a)();(0,l.useRouter)();let[t,n]=(0,a.useState)([]),[c,u]=(0,a.useState)([]),[h,g]=(0,a.useState)(!0),[b,f]=(0,a.useState)(null),[j,y]=(0,a.useState)(!1),{showNotification:N}=(0,T.l)(),[v,w]=(0,a.useState)([]),[k,S]=(0,a.useState)(!1),[E,C]=(0,a.useState)(!1),[Z,R]=(0,a.useState)(null),D=(0,a.useMemo)(()=>{if(0===c.length)return t;let e=new Map(c.map(e=>[e.id,e.name]));return t.map(s=>({...s,site:{id:s.site.id,name:e.get(s.site.id)||"Unknown Site"}}))},[t,c]),$=e&&m.c9.includes(e.role),F=e&&m.$p.includes(e.role),z=(0,a.useCallback)(async(e,t)=>{let r=Z?[Z]:v;if(0!==r.length){S(!0);try{if(!s)throw Error("กรุณาล็อกอินก่อน");let a=await s.getIdToken(),l=await fetch("/api/work-request/batch-update",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({ids:r,action:e,payload:{comments:t||""}})}),i=await l.json();if(i.success)N("success","ดำเนินการสำเร็จ!",`${"APPROVE_DRAFT"===e?"อนุมัติ":"ไม่อนุมัติ"} ${i.updatedCount} รายการเรียบร้อยแล้ว`),w([]),C(!1),R(null);else throw Error(i.error||`เกิดข้อผิดพลาดในการ ${e}`)}catch(e){N("error","เกิดข้อผิดพลาด",e instanceof Error?e.message:"Unknown error")}finally{S(!1)}}},[s,v,Z,N]),I=(0,a.useCallback)(async(e,t,r)=>{S(!0);try{if(!s)throw Error("กรุณาล็อกอินก่อน");let a=await s.getIdToken(),l=await fetch(`/api/work-request/${t}/update`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({action:e,payload:{comments:r||""}})}),i=await l.json();if(i.success)N("success","ดำเนินการสำเร็จ!",`${"APPROVE_DRAFT"===e?"อนุมัติ":"ไม่อนุมัติ"}เอกสารเรียบร้อยแล้ว`),C(!1),R(null);else throw Error(i.error||`เกิดข้อผิดพลาดในการ ${e}`)}catch(e){N("error","เกิดข้อผิดพลาด",e instanceof Error?e.message:"Unknown error")}finally{S(!1)}},[s,N]),O=e=>{I("APPROVE_DRAFT",e)},B=e=>{R(e),C(!0)};return(0,r.jsxs)("div",{className:"max-w-screen-2xl mx-auto flex flex-col h-full",children:[r.jsx("div",{children:(0,r.jsxs)("div",{className:"mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[(0,r.jsxs)("div",{children:[r.jsx("h1",{className:"text-2xl lg:text-3xl font-bold text-gray-900",children:"✍️ Work Requests"}),r.jsx("p",{className:"text-gray-600 mt-1",children:"รายการคำร้องของานทั้งหมด (Real-time)"})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-3 mt-4 sm:mt-0",children:[(0,r.jsxs)("button",{className:"flex items-center px-3 py-2 bg-gray-100 text-gray-700 rounded-lg cursor-default",disabled:!0,children:[r.jsx(M.Z,{className:`w-4 h-4 mr-2 ${h?"animate-spin":""}`}),"Real-time Sync"]}),$&&(0,r.jsxs)("button",{onClick:()=>y(!0),className:"flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[r.jsx(q.Z,{className:"w-4 h-4 mr-2"}),"สร้าง Work Request"]})]})]})}),F&&(0,r.jsxs)("div",{className:"bg-white p-3 rounded-lg shadow border border-gray-200 flex items-center space-x-3",children:[(0,r.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:["รายการที่เลือก (",v.length,"):"]}),(0,r.jsxs)("button",{onClick:()=>{0!==v.length&&z("APPROVE_DRAFT")},disabled:0===v.length||k,className:"flex items-center px-3 py-1.5 text-xs font-medium text-white bg-green-600 rounded-md hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed",children:[k?r.jsx(d.Z,{className:"w-4 h-4 mr-1"}):r.jsx(o.Z,{size:14,className:"mr-1"})," อนุมัติ"]}),(0,r.jsxs)("button",{onClick:()=>{0!==v.length&&(R(null),C(!0))},disabled:0===v.length||k,className:"flex items-center px-3 py-1.5 text-xs font-medium text-white bg-red-600 rounded-md hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed",children:[k?r.jsx(d.Z,{className:"w-4 h-4 mr-1"}):r.jsx(x.Z,{size:14,className:"mr-1"})," ไม่อนุมัติ"]}),k&&r.jsx("span",{className:"text-xs text-gray-500 italic",children:"กำลังดำเนินการ..."})]}),r.jsx("div",{className:"flex-1 min-h-0",children:r.jsx(p,{documents:D,isLoading:h,onDocumentClick:e=>{f(e.id)},selectedIds:v,onSelectionChange:w,onApproveRejectClick:(e,s)=>{"APPROVE_DRAFT"===e?O(s):"REJECT_DRAFT"===e&&B(s)}})}),b&&r.jsx(A,{documentId:b,onClose:()=>{f(null)},onUpdate:()=>{}}),j&&r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4",children:r.jsx("div",{className:"w-full max-w-4xl bg-white rounded-lg shadow-xl p-6",children:r.jsx(P.Z,{onClose:()=>{y(!1)},userProp:e||void 0})})}),r.jsx(_,{isOpen:E,onClose:()=>{C(!1),R(null)},onSubmit:Z?e=>{Z&&I("REJECT_DRAFT",Z,e)}:e=>{z("REJECT_DRAFT",e)},isSubmitting:k})]})}function F(){return r.jsx(n.AuthGuard,{requiredRoles:[m.K$.ADMIN,m.K$.SITE_ADMIN,m.K$.BIM,...m.c9,...m.$p],children:r.jsx(a.Suspense,{fallback:r.jsx("div",{className:"text-center p-8",children:"Loading Page..."}),children:r.jsx($,{})})})}},22834:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>r});let r=(0,t(68570).createProxy)(String.raw`D:\ttsdoc-v2\src\app\dashboard\layout.tsx#default`)},32848:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>r});let r=(0,t(68570).createProxy)(String.raw`D:\ttsdoc-v2\src\app\dashboard\work-request\page.tsx#default`)}};var s=require("../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[9276,4637,3764,3706,8077,191],()=>t(3477));module.exports=r})();