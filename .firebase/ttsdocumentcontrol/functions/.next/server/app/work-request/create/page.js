(()=>{var e={};e.id=3403,e.ids=[3403],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},84770:e=>{"use strict";e.exports=require("crypto")},80665:e=>{"use strict";e.exports=require("dns")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},32694:e=>{"use strict";e.exports=require("http2")},98216:e=>{"use strict";e.exports=require("net")},19801:e=>{"use strict";e.exports=require("os")},55315:e=>{"use strict";e.exports=require("path")},35816:e=>{"use strict";e.exports=require("process")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},16461:(e,t,r)=>{"use strict";r.r(t),r.d(t,{GlobalError:()=>l.a,__next_app__:()=>m,originalPathname:()=>u,pages:()=>c,routeModule:()=>p,tree:()=>d}),r(98644),r(87666),r(35866);var s=r(23191),a=r(88716),i=r(37922),l=r.n(i),o=r(95231),n={};for(let e in o)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(n[e]=()=>o[e]);r.d(t,n);let d=["",{children:["work-request",{children:["create",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(r.bind(r,98644)),"D:\\ttsdoc-v2\\src\\app\\work-request\\create\\page.tsx"]}]},{}]},{metadata:{icon:[async e=>(await Promise.resolve().then(r.bind(r,73881))).default(e)],apple:[],openGraph:[],twitter:[],manifest:void 0}}]},{layout:[()=>Promise.resolve().then(r.bind(r,87666)),"D:\\ttsdoc-v2\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(r.t.bind(r,35866,23)),"next/dist/client/components/not-found-error"],metadata:{icon:[async e=>(await Promise.resolve().then(r.bind(r,73881))).default(e)],apple:[],openGraph:[],twitter:[],manifest:void 0}}],c=["D:\\ttsdoc-v2\\src\\app\\work-request\\create\\page.tsx"],u="/work-request/create/page",m={require:r,loadChunk:()=>Promise.resolve()},p=new s.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/work-request/create/page",pathname:"/work-request/create",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},80128:(e,t,r)=>{Promise.resolve().then(r.bind(r,49535))},32933:(e,t,r)=>{"use strict";r.d(t,{Z:()=>s});let s=(0,r(62881).Z)("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]])},69436:(e,t,r)=>{"use strict";r.d(t,{Z:()=>s});let s=(0,r(62881).Z)("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]])},50949:(e,t,r)=>{"use strict";r.d(t,{Z:()=>s});let s=(0,r(62881).Z)("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},63685:(e,t,r)=>{"use strict";r.d(t,{Z:()=>s});let s=(0,r(62881).Z)("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]])},49535:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>j});var s=r(10326),a=r(32875),i=r(28882),l=r(17577),o=r(26107),n=r(87274),d=r(79821),c=r(63685),u=r(36283),m=r(32933),p=r(50949),x=r(94019),h=r(69436);function g({onClose:e,userProp:t}){let{firebaseUser:r}=(0,o.aC)(),[a,i]=(0,l.useState)([]),[g,f]=(0,l.useState)(""),[b,N]=(0,l.useState)(""),[j,y]=(0,l.useState)(""),[v,w]=(0,l.useState)(n.O.NORMAL),[k,q]=(0,l.useState)([]),[E,P]=(0,l.useState)(!1),[S,_]=(0,l.useState)(!1),[C,D]=(0,l.useState)({}),I=async e=>{try{if(!r)throw Error("กรุณาล็อกอินก่อนอัปโหลดไฟล์");let t=await r.getIdToken(),s=new FormData;s.append("file",e);let a=await fetch("/api/rfa/upload-temp-file",{method:"POST",headers:{Authorization:`Bearer ${t}`},body:s}),i=await a.json();if(i.success)return{status:"success",progress:100,uploadedData:i.fileData};throw Error(i.error||"อัปโหลดล้มเหลว")}catch(e){return{status:"error",error:e instanceof Error?e.message:"เกิดข้อผิดพลาด"}}},O=async e=>{try{if(!r)return;let t=await r.getIdToken();await fetch("/api/rfa/delete-temp-file",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({filePath:e})})}catch(e){console.error("Failed to delete temp file:",e)}},A=async e=>{let t=Array.from(e.target.files||[]);if(!t.length)return;let r=t.map(e=>({id:`${e.name}-${Date.now()}`,file:e,status:"pending",progress:0}));for(let e of(q(e=>[...e,...r]),r)){q(t=>t.map(t=>t.id===e.id?{...t,status:"uploading"}:t));let t=await I(e.file);q(r=>r.map(r=>r.id===e.id?{...r,...t}:r))}e.target.value=""},R=e=>{let t=k[e];t.uploadedData?.filePath&&O(t.uploadedData.filePath),q(t=>t.filter((t,r)=>r!==e))},M=()=>{let e={};return g||(e.site="กรุณาเลือกโครงการ"),b.trim()||(e.taskName="กรุณาใส่หัวข้องาน"),D(e),0===Object.keys(e).length},T=async t=>{if(t.preventDefault(),M()){_(!0),D({});try{if(!r)throw Error("กรุณาล็อกอินก่อนส่งคำขอ");let t=await r.getIdToken(),s={siteId:g,taskName:b,description:j,priority:v,files:k.filter(e=>"success"===e.status&&e.uploadedData).map(e=>e.uploadedData)},a=await fetch("/api/work-request/create",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(s)}),i=await a.json();if(!a.ok||!i.success)throw Error(i.error||i.details||"เกิดข้อผิดพลาดในการสร้าง Work Request");alert(`สร้าง Work Request สำเร็จ!
เลขที่เอกสาร: ${i.documentNumber}`),e()}catch(e){console.error("Submit Error:",e),D({form:e instanceof Error?e.message:"เกิดข้อผิดพลาดที่ไม่รู้จัก"})}finally{_(!1)}}};return(0,s.jsxs)("form",{onSubmit:T,className:"space-y-6",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{children:[s.jsx("label",{htmlFor:"site",className:"block text-sm font-medium text-gray-700 mb-1",children:"โครงการ"}),(0,s.jsxs)("select",{id:"site",value:g,onChange:e=>f(e.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",disabled:E,children:[s.jsx("option",{value:"",children:E?"กำลังโหลด...":"-- เลือกโครงการ --"}),a.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]}),C.site&&s.jsx("p",{className:"text-red-600 text-sm mt-1",children:C.site})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{htmlFor:"priority",className:"block text-sm font-medium text-gray-700 mb-1",children:"ระดับความสำคัญ"}),(0,s.jsxs)("select",{id:"priority",value:v,onChange:e=>w(e.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[s.jsx("option",{value:n.O.NORMAL,children:"ปกติ"}),s.jsx("option",{value:n.O.HIGH,children:"ด่วน"}),s.jsx("option",{value:n.O.URGENT,children:"ด่วนที่สุด"})]})]})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{htmlFor:"taskName",className:"block text-sm font-medium text-gray-700 mb-1",children:"หัวข้องาน (Task Name)"}),s.jsx("input",{id:"taskName",type:"text",value:b,onChange:e=>N(e.target.value),placeholder:"เช่น ขอแก้ไขโมเดลโครงสร้างอาคาร A",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"}),C.taskName&&s.jsx("p",{className:"text-red-600 text-sm mt-1",children:C.taskName})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700 mb-1",children:["รายละเอียด ",s.jsx("span",{className:"text-gray-400 font-normal",children:"(Optional)"})]}),s.jsx("textarea",{id:"description",value:j,onChange:e=>y(e.target.value),rows:5,placeholder:"อธิบายรายละเอียดเพิ่มเติม (ถ้ามี)...",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"แนบไฟล์ (ถ้ามี)"}),(0,s.jsxs)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors",children:[s.jsx("input",{type:"file",multiple:!0,onChange:A,id:"file-upload",className:"hidden"}),(0,s.jsxs)("label",{htmlFor:"file-upload",className:"cursor-pointer text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center",children:[s.jsx(c.Z,{size:18,className:"mr-2"}),"คลิกเพื่อเลือกไฟล์"]})]}),k.length>0&&s.jsx("div",{className:"mt-4 space-y-2",children:k.map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center text-sm p-2 bg-gray-100 rounded",children:[s.jsx(u.Z,{className:"w-4 h-4 mr-3 text-gray-500"}),s.jsx("span",{className:"flex-1 truncate",children:e.file.name}),(0,s.jsxs)("div",{className:"flex items-center ml-3",children:["uploading"===e.status&&s.jsx(d.Z,{className:"w-4 h-4"}),"success"===e.status&&s.jsx(m.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&s.jsx("span",{title:e.error,children:s.jsx(p.Z,{className:"w-4 h-4 text-red-500"})}),s.jsx("button",{type:"button",onClick:()=>R(t),className:"ml-3 text-gray-500 hover:text-red-600",children:s.jsx(x.Z,{size:16})})]})]},e.id))})]}),C.form&&s.jsx("p",{className:"text-red-600 text-sm text-center bg-red-50 p-3 rounded-lg",children:C.form}),(0,s.jsxs)("div",{className:"flex justify-end gap-4 pt-4 border-t",children:[s.jsx("button",{type:"button",onClick:e,className:"px-6 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200",children:"ยกเลิก"}),(0,s.jsxs)("button",{type:"submit",disabled:S,className:"flex items-center px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-blue-300",children:[S?s.jsx(d.Z,{className:"w-5 h-5 mr-2"}):s.jsx(h.Z,{className:"w-5 h-5 mr-2"}),S?"กำลังส่ง...":"ส่งคำขอ"]})]})]})}var f=r(35047),b=r(7619);function N(){let e=(0,f.useRouter)(),{user:t}=(0,o.aC)(),r=t?{id:t.id,email:t.email,role:t.role,sites:t.sites||[],status:t.status}:void 0;return s.jsx(i.Z,{children:(0,s.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-2 mb-2",children:[s.jsx("span",{className:"text-2xl",children:"✍️"}),s.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Create New Work Request"})]}),s.jsx("p",{className:"text-gray-600",children:"ส่งคำร้องของานไปยังทีม BIM สำหรับงานเร่งด่วนหรืองานที่ไม่ได้วางแผน"})]}),s.jsx("div",{className:"bg-white rounded-lg shadow-sm border p-6",children:s.jsx(g,{onClose:()=>{e.push("/dashboard/work-request")},userProp:r})})]})})}function j(){return s.jsx(a.AuthGuard,{requiredRoles:[b.K$.SITE_ADMIN,b.K$.ADMIN],children:s.jsx(l.Suspense,{fallback:s.jsx("div",{className:"text-center p-8",children:"Loading Form..."}),children:s.jsx(N,{})})})}},87274:(e,t,r)=>{"use strict";var s,a;r.d(t,{O:()=>s,P:()=>a}),function(e){e.NORMAL="NORMAL",e.HIGH="HIGH",e.URGENT="URGENT"}(s||(s={})),function(e){e.PENDING_BIM="PENDING_BIM",e.IN_PROGRESS="IN_PROGRESS",e.PENDING_ACCEPTANCE="PENDING_ACCEPTANCE",e.REVISION_REQUESTED="REVISION_REQUESTED",e.COMPLETED="COMPLETED"}(a||(a={}))},98644:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>s});let s=(0,r(68570).createProxy)(String.raw`D:\ttsdoc-v2\src\app\work-request\create\page.tsx#default`)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,4490,6621,4222,9860,8882],()=>r(16461));module.exports=s})();