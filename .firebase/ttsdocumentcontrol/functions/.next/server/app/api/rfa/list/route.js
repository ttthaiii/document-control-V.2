"use strict";(()=>{var e={};e.id=5426,e.ids=[5426],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},85871:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>u,patchFetch:()=>A,requestAsyncStorage:()=>c,routeModule:()=>R,serverHooks:()=>D,staticGenerationAsyncStorage:()=>_});var E={};r.r(E),r.d(E,{GET:()=>N,dynamic:()=>P});var s=r(49303),I=r(88716),i=r(60670),a=r(87070),n=r(40416),o=r(4458);let P="force-dynamic";async function N(e){try{let t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return a.NextResponse.json({success:!1,error:"Missing or invalid authorization header"},{status:401});let r=t.split("Bearer ")[1],E=(await n.CZ.verifyIdToken(r)).uid,s=await n.iW.collection("users").doc(E).get();if(!s.exists)return a.NextResponse.json({success:!1,error:"User not found"},{status:404});let I=s.data().sites||[];if(0===I.length)return a.NextResponse.json({success:!0,documents:[]});let{searchParams:i}=new URL(e.url),P=i.get("view");if("approved"!==P)return a.NextResponse.json({success:!1,error:"Invalid view parameter for this endpoint"},{status:400});let N=n.iW.collection("rfaDocuments"),R=[o.n$.APPROVED,o.n$.APPROVED_WITH_COMMENTS,o.n$.APPROVED_REVISION_REQUIRED];N=N.where("isLatest","==",!0).where("status","in",R);let c=i.get("siteId");if(c&&"ALL"!==c){if(!I.includes(c))return a.NextResponse.json({success:!0,documents:[]});N=N.where("siteId","==",c)}else N=N.where("siteId","in",I);let _=i.get("categoryId");_&&"ALL"!==_&&(N=N.where("categoryId","==",_)),N=N.orderBy("updatedAt","desc");let D=await N.get(),u=[];return D.forEach(e=>{let t=e.data();u.push({id:e.id,documentNumber:t.documentNumber,title:t.title,status:t.status,updatedAt:t.updatedAt,rfaType:t.rfaType,site:{id:t.siteId,name:t.siteName||"N/A"},category:{id:t.categoryId,categoryCode:t.taskData?.taskCategory||t.categoryId||"N/A"},files:t.files||[]})}),a.NextResponse.json({success:!0,documents:u})}catch(t){if(console.error("Error fetching approved RFA documents:",t),t instanceof Error&&t.message.includes("FAILED_PRECONDITION"))return a.NextResponse.json({success:!1,error:"Firestore query requires a composite index. Please check the server logs for the creation link."},{status:400});let e=t instanceof Error?t.message:"Internal Server Error";return a.NextResponse.json({success:!1,error:e},{status:500})}}let R=new s.AppRouteRouteModule({definition:{kind:I.x.APP_ROUTE,page:"/api/rfa/list/route",pathname:"/api/rfa/list",filename:"route",bundlePath:"app/api/rfa/list/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\list\\route.ts",nextConfigOutput:"",userland:E}),{requestAsyncStorage:c,staticGenerationAsyncStorage:_,serverHooks:D}=R,u="/api/rfa/list/route";function A(){return(0,i.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:_})}},4458:(e,t,r)=>{r.d(t,{$p:()=>n,Ge:()=>P,K$:()=>E,NK:()=>N,c9:()=>a,gf:()=>i,n$:()=>o,oU:()=>I,uc:()=>s});let E={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},s=[E.BIM,E.ME,E.SN,E.SITE_ADMIN,E.ADMIN,E.PM,E.PE,E.OE],I=[E.SITE_ADMIN,E.ADMIN_SITE_2,E.OE,E.PE,E.ADMIN],i=[E.CM,E.ADMIN,E.SITE_ADMIN,E.PM,E.PE,E.OE];E.PM,E.ADMIN,E.SE,E.FM;let a=[E.PE,E.OE,E.ADMIN],n=[E.PM,E.ADMIN];E.PD,E.SE,E.FM;let o={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},P={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},N={[o.PENDING_REVIEW]:"รอตรวจสอบ",[o.PENDING_CM_APPROVAL]:"รออนุมัติ (CM/Approver)",[o.REVISION_REQUIRED]:"แก้ไข",[o.APPROVED]:"อนุมัติ",[o.APPROVED_WITH_COMMENTS]:"อนุมัติตามคอมเมนต์ (ไม่แก้ไข)",[o.APPROVED_REVISION_REQUIRED]:"อนุมัติตามคอมเมนต์ (ต้องแก้ไข)",[o.REJECTED]:"ไม่อนุมัติ",[o.PENDING_FINAL_APPROVAL]:"รอ SITE อนุมัติขั้นสุดท้าย",[P.DRAFT]:"รออนุมัติ (PM)",[P.REJECTED_BY_PM]:"ไม่อนุมัติ (PM)",[P.PENDING_BIM]:"รอ BIM รับงาน",[P.IN_PROGRESS]:"BIM กำลังดำเนินการ",[P.PENDING_ACCEPTANCE]:"รอตรวจรับ (Site)",[P.REVISION_REQUESTED]:"ขอแก้ไข (WR)",[P.COMPLETED]:"เสร็จสิ้น"};o.PENDING_REVIEW,o.PENDING_CM_APPROVAL,o.REVISION_REQUIRED,o.APPROVED,o.REJECTED,o.APPROVED_WITH_COMMENTS,o.APPROVED_REVISION_REQUIRED,P.DRAFT,P.REJECTED_BY_PM,P.PENDING_BIM,P.IN_PROGRESS,P.PENDING_ACCEPTANCE,P.REVISION_REQUESTED,P.COMPLETED},40416:(e,t,r)=>{r.d(t,{CZ:()=>a,Hf:()=>n,iW:()=>i,SI:()=>o,uE:()=>P,Dh:()=>R,_B:()=>N,Lv:()=>c});let E=require("firebase-admin"),s=(e,t)=>E.apps.find(t=>t?.name===e)||E.initializeApp(t,e),I=()=>s("ttsdoc-v2",{credential:E.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),i=I().firestore(),a=I().auth(),n=I().storage().bucket(),o=I().messaging(),P=s("bim-tracking",{credential:E.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),N=()=>i,R=()=>a,c=()=>P}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),E=t.X(0,[9276,5972],()=>r(85871));module.exports=E})();