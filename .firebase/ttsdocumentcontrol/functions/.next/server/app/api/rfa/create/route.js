"use strict";(()=>{var e={};e.id=5044,e.ids=[5044],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},77913:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>l,patchFetch:()=>c,requestAsyncStorage:()=>N,routeModule:()=>I,serverHooks:()=>u,staticGenerationAsyncStorage:()=>P});var i=r(49303),E=r(88716),s=r(60670),n=r(29276),o=e([n]);n=(o.then?(await o)():o)[0];let I=new i.AppRouteRouteModule({definition:{kind:E.x.APP_ROUTE,page:"/api/rfa/create/route",pathname:"/api/rfa/create",filename:"route",bundlePath:"app/api/rfa/create/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\create\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:N,staticGenerationAsyncStorage:P,serverHooks:u}=I,l="/api/rfa/create/route";function c(){return(0,s.patchFetch)({serverHooks:u,staticGenerationAsyncStorage:P})}a()}catch(e){a(e)}})},29276:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{POST:()=>P,dynamic:()=>u});var i=r(87070),E=r(40416),s=r(72929),n=r(4458),o=e([s]);s=(o.then?(await o)():o)[0];let u="force-dynamic";async function c(e,t,r){let a=t?t.trim().replace(/[^\p{L}\p{N}]+/gu,"_").replace(/^_+|_+$/g,"").toUpperCase():"",i=E.iW.doc(`sites/${e}/categories/${a}`);return(await i.get()).exists?{id:a,created:!1}:(await i.set({name:r?.name??t,categoryCode:t,categoryName:r?.name??t,description:r?.description??"",rfaTypes:r?.rfaType?[r.rfaType]:[],active:!0,createdAt:s.FieldValue.serverTimestamp(),createdBy:r?.createdBy??"SYSTEM"}),{id:a,created:!0})}async function I(e){let t=(e.headers.get("authorization")||"").match(/^Bearer (.+)$/i);if(!t)return null;try{return(await E.CZ.verifyIdToken(t[1])).uid}catch{return null}}async function N(e){return e.json().catch(()=>({}))}async function P(e){let t=await I(e);if(!t)return i.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let r=null,a=[];try{let o=await E.iW.collection("users").doc(t).get();if(!o.exists)return i.NextResponse.json({error:"User not found"},{status:403});let I=o.data(),P=I?.role,{payload:u}=await N(e),{rfaType:l,siteId:d,categoryId:R,title:_,description:D,taskData:p,documentNumber:A,revisionNumber:M,uploadedFiles:T}=u||{};if(!l||!d||!_||!T||0===T.length||!R)return i.NextResponse.json({error:"Missing required fields. Required: rfaType, siteId, categoryId, title, uploadedFiles."},{status:400});if(A){let e=E.iW.collection("rfaDocuments").where("siteId","==",d).where("documentNumber","==",A.trim());if(!(await e.get()).empty)return i.NextResponse.json({success:!1,error:`เลขที่เอกสาร "${A.trim()}" นี้ถูกใช้ไปแล้วในโครงการนี้`},{status:409})}let S=await E.iW.runTransaction(async e=>{let t=E.iW.collection("sites").doc(d),r=await e.get(t);if(!r.exists)throw Error("Site not found");let a=r.data()?.shortName;if(!a)throw Error(`'shortName' is not configured for site ID: ${d}`);let i=`${d}_${l}`,s=E.iW.collection("counters").doc(i),n=await e.get(s),o=1;n.exists&&(o=(n.data()?.currentNumber||0)+1),e.set(s,{currentNumber:o},{merge:!0});let c=String(o).padStart(4,"0");return`${l}-${a}-${c}`});R||p?.taskCategory;let{id:O}=await c(d,R,{name:R,createdBy:t,rfaType:l}),m=A||S,C=[];for(let e of T){let r=e.filePath;if(!r||!r.startsWith(`temp/${t}/`)){console.warn(`Skipping invalid or unauthorized file path: ${r}`);continue}a.push(r);let i=e.fileName,s=Date.now(),n=`sites/${d}/rfa/${m}/${s}_${i}`;await E.Hf.file(r).move(n),C.push({...e,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${n}`,filePath:n,uploadedAt:new Date().toISOString(),uploadedBy:t})}let f=n.n$.PENDING_REVIEW,V="CREATE",g=n.oU.includes(P),h=P===n.K$.ME||P===n.K$.SN;"RFA-SHOP"===l&&h?(f=n.n$.PENDING_CM_APPROVAL,V="CREATE_AND_SUBMIT_TO_CM"):g&&["RFA-MAT","RFA-GEN","RFA-SHOP"].includes(l)&&(f=n.n$.PENDING_CM_APPROVAL,V="CREATE_AND_SUBMIT");let y=E.iW.collection("rfaDocuments").doc();return r=y.id,await y.set({siteId:d,rfaType:l,categoryId:O,title:_,description:D||"",taskData:p||null,documentNumber:A||"",status:f,currentStep:f,createdBy:t,createdAt:s.FieldValue.serverTimestamp(),updatedAt:s.FieldValue.serverTimestamp(),workflow:[{action:V,status:f,userId:t,userName:I?.email,role:P,timestamp:new Date().toISOString(),files:C}],files:C,runningNumber:S,revisionNumber:parseInt(M,10)||0,isLatest:!0}),i.NextResponse.json({success:!0,id:y.id,runningNumber:S},{status:201})}catch(e){return console.error("RFA Create Finalization Error:",e),r&&await E.iW.collection("rfaDocuments").doc(r).delete().catch(e=>console.error("Cleanup failed for doc:",e)),i.NextResponse.json({error:"Internal Server Error",details:e.message},{status:500})}}a()}catch(e){a(e)}})},4458:(e,t,r)=>{r.d(t,{$p:()=>o,Ge:()=>I,K$:()=>a,NK:()=>N,c9:()=>n,gf:()=>s,n$:()=>c,oU:()=>E,uc:()=>i});let a={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},i=[a.BIM,a.ME,a.SN,a.SITE_ADMIN,a.ADMIN,a.PM,a.PE,a.OE],E=[a.SITE_ADMIN,a.ADMIN_SITE_2,a.OE,a.PE,a.ADMIN],s=[a.CM,a.ADMIN,a.SITE_ADMIN,a.PM,a.PE,a.OE];a.PM,a.ADMIN,a.SE,a.FM;let n=[a.PE,a.OE,a.ADMIN],o=[a.PM,a.ADMIN];a.PD,a.SE,a.FM;let c={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},I={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},N={[c.PENDING_REVIEW]:"รอตรวจสอบ",[c.PENDING_CM_APPROVAL]:"รออนุมัติ (CM/Approver)",[c.REVISION_REQUIRED]:"แก้ไข",[c.APPROVED]:"อนุมัติ",[c.APPROVED_WITH_COMMENTS]:"อนุมัติตามคอมเมนต์ (ไม่แก้ไข)",[c.APPROVED_REVISION_REQUIRED]:"อนุมัติตามคอมเมนต์ (ต้องแก้ไข)",[c.REJECTED]:"ไม่อนุมัติ",[c.PENDING_FINAL_APPROVAL]:"รอ SITE อนุมัติขั้นสุดท้าย",[I.DRAFT]:"รออนุมัติ (PM)",[I.REJECTED_BY_PM]:"ไม่อนุมัติ (PM)",[I.PENDING_BIM]:"รอ BIM รับงาน",[I.IN_PROGRESS]:"BIM กำลังดำเนินการ",[I.PENDING_ACCEPTANCE]:"รอตรวจรับ (Site)",[I.REVISION_REQUESTED]:"ขอแก้ไข (WR)",[I.COMPLETED]:"เสร็จสิ้น"};c.PENDING_REVIEW,c.PENDING_CM_APPROVAL,c.REVISION_REQUIRED,c.APPROVED,c.REJECTED,c.APPROVED_WITH_COMMENTS,c.APPROVED_REVISION_REQUIRED,I.DRAFT,I.REJECTED_BY_PM,I.PENDING_BIM,I.IN_PROGRESS,I.PENDING_ACCEPTANCE,I.REVISION_REQUESTED,I.COMPLETED},40416:(e,t,r)=>{r.d(t,{CZ:()=>n,Hf:()=>o,iW:()=>s,SI:()=>c,uE:()=>I,Dh:()=>P,_B:()=>N,Lv:()=>u});let a=require("firebase-admin"),i=(e,t)=>a.apps.find(t=>t?.name===e)||a.initializeApp(t,e),E=()=>i("ttsdoc-v2",{credential:a.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),s=E().firestore(),n=E().auth(),o=E().storage().bucket(),c=E().messaging(),I=i("bim-tracking",{credential:a.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),N=()=>s,P=()=>n,u=()=>I}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9276,5972],()=>r(77913));module.exports=a})();