"use strict";(()=>{var e={};e.id=5044,e.ids=[5044],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},77913:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>p,patchFetch:()=>E,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>I,staticGenerationAsyncStorage:()=>l});var i=r(49303),n=r(88716),s=r(60670),o=r(29276),c=e([o]);o=(c.then?(await c)():c)[0];let u=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/rfa/create/route",pathname:"/api/rfa/create",filename:"route",bundlePath:"app/api/rfa/create/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\create\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:d,staticGenerationAsyncStorage:l,serverHooks:I}=u,p="/api/rfa/create/route";function E(){return(0,s.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:l})}a()}catch(e){a(e)}})},29276:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{POST:()=>l,dynamic:()=>I});var i=r(87070),n=r(40416),s=r(72929),o=r(4458),c=e([s]);s=(c.then?(await c)():c)[0];let I="force-dynamic";async function E(e,t,r){let a=t?t.trim().replace(/[^\p{L}\p{N}]+/gu,"_").replace(/^_+|_+$/g,"").toUpperCase():"",i=n.iW.doc(`sites/${e}/categories/${a}`);return(await i.get()).exists?{id:a,created:!1}:(await i.set({name:r?.name??t,categoryCode:t,categoryName:r?.name??t,description:r?.description??"",rfaTypes:r?.rfaType?[r.rfaType]:[],active:!0,createdAt:s.FieldValue.serverTimestamp(),createdBy:r?.createdBy??"SYSTEM"}),{id:a,created:!0})}async function u(e){let t=(e.headers.get("authorization")||"").match(/^Bearer (.+)$/i);if(!t)return null;try{return(await n.CZ.verifyIdToken(t[1])).uid}catch{return null}}async function d(e){return e.json().catch(()=>({}))}async function l(e){let t=await u(e);if(!t)return i.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let r=null,a=[];try{let c=await n.iW.collection("users").doc(t).get();if(!c.exists)return i.NextResponse.json({error:"User not found"},{status:403});let u=c.data(),l=u?.role,{payload:I}=await d(e),{rfaType:p,siteId:R,categoryId:N,title:P,description:_,taskData:A,documentNumber:D,revisionNumber:f,uploadedFiles:m}=I||{};if(!p||!R||!P||!D||!m||0===m.length||!N)return i.NextResponse.json({error:"Missing required fields. Required: rfaType, siteId, categoryId, title, documentNumber, uploadedFiles."},{status:400});let T=await n.iW.runTransaction(async e=>{let t=n.iW.collection("sites").doc(R),r=await e.get(t);if(!r.exists)throw Error("Site not found");let a=r.data()?.shortName;if(!a)throw Error(`'shortName' is not configured for site ID: ${R}`);let i=`${R}_${p}`,s=n.iW.collection("counters").doc(i),o=await e.get(s),c=1;o.exists&&(c=(o.data()?.currentNumber||0)+1),e.set(s,{currentNumber:c},{merge:!0});let E=String(c).padStart(4,"0");return`${p}-${a}-${E}`});N||A?.taskCategory;let{id:O}=await E(R,N,{name:N,createdBy:t,rfaType:p}),S=[];for(let e of m){let r=e.filePath;if(!r||!r.startsWith(`temp/${t}/`)){console.warn(`Skipping invalid or unauthorized file path: ${r}`);continue}a.push(r);let i=e.fileName,s=Date.now(),o=`sites/${R}/rfa/${D}/${s}_${i}`;await n.Hf.file(r).move(o),S.push({...e,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${o}`,filePath:o,uploadedAt:new Date().toISOString(),uploadedBy:t})}let M=o.n$.PENDING_REVIEW,C="CREATE",V=o.oU.includes(l),g=l===o.K$.ME||l===o.K$.SN;"RFA-SHOP"===p&&g?(M=o.n$.PENDING_CM_APPROVAL,C="CREATE_AND_SUBMIT_TO_CM"):V&&["RFA-MAT","RFA-GEN","RFA-SHOP"].includes(p)&&(M=o.n$.PENDING_CM_APPROVAL,C="CREATE_AND_SUBMIT");let h=n.iW.collection("rfaDocuments").doc();return r=h.id,await h.set({siteId:R,rfaType:p,categoryId:O,title:P,description:_||"",taskData:A||null,documentNumber:D,status:M,currentStep:M,createdBy:t,createdAt:s.FieldValue.serverTimestamp(),updatedAt:s.FieldValue.serverTimestamp(),workflow:[{action:C,status:M,userId:t,userName:u?.email,role:l,timestamp:new Date().toISOString(),files:S}],files:S,runningNumber:T,revisionNumber:parseInt(f,10)||0,isLatest:!0}),i.NextResponse.json({success:!0,id:h.id,runningNumber:T},{status:201})}catch(e){return console.error("RFA Create Finalization Error:",e),r&&await n.iW.collection("rfaDocuments").doc(r).delete().catch(e=>console.error("Cleanup failed for doc:",e)),i.NextResponse.json({error:"Internal Server Error",details:e.message},{status:500})}}a()}catch(e){a(e)}})},4458:(e,t,r)=>{r.d(t,{K$:()=>a,gf:()=>s,n$:()=>o,oU:()=>n,uc:()=>i});let a={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",SE:"SE",ADMIN_SITE_2:"Adminsite2"},i=[a.BIM,a.ME,a.SN],n=[a.SITE_ADMIN,a.ADMIN_SITE_2,a.OE,a.PE],s=[a.CM];a.PM,a.SE;let o={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"};o.PENDING_REVIEW,o.PENDING_CM_APPROVAL,o.REVISION_REQUIRED,o.APPROVED,o.APPROVED_WITH_COMMENTS,o.APPROVED_REVISION_REQUIRED,o.REJECTED,o.PENDING_FINAL_APPROVAL,o.PENDING_REVIEW,o.PENDING_CM_APPROVAL,o.REVISION_REQUIRED,o.APPROVED,o.REJECTED,o.APPROVED_WITH_COMMENTS,o.APPROVED_REVISION_REQUIRED},40416:(e,t,r)=>{r.d(t,{CZ:()=>o,Hf:()=>c,iW:()=>s,uE:()=>E,Lv:()=>u});let a=require("firebase-admin"),i=(e,t)=>a.apps.find(t=>t?.name===e)||a.initializeApp(t,e),n=()=>i("ttsdoc-v2",{credential:a.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),s=n().firestore(),o=n().auth(),c=n().storage().bucket(),E=i("bim-tracking",{credential:a.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),u=()=>E}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972],()=>r(77913));module.exports=a})();