"use strict";(()=>{var e={id:5044,ids:[5044]};e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},77913:(e,t,r)=>{r.a(e,(async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>_,requestAsyncStorage:()=>u,routeModule:()=>N,serverHooks:()=>d,staticGenerationAsyncStorage:()=>P});var s=r(49303),n=r(88716),i=r(60670),o=r(29276),E=e([o]);o=(E.then?(await E)():E)[0];const I="",N=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/rfa/create/route",pathname:"/api/rfa/create",filename:"route",bundlePath:"app/api/rfa/create/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\create\\route.ts",nextConfigOutput:I,userland:o}),{requestAsyncStorage:u,staticGenerationAsyncStorage:P,serverHooks:d}=N,R="/api/rfa/create/route";function _(){return(0,i.patchFetch)({serverHooks:d,staticGenerationAsyncStorage:P})}a()}catch(c){a(c)}}))},29276:(e,t,r)=>{r.a(e,(async(e,a)=>{try{r.r(t),r.d(t,{POST:()=>d,dynamic:()=>I});var s=r(87070),n=r(40416),i=r(72929),o=r(4458),E=e([i]);i=(E.then?(await E)():E)[0];const I="force-dynamic";async function N(e,t,r){const a=(s=t)?s.trim().replace(/[^\p{L}\p{N}]+/gu,"_").replace(/^_+|_+$/g,"").toUpperCase():"";var s;const o=n.iW.doc(`sites/${e}/categories/${a}`);return(await o.get()).exists?{id:a,created:!1}:(await o.set({name:r?.name??t,categoryCode:t,categoryName:r?.name??t,description:r?.description??"",rfaTypes:r?.rfaType?[r.rfaType]:[],active:!0,createdAt:i.FieldValue.serverTimestamp(),createdBy:r?.createdBy??"SYSTEM"}),{id:a,created:!0})}async function u(e){const t=(e.headers.get("authorization")||"").match(/^Bearer (.+)$/i);if(!t)return null;try{return(await n.CZ.verifyIdToken(t[1])).uid}catch{return null}}async function P(e){return e.json().catch((()=>({})))}async function d(e){const t=await u(e);if(!t)return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let r=null;const a=[];try{const E=await n.iW.collection("users").doc(t).get();if(!E.exists)return s.NextResponse.json({error:"User not found"},{status:403});const c=E.data(),I=c?.role,u=await P(e),{payload:d}=u,{rfaType:R,siteId:_,categoryId:p,title:D,description:A,taskData:l,documentNumber:M,revisionNumber:T,uploadedFiles:S}=d||{};if(!R||!_||!D||!S||0===S.length||!p)return s.NextResponse.json({error:"Missing required fields. Required: rfaType, siteId, categoryId, title, uploadedFiles."},{status:400});if(M){const e=n.iW.collection("rfaDocuments").where("siteId","==",_).where("documentNumber","==",M.trim());if(!(await e.get()).empty)return s.NextResponse.json({success:!1,error:`\u0e40\u0e25\u0e02\u0e17\u0e35\u0e48\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23 "${M.trim()}" \u0e19\u0e35\u0e49\u0e16\u0e39\u0e01\u0e43\u0e0a\u0e49\u0e44\u0e1b\u0e41\u0e25\u0e49\u0e27\u0e43\u0e19\u0e42\u0e04\u0e23\u0e07\u0e01\u0e32\u0e23\u0e19\u0e35\u0e49`},{status:409})}const m=await n.iW.runTransaction((async e=>{const t=n.iW.collection("sites").doc(_),r=await e.get(t);if(!r.exists)throw new Error("Site not found");const a=r.data()?.shortName;if(!a)throw new Error(`'shortName' is not configured for site ID: ${_}`);const s=`${_}_${R}`,i=n.iW.collection("counters").doc(s),o=await e.get(i);let E=1;o.exists&&(E=(o.data()?.currentNumber||0)+1),e.set(i,{currentNumber:E},{merge:!0});const c=String(E).padStart(4,"0");return`${R}-${a}-${c}`})),{id:O}=await N(_,p,{name:p,createdBy:t,rfaType:R}),f=M||m,C=[],g="https://ttsdoc-cdn.ttthaiii30.workers.dev";for(const e of S){const r=e.filePath;if(!r||!r.startsWith(`temp/${t}/`)){console.warn(`Skipping invalid or unauthorized file path: ${r}`);continue}a.push(r);const s=e.fileName,i=Date.now(),o=`sites/${_}/rfa/${f}/${i}_${s}`;await n.Hf.file(r).move(o),C.push({...e,fileUrl:`${g}/${o}`,filePath:o,uploadedAt:(new Date).toISOString(),uploadedBy:t})}let V=o.n$.PENDING_REVIEW,y="CREATE";const h=o.oU.includes(I),v=I===o.K$.ME||I===o.K$.SN;"RFA-SHOP"===R&&v?(V=o.n$.PENDING_CM_APPROVAL,y="CREATE_AND_SUBMIT_TO_CM"):h&&["RFA-MAT","RFA-GEN","RFA-SHOP"].includes(R)&&(V=o.n$.PENDING_CM_APPROVAL,y="CREATE_AND_SUBMIT");const G=n.iW.collection("rfaDocuments").doc();return r=G.id,await G.set({siteId:_,rfaType:R,categoryId:O,title:D,description:A||"",taskData:l||null,documentNumber:M||"",status:V,currentStep:V,createdBy:t,createdAt:i.FieldValue.serverTimestamp(),updatedAt:i.FieldValue.serverTimestamp(),workflow:[{action:y,status:V,userId:t,userName:c?.email,role:I,timestamp:(new Date).toISOString(),files:C}],files:C,runningNumber:m,revisionNumber:parseInt(T,10)||0,isLatest:!0}),s.NextResponse.json({success:!0,id:G.id,runningNumber:m},{status:201})}catch(E){return console.error("RFA Create Finalization Error:",E),r&&await n.iW.collection("rfaDocuments").doc(r).delete().catch((e=>console.error("Cleanup failed for doc:",e))),s.NextResponse.json({error:"Internal Server Error",details:E.message},{status:500})}}a()}catch(c){a(c)}}))},4458:(e,t,r)=>{r.d(t,{$p:()=>E,Ge:()=>I,K$:()=>a,NK:()=>N,c9:()=>o,gf:()=>i,n$:()=>c,oU:()=>n,uc:()=>s});const a={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},s=[a.BIM,a.ME,a.SN,a.SITE_ADMIN,a.ADMIN,a.PM,a.PE,a.OE],n=[a.SITE_ADMIN,a.ADMIN_SITE_2,a.OE,a.PE,a.ADMIN],i=[a.CM,a.ADMIN,a.SITE_ADMIN,a.PM,a.PE,a.OE],o=(a.PM,a.ADMIN,a.SE,a.FM,[a.PE,a.OE,a.ADMIN]),E=[a.PM,a.ADMIN],c=(a.PD,a.SE,a.FM,{PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"}),I={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},N={[c.PENDING_REVIEW]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e2a\u0e2d\u0e1a",[c.PENDING_CM_APPROVAL]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (CM/Approver)",[c.REVISION_REQUIRED]:"\u0e41\u0e01\u0e49\u0e44\u0e02",[c.APPROVED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[c.APPROVED_WITH_COMMENTS]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e44\u0e21\u0e48\u0e41\u0e01\u0e49\u0e44\u0e02)",[c.APPROVED_REVISION_REQUIRED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e15\u0e49\u0e2d\u0e07\u0e41\u0e01\u0e49\u0e44\u0e02)",[c.REJECTED]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[c.PENDING_FINAL_APPROVAL]:"\u0e23\u0e2d SITE \u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e02\u0e31\u0e49\u0e19\u0e2a\u0e38\u0e14\u0e17\u0e49\u0e32\u0e22",[I.DRAFT]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[I.REJECTED_BY_PM]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[I.PENDING_BIM]:"\u0e23\u0e2d BIM \u0e23\u0e31\u0e1a\u0e07\u0e32\u0e19",[I.IN_PROGRESS]:"BIM \u0e01\u0e33\u0e25\u0e31\u0e07\u0e14\u0e33\u0e40\u0e19\u0e34\u0e19\u0e01\u0e32\u0e23",[I.PENDING_ACCEPTANCE]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e23\u0e31\u0e1a (Site)",[I.REVISION_REQUESTED]:"\u0e02\u0e2d\u0e41\u0e01\u0e49\u0e44\u0e02 (WR)",[I.COMPLETED]:"\u0e40\u0e2a\u0e23\u0e47\u0e08\u0e2a\u0e34\u0e49\u0e19"};c.PENDING_REVIEW,c.PENDING_CM_APPROVAL,c.REVISION_REQUIRED,c.APPROVED,c.REJECTED,c.APPROVED_WITH_COMMENTS,c.APPROVED_REVISION_REQUIRED,c.PENDING_FINAL_APPROVAL,I.DRAFT,I.REJECTED_BY_PM,I.PENDING_BIM,I.IN_PROGRESS,I.PENDING_ACCEPTANCE,I.REVISION_REQUESTED,I.COMPLETED},40416:(e,t,r)=>{r.d(t,{CZ:()=>o,Hf:()=>E,iW:()=>i,SI:()=>c,uE:()=>I,Dh:()=>u,aj:()=>P,_B:()=>N,Lv:()=>d});const a=require("firebase-admin"),s=(e,t)=>a.apps.find((t=>t?.name===e))||a.initializeApp(t,e),n=()=>{const e={credential:a.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"};return s("ttsdoc-v2",e)},i=n().firestore(),o=n().auth(),E=n().storage().bucket(),c=n().messaging(),I=(()=>{const e={credential:a.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})};return s("bim-tracking",e)})().firestore(),N=()=>i,u=()=>o,P=()=>E,d=()=>I}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=t.X(0,[9276,5972],(()=>{return e=77913,t(t.s=e);var e}));module.exports=r})();