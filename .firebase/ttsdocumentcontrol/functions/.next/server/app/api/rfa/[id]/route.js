"use strict";(()=>{var e={id:1173,ids:[1173]};e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},65572:(e,t,s)=>{s.a(e,(async(e,E)=>{try{s.r(t),s.d(t,{originalPathname:()=>_,patchFetch:()=>u,requestAsyncStorage:()=>N,routeModule:()=>R,serverHooks:()=>A,staticGenerationAsyncStorage:()=>P});var r=s(49303),n=s(88716),o=s(60670),a=s(72848),i=e([a]);a=(i.then?(await i)():i)[0];const c="",R=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/rfa/[id]/route",pathname:"/api/rfa/[id]",filename:"route",bundlePath:"app/api/rfa/[id]/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\[id]\\route.ts",nextConfigOutput:c,userland:a}),{requestAsyncStorage:N,staticGenerationAsyncStorage:P,serverHooks:A}=R,_="/api/rfa/[id]/route";function u(){return(0,o.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:P})}E()}catch(I){E(I)}}))},72848:(e,t,s)=>{s.a(e,(async(e,E)=>{try{s.r(t),s.d(t,{GET:()=>A,PUT:()=>_,dynamic:()=>N});var r=s(87070),n=s(40416),o=s(72929),a=s(4458),i=s(58780),I=s(51951),c=e([o]);o=(c.then?(await c)():c)[0];const N="force-dynamic",P=(e,t,s,E,r)=>{const n=t?.[s]?.[E];return void 0!==n?n:r.includes(e)};async function A(e,{params:t}){try{const s=e.headers.get("authorization");if(!s?.startsWith("Bearer "))return r.NextResponse.json({success:!1,error:"Missing authorization"},{status:401});const E=s.split("Bearer ")[1],o=(await n.CZ.verifyIdToken(E)).uid,i=await n.iW.collection("users").doc(o).get();if(!i.exists)return r.NextResponse.json({success:!1,error:"User not found"},{status:404});const c=i.data(),R=c.sites||[],N=await n.iW.collection("rfaDocuments").doc(t.id).get();if(!N.exists)return r.NextResponse.json({success:!1,error:"RFA document not found"},{status:404});const A=N.data();if(c.role!==a.K$.ADMIN&&!R.includes(A.siteId))return r.NextResponse.json({success:!1,error:"Access denied"},{status:403});let _={id:A.siteId,name:"N/A"},u={},d="INTERNAL";if(A.siteId){const e=await n.iW.collection("sites").doc(A.siteId).get();if(e.exists){const t=e.data();_={id:e.id,name:t?.name||"Unknown Site",cmSystemType:t?.cmSystemType||"INTERNAL"},d=t?.cmSystemType||"INTERNAL",u=t?.userOverrides?.[o]||{}}}const D={id:A.categoryId,categoryCode:A.taskData?.taskCategory||A.categoryId||"N/A"},M=c.role,O=A.status,T=a.oU.includes(M),l=M===a.K$.CM||M===a.K$.ADMIN,S=P(M,u,"RFA",I.S4.RFA.APPROVE,a.gf);let $=!1,V=!1;"INTERNAL"===d?O===a.n$.PENDING_CM_APPROVAL?($=l||S,V=l||S):O===a.n$.PENDING_FINAL_APPROVAL&&($=T||S,V=T||S):O===a.n$.PENDING_CM_APPROVAL&&($=T||S,V=T||S);const p={canView:!0,canEdit:a.uc.includes(c.role)&&A.status===a.n$.REVISION_REQUIRED,canSendToCm:T&&A.status===a.n$.PENDING_REVIEW,canRequestRevision:T&&A.status===a.n$.PENDING_REVIEW,canApprove:$,canReject:V,canDownloadFiles:!0};return r.NextResponse.json({success:!0,document:{id:N.id,...A,site:_,category:D,permissions:p}})}catch(s){return console.error("Error fetching RFA:",s),r.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function _(e,{params:t}){try{const s=e.headers.get("authorization");if(!s?.startsWith("Bearer "))return r.NextResponse.json({error:"Unauthorized"},{status:401});const E=s.split("Bearer ")[1],c=(await n.CZ.verifyIdToken(E)).uid,R=await n.iW.collection("users").doc(c).get();if(!R.exists)return r.NextResponse.json({error:"User not found"},{status:404});const N=R.data(),A=N.role,_=await e.json(),{action:u,comments:d,newFiles:D,documentNumber:M}=_;if(!u)return r.NextResponse.json({error:"Action is required"},{status:400});const O=n.iW.collection("rfaDocuments").doc(t.id),T=await O.get();if(!T.exists)return r.NextResponse.json({error:"RFA not found"},{status:404});const l=T.data(),S=(await n.iW.collection("sites").doc(l.siteId).get()).data(),$=S?.cmSystemType||"INTERNAL",V=S?.name||"\u0e42\u0e04\u0e23\u0e07\u0e01\u0e32\u0e23\u0e17\u0e31\u0e48\u0e27\u0e44\u0e1b",p=S?.userOverrides?.[c]||{};let C=l.status,m=!1;const f=a.oU.includes(A);f&&l.status===a.n$.PENDING_REVIEW&&["SEND_TO_CM","REQUEST_REVISION"].includes(u)&&(m=!0),a.uc.includes(A)&&l.createdBy===c&&l.status===a.n$.REVISION_REQUIRED&&"SUBMIT_REVISION"===u&&(m=!0);const K=A===a.K$.CM||A===a.K$.ADMIN,g=P(A,p,"RFA",I.S4.RFA.APPROVE,a.gf);if(["APPROVE","APPROVE_WITH_COMMENTS","REJECT","APPROVE_REVISION_REQUIRED"].includes(u)&&("INTERNAL"===$?l.status===a.n$.PENDING_CM_APPROVAL?(K||g)&&(m=!0):l.status===a.n$.PENDING_FINAL_APPROVAL&&(f||g)&&(m=!0):l.status===a.n$.PENDING_CM_APPROVAL&&(f||g)&&(m=!0)),!m)return r.NextResponse.json({success:!1,error:"Permission denied or invalid status."},{status:403});switch(u){case"SEND_TO_CM":C=a.n$.PENDING_CM_APPROVAL;break;case"REQUEST_REVISION":C=a.n$.REVISION_REQUIRED;break;case"SUBMIT_REVISION":C=a.n$.PENDING_REVIEW;break;case"REJECT":C=a.n$.REJECTED;break;case"APPROVE_REVISION_REQUIRED":C=a.n$.APPROVED_REVISION_REQUIRED;break;case"APPROVE":case"APPROVE_WITH_COMMENTS":C="INTERNAL"===$&&l.status===a.n$.PENDING_CM_APPROVAL?a.n$.PENDING_FINAL_APPROVAL:"APPROVE"===u?a.n$.APPROVED:a.n$.APPROVED_WITH_COMMENTS}let h=l.files||[],F=[];if(D&&Array.isArray(D)&&D.length>0){const e="https://ttsdoc-cdn.ttthaiii30.workers.dev";for(const t of D){const s=t.filePath;if(!s||!s.startsWith(`temp/${c}/`))continue;const E=M||l.documentNumber||"temp",r=`sites/${l.siteId}/rfa/${E}/${Date.now()}_${t.fileName}`;await n.Hf.file(s).move(r);const o={fileName:t.fileName,fileUrl:`${e}/${r}`,filePath:r,size:t.size,fileSize:t.size,contentType:t.contentType,uploadedAt:(new Date).toISOString(),uploadedBy:c};F.push(o),h.push(o)}}const G={action:u,status:C,userId:c,userName:N.email,role:A,timestamp:(new Date).toISOString(),comments:d||"",files:F},W={status:C,currentStep:C,workflow:o.FieldValue.arrayUnion(G),updatedAt:o.FieldValue.serverTimestamp()};M&&(W.documentNumber=M),F.length>0&&(W.files=h),await O.update(W);if([a.n$.APPROVED,a.n$.APPROVED_WITH_COMMENTS,a.n$.APPROVED_REVISION_REQUIRED,a.n$.PENDING_FINAL_APPROVAL].includes(C)){const e=[];if((await n.iW.collection("users").where("sites","array-contains",l.siteId).where("status","==","ACTIVE").get()).forEach((t=>{const s=t.data().role;C===a.n$.PENDING_FINAL_APPROVAL?a.oU.includes(s)&&e.push(t.id):["SE","FM"].includes(s)&&e.push(t.id)})),e.length>0){let s=`\ud83d\udce3 \u0e2d\u0e31\u0e1b\u0e40\u0e14\u0e15\u0e2a\u0e16\u0e32\u0e19\u0e30: ${M||l.documentNumber}`;C===a.n$.PENDING_FINAL_APPROVAL&&(s=`\u23f3 \u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e02\u0e31\u0e49\u0e19\u0e2a\u0e38\u0e14\u0e17\u0e49\u0e32\u0e22: ${M||l.documentNumber}`),C===a.n$.APPROVED&&(s=`\u2705 \u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e41\u0e25\u0e49\u0e27: ${M||l.documentNumber}`);const E=`\u0e42\u0e04\u0e23\u0e07\u0e01\u0e32\u0e23: ${V}\n\u0e2a\u0e16\u0e32\u0e19\u0e30: ${a.NK[C]||C}`;await(0,i.z)(e,{title:s,body:E,url:`/dashboard/rfa/${t.id}`})}}return r.NextResponse.json({success:!0,message:"Action completed",newStatus:C})}catch(s){return console.error("Error updating RFA:",s),r.NextResponse.json({success:!1,error:s.message},{status:500})}}E()}catch(R){E(R)}}))},51951:(e,t,s)=>{s.d(t,{S4:()=>r});var E=s(4458);const r={RFA:{VIEW_SHOP:"view_shop",CREATE_SHOP:"create_shop",VIEW_GEN:"view_gen",CREATE_GEN:"create_gen",VIEW_MAT:"view_mat",CREATE_MAT:"create_mat",APPROVE:"can_approve"},WORK_REQUEST:{VIEW:"view_wr",CREATE:"create_wr",APPROVE:"approve_wr",VERIFY:"verify_wr"}},n=(E.K$.ADMIN,E.K$.PD,E.K$.PM,E.K$.SE,E.K$.FM,E.K$.BIM,E.K$.SITE_ADMIN,E.K$.CM,E.K$.ME,E.K$.SN,E.K$.OE,E.K$.PE,[E.K$.ADMIN,E.K$.PD,E.K$.PM,E.K$.BIM,E.K$.SITE_ADMIN,E.K$.CM,E.K$.ME,E.K$.SN,E.K$.OE,E.K$.PE]);r.RFA.VIEW_SHOP,r.RFA.CREATE_SHOP,E.K$.BIM,E.K$.ME,E.K$.SN,E.K$.SITE_ADMIN,E.K$.ADMIN,E.K$.PM,E.K$.PE,E.K$.OE,r.RFA.VIEW_GEN,r.RFA.CREATE_GEN,E.K$.BIM,E.K$.ME,E.K$.SN,E.K$.SITE_ADMIN,E.K$.ADMIN,E.K$.PM,E.K$.PE,E.K$.OE,r.RFA.VIEW_MAT,r.RFA.CREATE_MAT,E.K$.SITE_ADMIN,E.K$.ADMIN,E.K$.PM,E.K$.PE,E.K$.OE,r.RFA.APPROVE,E.K$.CM,E.K$.ADMIN,E.K$.SITE_ADMIN,E.K$.PM,E.K$.PE,E.K$.OE,r.WORK_REQUEST.VIEW,r.WORK_REQUEST.CREATE,E.K$.PE,E.K$.OE,E.K$.ADMIN,r.WORK_REQUEST.APPROVE,E.K$.PM,E.K$.ADMIN,r.WORK_REQUEST.VERIFY,E.K$.SITE_ADMIN,E.K$.ADMIN,E.K$.BIM,r.RFA.VIEW_SHOP,r.RFA.CREATE_SHOP,r.RFA.VIEW_GEN,r.RFA.CREATE_GEN,r.RFA.VIEW_MAT,r.RFA.CREATE_MAT,r.RFA.APPROVE,r.WORK_REQUEST.VIEW,r.WORK_REQUEST.CREATE,r.WORK_REQUEST.APPROVE,r.WORK_REQUEST.VERIFY},4458:(e,t,s)=>{s.d(t,{$p:()=>i,Ge:()=>c,K$:()=>E,NK:()=>R,c9:()=>a,gf:()=>o,n$:()=>I,oU:()=>n,uc:()=>r});const E={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},r=[E.BIM,E.ME,E.SN,E.SITE_ADMIN,E.ADMIN,E.PM,E.PE,E.OE],n=[E.SITE_ADMIN,E.ADMIN_SITE_2,E.OE,E.PE,E.ADMIN],o=[E.CM,E.ADMIN,E.SITE_ADMIN,E.PM,E.PE,E.OE],a=(E.PM,E.ADMIN,E.SE,E.FM,[E.PE,E.OE,E.ADMIN]),i=[E.PM,E.ADMIN],I=(E.PD,E.SE,E.FM,{PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"}),c={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},R={[I.PENDING_REVIEW]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e2a\u0e2d\u0e1a",[I.PENDING_CM_APPROVAL]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (CM/Approver)",[I.REVISION_REQUIRED]:"\u0e41\u0e01\u0e49\u0e44\u0e02",[I.APPROVED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[I.APPROVED_WITH_COMMENTS]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e44\u0e21\u0e48\u0e41\u0e01\u0e49\u0e44\u0e02)",[I.APPROVED_REVISION_REQUIRED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e15\u0e49\u0e2d\u0e07\u0e41\u0e01\u0e49\u0e44\u0e02)",[I.REJECTED]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[I.PENDING_FINAL_APPROVAL]:"\u0e23\u0e2d SITE \u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e02\u0e31\u0e49\u0e19\u0e2a\u0e38\u0e14\u0e17\u0e49\u0e32\u0e22",[c.DRAFT]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[c.REJECTED_BY_PM]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[c.PENDING_BIM]:"\u0e23\u0e2d BIM \u0e23\u0e31\u0e1a\u0e07\u0e32\u0e19",[c.IN_PROGRESS]:"BIM \u0e01\u0e33\u0e25\u0e31\u0e07\u0e14\u0e33\u0e40\u0e19\u0e34\u0e19\u0e01\u0e32\u0e23",[c.PENDING_ACCEPTANCE]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e23\u0e31\u0e1a (Site)",[c.REVISION_REQUESTED]:"\u0e02\u0e2d\u0e41\u0e01\u0e49\u0e44\u0e02 (WR)",[c.COMPLETED]:"\u0e40\u0e2a\u0e23\u0e47\u0e08\u0e2a\u0e34\u0e49\u0e19"};I.PENDING_REVIEW,I.PENDING_CM_APPROVAL,I.REVISION_REQUIRED,I.APPROVED,I.REJECTED,I.APPROVED_WITH_COMMENTS,I.APPROVED_REVISION_REQUIRED,I.PENDING_FINAL_APPROVAL,c.DRAFT,c.REJECTED_BY_PM,c.PENDING_BIM,c.IN_PROGRESS,c.PENDING_ACCEPTANCE,c.REVISION_REQUESTED,c.COMPLETED},40416:(e,t,s)=>{s.d(t,{CZ:()=>a,Hf:()=>i,iW:()=>o,SI:()=>I,uE:()=>c,Dh:()=>N,aj:()=>P,_B:()=>R,Lv:()=>A});const E=require("firebase-admin"),r=(e,t)=>E.apps.find((t=>t?.name===e))||E.initializeApp(t,e),n=()=>{const e={credential:E.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"};return r("ttsdoc-v2",e)},o=n().firestore(),a=n().auth(),i=n().storage().bucket(),I=n().messaging(),c=(()=>{const e={credential:E.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})};return r("bim-tracking",e)})().firestore(),R=()=>o,N=()=>a,P=()=>i,A=()=>c},58780:(e,t,s)=>{s.d(t,{z:()=>r});var E=s(40416);async function r(e,t){if(e&&0!==e.length)try{console.log(`\ud83d\udd14 Preparing to send notification to ${e.length} users...`);const s=e.map((e=>E.iW.collection("users").doc(e))),r=await E.iW.getAll(...s);let n=[];if(r.forEach((e=>{if(e.exists){const t=e.data();t?.fcmTokens&&Array.isArray(t.fcmTokens)&&n.push(...t.fcmTokens)}})),n=[...new Set(n)].filter((e=>e)),0===n.length)return void console.log("\u26a0\ufe0f No registered devices found for these users.");const o={data:{title:t.title,body:t.body,url:t.url||"/dashboard",click_action:t.url||"/dashboard"},tokens:n},a=await E.SI.sendEachForMulticast(o);console.log(`\u2705 Sent ${a.successCount} messages successfully.`),a.failureCount>0&&console.log(`\u274c Failed to send ${a.failureCount} messages.`)}catch(s){console.error("\ud83d\udd25 Error sending push notification:",s)}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=t.X(0,[9276,5972],(()=>{return e=65572,t(t.s=e);var e}));module.exports=s})();