"use strict";(()=>{var e={};e.id=1173,e.ids=[1173],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},65572:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{originalPathname:()=>N,patchFetch:()=>c,requestAsyncStorage:()=>R,routeModule:()=>I,serverHooks:()=>d,staticGenerationAsyncStorage:()=>u});var a=s(49303),n=s(88716),i=s(60670),o=s(72848),E=e([o]);o=(E.then?(await E)():E)[0];let I=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/rfa/[id]/route",pathname:"/api/rfa/[id]",filename:"route",bundlePath:"app/api/rfa/[id]/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\[id]\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:R,staticGenerationAsyncStorage:u,serverHooks:d}=I,N="/api/rfa/[id]/route";function c(){return(0,i.patchFetch)({serverHooks:d,staticGenerationAsyncStorage:u})}r()}catch(e){r(e)}})},72848:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{GET:()=>c,PUT:()=>I,dynamic:()=>R});var a=s(87070),n=s(40416),i=s(72929),o=s(4458),E=e([i]);i=(E.then?(await E)():E)[0];let R="force-dynamic";async function c(e,{params:t}){try{let s=e.headers.get("authorization");if(!s?.startsWith("Bearer "))return a.NextResponse.json({success:!1,error:"Missing or invalid authorization header"},{status:401});let r=s.split("Bearer ")[1],i=(await n.CZ.verifyIdToken(r)).uid,E=await n.iW.collection("users").doc(i).get();if(!E.exists)return a.NextResponse.json({success:!1,error:"User not found"},{status:404});let c=E.data(),I=c.sites||[],R=await n.iW.collection("rfaDocuments").doc(t.id).get();if(!R.exists)return a.NextResponse.json({success:!1,error:"RFA document not found"},{status:404});let u=R.data();if(!I.includes(u.siteId))return a.NextResponse.json({success:!1,error:"Access denied to this site"},{status:403});let d={id:u.siteId,name:"N/A"};if(u.siteId){let e=await n.iW.collection("sites").doc(u.siteId).get();e.exists&&(d={id:e.id,name:e.data()?.name||"Unknown Site",cmSystemType:e.data()?.cmSystemType||"INTERNAL"})}let N=u.workflow?.[0]?.role||"BIM",P={id:u.categoryId,categoryCode:u.taskData?.taskCategory||u.categoryId||"N/A"},l={canView:!0,canEdit:o.uc.includes(c.role)&&u.status===o.n$.REVISION_REQUIRED,canSendToCm:o.oU.includes(c.role)&&u.status===o.n$.PENDING_REVIEW,canRequestRevision:o.oU.includes(c.role)&&u.status===o.n$.PENDING_REVIEW,canApprove:o.gf.includes(c.role)&&u.status===o.n$.PENDING_CM_APPROVAL,canReject:o.gf.includes(c.role)&&u.status===o.n$.PENDING_CM_APPROVAL,canDownloadFiles:!0},_={id:R.id,...u,site:d,category:P,permissions:l,creatorRole:N};return a.NextResponse.json({success:!0,document:_})}catch(e){return console.error("Error fetching RFA document:",e),a.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function I(e,{params:t}){try{let s=e.headers.get("authorization");if(!s?.startsWith("Bearer "))return a.NextResponse.json({error:"Unauthorized"},{status:401});let r=s.split("Bearer ")[1],E=(await n.CZ.verifyIdToken(r)).uid,c=await n.iW.collection("users").doc(E).get();if(!c.exists)return a.NextResponse.json({error:"User not found"},{status:404});let I=c.data(),R=I.role,{action:u,comments:d,newFiles:N}=await e.json();if(!u)return a.NextResponse.json({error:"Action is required"},{status:400});let P=n.iW.collection("rfaDocuments").doc(t.id),l=await P.get();if(!l.exists)return a.NextResponse.json({error:"RFA document not found"},{status:404});let _=l.data(),A=await n.iW.collection("sites").doc(_.siteId).get(),p=A.data()?.cmSystemType||"INTERNAL",O=_.status,D=!1;if(o.oU.includes(R)?_.status===o.n$.PENDING_REVIEW&&("SEND_TO_CM"===u||"REQUEST_REVISION"===u)?D=!0:_.status===o.n$.PENDING_CM_APPROVAL&&"EXTERNAL"===p&&["APPROVE","APPROVE_WITH_COMMENTS","APPROVE_REVISION_REQUIRED","REJECT"].includes(u)?D=!0:_.status===o.n$.PENDING_FINAL_APPROVAL&&"INTERNAL"===p&&["APPROVE","APPROVE_WITH_COMMENTS","APPROVE_REVISION_REQUIRED","REJECT"].includes(u)&&(D=!0):o.gf.includes(R)&&_.status===o.n$.PENDING_CM_APPROVAL&&"INTERNAL"===p?["APPROVE","APPROVE_WITH_COMMENTS","REJECT"].includes(u)&&(D=!0):o.uc.includes(R)&&_.createdBy===E&&_.status===o.n$.REVISION_REQUIRED&&"SUBMIT_REVISION"===u&&(D=!0),!D)return a.NextResponse.json({success:!1,error:"Permission denied for this action or invalid document status."},{status:403});switch(u){case"SEND_TO_CM":O=o.n$.PENDING_CM_APPROVAL;break;case"REQUEST_REVISION":O=o.n$.REVISION_REQUIRED;break;case"SUBMIT_REVISION":O=o.n$.PENDING_REVIEW;break;case"REJECT":O=o.n$.REJECTED;break;case"APPROVE_REVISION_REQUIRED":O=o.n$.APPROVED_REVISION_REQUIRED;break;case"APPROVE":O="CM"===R&&"INTERNAL"===p?o.n$.PENDING_FINAL_APPROVAL:o.n$.APPROVED;break;case"APPROVE_WITH_COMMENTS":O="CM"===R&&"INTERNAL"===p?o.n$.PENDING_FINAL_APPROVAL:o.n$.APPROVED_WITH_COMMENTS}let V=_.files||[],T=[];if(N&&Array.isArray(N)&&N.length>0){let e=[];for(let t of N){let s=t.filePath;if(!s||!s.startsWith(`temp/${E}/`))continue;let r=`sites/${_.siteId}/rfa/${_.documentNumber}/${Date.now()}_${t.fileName}`;await n.Hf.file(s).move(r),e.push({fileName:t.fileName,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${r}`,filePath:r,size:t.size,fileSize:t.size,contentType:t.contentType,uploadedAt:new Date().toISOString(),uploadedBy:E})}T=e,V.push(...e)}let f={action:u,status:O,userId:E,userName:I.email,role:R,timestamp:new Date().toISOString(),comments:d||"",files:T};return await P.update({status:O,currentStep:O,files:V,workflow:i.FieldValue.arrayUnion(f),updatedAt:i.FieldValue.serverTimestamp()}),a.NextResponse.json({success:!0,message:`Action [${u}] completed successfully`,newStatus:O})}catch(t){console.error("Error updating RFA document:",t);let e=t instanceof Error?t.message:"Internal server error";return a.NextResponse.json({success:!1,error:e},{status:500})}}r()}catch(e){r(e)}})},4458:(e,t,s)=>{s.d(t,{K$:()=>r,gf:()=>i,n$:()=>o,oU:()=>n,uc:()=>a});let r={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",SE:"SE",ADMIN_SITE_2:"Adminsite2"},a=[r.BIM,r.ME,r.SN],n=[r.SITE_ADMIN,r.ADMIN_SITE_2,r.OE,r.PE],i=[r.CM];r.PM,r.SE;let o={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"};o.PENDING_REVIEW,o.PENDING_CM_APPROVAL,o.REVISION_REQUIRED,o.APPROVED,o.APPROVED_WITH_COMMENTS,o.APPROVED_REVISION_REQUIRED,o.REJECTED,o.PENDING_FINAL_APPROVAL,o.PENDING_REVIEW,o.PENDING_CM_APPROVAL,o.REVISION_REQUIRED,o.APPROVED,o.REJECTED,o.APPROVED_WITH_COMMENTS,o.APPROVED_REVISION_REQUIRED},40416:(e,t,s)=>{s.d(t,{CZ:()=>o,Hf:()=>E,iW:()=>i,uE:()=>c,Lv:()=>I});let r=require("firebase-admin"),a=(e,t)=>r.apps.find(t=>t?.name===e)||r.initializeApp(t,e),n=()=>a("ttsdoc-v2",{credential:r.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),i=n().firestore(),o=n().auth(),E=n().storage().bucket(),c=a("bim-tracking",{credential:r.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),I=()=>c}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>s(65572));module.exports=r})();