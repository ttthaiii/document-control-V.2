"use strict";(()=>{var e={};e.id=173,e.ids=[173],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},65572:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{originalPathname:()=>I,patchFetch:()=>u,requestAsyncStorage:()=>d,routeModule:()=>E,serverHooks:()=>l,staticGenerationAsyncStorage:()=>R});var a=s(49303),n=s(88716),i=s(60670),o=s(72848),c=e([o]);o=(c.then?(await c)():c)[0];let E=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/rfa/[id]/route",pathname:"/api/rfa/[id]",filename:"route",bundlePath:"app/api/rfa/[id]/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\[id]\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:d,staticGenerationAsyncStorage:R,serverHooks:l}=E,I="/api/rfa/[id]/route";function u(){return(0,i.patchFetch)({serverHooks:l,staticGenerationAsyncStorage:R})}r()}catch(e){r(e)}})},72848:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{GET:()=>u,PUT:()=>E});var a=s(87070),n=s(40416),i=s(72929),o=s(4458),c=e([i]);async function u(e,{params:t}){try{let s=e.headers.get("authorization");if(!s?.startsWith("Bearer "))return a.NextResponse.json({success:!1,error:"Missing or invalid authorization header"},{status:401});let r=s.split("Bearer ")[1],i=(await n.CZ.verifyIdToken(r)).uid,c=await n.iW.collection("users").doc(i).get();if(!c.exists)return a.NextResponse.json({success:!1,error:"User not found"},{status:404});let u=c.data(),E=u.role,d=u.sites||[],R=await n.iW.collection("rfaDocuments").doc(t.id).get();if(!R.exists)return a.NextResponse.json({success:!1,error:"RFA document not found"},{status:404});let l=R.data();if(!d.includes(l.siteId))return a.NextResponse.json({success:!1,error:"Access denied to this site"},{status:403});let I={id:l.siteId,name:l.siteName||"N/A"},p={id:l.categoryId,categoryCode:l.taskData?.taskCategory||l.categoryId||"N/A"},N={canView:!0,canEdit:o.uc.includes(E)&&l.status===o.n$.REVISION_REQUIRED,canSendToCm:o.oU.includes(E)&&l.status===o.n$.PENDING_REVIEW,canRequestRevision:o.oU.includes(E)&&l.status===o.n$.PENDING_REVIEW,canApprove:o.gf.includes(E)&&l.status===o.n$.PENDING_CM_APPROVAL,canReject:o.gf.includes(E)&&l.status===o.n$.PENDING_CM_APPROVAL,canDownloadFiles:!0},P={id:R.id,...l,site:I,category:p,permissions:N};return a.NextResponse.json({success:!0,document:P})}catch(e){return console.error("Error fetching RFA document:",e),a.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function E(e,{params:t}){try{let s=e.headers.get("authorization");if(!s?.startsWith("Bearer "))return a.NextResponse.json({error:"Unauthorized"},{status:401});let r=s.split("Bearer ")[1],c=(await n.CZ.verifyIdToken(r)).uid,u=await n.iW.collection("users").doc(c).get();if(!u.exists)return a.NextResponse.json({error:"User not found"},{status:404});let E=u.data(),d=E.role,{action:R,comments:l,newFiles:I}=await e.json();if(!R)return a.NextResponse.json({error:"Action is required"},{status:400});if(!I||!Array.isArray(I)||0===I.length)return a.NextResponse.json({error:"Attaching new files is required for this action"},{status:400});let p=n.iW.collection("rfaDocuments").doc(t.id),N=await p.get();if(!N.exists)return a.NextResponse.json({error:"RFA document not found"},{status:404});let P=N.data(),_=P.status,f=!1;switch(R){case"SUBMIT_REVISION":(f=o.uc.includes(d)&&P.status===o.n$.REVISION_REQUIRED&&P.createdBy===c)&&(_=o.n$.PENDING_REVIEW);break;case"SEND_TO_CM":(f=o.oU.includes(d)&&P.status===o.n$.PENDING_REVIEW)&&(_=o.n$.PENDING_CM_APPROVAL);break;case"REQUEST_REVISION":(f=o.oU.includes(d)&&P.status===o.n$.PENDING_REVIEW)&&(_=o.n$.REVISION_REQUIRED);break;case"APPROVE":(f=o.gf.includes(d)&&P.status===o.n$.PENDING_CM_APPROVAL)&&(_=o.n$.APPROVED);break;case"REJECT":(f=o.gf.includes(d)&&P.status===o.n$.PENDING_CM_APPROVAL)&&(_=o.n$.REJECTED);break;case"APPROVE_WITH_COMMENTS":(f=o.gf.includes(d)&&P.status===o.n$.PENDING_CM_APPROVAL)&&(_=o.n$.APPROVED_WITH_COMMENTS);break;case"APPROVE_REVISION_REQUIRED":(f=o.gf.includes(d)&&P.status===o.n$.PENDING_CM_APPROVAL)&&(_=o.n$.REVISION_REQUIRED);break;default:return a.NextResponse.json({success:!1,error:"Invalid action"},{status:400})}if(!f)return a.NextResponse.json({success:!1,error:"Permission denied for this action or invalid document status"},{status:403});let A=[];for(let e of I){let t=e.filePath;if(!t||!t.startsWith(`temp/${c}/`)){console.warn(`Skipping invalid file path: ${t}`);continue}let s=e.fileName,r=Date.now(),a=`sites/${P.siteId}/rfa/${P.documentNumber}/${r}_${s}`;await n.Hf.file(t).move(a),A.push({fileName:s,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${a}`,filePath:a,size:e.size,contentType:e.contentType,uploadedAt:new Date().toISOString(),uploadedBy:c})}let D={action:R,status:_,userId:c,userName:E.email,role:d,timestamp:new Date().toISOString(),comments:l||"",files:A};return await p.update({status:_,currentStep:_,files:A,workflow:i.FieldValue.arrayUnion(D),updatedAt:i.FieldValue.serverTimestamp()}),a.NextResponse.json({success:!0,message:`Action [${R}] completed successfully`,newStatus:_})}catch(t){console.error("Error updating RFA document:",t);let e=t instanceof Error?t.message:"Internal server error";return a.NextResponse.json({success:!1,error:e},{status:500})}}i=(c.then?(await c)():c)[0],r()}catch(e){r(e)}})},4458:(e,t,s)=>{s.d(t,{gf:()=>n,n$:()=>o,oU:()=>a,rz:()=>i,uc:()=>r});let r=["BIM","ME","SN"],a=["Site Admin","Adminsite2","OE","PE"],n=["CM"],i=["SE"],o={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED"};o.PENDING_REVIEW,o.PENDING_CM_APPROVAL,o.REVISION_REQUIRED,o.APPROVED,o.APPROVED_WITH_COMMENTS,o.APPROVED_REVISION_REQUIRED,o.REJECTED},40416:(e,t,s)=>{s.d(t,{CZ:()=>E,Hf:()=>d,iW:()=>u,uE:()=>R});let r=require("firebase-admin");var a=s.n(r);let n={credential:a().credential.cert({projectId:process.env.FIREBASE_PROJECT_ID,clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"},i={credential:a().credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})},o=a().apps.find(e=>e?.name==="ttsdoc-v2")||a().initializeApp(n,"ttsdoc-v2"),c=a().apps.find(e=>e?.name==="bim-tracking")||a().initializeApp(i,"bim-tracking"),u=o.firestore(),E=o.auth(),d=o.storage().bucket(),R=c.firestore()}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[948,972],()=>s(65572));module.exports=r})();