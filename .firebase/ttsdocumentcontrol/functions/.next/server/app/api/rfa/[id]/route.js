"use strict";(()=>{var e={};e.id=1173,e.ids=[1173],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},65572:(e,t,E)=>{E.a(e,async(e,s)=>{try{E.r(t),E.d(t,{originalPathname:()=>c,patchFetch:()=>I,requestAsyncStorage:()=>N,routeModule:()=>R,serverHooks:()=>A,staticGenerationAsyncStorage:()=>P});var r=E(49303),a=E(88716),i=E(60670),n=E(72848),o=e([n]);n=(o.then?(await o)():o)[0];let R=new r.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/rfa/[id]/route",pathname:"/api/rfa/[id]",filename:"route",bundlePath:"app/api/rfa/[id]/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\[id]\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:N,staticGenerationAsyncStorage:P,serverHooks:A}=R,c="/api/rfa/[id]/route";function I(){return(0,i.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:P})}s()}catch(e){s(e)}})},72848:(e,t,E)=>{E.a(e,async(e,s)=>{try{E.r(t),E.d(t,{GET:()=>N,PUT:()=>P,dynamic:()=>A});var r=E(87070),a=E(40416),i=E(72929),n=E(4458),o=E(58780),I=E(51951),R=e([i]);i=(R.then?(await R)():R)[0];let A="force-dynamic",c=(e,t,E,s,r)=>{let a=t?.[E]?.[s];return void 0!==a?a:r.includes(e)};async function N(e,{params:t}){try{let E=e.headers.get("authorization");if(!E?.startsWith("Bearer "))return r.NextResponse.json({success:!1,error:"Missing authorization"},{status:401});let s=E.split("Bearer ")[1],i=(await a.CZ.verifyIdToken(s)).uid,o=await a.iW.collection("users").doc(i).get();if(!o.exists)return r.NextResponse.json({success:!1,error:"User not found"},{status:404});let R=o.data(),N=R.sites||[],P=await a.iW.collection("rfaDocuments").doc(t.id).get();if(!P.exists)return r.NextResponse.json({success:!1,error:"RFA document not found"},{status:404});let A=P.data();if(R.role!==n.K$.ADMIN&&!N.includes(A.siteId))return r.NextResponse.json({success:!1,error:"Access denied"},{status:403});let _={id:A.siteId,name:"N/A"},u={},d="INTERNAL";if(A.siteId){let e=await a.iW.collection("sites").doc(A.siteId).get();if(e.exists){let t=e.data();_={id:e.id,name:t?.name||"Unknown Site",cmSystemType:t?.cmSystemType||"INTERNAL"},d=t?.cmSystemType||"INTERNAL",u=t?.userOverrides?.[i]||{}}}let l={id:A.categoryId,categoryCode:A.taskData?.taskCategory||A.categoryId||"N/A"},D=R.role,M=A.status,O=n.oU.includes(D),T=D===n.K$.CM||D===n.K$.ADMIN,S=c(D,u,"RFA",I.S4.RFA.APPROVE,n.gf),$=!1,V=!1;"INTERNAL"===d?M===n.n$.PENDING_CM_APPROVAL?($=T||S,V=T||S):M===n.n$.PENDING_FINAL_APPROVAL&&($=O||S,V=O||S):M===n.n$.PENDING_CM_APPROVAL&&($=O||S,V=O||S);let p={canView:!0,canEdit:n.uc.includes(R.role)&&A.status===n.n$.REVISION_REQUIRED,canSendToCm:O&&A.status===n.n$.PENDING_REVIEW,canRequestRevision:O&&A.status===n.n$.PENDING_REVIEW,canApprove:$,canReject:V,canDownloadFiles:!0};return r.NextResponse.json({success:!0,document:{id:P.id,...A,site:_,category:l,permissions:p}})}catch(e){return console.error("Error fetching RFA:",e),r.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function P(e,{params:t}){try{let E=e.headers.get("authorization");if(!E?.startsWith("Bearer "))return r.NextResponse.json({error:"Unauthorized"},{status:401});let s=E.split("Bearer ")[1],R=(await a.CZ.verifyIdToken(s)).uid,N=await a.iW.collection("users").doc(R).get();if(!N.exists)return r.NextResponse.json({error:"User not found"},{status:404});let P=N.data(),A=P.role,{action:_,comments:u,newFiles:d,documentNumber:l}=await e.json();if(!_)return r.NextResponse.json({error:"Action is required"},{status:400});let D=a.iW.collection("rfaDocuments").doc(t.id),M=await D.get();if(!M.exists)return r.NextResponse.json({error:"RFA not found"},{status:404});let O=M.data(),T=(await a.iW.collection("sites").doc(O.siteId).get()).data(),S=T?.cmSystemType||"INTERNAL",$=T?.name||"à¹‚à¸„à¸£à¸‡à¸à¸²à¸£à¸—à¸±à¹ˆà¸§à¹„à¸›";O?.title;let V=T?.userOverrides?.[R]||{},p=O.status,C=!1,f=n.oU.includes(A);f&&O.status===n.n$.PENDING_REVIEW&&["SEND_TO_CM","REQUEST_REVISION"].includes(_)&&(C=!0),n.uc.includes(A)&&O.createdBy===R&&O.status===n.n$.REVISION_REQUIRED&&"SUBMIT_REVISION"===_&&(C=!0);let K=A===n.K$.CM||A===n.K$.ADMIN,m=c(A,V,"RFA",I.S4.RFA.APPROVE,n.gf);if(["APPROVE","APPROVE_WITH_COMMENTS","REJECT","APPROVE_REVISION_REQUIRED"].includes(_)&&("INTERNAL"===S?O.status===n.n$.PENDING_CM_APPROVAL?(K||m)&&(C=!0):O.status===n.n$.PENDING_FINAL_APPROVAL&&(f||m)&&(C=!0):O.status===n.n$.PENDING_CM_APPROVAL&&(f||m)&&(C=!0)),!C)return r.NextResponse.json({success:!1,error:"Permission denied or invalid status."},{status:403});switch(_){case"SEND_TO_CM":p=n.n$.PENDING_CM_APPROVAL;break;case"REQUEST_REVISION":p=n.n$.REVISION_REQUIRED;break;case"SUBMIT_REVISION":p=n.n$.PENDING_REVIEW;break;case"REJECT":p=n.n$.REJECTED;break;case"APPROVE_REVISION_REQUIRED":p=n.n$.APPROVED_REVISION_REQUIRED;break;case"APPROVE":case"APPROVE_WITH_COMMENTS":p="INTERNAL"===S&&O.status===n.n$.PENDING_CM_APPROVAL?n.n$.PENDING_FINAL_APPROVAL:"APPROVE"===_?n.n$.APPROVED:n.n$.APPROVED_WITH_COMMENTS}let g=O.files||[],h=[];if(d&&Array.isArray(d)&&d.length>0)for(let e of d){let t=e.filePath;if(!t||!t.startsWith(`temp/${R}/`))continue;let E=l||O.documentNumber||"temp",s=`sites/${O.siteId}/rfa/${E}/${Date.now()}_${e.fileName}`;await a.Hf.file(t).move(s);let r={fileName:e.fileName,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${s}`,filePath:s,size:e.size,fileSize:e.size,contentType:e.contentType,uploadedAt:new Date().toISOString(),uploadedBy:R};h.push(r),g.push(r)}let F={action:_,status:p,userId:R,userName:P.email,role:A,timestamp:new Date().toISOString(),comments:u||"",files:h},G={status:p,currentStep:p,workflow:i.FieldValue.arrayUnion(F),updatedAt:i.FieldValue.serverTimestamp()};if(l&&(G.documentNumber=l),h.length>0&&(G.files=g),await D.update(G),[n.n$.APPROVED,n.n$.APPROVED_WITH_COMMENTS,n.n$.APPROVED_REVISION_REQUIRED,n.n$.PENDING_FINAL_APPROVAL].includes(p)){let e=[];if((await a.iW.collection("users").where("sites","array-contains",O.siteId).where("status","==","ACTIVE").get()).forEach(t=>{let E=t.data().role;p===n.n$.PENDING_FINAL_APPROVAL?n.oU.includes(E)&&e.push(t.id):["SE","FM"].includes(E)&&e.push(t.id)}),e.length>0){let E=`ðŸ“£ à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°: ${l||O.documentNumber}`;p===n.n$.PENDING_FINAL_APPROVAL&&(E=`â³ à¸£à¸­à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸‚à¸±à¹‰à¸™à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢: ${l||O.documentNumber}`),p===n.n$.APPROVED&&(E=`âœ… à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¹à¸¥à¹‰à¸§: ${l||O.documentNumber}`);let s=n.NK[p]||p,r=`à¹‚à¸„à¸£à¸‡à¸à¸²à¸£: ${$}
à¸ªà¸–à¸²à¸™à¸°: ${s}`;await (0,o.z)(e,{title:E,body:r,url:`/dashboard/rfa/${t.id}`})}}return r.NextResponse.json({success:!0,message:"Action completed",newStatus:p})}catch(e){return console.error("Error updating RFA:",e),r.NextResponse.json({success:!1,error:e.message},{status:500})}}s()}catch(e){s(e)}})},51951:(e,t,E)=>{E.d(t,{S4:()=>r});var s=E(4458);let r={RFA:{VIEW_SHOP:"view_shop",CREATE_SHOP:"create_shop",VIEW_GEN:"view_gen",CREATE_GEN:"create_gen",VIEW_MAT:"view_mat",CREATE_MAT:"create_mat",APPROVE:"can_approve"},WORK_REQUEST:{VIEW:"view_wr",CREATE:"create_wr",APPROVE:"approve_wr",VERIFY:"verify_wr"}};s.K$.ADMIN,s.K$.PD,s.K$.PM,s.K$.SE,s.K$.FM,s.K$.BIM,s.K$.SITE_ADMIN,s.K$.CM,s.K$.ME,s.K$.SN,s.K$.OE,s.K$.PE,s.K$.ADMIN,s.K$.PD,s.K$.PM,s.K$.BIM,s.K$.SITE_ADMIN,s.K$.CM,s.K$.ME,s.K$.SN,s.K$.OE,s.K$.PE,r.RFA.VIEW_SHOP,r.RFA.CREATE_SHOP,s.K$.BIM,s.K$.ME,s.K$.SN,s.K$.SITE_ADMIN,s.K$.ADMIN,s.K$.PM,s.K$.PE,s.K$.OE,r.RFA.VIEW_GEN,r.RFA.CREATE_GEN,s.K$.BIM,s.K$.ME,s.K$.SN,s.K$.SITE_ADMIN,s.K$.ADMIN,s.K$.PM,s.K$.PE,s.K$.OE,r.RFA.VIEW_MAT,r.RFA.CREATE_MAT,s.K$.SITE_ADMIN,s.K$.ADMIN,s.K$.PM,s.K$.PE,s.K$.OE,r.RFA.APPROVE,s.K$.CM,s.K$.ADMIN,s.K$.SITE_ADMIN,s.K$.PM,s.K$.PE,s.K$.OE,r.WORK_REQUEST.VIEW,r.WORK_REQUEST.CREATE,s.K$.PE,s.K$.OE,s.K$.ADMIN,r.WORK_REQUEST.APPROVE,s.K$.PM,s.K$.ADMIN,r.WORK_REQUEST.VERIFY,s.K$.SITE_ADMIN,s.K$.ADMIN,s.K$.BIM,r.RFA.VIEW_SHOP,r.RFA.CREATE_SHOP,r.RFA.VIEW_GEN,r.RFA.CREATE_GEN,r.RFA.VIEW_MAT,r.RFA.CREATE_MAT,r.RFA.APPROVE,r.WORK_REQUEST.VIEW,r.WORK_REQUEST.CREATE,r.WORK_REQUEST.APPROVE,r.WORK_REQUEST.VERIFY},4458:(e,t,E)=>{E.d(t,{$p:()=>o,Ge:()=>R,K$:()=>s,NK:()=>N,c9:()=>n,gf:()=>i,n$:()=>I,oU:()=>a,uc:()=>r});let s={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},r=[s.BIM,s.ME,s.SN,s.SITE_ADMIN,s.ADMIN,s.PM,s.PE,s.OE],a=[s.SITE_ADMIN,s.ADMIN_SITE_2,s.OE,s.PE,s.ADMIN],i=[s.CM,s.ADMIN,s.SITE_ADMIN,s.PM,s.PE,s.OE];s.PM,s.ADMIN,s.SE,s.FM;let n=[s.PE,s.OE,s.ADMIN],o=[s.PM,s.ADMIN];s.PD,s.SE,s.FM;let I={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},R={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},N={[I.PENDING_REVIEW]:"à¸£à¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š",[I.PENDING_CM_APPROVAL]:"à¸£à¸­à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´ (CM/Approver)",[I.REVISION_REQUIRED]:"à¹à¸à¹‰à¹„à¸‚",[I.APPROVED]:"à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´",[I.APPROVED_WITH_COMMENTS]:"à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸•à¸²à¸¡à¸„à¸­à¸¡à¹€à¸¡à¸™à¸•à¹Œ (à¹„à¸¡à¹ˆà¹à¸à¹‰à¹„à¸‚)",[I.APPROVED_REVISION_REQUIRED]:"à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸•à¸²à¸¡à¸„à¸­à¸¡à¹€à¸¡à¸™à¸•à¹Œ (à¸•à¹‰à¸­à¸‡à¹à¸à¹‰à¹„à¸‚)",[I.REJECTED]:"à¹„à¸¡à¹ˆà¸­à¸™à¸¸à¸¡à¸±à¸•à¸´",[I.PENDING_FINAL_APPROVAL]:"à¸£à¸­ SITE à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸‚à¸±à¹‰à¸™à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢",[R.DRAFT]:"à¸£à¸­à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´ (PM)",[R.REJECTED_BY_PM]:"à¹„à¸¡à¹ˆà¸­à¸™à¸¸à¸¡à¸±à¸•à¸´ (PM)",[R.PENDING_BIM]:"à¸£à¸­ BIM à¸£à¸±à¸šà¸‡à¸²à¸™",[R.IN_PROGRESS]:"BIM à¸à¸³à¸¥à¸±à¸‡à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£",[R.PENDING_ACCEPTANCE]:"à¸£à¸­à¸•à¸£à¸§à¸ˆà¸£à¸±à¸š (Site)",[R.REVISION_REQUESTED]:"à¸‚à¸­à¹à¸à¹‰à¹„à¸‚ (WR)",[R.COMPLETED]:"à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™"};I.PENDING_REVIEW,I.PENDING_CM_APPROVAL,I.REVISION_REQUIRED,I.APPROVED,I.REJECTED,I.APPROVED_WITH_COMMENTS,I.APPROVED_REVISION_REQUIRED,R.DRAFT,R.REJECTED_BY_PM,R.PENDING_BIM,R.IN_PROGRESS,R.PENDING_ACCEPTANCE,R.REVISION_REQUESTED,R.COMPLETED},40416:(e,t,E)=>{E.d(t,{CZ:()=>n,Hf:()=>o,iW:()=>i,SI:()=>I,uE:()=>R,Dh:()=>P,_B:()=>N,Lv:()=>A});let s=require("firebase-admin"),r=(e,t)=>s.apps.find(t=>t?.name===e)||s.initializeApp(t,e),a=()=>r("ttsdoc-v2",{credential:s.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),i=a().firestore(),n=a().auth(),o=a().storage().bucket(),I=a().messaging(),R=r("bim-tracking",{credential:s.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),N=()=>i,P=()=>n,A=()=>R},58780:(e,t,E)=>{E.d(t,{z:()=>r});var s=E(40416);async function r(e,t){if(e&&0!==e.length)try{console.log(`ðŸ”” Preparing to send notification to ${e.length} users...`);let E=e.map(e=>s.iW.collection("users").doc(e)),r=await s.iW.getAll(...E),a=[];if(r.forEach(e=>{if(e.exists){let t=e.data();t?.fcmTokens&&Array.isArray(t.fcmTokens)&&a.push(...t.fcmTokens)}}),a=[...new Set(a)].filter(e=>e),0===a.length){console.log("âš ï¸ No registered devices found for these users.");return}let i={data:{title:t.title,body:t.body,url:t.url||"/dashboard",click_action:t.url||"/dashboard"},tokens:a},n=await s.SI.sendEachForMulticast(i);console.log(`âœ… Sent ${n.successCount} messages successfully.`),n.failureCount>0&&console.log(`âŒ Failed to send ${n.failureCount} messages.`)}catch(e){console.error("\uD83D\uDD25 Error sending push notification:",e)}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var E=e=>t(t.s=e),s=t.X(0,[9276,5972],()=>E(65572));module.exports=s})();