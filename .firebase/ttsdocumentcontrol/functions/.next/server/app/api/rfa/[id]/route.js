"use strict";(()=>{var e={};e.id=1173,e.ids=[1173],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},65572:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{originalPathname:()=>l,patchFetch:()=>c,requestAsyncStorage:()=>R,routeModule:()=>I,serverHooks:()=>N,staticGenerationAsyncStorage:()=>u});var n=s(49303),o=s(88716),i=s(60670),a=s(72848),E=e([a]);a=(E.then?(await E)():E)[0];let I=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/rfa/[id]/route",pathname:"/api/rfa/[id]",filename:"route",bundlePath:"app/api/rfa/[id]/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\[id]\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:R,staticGenerationAsyncStorage:u,serverHooks:N}=I,l="/api/rfa/[id]/route";function c(){return(0,i.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:u})}r()}catch(e){r(e)}})},72848:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{GET:()=>I,PUT:()=>R,dynamic:()=>u});var n=s(87070),o=s(40416),i=s(72929),a=s(4458),E=s(58780),c=e([i]);i=(c.then?(await c)():c)[0];let u="force-dynamic";async function I(e,{params:t}){try{let s=e.headers.get("authorization");if(!s?.startsWith("Bearer "))return n.NextResponse.json({success:!1,error:"Missing or invalid authorization header"},{status:401});let r=s.split("Bearer ")[1],i=(await o.CZ.verifyIdToken(r)).uid,E=await o.iW.collection("users").doc(i).get();if(!E.exists)return n.NextResponse.json({success:!1,error:"User not found"},{status:404});let c=E.data(),I=c.sites||[],R=await o.iW.collection("rfaDocuments").doc(t.id).get();if(!R.exists)return n.NextResponse.json({success:!1,error:"RFA document not found"},{status:404});let u=R.data();if(!I.includes(u.siteId))return n.NextResponse.json({success:!1,error:"Access denied to this site"},{status:403});let N={id:u.siteId,name:"N/A"};if(u.siteId){let e=await o.iW.collection("sites").doc(u.siteId).get();e.exists&&(N={id:e.id,name:e.data()?.name||"Unknown Site",cmSystemType:e.data()?.cmSystemType||"INTERNAL"})}let l=u.workflow?.[0]?.role||"BIM",P={id:u.categoryId,categoryCode:u.taskData?.taskCategory||u.categoryId||"N/A"},d={canView:!0,canEdit:a.uc.includes(c.role)&&u.status===a.n$.REVISION_REQUIRED,canSendToCm:a.oU.includes(c.role)&&u.status===a.n$.PENDING_REVIEW,canRequestRevision:a.oU.includes(c.role)&&u.status===a.n$.PENDING_REVIEW,canApprove:a.gf.includes(c.role)&&u.status===a.n$.PENDING_CM_APPROVAL,canReject:a.gf.includes(c.role)&&u.status===a.n$.PENDING_CM_APPROVAL,canDownloadFiles:!0},_={id:R.id,...u,site:N,category:P,permissions:d,creatorRole:l};return n.NextResponse.json({success:!0,document:_})}catch(e){return console.error("Error fetching RFA document:",e),n.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function R(e,{params:t}){try{let s=e.headers.get("authorization");if(!s?.startsWith("Bearer "))return n.NextResponse.json({error:"Unauthorized"},{status:401});let r=s.split("Bearer ")[1],c=(await o.CZ.verifyIdToken(r)).uid,I=await o.iW.collection("users").doc(c).get();if(!I.exists)return n.NextResponse.json({error:"User not found"},{status:404});let R=I.data(),u=R.role,{action:N,comments:l,newFiles:P,documentNumber:d}=await e.json();if(!N)return n.NextResponse.json({error:"Action is required"},{status:400});let _=o.iW.collection("rfaDocuments").doc(t.id),A=await _.get();if(!A.exists)return n.NextResponse.json({error:"RFA document not found"},{status:404});let D=A.data(),O=await o.iW.collection("sites").doc(D.siteId).get(),T=O.data()?.cmSystemType||"INTERNAL",p=O.data()?.name||"à¹‚à¸„à¸£à¸‡à¸à¸²à¸£à¸—à¸±à¹ˆà¸§à¹„à¸›",f=D?.title||"à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­à¹€à¸£à¸·à¹ˆà¸­à¸‡",M=D.status,S=!1;if(a.oU.includes(u)?D.status===a.n$.PENDING_REVIEW&&("SEND_TO_CM"===N||"REQUEST_REVISION"===N)?S=!0:D.status===a.n$.PENDING_CM_APPROVAL&&"EXTERNAL"===T&&["APPROVE","APPROVE_WITH_COMMENTS","APPROVE_REVISION_REQUIRED","REJECT"].includes(N)?S=!0:D.status===a.n$.PENDING_FINAL_APPROVAL&&"INTERNAL"===T&&["APPROVE","APPROVE_WITH_COMMENTS","APPROVE_REVISION_REQUIRED","REJECT"].includes(N)&&(S=!0):a.gf.includes(u)&&D.status===a.n$.PENDING_CM_APPROVAL&&"INTERNAL"===T?["APPROVE","APPROVE_WITH_COMMENTS","REJECT"].includes(N)&&(S=!0):a.uc.includes(u)&&D.createdBy===c&&D.status===a.n$.REVISION_REQUIRED&&"SUBMIT_REVISION"===N&&(S=!0),!S)return n.NextResponse.json({success:!1,error:"Permission denied for this action or invalid document status."},{status:403});switch(N){case"SEND_TO_CM":M=a.n$.PENDING_CM_APPROVAL;break;case"REQUEST_REVISION":M=a.n$.REVISION_REQUIRED;break;case"SUBMIT_REVISION":M=a.n$.PENDING_REVIEW;break;case"REJECT":M=a.n$.REJECTED;break;case"APPROVE_REVISION_REQUIRED":M=a.n$.APPROVED_REVISION_REQUIRED;break;case"APPROVE":M="CM"===u&&"INTERNAL"===T?a.n$.PENDING_FINAL_APPROVAL:a.n$.APPROVED;break;case"APPROVE_WITH_COMMENTS":M="CM"===u&&"INTERNAL"===T?a.n$.PENDING_FINAL_APPROVAL:a.n$.APPROVED_WITH_COMMENTS}let V=D.files||[],C=[];if(P&&Array.isArray(P)&&P.length>0){let e=[];for(let t of P){let s=t.filePath;if(!s||!s.startsWith(`temp/${c}/`))continue;let r=d||D.documentNumber||D.runningNumber,n=`sites/${D.siteId}/rfa/${r}/${Date.now()}_${t.fileName}`;await o.Hf.file(s).move(n),e.push({fileName:t.fileName,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${n}`,filePath:n,size:t.size,fileSize:t.size,contentType:t.contentType,uploadedAt:new Date().toISOString(),uploadedBy:c})}C=e,V.push(...e)}let m={action:N,status:M,userId:c,userName:R.email,role:u,timestamp:new Date().toISOString(),comments:l||"",files:C},g={status:M,currentStep:M,workflow:i.FieldValue.arrayUnion(m),updatedAt:i.FieldValue.serverTimestamp()};if(d&&(g.documentNumber=d),C.length>0&&(g.files=V),await _.update(g),[a.n$.APPROVED,a.n$.APPROVED_WITH_COMMENTS,a.n$.APPROVED_REVISION_REQUIRED].includes(M)){let e=[];try{let t=await o.iW.collection("users").where("sites","array-contains",D.siteId).where("status","==","ACTIVE").get(),s=["SE","FM"];t.forEach(t=>{let r=t.data();s.includes(r.role)&&e.push(t.id)}),console.log(`ðŸŽ¯ Found ${e.length} targets (SE/FM) for notification in site ${D.siteId}`)}catch(e){console.error("Error fetching target users:",e)}if(e.length>0){let s=d||D.documentNumber||"RFA-xxxx",r=`âœ… à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¹à¸¥à¹‰à¸§: ${s}`,n=`à¹‚à¸„à¸£à¸‡à¸à¸²à¸£: ${p}
à¹€à¸­à¸à¸ªà¸²à¸£à¹€à¸£à¸·à¹ˆà¸­à¸‡ "${f}" à¹„à¸”à¹‰à¸£à¸±à¸šà¸à¸²à¸£à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¹à¸¥à¹‰à¸§ à¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™`;M===a.n$.APPROVED?n=`à¹‚à¸„à¸£à¸‡à¸à¸²à¸£: ${p}
à¹€à¸­à¸à¸ªà¸²à¸£à¹€à¸£à¸·à¹ˆà¸­à¸‡ "${f}" à¹„à¸”à¹‰à¸£à¸±à¸šà¸à¸²à¸£à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´ (Approved)`:M===a.n$.APPROVED_WITH_COMMENTS?(r=`âš ï¸ à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸•à¸²à¸¡à¸„à¸­à¸¡à¹€à¸¡à¸™à¸•à¹Œ: ${s}`,n=`à¹‚à¸„à¸£à¸‡à¸à¸²à¸£: ${p}
à¹€à¸­à¸à¸ªà¸²à¸£à¹€à¸£à¸·à¹ˆà¸­à¸‡ "${f}" à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¹‚à¸”à¸¢à¸¡à¸µà¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚ (Approved with comments)`):M===a.n$.APPROVED_REVISION_REQUIRED&&(r=`âš ï¸ à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´ (à¸•à¹‰à¸­à¸‡à¹à¸à¹‰à¹„à¸‚): ${s}`,n=`à¹‚à¸„à¸£à¸‡à¸à¸²à¸£: ${p}
à¹€à¸­à¸à¸ªà¸²à¸£à¹€à¸£à¸·à¹ˆà¸­à¸‡ "${f}" à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¹ƒà¸«à¹‰à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¹„à¸”à¹‰ à¹à¸•à¹ˆà¸•à¹‰à¸­à¸‡à¹à¸à¹‰à¹„à¸‚à¹€à¸­à¸à¸ªà¸²à¸£à¸•à¸²à¸¡à¹à¸™à¸š (Approved & Revise)`),await (0,E.z)(e,{title:r,body:n,url:`/dashboard/rfa/${t.id}`})}else console.log("âš ï¸ No SE or FM found in this site to notify.")}return n.NextResponse.json({success:!0,message:`Action [${N}] completed successfully`,newStatus:M})}catch(t){console.error("Error updating RFA document:",t);let e=t instanceof Error?t.message:"Internal server error";return n.NextResponse.json({success:!1,error:e},{status:500})}}r()}catch(e){r(e)}})},4458:(e,t,s)=>{s.d(t,{$p:()=>E,Ge:()=>I,K$:()=>r,c9:()=>a,gf:()=>i,n$:()=>c,oU:()=>o,uc:()=>n});let r={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},n=[r.BIM,r.ME,r.SN,r.ADMIN],o=[r.SITE_ADMIN,r.ADMIN_SITE_2,r.OE,r.PE,r.ADMIN],i=[r.CM,r.PD,r.ADMIN];r.PM,r.ADMIN,r.SE,r.FM;let a=[r.PE,r.OE,r.ADMIN],E=[r.PD,r.PM,r.ADMIN],c={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},I={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"};c.PENDING_REVIEW,c.PENDING_CM_APPROVAL,c.REVISION_REQUIRED,c.APPROVED,c.APPROVED_WITH_COMMENTS,c.APPROVED_REVISION_REQUIRED,c.REJECTED,c.PENDING_FINAL_APPROVAL,I.DRAFT,I.REJECTED_BY_PM,I.PENDING_BIM,I.IN_PROGRESS,I.PENDING_ACCEPTANCE,I.REVISION_REQUESTED,I.COMPLETED,c.PENDING_REVIEW,c.PENDING_CM_APPROVAL,c.REVISION_REQUIRED,c.APPROVED,c.REJECTED,c.APPROVED_WITH_COMMENTS,c.APPROVED_REVISION_REQUIRED,I.DRAFT,I.REJECTED_BY_PM,I.PENDING_BIM,I.IN_PROGRESS,I.PENDING_ACCEPTANCE,I.REVISION_REQUESTED,I.COMPLETED},40416:(e,t,s)=>{s.d(t,{CZ:()=>a,Hf:()=>E,iW:()=>i,SI:()=>c,uE:()=>I,Dh:()=>u,_B:()=>R,Lv:()=>N});let r=require("firebase-admin"),n=(e,t)=>r.apps.find(t=>t?.name===e)||r.initializeApp(t,e),o=()=>n("ttsdoc-v2",{credential:r.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),i=o().firestore(),a=o().auth(),E=o().storage().bucket(),c=o().messaging(),I=n("bim-tracking",{credential:r.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),R=()=>i,u=()=>a,N=()=>I},58780:(e,t,s)=>{s.d(t,{z:()=>n});var r=s(40416);async function n(e,t){if(e&&0!==e.length)try{console.log(`ðŸ”” Preparing to send notification to ${e.length} users...`);let s=e.map(e=>r.iW.collection("users").doc(e)),n=await r.iW.getAll(...s),o=[];if(n.forEach(e=>{if(e.exists){let t=e.data();t?.fcmTokens&&Array.isArray(t.fcmTokens)&&o.push(...t.fcmTokens)}}),o=[...new Set(o)].filter(e=>e),0===o.length){console.log("âš ï¸ No registered devices found for these users.");return}let i={notification:{title:t.title,body:t.body},data:{title:t.title,body:t.body,url:t.url||"/dashboard",click_action:t.url||"/dashboard"},tokens:o},a=await r.SI.sendEachForMulticast(i);console.log(`âœ… Sent ${a.successCount} messages successfully.`),a.failureCount>0&&console.log(`âŒ Failed to send ${a.failureCount} messages.`)}catch(e){console.error("\uD83D\uDD25 Error sending push notification:",e)}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[9276,5972],()=>s(65572));module.exports=r})();