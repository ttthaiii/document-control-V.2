"use strict";(()=>{var e={};e.id=1173,e.ids=[1173],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},65572:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{originalPathname:()=>u,patchFetch:()=>I,requestAsyncStorage:()=>c,routeModule:()=>R,serverHooks:()=>P,staticGenerationAsyncStorage:()=>N});var E=s(49303),a=s(88716),n=s(60670),i=s(72848),o=e([i]);i=(o.then?(await o)():o)[0];let R=new E.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/rfa/[id]/route",pathname:"/api/rfa/[id]",filename:"route",bundlePath:"app/api/rfa/[id]/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\[id]\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:c,staticGenerationAsyncStorage:N,serverHooks:P}=R,u="/api/rfa/[id]/route";function I(){return(0,n.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:N})}r()}catch(e){r(e)}})},72848:(e,t,s)=>{s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{GET:()=>I,PUT:()=>R,dynamic:()=>c});var E=s(87070),a=s(40416),n=s(72929),i=s(4458),o=e([n]);n=(o.then?(await o)():o)[0];let c="force-dynamic";async function I(e,{params:t}){try{let s=e.headers.get("authorization");if(!s?.startsWith("Bearer "))return E.NextResponse.json({success:!1,error:"Missing or invalid authorization header"},{status:401});let r=s.split("Bearer ")[1],n=(await a.CZ.verifyIdToken(r)).uid,o=await a.iW.collection("users").doc(n).get();if(!o.exists)return E.NextResponse.json({success:!1,error:"User not found"},{status:404});let I=o.data(),R=I.sites||[],c=await a.iW.collection("rfaDocuments").doc(t.id).get();if(!c.exists)return E.NextResponse.json({success:!1,error:"RFA document not found"},{status:404});let N=c.data();if(!R.includes(N.siteId))return E.NextResponse.json({success:!1,error:"Access denied to this site"},{status:403});let P={id:N.siteId,name:"N/A"};if(N.siteId){let e=await a.iW.collection("sites").doc(N.siteId).get();e.exists&&(P={id:e.id,name:e.data()?.name||"Unknown Site",cmSystemType:e.data()?.cmSystemType||"INTERNAL"})}let u=N.workflow?.[0]?.role||"BIM",_={id:N.categoryId,categoryCode:N.taskData?.taskCategory||N.categoryId||"N/A"},d={canView:!0,canEdit:i.uc.includes(I.role)&&N.status===i.n$.REVISION_REQUIRED,canSendToCm:i.oU.includes(I.role)&&N.status===i.n$.PENDING_REVIEW,canRequestRevision:i.oU.includes(I.role)&&N.status===i.n$.PENDING_REVIEW,canApprove:i.gf.includes(I.role)&&N.status===i.n$.PENDING_CM_APPROVAL,canReject:i.gf.includes(I.role)&&N.status===i.n$.PENDING_CM_APPROVAL,canDownloadFiles:!0},A={id:c.id,...N,site:P,category:_,permissions:d,creatorRole:u};return E.NextResponse.json({success:!0,document:A})}catch(e){return console.error("Error fetching RFA document:",e),E.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function R(e,{params:t}){try{let s=e.headers.get("authorization");if(!s?.startsWith("Bearer "))return E.NextResponse.json({error:"Unauthorized"},{status:401});let r=s.split("Bearer ")[1],o=(await a.CZ.verifyIdToken(r)).uid,I=await a.iW.collection("users").doc(o).get();if(!I.exists)return E.NextResponse.json({error:"User not found"},{status:404});let R=I.data(),c=R.role,{action:N,comments:P,newFiles:u,documentNumber:_}=await e.json();if(!N)return E.NextResponse.json({error:"Action is required"},{status:400});let d=a.iW.collection("rfaDocuments").doc(t.id),A=await d.get();if(!A.exists)return E.NextResponse.json({error:"RFA document not found"},{status:404});let l=A.data(),D=await a.iW.collection("sites").doc(l.siteId).get(),O=D.data()?.cmSystemType||"INTERNAL",T=l.status,p=!1;if(i.oU.includes(c)?l.status===i.n$.PENDING_REVIEW&&("SEND_TO_CM"===N||"REQUEST_REVISION"===N)?p=!0:l.status===i.n$.PENDING_CM_APPROVAL&&"EXTERNAL"===O&&["APPROVE","APPROVE_WITH_COMMENTS","APPROVE_REVISION_REQUIRED","REJECT"].includes(N)?p=!0:l.status===i.n$.PENDING_FINAL_APPROVAL&&"INTERNAL"===O&&["APPROVE","APPROVE_WITH_COMMENTS","APPROVE_REVISION_REQUIRED","REJECT"].includes(N)&&(p=!0):i.gf.includes(c)&&l.status===i.n$.PENDING_CM_APPROVAL&&"INTERNAL"===O?["APPROVE","APPROVE_WITH_COMMENTS","REJECT"].includes(N)&&(p=!0):i.uc.includes(c)&&l.createdBy===o&&l.status===i.n$.REVISION_REQUIRED&&"SUBMIT_REVISION"===N&&(p=!0),!p)return E.NextResponse.json({success:!1,error:"Permission denied for this action or invalid document status."},{status:403});switch(N){case"SEND_TO_CM":T=i.n$.PENDING_CM_APPROVAL;break;case"REQUEST_REVISION":T=i.n$.REVISION_REQUIRED;break;case"SUBMIT_REVISION":T=i.n$.PENDING_REVIEW;break;case"REJECT":T=i.n$.REJECTED;break;case"APPROVE_REVISION_REQUIRED":T=i.n$.APPROVED_REVISION_REQUIRED;break;case"APPROVE":T="CM"===c&&"INTERNAL"===O?i.n$.PENDING_FINAL_APPROVAL:i.n$.APPROVED;break;case"APPROVE_WITH_COMMENTS":T="CM"===c&&"INTERNAL"===O?i.n$.PENDING_FINAL_APPROVAL:i.n$.APPROVED_WITH_COMMENTS}let S=l.files||[],V=[];if(u&&Array.isArray(u)&&u.length>0){let e=[];for(let t of u){let s=t.filePath;if(!s||!s.startsWith(`temp/${o}/`))continue;let r=_||l.documentNumber||l.runningNumber,E=`sites/${l.siteId}/rfa/${r}/${Date.now()}_${t.fileName}`;await a.Hf.file(s).move(E),e.push({fileName:t.fileName,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${E}`,filePath:E,size:t.size,fileSize:t.size,contentType:t.contentType,uploadedAt:new Date().toISOString(),uploadedBy:o})}V=e,S.push(...e)}let M={action:N,status:T,userId:o,userName:R.email,role:c,timestamp:new Date().toISOString(),comments:P||"",files:V},C={status:T,currentStep:T,workflow:n.FieldValue.arrayUnion(M),updatedAt:n.FieldValue.serverTimestamp()};return _&&(C.documentNumber=_),V.length>0&&(C.files=S),await d.update(C),E.NextResponse.json({success:!0,message:`Action [${N}] completed successfully`,newStatus:T})}catch(t){console.error("Error updating RFA document:",t);let e=t instanceof Error?t.message:"Internal server error";return E.NextResponse.json({success:!1,error:e},{status:500})}}r()}catch(e){r(e)}})},4458:(e,t,s)=>{s.d(t,{$p:()=>o,Ge:()=>R,K$:()=>r,c9:()=>i,gf:()=>n,n$:()=>I,oU:()=>a,uc:()=>E});let r={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",ADMIN_SITE_2:"Adminsite2"},E=[r.BIM,r.ME,r.SN],a=[r.SITE_ADMIN,r.ADMIN_SITE_2,r.OE,r.PE],n=[r.CM,r.PD];r.PM,r.SE;let i=[r.PE,r.OE,r.ADMIN],o=[r.PD,r.PM,r.ADMIN],I={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},R={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"};I.PENDING_REVIEW,I.PENDING_CM_APPROVAL,I.REVISION_REQUIRED,I.APPROVED,I.APPROVED_WITH_COMMENTS,I.APPROVED_REVISION_REQUIRED,I.REJECTED,I.PENDING_FINAL_APPROVAL,R.DRAFT,R.REJECTED_BY_PM,R.PENDING_BIM,R.IN_PROGRESS,R.PENDING_ACCEPTANCE,R.REVISION_REQUESTED,R.COMPLETED,I.PENDING_REVIEW,I.PENDING_CM_APPROVAL,I.REVISION_REQUIRED,I.APPROVED,I.REJECTED,I.APPROVED_WITH_COMMENTS,I.APPROVED_REVISION_REQUIRED,R.DRAFT,R.REJECTED_BY_PM,R.PENDING_BIM,R.IN_PROGRESS,R.PENDING_ACCEPTANCE,R.REVISION_REQUESTED,R.COMPLETED},40416:(e,t,s)=>{s.d(t,{CZ:()=>i,Hf:()=>o,iW:()=>n,uE:()=>I,Dh:()=>c,_B:()=>R,Lv:()=>N});let r=require("firebase-admin"),E=(e,t)=>r.apps.find(t=>t?.name===e)||r.initializeApp(t,e),a=()=>E("ttsdoc-v2",{credential:r.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),n=a().firestore(),i=a().auth(),o=a().storage().bucket(),I=E("bim-tracking",{credential:r.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),R=()=>n,c=()=>i,N=()=>I}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>s(65572));module.exports=r})();