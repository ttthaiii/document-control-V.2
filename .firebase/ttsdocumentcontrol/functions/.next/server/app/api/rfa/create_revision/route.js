"use strict";(()=>{var e={};e.id=255,e.ids=[255],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},73184:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>u,requestAsyncStorage:()=>d,routeModule:()=>E,serverHooks:()=>p,staticGenerationAsyncStorage:()=>l});var i=r(49303),s=r(88716),n=r(60670),o=r(87091),c=e([o]);o=(c.then?(await c)():c)[0];let E=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/rfa/create_revision/route",pathname:"/api/rfa/create_revision",filename:"route",bundlePath:"app/api/rfa/create_revision/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\create_revision\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:d,staticGenerationAsyncStorage:l,serverHooks:p}=E,I="/api/rfa/create_revision/route";function u(){return(0,n.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:l})}a()}catch(e){a(e)}})},87091:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{POST:()=>E});var i=r(87070),s=r(40416),n=r(72929),o=r(4458),c=e([n]);async function u(e){let t=(e.headers.get("authorization")||"").match(/^Bearer (.+)$/i);if(!t)return null;try{return(await s.CZ.verifyIdToken(t[1])).uid}catch{return null}}async function E(e){let t=await u(e);if(!t)return i.NextResponse.json({error:"Unauthorized"},{status:401});try{let{originalDocId:r,uploadedFiles:a}=await e.json();if(!r||!a||0===a.length)return i.NextResponse.json({error:"Missing required fields"},{status:400});let c=(await s.iW.collection("users").doc(t).get()).data();if(!c)return i.NextResponse.json({error:"User not found"},{status:403});let u=s.iW.collection("rfaDocuments").doc(r);return await s.iW.runTransaction(async e=>{let r=await e.get(u);if(!r.exists)throw Error("Original document not found");let i=r.data(),E=(i.revisionNumber||0)+1,d=i.documentNumber,l=[];for(let e of a){let r=e.filePath;if(!r||!r.startsWith(`temp/${t}/`))continue;let a=`sites/${i.siteId}/rfa/${d}/${Date.now()}_${e.fileName}`;await s.Hf.file(r).move(a),l.push({...e,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${a}`,filePath:a,uploadedAt:new Date().toISOString(),uploadedBy:t})}let p=s.iW.collection("rfaDocuments").doc(),I=o.n$.PENDING_REVIEW;e.set(p,{...i,revisionNumber:E,documentNumber:d,status:I,currentStep:I,isLatest:!0,parentRfaId:i.parentRfaId||r.id,revisionHistory:[...i.revisionHistory||[],r.id],createdAt:n.FieldValue.serverTimestamp(),updatedAt:n.FieldValue.serverTimestamp(),files:l,workflow:[{action:"CREATE_REVISION",status:I,userId:t,userName:c.email,role:c.role,timestamp:new Date().toISOString(),files:l}]}),e.update(u,{isLatest:!1,updatedAt:n.FieldValue.serverTimestamp()})}),i.NextResponse.json({success:!0,message:"New revision created successfully."},{status:201})}catch(e){return console.error("Create Revision Error:",e),i.NextResponse.json({error:"Internal Server Error",details:e.message},{status:500})}}n=(c.then?(await c)():c)[0],a()}catch(e){a(e)}})},4458:(e,t,r)=>{r.d(t,{gf:()=>s,n$:()=>o,oU:()=>i,rz:()=>n,uc:()=>a});let a=["BIM","ME","SN"],i=["Site Admin","Adminsite2","OE","PE"],s=["CM"],n=["SE"],o={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED"};o.PENDING_REVIEW,o.PENDING_CM_APPROVAL,o.REVISION_REQUIRED,o.APPROVED,o.APPROVED_WITH_COMMENTS,o.APPROVED_REVISION_REQUIRED,o.REJECTED},40416:(e,t,r)=>{r.d(t,{CZ:()=>E,Hf:()=>d,iW:()=>u,uE:()=>l});let a=require("firebase-admin");var i=r.n(a);let s={credential:i().credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"},n={credential:i().credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})},o=i().apps.find(e=>e?.name==="ttsdoc-v2")||i().initializeApp(s,"ttsdoc-v2"),c=i().apps.find(e=>e?.name==="bim-tracking")||i().initializeApp(n,"bim-tracking"),u=o.firestore(),E=o.auth(),d=o.storage().bucket(),l=c.firestore()}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[948,972],()=>r(73184));module.exports=a})();