"use strict";(()=>{var e={id:8255,ids:[8255]};e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},73184:(e,t,r)=>{r.a(e,(async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>D,patchFetch:()=>u,requestAsyncStorage:()=>N,routeModule:()=>P,serverHooks:()=>_,staticGenerationAsyncStorage:()=>R});var s=r(49303),E=r(88716),i=r(60670),n=r(87091),o=e([n]);n=(o.then?(await o)():o)[0];const c="",P=new s.AppRouteRouteModule({definition:{kind:E.x.APP_ROUTE,page:"/api/rfa/create_revision/route",pathname:"/api/rfa/create_revision",filename:"route",bundlePath:"app/api/rfa/create_revision/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\create_revision\\route.ts",nextConfigOutput:c,userland:n}),{requestAsyncStorage:N,staticGenerationAsyncStorage:R,serverHooks:_}=P,D="/api/rfa/create_revision/route";function u(){return(0,i.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:R})}a()}catch(I){a(I)}}))},87091:(e,t,r)=>{r.a(e,(async(e,a)=>{try{r.r(t),r.d(t,{POST:()=>N,dynamic:()=>c});var s=r(87070),E=r(40416),i=r(72929),n=r(4458),o=e([i]);i=(o.then?(await o)():o)[0];const c="force-dynamic";async function P(e){const t=(e.headers.get("authorization")||"").match(/^Bearer (.+)$/i);if(!t)return null;try{return(await E.CZ.verifyIdToken(t[1])).uid}catch{return null}}async function N(e){const t=await P(e);if(!t)return s.NextResponse.json({error:"Unauthorized"},{status:401});try{const{originalDocId:r,uploadedFiles:a,verifiedTaskId:o}=await e.json(),I=(await E.iW.collection("users").doc(t).get()).data();if(!I)return s.NextResponse.json({error:"User not found"},{status:403});const c="ME"===I.role||"SN"===I.role;if(!r||!a||0===a.length||!c&&!o)return s.NextResponse.json({error:"Missing required fields (originalDocId, uploadedFiles, and verifiedTaskId for non-manual flow)"},{status:400});const P=E.iW.collection("rfaDocuments").doc(r);return await E.iW.runTransaction((async e=>{const r=await e.get(P);if(!r.exists)throw new Error("Original document not found");const s=r.data(),c=o?{...s.taskData,taskUid:o}:s.taskData,N=(s.revisionNumber||0)+1,R=s.documentNumber,_=[];for(const i of a){const e=i.filePath;if(!e||!e.startsWith(`temp/${t}/`))continue;const r=`sites/${s.siteId}/rfa/${R}/${Date.now()}_${i.fileName}`;await E.Hf.file(e).move(r),_.push({...i,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${r}`,filePath:r,uploadedAt:(new Date).toISOString(),uploadedBy:t})}const D=E.iW.collection("rfaDocuments").doc(),u=n.n$.PENDING_REVIEW;e.set(D,{...s,taskData:c,revisionNumber:N,documentNumber:R,status:u,currentStep:u,isLatest:!0,parentRfaId:s.parentRfaId||r.id,revisionHistory:[...s.revisionHistory||[],r.id],createdAt:i.FieldValue.serverTimestamp(),updatedAt:i.FieldValue.serverTimestamp(),files:_,workflow:[{action:"CREATE_REVISION",status:u,userId:t,userName:I.email,role:I.role,timestamp:(new Date).toISOString(),files:_}]}),e.update(P,{isLatest:!1,updatedAt:i.FieldValue.serverTimestamp()})})),s.NextResponse.json({success:!0,message:"New revision created successfully."},{status:201})}catch(r){return console.error("Create Revision Error:",r),s.NextResponse.json({error:"Internal Server Error",details:r.message},{status:500})}}a()}catch(I){a(I)}}))},4458:(e,t,r)=>{r.d(t,{$p:()=>o,Ge:()=>c,K$:()=>a,NK:()=>P,c9:()=>n,gf:()=>i,n$:()=>I,oU:()=>E,uc:()=>s});const a={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},s=[a.BIM,a.ME,a.SN,a.SITE_ADMIN,a.ADMIN,a.PM,a.PE,a.OE],E=[a.SITE_ADMIN,a.ADMIN_SITE_2,a.OE,a.PE,a.ADMIN],i=[a.CM,a.ADMIN,a.SITE_ADMIN,a.PM,a.PE,a.OE],n=(a.PM,a.ADMIN,a.SE,a.FM,[a.PE,a.OE,a.ADMIN]),o=[a.PM,a.ADMIN],I=(a.PD,a.SE,a.FM,{PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"}),c={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},P={[I.PENDING_REVIEW]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e2a\u0e2d\u0e1a",[I.PENDING_CM_APPROVAL]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (CM/Approver)",[I.REVISION_REQUIRED]:"\u0e41\u0e01\u0e49\u0e44\u0e02",[I.APPROVED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[I.APPROVED_WITH_COMMENTS]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e44\u0e21\u0e48\u0e41\u0e01\u0e49\u0e44\u0e02)",[I.APPROVED_REVISION_REQUIRED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e15\u0e49\u0e2d\u0e07\u0e41\u0e01\u0e49\u0e44\u0e02)",[I.REJECTED]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[I.PENDING_FINAL_APPROVAL]:"\u0e23\u0e2d SITE \u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e02\u0e31\u0e49\u0e19\u0e2a\u0e38\u0e14\u0e17\u0e49\u0e32\u0e22",[c.DRAFT]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[c.REJECTED_BY_PM]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[c.PENDING_BIM]:"\u0e23\u0e2d BIM \u0e23\u0e31\u0e1a\u0e07\u0e32\u0e19",[c.IN_PROGRESS]:"BIM \u0e01\u0e33\u0e25\u0e31\u0e07\u0e14\u0e33\u0e40\u0e19\u0e34\u0e19\u0e01\u0e32\u0e23",[c.PENDING_ACCEPTANCE]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e23\u0e31\u0e1a (Site)",[c.REVISION_REQUESTED]:"\u0e02\u0e2d\u0e41\u0e01\u0e49\u0e44\u0e02 (WR)",[c.COMPLETED]:"\u0e40\u0e2a\u0e23\u0e47\u0e08\u0e2a\u0e34\u0e49\u0e19"};I.PENDING_REVIEW,I.PENDING_CM_APPROVAL,I.REVISION_REQUIRED,I.APPROVED,I.REJECTED,I.APPROVED_WITH_COMMENTS,I.APPROVED_REVISION_REQUIRED,I.PENDING_FINAL_APPROVAL,c.DRAFT,c.REJECTED_BY_PM,c.PENDING_BIM,c.IN_PROGRESS,c.PENDING_ACCEPTANCE,c.REVISION_REQUESTED,c.COMPLETED},40416:(e,t,r)=>{r.d(t,{CZ:()=>n,Hf:()=>o,iW:()=>i,SI:()=>I,uE:()=>c,Dh:()=>N,aj:()=>R,_B:()=>P,Lv:()=>_});const a=require("firebase-admin"),s=(e,t)=>a.apps.find((t=>t?.name===e))||a.initializeApp(t,e),E=()=>{const e={credential:a.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"};return s("ttsdoc-v2",e)},i=E().firestore(),n=E().auth(),o=E().storage().bucket(),I=E().messaging(),c=(()=>{const e={credential:a.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})};return s("bim-tracking",e)})().firestore(),P=()=>i,N=()=>n,R=()=>o,_=()=>c}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=t.X(0,[9276,5972],(()=>{return e=73184,t(t.s=e);var e}));module.exports=r})();