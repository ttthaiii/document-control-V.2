"use strict";(()=>{var e={};e.id=8255,e.ids=[8255],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},73184:(e,t,r)=>{r.a(e,async(e,E)=>{try{r.r(t),r.d(t,{originalPathname:()=>c,patchFetch:()=>I,requestAsyncStorage:()=>N,routeModule:()=>P,serverHooks:()=>_,staticGenerationAsyncStorage:()=>R});var a=r(49303),i=r(88716),s=r(60670),n=r(87091),o=e([n]);n=(o.then?(await o)():o)[0];let P=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/rfa/create_revision/route",pathname:"/api/rfa/create_revision",filename:"route",bundlePath:"app/api/rfa/create_revision/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\rfa\\create_revision\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:N,staticGenerationAsyncStorage:R,serverHooks:_}=P,c="/api/rfa/create_revision/route";function I(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:R})}E()}catch(e){E(e)}})},87091:(e,t,r)=>{r.a(e,async(e,E)=>{try{r.r(t),r.d(t,{POST:()=>P,dynamic:()=>N});var a=r(87070),i=r(40416),s=r(72929),n=r(4458),o=e([s]);s=(o.then?(await o)():o)[0];let N="force-dynamic";async function I(e){let t=(e.headers.get("authorization")||"").match(/^Bearer (.+)$/i);if(!t)return null;try{return(await i.CZ.verifyIdToken(t[1])).uid}catch{return null}}async function P(e){let t=await I(e);if(!t)return a.NextResponse.json({error:"Unauthorized"},{status:401});try{let{originalDocId:r,uploadedFiles:E,verifiedTaskId:o}=await e.json(),I=(await i.iW.collection("users").doc(t).get()).data();if(!I)return a.NextResponse.json({error:"User not found"},{status:403});let P="ME"===I.role||"SN"===I.role;if(!r||!E||0===E.length||!P&&!o)return a.NextResponse.json({error:"Missing required fields (originalDocId, uploadedFiles, and verifiedTaskId for non-manual flow)"},{status:400});let N=i.iW.collection("rfaDocuments").doc(r);return await i.iW.runTransaction(async e=>{let r=await e.get(N);if(!r.exists)throw Error("Original document not found");let a=r.data(),P=o?{...a.taskData,taskUid:o}:a.taskData,R=(a.revisionNumber||0)+1,_=a.documentNumber,c=[];for(let e of E){let r=e.filePath;if(!r||!r.startsWith(`temp/${t}/`))continue;let E=`sites/${a.siteId}/rfa/${_}/${Date.now()}_${e.fileName}`;await i.Hf.file(r).move(E),c.push({...e,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${E}`,filePath:E,uploadedAt:new Date().toISOString(),uploadedBy:t})}let D=i.iW.collection("rfaDocuments").doc(),u=n.n$.PENDING_REVIEW;e.set(D,{...a,taskData:P,revisionNumber:R,documentNumber:_,status:u,currentStep:u,isLatest:!0,parentRfaId:a.parentRfaId||r.id,revisionHistory:[...a.revisionHistory||[],r.id],createdAt:s.FieldValue.serverTimestamp(),updatedAt:s.FieldValue.serverTimestamp(),files:c,workflow:[{action:"CREATE_REVISION",status:u,userId:t,userName:I.email,role:I.role,timestamp:new Date().toISOString(),files:c}]}),e.update(N,{isLatest:!1,updatedAt:s.FieldValue.serverTimestamp()})}),a.NextResponse.json({success:!0,message:"New revision created successfully."},{status:201})}catch(e){return console.error("Create Revision Error:",e),a.NextResponse.json({error:"Internal Server Error",details:e.message},{status:500})}}E()}catch(e){E(e)}})},4458:(e,t,r)=>{r.d(t,{$p:()=>o,Ge:()=>P,K$:()=>E,NK:()=>N,c9:()=>n,gf:()=>s,n$:()=>I,oU:()=>i,uc:()=>a});let E={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},a=[E.BIM,E.ME,E.SN,E.SITE_ADMIN,E.ADMIN,E.PM,E.PE,E.OE],i=[E.SITE_ADMIN,E.ADMIN_SITE_2,E.OE,E.PE,E.ADMIN],s=[E.CM,E.ADMIN,E.SITE_ADMIN,E.PM,E.PE,E.OE];E.PM,E.ADMIN,E.SE,E.FM;let n=[E.PE,E.OE,E.ADMIN],o=[E.PM,E.ADMIN];E.PD,E.SE,E.FM;let I={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},P={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},N={[I.PENDING_REVIEW]:"รอตรวจสอบ",[I.PENDING_CM_APPROVAL]:"รออนุมัติ (CM/Approver)",[I.REVISION_REQUIRED]:"แก้ไข",[I.APPROVED]:"อนุมัติ",[I.APPROVED_WITH_COMMENTS]:"อนุมัติตามคอมเมนต์ (ไม่แก้ไข)",[I.APPROVED_REVISION_REQUIRED]:"อนุมัติตามคอมเมนต์ (ต้องแก้ไข)",[I.REJECTED]:"ไม่อนุมัติ",[I.PENDING_FINAL_APPROVAL]:"รอ SITE อนุมัติขั้นสุดท้าย",[P.DRAFT]:"รออนุมัติ (PM)",[P.REJECTED_BY_PM]:"ไม่อนุมัติ (PM)",[P.PENDING_BIM]:"รอ BIM รับงาน",[P.IN_PROGRESS]:"BIM กำลังดำเนินการ",[P.PENDING_ACCEPTANCE]:"รอตรวจรับ (Site)",[P.REVISION_REQUESTED]:"ขอแก้ไข (WR)",[P.COMPLETED]:"เสร็จสิ้น"};I.PENDING_REVIEW,I.PENDING_CM_APPROVAL,I.REVISION_REQUIRED,I.APPROVED,I.REJECTED,I.APPROVED_WITH_COMMENTS,I.APPROVED_REVISION_REQUIRED,P.DRAFT,P.REJECTED_BY_PM,P.PENDING_BIM,P.IN_PROGRESS,P.PENDING_ACCEPTANCE,P.REVISION_REQUESTED,P.COMPLETED},40416:(e,t,r)=>{r.d(t,{CZ:()=>n,Hf:()=>o,iW:()=>s,SI:()=>I,uE:()=>P,Dh:()=>R,_B:()=>N,Lv:()=>_});let E=require("firebase-admin"),a=(e,t)=>E.apps.find(t=>t?.name===e)||E.initializeApp(t,e),i=()=>a("ttsdoc-v2",{credential:E.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),s=i().firestore(),n=i().auth(),o=i().storage().bucket(),I=i().messaging(),P=a("bim-tracking",{credential:E.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),N=()=>s,R=()=>n,_=()=>P}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),E=t.X(0,[9276,5972],()=>r(73184));module.exports=E})();