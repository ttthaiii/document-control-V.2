"use strict";(()=>{var e={};e.id=2785,e.ids=[2785],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},72929:e=>{e.exports=import("firebase-admin/firestore")},78056:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{originalPathname:()=>m,patchFetch:()=>l,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>v,staticGenerationAsyncStorage:()=>u});var a=i(49303),n=i(88716),o=i(60670),s=i(45365),c=e([s]);s=(c.then?(await c)():c)[0];let p=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/invitation/accept/route",pathname:"/api/invitation/accept",filename:"route",bundlePath:"app/api/invitation/accept/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\invitation\\accept\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:d,staticGenerationAsyncStorage:u,serverHooks:v}=p,m="/api/invitation/accept/route";function l(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:u})}r()}catch(e){r(e)}})},45365:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{GET:()=>c,POST:()=>s,dynamic:()=>l});var a=i(87070),n=i(45758),o=e([n]);n=(o.then?(await o)():o)[0];let l="force-dynamic";async function s(e){try{let{token:t,password:i}=await e.json();if(!t||!i)return a.NextResponse.json({error:"Missing token or password"},{status:400});let r=await n.e.acceptInvitation(t,i);return a.NextResponse.json(r)}catch(e){return console.error("Error accepting invitation:",e),a.NextResponse.json({error:e},{status:400})}}async function c(e){try{let{searchParams:t}=new URL(e.url),i=t.get("token");if(!i)return a.NextResponse.json({error:"Missing token"},{status:400});let r=await n.e.getInvitation(i);return a.NextResponse.json(r)}catch(e){return console.error("Error getting invitation:",e),a.NextResponse.json({error:"Failed to get invitation"},{status:500})}}r()}catch(e){r(e)}})},45758:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.d(t,{e:()=>c});var a=i(40416),n=i(84770),o=i(72929),s=e([o]);o=(s.then?(await s)():s)[0];class c{static async createInvitation(e){try{let t=(0,n.randomBytes)(32).toString("hex"),i=new Date(Date.now()+6048e5);await a.iW.collection("invitations").doc(t).set({...e,status:"PENDING",createdAt:new Date,expiresAt:i,createdByAdmin:!0});let r=`http://localhost:3000/accept-invitation?token=${t}`;return{success:!0,token:t,invitationUrl:r,expiresAt:i}}catch(e){throw console.error("Error creating invitation:",e),Error("Failed to create invitation")}}static async acceptInvitation(e,t){try{let i=await a.iW.collection("invitations").doc(e).get();if(!i.exists)throw Error("Invalid or expired invitation token.");let r=i.data();if("PENDING"!==r.status)throw Error("Invitation has already been used or expired.");let n=await a.CZ.createUser({email:r.email,password:t,emailVerified:!0,displayName:r.name}),s=Array.isArray(r.sites)?r.sites:[r.sites].filter(Boolean);if(await a.iW.collection("users").doc(n.uid).set({email:r.email,name:r.name||"",employeeId:r.employeeId||"",role:r.role,sites:s,status:"ACTIVE",createdFromInvitation:!0,acceptedAt:new Date}),s.length>0){let e=s.map(e=>a.iW.collection("sites").doc(e).update({members:o.FieldValue.arrayUnion(n.uid)}).catch(t=>{console.error(`Warning: Failed to add user to site ${e}`,t)}));await Promise.all(e)}return await a.iW.collection("invitations").doc(e).update({status:"ACCEPTED",acceptedAt:new Date,acceptedBy:n.uid}),{success:!0,userId:n.uid,message:"Account created successfully! You can now login."}}catch(e){throw console.error("Error accepting invitation:",e),e}}static async getInvitation(e){try{let t=await a.iW.collection("invitations").doc(e).get();if(!t.exists)return{success:!1,error:"Invalid invitation"};let i=t.data();return{success:!0,invitation:{email:i.email,name:i.name,role:i.role,status:i.status,expiresAt:i.expiresAt.toDate()}}}catch(e){return console.error("Error getting invitation:",e),{success:!1,error:"Failed to get invitation"}}}}r()}catch(e){r(e)}})},40416:(e,t,i)=>{i.d(t,{CZ:()=>s,Hf:()=>c,iW:()=>o,SI:()=>l,uE:()=>p,Dh:()=>u,_B:()=>d,Lv:()=>v});let r=require("firebase-admin"),a=(e,t)=>r.apps.find(t=>t?.name===e)||r.initializeApp(t,e),n=()=>a("ttsdoc-v2",{credential:r.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),o=n().firestore(),s=n().auth(),c=n().storage().bucket(),l=n().messaging(),p=a("bim-tracking",{credential:r.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),d=()=>o,u=()=>s,v=()=>p}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[9276,5972],()=>i(78056));module.exports=r})();