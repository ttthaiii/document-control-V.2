"use strict";(()=>{var e={id:2785,ids:[2785]};e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},72929:e=>{e.exports=import("firebase-admin/firestore")},78056:(e,t,r)=>{r.a(e,(async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>y,requestAsyncStorage:()=>l,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>v});var n=r(49303),i=r(88716),o=r(60670),s=r(45365),c=e([s]);s=(c.then?(await c)():c)[0];const u="",d=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/invitation/accept/route",pathname:"/api/invitation/accept",filename:"route",bundlePath:"app/api/invitation/accept/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\invitation\\accept\\route.ts",nextConfigOutput:u,userland:s}),{requestAsyncStorage:l,staticGenerationAsyncStorage:v,serverHooks:m}=d,g="/api/invitation/accept/route";function y(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:v})}a()}catch(p){a(p)}}))},45365:(e,t,r)=>{r.a(e,(async(e,a)=>{try{r.r(t),r.d(t,{GET:()=>u,POST:()=>p,dynamic:()=>c});var n=r(87070),i=r(45758),o=e([i]);i=(o.then?(await o)():o)[0];const c="force-dynamic";async function p(e){try{const{token:t,password:r}=await e.json();if(!t||!r)return n.NextResponse.json({error:"Missing token or password"},{status:400});const a=await i.e.acceptInvitation(t,r);return n.NextResponse.json(a)}catch(t){return console.error("Error accepting invitation:",t),n.NextResponse.json({error:t},{status:400})}}async function u(e){try{const{searchParams:t}=new URL(e.url),r=t.get("token");if(!r)return n.NextResponse.json({error:"Missing token"},{status:400});const a=await i.e.getInvitation(r);return n.NextResponse.json(a)}catch(t){return console.error("Error getting invitation:",t),n.NextResponse.json({error:"Failed to get invitation"},{status:500})}}a()}catch(s){a(s)}}))},45758:(e,t,r)=>{r.a(e,(async(e,a)=>{try{r.d(t,{e:()=>c});var n=r(40416),i=r(84770),o=r(72929),s=e([o]);o=(s.then?(await s)():s)[0];class c{static async createInvitation(e){try{const t=(0,i.randomBytes)(32).toString("hex"),r=new Date(Date.now()+6048e5);await n.iW.collection("invitations").doc(t).set({...e,status:"PENDING",createdAt:new Date,expiresAt:r,createdByAdmin:!0});return{success:!0,token:t,invitationUrl:`${"https://ttsdocumentcontrol.web.app"}/accept-invitation?token=${t}`,expiresAt:r}}catch(t){throw console.error("Error creating invitation:",t),new Error("Failed to create invitation")}}static async acceptInvitation(e,t){try{const r=await n.iW.collection("invitations").doc(e).get();if(!r.exists)throw new Error("Invalid or expired invitation token.");const a=r.data();if("PENDING"!==a.status)throw new Error("Invitation has already been used or expired.");const i=await n.CZ.createUser({email:a.email,password:t,emailVerified:!0,displayName:a.name}),s=Array.isArray(a.sites)?a.sites:[a.sites].filter(Boolean);if(await n.iW.collection("users").doc(i.uid).set({email:a.email,name:a.name||"",employeeId:a.employeeId||"",role:a.role,sites:s,status:"ACTIVE",createdFromInvitation:!0,acceptedAt:new Date}),s.length>0){const e=s.map((e=>n.iW.collection("sites").doc(e).update({members:o.FieldValue.arrayUnion(i.uid)}).catch((t=>{console.error(`Warning: Failed to add user to site ${e}`,t)}))));await Promise.all(e)}return await n.iW.collection("invitations").doc(e).update({status:"ACCEPTED",acceptedAt:new Date,acceptedBy:i.uid}),{success:!0,userId:i.uid,message:"Account created successfully! You can now login."}}catch(r){throw console.error("Error accepting invitation:",r),r}}static async getInvitation(e){try{const t=await n.iW.collection("invitations").doc(e).get();if(!t.exists)return{success:!1,error:"Invalid invitation"};const r=t.data();return{success:!0,invitation:{email:r.email,name:r.name,role:r.role,status:r.status,expiresAt:r.expiresAt.toDate()}}}catch(t){return console.error("Error getting invitation:",t),{success:!1,error:"Failed to get invitation"}}}}a()}catch(c){a(c)}}))},40416:(e,t,r)=>{r.d(t,{CZ:()=>s,Hf:()=>c,iW:()=>o,SI:()=>p,uE:()=>u,Dh:()=>l,aj:()=>v,_B:()=>d,Lv:()=>m});const a=require("firebase-admin"),n=(e,t)=>a.apps.find((t=>t?.name===e))||a.initializeApp(t,e),i=()=>{const e={credential:a.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"};return n("ttsdoc-v2",e)},o=i().firestore(),s=i().auth(),c=i().storage().bucket(),p=i().messaging(),u=(()=>{const e={credential:a.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})};return n("bim-tracking",e)})().firestore(),d=()=>o,l=()=>s,v=()=>c,m=()=>u}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=t.X(0,[9276,5972],(()=>{return e=78056,t(t.s=e);var e}));module.exports=r})();