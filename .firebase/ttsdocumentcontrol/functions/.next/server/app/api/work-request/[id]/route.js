"use strict";(()=>{var e={};e.id=932,e.ids=[932],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},86178:(e,E,t)=>{t.r(E),t.d(E,{originalPathname:()=>d,patchFetch:()=>A,requestAsyncStorage:()=>_,routeModule:()=>R,serverHooks:()=>c,staticGenerationAsyncStorage:()=>D});var r={};t.r(r),t.d(r,{GET:()=>N,dynamic:()=>P});var s=t(49303),i=t(88716),I=t(60670),o=t(87070),n=t(40416),a=t(4458);let P="force-dynamic";async function N(e,{params:E}){try{let t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return o.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let r=t.split("Bearer ")[1],s=(await n.CZ.verifyIdToken(r)).uid,i=await n.iW.collection("users").doc(s).get();if(!i.exists)return o.NextResponse.json({success:!1,error:"User not found"},{status:404});let I=i.data(),P=I.sites||[],N=E.id,R=n.iW.collection("workRequests").doc(N),_=await R.get();if(!_.exists)return o.NextResponse.json({success:!1,error:"Document not found"},{status:404});let D=_.data();if(I.role!==a.K$.ADMIN&&!P.includes(D.siteId))return o.NextResponse.json({success:!1,error:"Access to this document is denied"},{status:403});let c=await n.iW.collection("sites").doc(D.siteId).get(),d=c.exists?{id:c.id,...c.data()}:{id:D.siteId,name:"Unknown Site"},A=Array.from(new Set(D.workflow.map(e=>e.userId))).map(e=>n.iW.collection("users").doc(e).get()),u=await Promise.all(A),M={};return u.forEach(e=>{if(e.exists){let E=e.data();M[e.id]={email:E.email,role:E.role}}}),o.NextResponse.json({success:!0,document:{id:_.id,...D,site:d,usersInfo:M}})}catch(t){console.error(`Error fetching work request ${E.id}:`,t);let e=t instanceof Error?t.message:"Internal Server Error";return o.NextResponse.json({success:!1,error:e},{status:500})}}let R=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/work-request/[id]/route",pathname:"/api/work-request/[id]",filename:"route",bundlePath:"app/api/work-request/[id]/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\work-request\\[id]\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:_,staticGenerationAsyncStorage:D,serverHooks:c}=R,d="/api/work-request/[id]/route";function A(){return(0,I.patchFetch)({serverHooks:c,staticGenerationAsyncStorage:D})}},4458:(e,E,t)=>{t.d(E,{$p:()=>n,Ge:()=>P,K$:()=>r,NK:()=>N,c9:()=>o,gf:()=>I,n$:()=>a,oU:()=>i,uc:()=>s});let r={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},s=[r.BIM,r.ME,r.SN,r.SITE_ADMIN,r.ADMIN,r.PM,r.PE,r.OE],i=[r.SITE_ADMIN,r.ADMIN_SITE_2,r.OE,r.PE,r.ADMIN],I=[r.CM,r.ADMIN,r.SITE_ADMIN,r.PM,r.PE,r.OE];r.PM,r.ADMIN,r.SE,r.FM;let o=[r.PE,r.OE,r.ADMIN],n=[r.PM,r.ADMIN];r.PD,r.SE,r.FM;let a={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},P={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},N={[a.PENDING_REVIEW]:"รอตรวจสอบ",[a.PENDING_CM_APPROVAL]:"รออนุมัติ (CM/Approver)",[a.REVISION_REQUIRED]:"แก้ไข",[a.APPROVED]:"อนุมัติ",[a.APPROVED_WITH_COMMENTS]:"อนุมัติตามคอมเมนต์ (ไม่แก้ไข)",[a.APPROVED_REVISION_REQUIRED]:"อนุมัติตามคอมเมนต์ (ต้องแก้ไข)",[a.REJECTED]:"ไม่อนุมัติ",[a.PENDING_FINAL_APPROVAL]:"รอ SITE อนุมัติขั้นสุดท้าย",[P.DRAFT]:"รออนุมัติ (PM)",[P.REJECTED_BY_PM]:"ไม่อนุมัติ (PM)",[P.PENDING_BIM]:"รอ BIM รับงาน",[P.IN_PROGRESS]:"BIM กำลังดำเนินการ",[P.PENDING_ACCEPTANCE]:"รอตรวจรับ (Site)",[P.REVISION_REQUESTED]:"ขอแก้ไข (WR)",[P.COMPLETED]:"เสร็จสิ้น"};a.PENDING_REVIEW,a.PENDING_CM_APPROVAL,a.REVISION_REQUIRED,a.APPROVED,a.REJECTED,a.APPROVED_WITH_COMMENTS,a.APPROVED_REVISION_REQUIRED,P.DRAFT,P.REJECTED_BY_PM,P.PENDING_BIM,P.IN_PROGRESS,P.PENDING_ACCEPTANCE,P.REVISION_REQUESTED,P.COMPLETED},40416:(e,E,t)=>{t.d(E,{CZ:()=>o,Hf:()=>n,iW:()=>I,SI:()=>a,uE:()=>P,Dh:()=>R,_B:()=>N,Lv:()=>_});let r=require("firebase-admin"),s=(e,E)=>r.apps.find(E=>E?.name===e)||r.initializeApp(E,e),i=()=>s("ttsdoc-v2",{credential:r.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),I=i().firestore(),o=i().auth(),n=i().storage().bucket(),a=i().messaging(),P=s("bim-tracking",{credential:r.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),N=()=>I,R=()=>o,_=()=>P}};var E=require("../../../../webpack-runtime.js");E.C(e);var t=e=>E(E.s=e),r=E.X(0,[9276,5972],()=>t(86178));module.exports=r})();