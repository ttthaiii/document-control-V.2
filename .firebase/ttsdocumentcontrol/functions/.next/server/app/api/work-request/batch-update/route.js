"use strict";(()=>{var e={id:9496,ids:[9496]};e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},11603:(e,t,r)=>{r.a(e,(async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>D,requestAsyncStorage:()=>P,routeModule:()=>u,serverHooks:()=>N,staticGenerationAsyncStorage:()=>R});var o=r(49303),E=r(88716),n=r(60670),a=r(72302),i=e([a]);a=(i.then?(await i)():i)[0];const I="",u=new o.AppRouteRouteModule({definition:{kind:E.x.APP_ROUTE,page:"/api/work-request/batch-update/route",pathname:"/api/work-request/batch-update",filename:"route",bundlePath:"app/api/work-request/batch-update/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\work-request\\batch-update\\route.ts",nextConfigOutput:I,userland:a}),{requestAsyncStorage:P,staticGenerationAsyncStorage:R,serverHooks:N}=u,_="/api/work-request/batch-update/route";function D(){return(0,n.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:R})}s()}catch(c){s(c)}}))},72302:(e,t,r)=>{r.a(e,(async(e,s)=>{try{r.r(t),r.d(t,{POST:()=>u,dynamic:()=>I});var o=r(87070),E=r(40416),n=r(72929),a=r(4458),i=e([n]);n=(i.then?(await i)():i)[0];const I="force-dynamic";async function u(e){let t=0,r=0;const s=[];let i=[];try{const c=e.headers.get("authorization");if(!c?.startsWith("Bearer "))return o.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});const I=c.split("Bearer ")[1],u=(await E.CZ.verifyIdToken(I)).uid,P=await E.iW.collection("users").doc(u).get();if(!P.exists||!a.$p.includes(P.data().role))return o.NextResponse.json({success:!1,error:"Permission denied. Approver role required."},{status:403});const R=P.data(),N=await e.json();i=N.ids;const _=N.action,D=N.payload;if(!Array.isArray(i)||0===i.length||!_)return o.NextResponse.json({success:!1,error:"Missing required fields: ids (array), action."},{status:400});if("APPROVE_DRAFT"!==_&&"REJECT_DRAFT"!==_)return o.NextResponse.json({success:!1,error:"Invalid action."},{status:400});if("REJECT_DRAFT"===_&&(!D||!D.comments||""===D.comments.trim()))return o.NextResponse.json({success:!1,error:"Comment is required when rejecting."},{status:400});const d="APPROVE_DRAFT"===_?a.Ge.PENDING_BIM:a.Ge.REJECTED_BY_PM,A=E.iW.batch(),p=E.iW.collection("workRequests"),M=i.map((e=>p.doc(e))),T=await E.iW.getAll(...M);for(const e of T){const o=e.id;if(!e.exists){console.warn(`[Batch Update WR/${o}] Document not found.`),r++,s.push({id:o,error:"Document not found"});continue}const E=e.data();if(E.status!==a.Ge.DRAFT){console.warn(`[Batch Update WR/${o}] Document not in DRAFT status (Current: ${E.status}). Skipping.`),r++,s.push({id:o,error:`Invalid status: ${E.status}`});continue}const i={action:_,status:d,userId:u,userName:R.email,role:R.role,timestamp:(new Date).toISOString(),comments:D?.comments||"",files:[]},c={status:d,workflow:n.FieldValue.arrayUnion(i),updatedAt:n.FieldValue.serverTimestamp()};A.update(e.ref,c),t++}return t>0?(await A.commit(),console.log(`[Batch Update WR] Successfully updated ${t} documents.`)):console.log("[Batch Update WR] No documents were updated."),o.NextResponse.json({success:!0,message:`Processed ${i.length} items. Updated: ${t}, Errors: ${r}.`,updatedCount:t,errorCount:r,errors:r>0?s:void 0})}catch(c){console.error("[Batch Update WR] Error:",c);const e=c instanceof Error?c.message:"Internal Server Error";return o.NextResponse.json({success:!1,error:e,updatedCount:t,errorCount:r+(i.length-t-r),errors:s},{status:500})}}s()}catch(c){s(c)}}))},4458:(e,t,r)=>{r.d(t,{$p:()=>i,Ge:()=>I,K$:()=>s,NK:()=>u,c9:()=>a,gf:()=>n,n$:()=>c,oU:()=>E,uc:()=>o});const s={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},o=[s.BIM,s.ME,s.SN,s.SITE_ADMIN,s.ADMIN,s.PM,s.PE,s.OE],E=[s.SITE_ADMIN,s.ADMIN_SITE_2,s.OE,s.PE,s.ADMIN],n=[s.CM,s.ADMIN,s.SITE_ADMIN,s.PM,s.PE,s.OE],a=(s.PM,s.ADMIN,s.SE,s.FM,[s.PE,s.OE,s.ADMIN]),i=[s.PM,s.ADMIN],c=(s.PD,s.SE,s.FM,{PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"}),I={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},u={[c.PENDING_REVIEW]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e2a\u0e2d\u0e1a",[c.PENDING_CM_APPROVAL]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (CM/Approver)",[c.REVISION_REQUIRED]:"\u0e41\u0e01\u0e49\u0e44\u0e02",[c.APPROVED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[c.APPROVED_WITH_COMMENTS]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e44\u0e21\u0e48\u0e41\u0e01\u0e49\u0e44\u0e02)",[c.APPROVED_REVISION_REQUIRED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e15\u0e49\u0e2d\u0e07\u0e41\u0e01\u0e49\u0e44\u0e02)",[c.REJECTED]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[c.PENDING_FINAL_APPROVAL]:"\u0e23\u0e2d SITE \u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e02\u0e31\u0e49\u0e19\u0e2a\u0e38\u0e14\u0e17\u0e49\u0e32\u0e22",[I.DRAFT]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[I.REJECTED_BY_PM]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[I.PENDING_BIM]:"\u0e23\u0e2d BIM \u0e23\u0e31\u0e1a\u0e07\u0e32\u0e19",[I.IN_PROGRESS]:"BIM \u0e01\u0e33\u0e25\u0e31\u0e07\u0e14\u0e33\u0e40\u0e19\u0e34\u0e19\u0e01\u0e32\u0e23",[I.PENDING_ACCEPTANCE]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e23\u0e31\u0e1a (Site)",[I.REVISION_REQUESTED]:"\u0e02\u0e2d\u0e41\u0e01\u0e49\u0e44\u0e02 (WR)",[I.COMPLETED]:"\u0e40\u0e2a\u0e23\u0e47\u0e08\u0e2a\u0e34\u0e49\u0e19"};c.PENDING_REVIEW,c.PENDING_CM_APPROVAL,c.REVISION_REQUIRED,c.APPROVED,c.REJECTED,c.APPROVED_WITH_COMMENTS,c.APPROVED_REVISION_REQUIRED,c.PENDING_FINAL_APPROVAL,I.DRAFT,I.REJECTED_BY_PM,I.PENDING_BIM,I.IN_PROGRESS,I.PENDING_ACCEPTANCE,I.REVISION_REQUESTED,I.COMPLETED},40416:(e,t,r)=>{r.d(t,{CZ:()=>a,Hf:()=>i,iW:()=>n,SI:()=>c,uE:()=>I,Dh:()=>P,aj:()=>R,_B:()=>u,Lv:()=>N});const s=require("firebase-admin"),o=(e,t)=>s.apps.find((t=>t?.name===e))||s.initializeApp(t,e),E=()=>{const e={credential:s.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"};return o("ttsdoc-v2",e)},n=E().firestore(),a=E().auth(),i=E().storage().bucket(),c=E().messaging(),I=(()=>{const e={credential:s.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})};return o("bim-tracking",e)})().firestore(),u=()=>n,P=()=>a,R=()=>i,N=()=>I}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=t.X(0,[9276,5972],(()=>{return e=11603,t(t.s=e);var e}));module.exports=r})();