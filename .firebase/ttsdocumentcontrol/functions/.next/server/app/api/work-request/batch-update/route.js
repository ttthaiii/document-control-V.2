"use strict";(()=>{var e={};e.id=9496,e.ids=[9496],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},11603:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>N,patchFetch:()=>I,requestAsyncStorage:()=>R,routeModule:()=>c,serverHooks:()=>u,staticGenerationAsyncStorage:()=>P});var E=r(49303),a=r(88716),o=r(60670),n=r(72302),i=e([n]);n=(i.then?(await i)():i)[0];let c=new E.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/work-request/batch-update/route",pathname:"/api/work-request/batch-update",filename:"route",bundlePath:"app/api/work-request/batch-update/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\work-request\\batch-update\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:R,staticGenerationAsyncStorage:P,serverHooks:u}=c,N="/api/work-request/batch-update/route";function I(){return(0,o.patchFetch)({serverHooks:u,staticGenerationAsyncStorage:P})}s()}catch(e){s(e)}})},72302:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{POST:()=>I,dynamic:()=>c});var E=r(87070),a=r(40416),o=r(72929),n=r(4458),i=e([o]);o=(i.then?(await i)():i)[0];let c="force-dynamic";async function I(e){let t=0,r=0,s=[],i=[];try{let I=e.headers.get("authorization");if(!I?.startsWith("Bearer "))return E.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let c=I.split("Bearer ")[1],R=(await a.CZ.verifyIdToken(c)).uid,P=await a.iW.collection("users").doc(R).get();if(!P.exists||!n.$p.includes(P.data().role))return E.NextResponse.json({success:!1,error:"Permission denied. Approver role required."},{status:403});let u=P.data(),N=await e.json();i=N.ids;let D=N.action,_=N.payload;if(!Array.isArray(i)||0===i.length||!D)return E.NextResponse.json({success:!1,error:"Missing required fields: ids (array), action."},{status:400});if("APPROVE_DRAFT"!==D&&"REJECT_DRAFT"!==D)return E.NextResponse.json({success:!1,error:"Invalid action."},{status:400});if("REJECT_DRAFT"===D&&(!_||!_.comments||""===_.comments.trim()))return E.NextResponse.json({success:!1,error:"Comment is required when rejecting."},{status:400});let d="APPROVE_DRAFT"===D?n.Ge.PENDING_BIM:n.Ge.REJECTED_BY_PM,p=a.iW.batch(),A=a.iW.collection("workRequests"),l=i.map(e=>A.doc(e));for(let e of(await a.iW.getAll(...l))){let E=e.id;if(!e.exists){console.warn(`[Batch Update WR/${E}] Document not found.`),r++,s.push({id:E,error:"Document not found"});continue}let a=e.data();if(a.status!==n.Ge.DRAFT){console.warn(`[Batch Update WR/${E}] Document not in DRAFT status (Current: ${a.status}). Skipping.`),r++,s.push({id:E,error:`Invalid status: ${a.status}`});continue}let i={action:D,status:d,userId:R,userName:u.email,role:u.role,timestamp:new Date().toISOString(),comments:_?.comments||"",files:[]},I={status:d,workflow:o.FieldValue.arrayUnion(i),updatedAt:o.FieldValue.serverTimestamp()};p.update(e.ref,I),t++}return t>0?(await p.commit(),console.log(`[Batch Update WR] Successfully updated ${t} documents.`)):console.log("[Batch Update WR] No documents were updated."),E.NextResponse.json({success:!0,message:`Processed ${i.length} items. Updated: ${t}, Errors: ${r}.`,updatedCount:t,errorCount:r,errors:r>0?s:void 0})}catch(a){console.error("[Batch Update WR] Error:",a);let e=a instanceof Error?a.message:"Internal Server Error";return E.NextResponse.json({success:!1,error:e,updatedCount:t,errorCount:r+(i.length-t-r),errors:s},{status:500})}}s()}catch(e){s(e)}})},4458:(e,t,r)=>{r.d(t,{$p:()=>i,Ge:()=>c,K$:()=>s,c9:()=>n,gf:()=>o,n$:()=>I,oU:()=>a,uc:()=>E});let s={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},E=[s.BIM,s.ME,s.SN,s.ADMIN],a=[s.SITE_ADMIN,s.ADMIN_SITE_2,s.OE,s.PE,s.ADMIN],o=[s.CM,s.PD,s.ADMIN];s.PM,s.ADMIN,s.SE,s.FM;let n=[s.PE,s.OE,s.ADMIN],i=[s.PD,s.PM,s.ADMIN],I={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},c={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"};I.PENDING_REVIEW,I.PENDING_CM_APPROVAL,I.REVISION_REQUIRED,I.APPROVED,I.APPROVED_WITH_COMMENTS,I.APPROVED_REVISION_REQUIRED,I.REJECTED,I.PENDING_FINAL_APPROVAL,c.DRAFT,c.REJECTED_BY_PM,c.PENDING_BIM,c.IN_PROGRESS,c.PENDING_ACCEPTANCE,c.REVISION_REQUESTED,c.COMPLETED,I.PENDING_REVIEW,I.PENDING_CM_APPROVAL,I.REVISION_REQUIRED,I.APPROVED,I.REJECTED,I.APPROVED_WITH_COMMENTS,I.APPROVED_REVISION_REQUIRED,c.DRAFT,c.REJECTED_BY_PM,c.PENDING_BIM,c.IN_PROGRESS,c.PENDING_ACCEPTANCE,c.REVISION_REQUESTED,c.COMPLETED},40416:(e,t,r)=>{r.d(t,{CZ:()=>n,Hf:()=>i,iW:()=>o,SI:()=>I,uE:()=>c,Dh:()=>P,_B:()=>R,Lv:()=>u});let s=require("firebase-admin"),E=(e,t)=>s.apps.find(t=>t?.name===e)||s.initializeApp(t,e),a=()=>E("ttsdoc-v2",{credential:s.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),o=a().firestore(),n=a().auth(),i=a().storage().bucket(),I=a().messaging(),c=E("bim-tracking",{credential:s.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),R=()=>o,P=()=>n,u=()=>c}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,5972],()=>r(11603));module.exports=s})();