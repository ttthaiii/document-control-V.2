"use strict";(()=>{var e={id:9312,ids:[9312]};e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},62310:(e,t,r)=>{r.a(e,(async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>D,patchFetch:()=>_,requestAsyncStorage:()=>N,routeModule:()=>u,serverHooks:()=>R,staticGenerationAsyncStorage:()=>P});var n=r(49303),o=r(88716),a=r(60670),E=r(60316),i=e([E]);E=(i.then?(await i)():i)[0];const I="",u=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/work-request/create/route",pathname:"/api/work-request/create",filename:"route",bundlePath:"app/api/work-request/create/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\work-request\\create\\route.ts",nextConfigOutput:I,userland:E}),{requestAsyncStorage:N,staticGenerationAsyncStorage:P,serverHooks:R}=u,D="/api/work-request/create/route";function _(){return(0,a.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:P})}s()}catch(c){s(c)}}))},60316:(e,t,r)=>{r.a(e,(async(e,s)=>{try{r.r(t),r.d(t,{POST:()=>N,dynamic:()=>I});var n=r(87070),o=r(40416),a=r(72929),E=r(4458),i=e([a]);a=(i.then?(await i)():i)[0];const I="force-dynamic";async function u(e){const t=(e.headers.get("authorization")||"").match(/^Bearer (.+)$/i);if(!t)return null;try{return(await o.CZ.verifyIdToken(t[1])).uid}catch{return null}}async function N(e){const t=await u(e);if(!t)return n.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});try{const s=await o.iW.collection("users").doc(t).get();if(!s.exists)return n.NextResponse.json({success:!1,error:"User not found"},{status:403});const i=s.data();if(!E.c9.includes(i.role))return n.NextResponse.json({success:!1,error:"Permission denied. Only Project Engineers (PE) or Owner Engineers (OE) can create Work Requests."},{status:403});const{siteId:c,taskName:I,description:u,dueDate:N,files:P}=await e.json();if(!c||!I||!N)return n.NextResponse.json({success:!1,error:"Missing required fields (siteId, taskName, dueDate)."},{status:400});const R=E.Ge.DRAFT,D=null,{documentNumber:_,runningNumber:d}=await o.iW.runTransaction((async e=>{const t=o.iW.collection("sites").doc(c),r=await e.get(t);if(!r.exists)throw new Error("Site not found");const s=r.data()?.shortName;if(!s)throw new Error(`'shortName' is not configured for site ID: ${c}`);const n=`${c}_WR`,a=o.iW.collection("counters").doc(n),E=await e.get(a),i=(E.data()?.currentNumber||0)+1;e.set(a,{currentNumber:i},{merge:!0});const I=String(i).padStart(4,"0");return{documentNumber:`WR-${s}-${I}`,runningNumber:I}})),A=[];if(P&&P.length>0){const e="https://ttsdoc-cdn.ttthaiii30.workers.dev";for(const s of P){const n=s.filePath;if(!n||!n.startsWith(`temp/${t}/`)){console.warn(`Skipping invalid file path during WR creation: ${n}`);continue}const a=`sites/${c}/work-requests/${_}/${Date.now()}_${s.fileName}`;try{await o.Hf.file(n).move(a),A.push({...s,fileUrl:`${e}/${a}`,filePath:a,uploadedAt:(new Date).toISOString(),uploadedBy:t})}catch(r){console.error(`Failed to move file ${n} to ${a}:`,r)}}}const l=o.iW.collection("workRequests").doc();return await l.set({documentNumber:_,runningNumber:d,siteId:c,taskName:I,description:u||"",status:R,createdBy:t,assignedTo:D,planStartDate:null,dueDate:new Date(N),createdAt:a.FieldValue.serverTimestamp(),updatedAt:a.FieldValue.serverTimestamp(),revisionNumber:0,isLatest:!0,files:A,taskData:null,workflow:[{action:"CREATE_DRAFT",status:R,userId:t,userName:i.email,role:i.role,timestamp:(new Date).toISOString(),files:A,comments:u||"\u0e2a\u0e23\u0e49\u0e32\u0e07\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e09\u0e1a\u0e31\u0e1a\u0e23\u0e48\u0e32\u0e07"}],usersInfo:{[t]:{email:i.email,role:i.role}}}),n.NextResponse.json({success:!0,id:l.id,documentNumber:_},{status:201})}catch(s){return console.error("Work Request Create Error:",s),n.NextResponse.json({success:!1,error:"Internal Server Error",details:s.message},{status:500})}}s()}catch(c){s(c)}}))},4458:(e,t,r)=>{r.d(t,{$p:()=>i,Ge:()=>I,K$:()=>s,NK:()=>u,c9:()=>E,gf:()=>a,n$:()=>c,oU:()=>o,uc:()=>n});const s={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},n=[s.BIM,s.ME,s.SN,s.SITE_ADMIN,s.ADMIN,s.PM,s.PE,s.OE],o=[s.SITE_ADMIN,s.ADMIN_SITE_2,s.OE,s.PE,s.ADMIN],a=[s.CM,s.ADMIN,s.SITE_ADMIN,s.PM,s.PE,s.OE],E=(s.PM,s.ADMIN,s.SE,s.FM,[s.PE,s.OE,s.ADMIN]),i=[s.PM,s.ADMIN],c=(s.PD,s.SE,s.FM,{PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"}),I={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},u={[c.PENDING_REVIEW]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e2a\u0e2d\u0e1a",[c.PENDING_CM_APPROVAL]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (CM/Approver)",[c.REVISION_REQUIRED]:"\u0e41\u0e01\u0e49\u0e44\u0e02",[c.APPROVED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[c.APPROVED_WITH_COMMENTS]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e44\u0e21\u0e48\u0e41\u0e01\u0e49\u0e44\u0e02)",[c.APPROVED_REVISION_REQUIRED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e15\u0e49\u0e2d\u0e07\u0e41\u0e01\u0e49\u0e44\u0e02)",[c.REJECTED]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[c.PENDING_FINAL_APPROVAL]:"\u0e23\u0e2d SITE \u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e02\u0e31\u0e49\u0e19\u0e2a\u0e38\u0e14\u0e17\u0e49\u0e32\u0e22",[I.DRAFT]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[I.REJECTED_BY_PM]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[I.PENDING_BIM]:"\u0e23\u0e2d BIM \u0e23\u0e31\u0e1a\u0e07\u0e32\u0e19",[I.IN_PROGRESS]:"BIM \u0e01\u0e33\u0e25\u0e31\u0e07\u0e14\u0e33\u0e40\u0e19\u0e34\u0e19\u0e01\u0e32\u0e23",[I.PENDING_ACCEPTANCE]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e23\u0e31\u0e1a (Site)",[I.REVISION_REQUESTED]:"\u0e02\u0e2d\u0e41\u0e01\u0e49\u0e44\u0e02 (WR)",[I.COMPLETED]:"\u0e40\u0e2a\u0e23\u0e47\u0e08\u0e2a\u0e34\u0e49\u0e19"};c.PENDING_REVIEW,c.PENDING_CM_APPROVAL,c.REVISION_REQUIRED,c.APPROVED,c.REJECTED,c.APPROVED_WITH_COMMENTS,c.APPROVED_REVISION_REQUIRED,c.PENDING_FINAL_APPROVAL,I.DRAFT,I.REJECTED_BY_PM,I.PENDING_BIM,I.IN_PROGRESS,I.PENDING_ACCEPTANCE,I.REVISION_REQUESTED,I.COMPLETED},40416:(e,t,r)=>{r.d(t,{CZ:()=>E,Hf:()=>i,iW:()=>a,SI:()=>c,uE:()=>I,Dh:()=>N,aj:()=>P,_B:()=>u,Lv:()=>R});const s=require("firebase-admin"),n=(e,t)=>s.apps.find((t=>t?.name===e))||s.initializeApp(t,e),o=()=>{const e={credential:s.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"};return n("ttsdoc-v2",e)},a=o().firestore(),E=o().auth(),i=o().storage().bucket(),c=o().messaging(),I=(()=>{const e={credential:s.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})};return n("bim-tracking",e)})().firestore(),u=()=>a,N=()=>E,P=()=>i,R=()=>I}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=t.X(0,[9276,5972],(()=>{return e=62310,t(t.s=e);var e}));module.exports=r})();