"use strict";(()=>{var e={};e.id=9312,e.ids=[9312],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},62310:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>I,requestAsyncStorage:()=>u,routeModule:()=>c,serverHooks:()=>N,staticGenerationAsyncStorage:()=>P});var E=r(49303),a=r(88716),i=r(60670),n=r(60316),o=e([n]);n=(o.then?(await o)():o)[0];let c=new E.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/work-request/create/route",pathname:"/api/work-request/create",filename:"route",bundlePath:"app/api/work-request/create/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\work-request\\create\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:u,staticGenerationAsyncStorage:P,serverHooks:N}=c,R="/api/work-request/create/route";function I(){return(0,i.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:P})}s()}catch(e){s(e)}})},60316:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{POST:()=>c,dynamic:()=>u});var E=r(87070),a=r(40416),i=r(72929),n=r(4458),o=e([i]);i=(o.then?(await o)():o)[0];let u="force-dynamic";async function I(e){let t=(e.headers.get("authorization")||"").match(/^Bearer (.+)$/i);if(!t)return null;try{return(await a.CZ.verifyIdToken(t[1])).uid}catch{return null}}async function c(e){let t=await I(e);if(!t)return E.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});try{let r=await a.iW.collection("users").doc(t).get();if(!r.exists)return E.NextResponse.json({success:!1,error:"User not found"},{status:403});let s=r.data();if(!n.c9.includes(s.role))return E.NextResponse.json({success:!1,error:"Permission denied. Only Project Engineers (PE) or Owner Engineers (OE) can create Work Requests."},{status:403});let{siteId:o,taskName:I,description:c,dueDate:u,files:P}=await e.json();if(!o||!I||!u)return E.NextResponse.json({success:!1,error:"Missing required fields (siteId, taskName, dueDate)."},{status:400});let N=n.Ge.DRAFT,{documentNumber:R,runningNumber:l}=await a.iW.runTransaction(async e=>{let t=a.iW.collection("sites").doc(o),r=await e.get(t);if(!r.exists)throw Error("Site not found");let s=r.data()?.shortName;if(!s)throw Error(`'shortName' is not configured for site ID: ${o}`);let E=`${o}_WR`,i=a.iW.collection("counters").doc(E),n=await e.get(i),I=(n.data()?.currentNumber||0)+1;e.set(i,{currentNumber:I},{merge:!0});let c=String(I).padStart(4,"0");return{documentNumber:`WR-${s}-${c}`,runningNumber:c}}),D=[];if(P&&P.length>0)for(let e of P){let r=e.filePath;if(!r||!r.startsWith(`temp/${t}/`)){console.warn(`Skipping invalid file path during WR creation: ${r}`);continue}let s=`sites/${o}/work-requests/${R}/${Date.now()}_${e.fileName}`;try{await a.Hf.file(r).move(s),D.push({...e,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${s}`,filePath:s,uploadedAt:new Date().toISOString(),uploadedBy:t})}catch(e){console.error(`Failed to move file ${r} to ${s}:`,e)}}let _=a.iW.collection("workRequests").doc();return await _.set({documentNumber:R,runningNumber:l,siteId:o,taskName:I,description:c||"",status:N,createdBy:t,assignedTo:null,planStartDate:null,dueDate:new Date(u),createdAt:i.FieldValue.serverTimestamp(),updatedAt:i.FieldValue.serverTimestamp(),revisionNumber:0,isLatest:!0,files:D,taskData:null,workflow:[{action:"CREATE_DRAFT",status:N,userId:t,userName:s.email,role:s.role,timestamp:new Date().toISOString(),files:D,comments:c||"สร้างเอกสารฉบับร่าง"}],usersInfo:{[t]:{email:s.email,role:s.role}}}),E.NextResponse.json({success:!0,id:_.id,documentNumber:R},{status:201})}catch(e){return console.error("Work Request Create Error:",e),E.NextResponse.json({success:!1,error:"Internal Server Error",details:e.message},{status:500})}}s()}catch(e){s(e)}})},4458:(e,t,r)=>{r.d(t,{$p:()=>o,Ge:()=>c,K$:()=>s,NK:()=>u,c9:()=>n,gf:()=>i,n$:()=>I,oU:()=>a,uc:()=>E});let s={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},E=[s.BIM,s.ME,s.SN,s.SITE_ADMIN,s.ADMIN,s.PM,s.PE,s.OE],a=[s.SITE_ADMIN,s.ADMIN_SITE_2,s.OE,s.PE,s.ADMIN],i=[s.CM,s.ADMIN,s.SITE_ADMIN,s.PM,s.PE,s.OE];s.PM,s.ADMIN,s.SE,s.FM;let n=[s.PE,s.OE,s.ADMIN],o=[s.PM,s.ADMIN];s.PD,s.SE,s.FM;let I={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},c={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},u={[I.PENDING_REVIEW]:"รอตรวจสอบ",[I.PENDING_CM_APPROVAL]:"รออนุมัติ (CM/Approver)",[I.REVISION_REQUIRED]:"แก้ไข",[I.APPROVED]:"อนุมัติ",[I.APPROVED_WITH_COMMENTS]:"อนุมัติตามคอมเมนต์ (ไม่แก้ไข)",[I.APPROVED_REVISION_REQUIRED]:"อนุมัติตามคอมเมนต์ (ต้องแก้ไข)",[I.REJECTED]:"ไม่อนุมัติ",[I.PENDING_FINAL_APPROVAL]:"รอ SITE อนุมัติขั้นสุดท้าย",[c.DRAFT]:"รออนุมัติ (PM)",[c.REJECTED_BY_PM]:"ไม่อนุมัติ (PM)",[c.PENDING_BIM]:"รอ BIM รับงาน",[c.IN_PROGRESS]:"BIM กำลังดำเนินการ",[c.PENDING_ACCEPTANCE]:"รอตรวจรับ (Site)",[c.REVISION_REQUESTED]:"ขอแก้ไข (WR)",[c.COMPLETED]:"เสร็จสิ้น"};I.PENDING_REVIEW,I.PENDING_CM_APPROVAL,I.REVISION_REQUIRED,I.APPROVED,I.REJECTED,I.APPROVED_WITH_COMMENTS,I.APPROVED_REVISION_REQUIRED,c.DRAFT,c.REJECTED_BY_PM,c.PENDING_BIM,c.IN_PROGRESS,c.PENDING_ACCEPTANCE,c.REVISION_REQUESTED,c.COMPLETED},40416:(e,t,r)=>{r.d(t,{CZ:()=>n,Hf:()=>o,iW:()=>i,SI:()=>I,uE:()=>c,Dh:()=>P,_B:()=>u,Lv:()=>N});let s=require("firebase-admin"),E=(e,t)=>s.apps.find(t=>t?.name===e)||s.initializeApp(t,e),a=()=>E("ttsdoc-v2",{credential:s.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),i=a().firestore(),n=a().auth(),o=a().storage().bucket(),I=a().messaging(),c=E("bim-tracking",{credential:s.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),u=()=>i,P=()=>n,N=()=>c}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,5972],()=>r(62310));module.exports=s})();