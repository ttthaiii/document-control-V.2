"use strict";(()=>{var e={};e.id=9312,e.ids=[9312],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},62310:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>u,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p});var a=r(49303),i=r(88716),o=r(60670),n=r(60316),c=e([n]);n=(c.then?(await c)():c)[0];let l=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/work-request/create/route",pathname:"/api/work-request/create",filename:"route",bundlePath:"app/api/work-request/create/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\work-request\\create\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:m}=l,f="/api/work-request/create/route";function u(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}s()}catch(e){s(e)}})},60316:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{POST:()=>l,dynamic:()=>d});var a=r(87070),i=r(40416),o=r(72929),n=r(39142),c=e([o]);o=(c.then?(await c)():c)[0];let d="force-dynamic";async function u(e){let t=(e.headers.get("authorization")||"").match(/^Bearer (.+)$/i);if(!t)return null;try{return(await i.CZ.verifyIdToken(t[1])).uid}catch{return null}}async function l(e){let t=await u(e);if(!t)return a.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});try{let r=await i.iW.collection("users").doc(t).get();if(!r.exists)return a.NextResponse.json({success:!1,error:"User not found"},{status:403});let s=r.data(),{siteId:c,taskName:u,description:l,priority:d,files:p}=await e.json();if(!c||!u||!d)return a.NextResponse.json({success:!1,error:"Missing required fields (siteId, taskName, priority)."},{status:400});let m=await i.iW.runTransaction(async e=>{let t=i.iW.collection("sites").doc(c),r=await e.get(t);if(!r.exists)throw Error("Site not found");if(!r.data()?.shortName)throw Error(`'shortName' is not configured for site ID: ${c}`);let s=`${c}_WR`,a=i.iW.collection("counters").doc(s),o=await e.get(a),n=(o.data()?.currentNumber||0)+1;return e.set(a,{currentNumber:n},{merge:!0}),String(n).padStart(4,"0")}),f=`WR-${(await i.iW.collection("sites").doc(c).get()).data()?.shortName}-${m}`,E=[];if(p&&p.length>0)for(let e of p){let r=e.filePath;if(!r||!r.startsWith(`temp/${t}/`))continue;let s=`sites/${c}/work-requests/${f}/${Date.now()}_${e.fileName}`;await i.Hf.file(r).move(s),await i.Hf.file(r).delete({ignoreNotFound:!0}),E.push({...e,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${s}`,filePath:s,uploadedAt:new Date().toISOString(),uploadedBy:t})}let N=i.iW.collection("workRequests").doc(),I=n.P.PENDING_BIM;return await N.set({documentNumber:f,runningNumber:m,siteId:c,taskName:u,description:l||"",priority:d,status:I,createdBy:t,createdAt:o.FieldValue.serverTimestamp(),updatedAt:o.FieldValue.serverTimestamp(),revisionNumber:0,isLatest:!0,files:E,workflow:[{action:"CREATE",status:I,userId:t,userName:s.email,role:s.role,timestamp:new Date().toISOString(),files:E,comments:l||""}],usersInfo:{[t]:{email:s.email,role:s.role}}}),a.NextResponse.json({success:!0,id:N.id,documentNumber:f},{status:201})}catch(e){return console.error("Work Request Create Error:",e),a.NextResponse.json({success:!1,error:"Internal Server Error",details:e.message},{status:500})}}s()}catch(e){s(e)}})},40416:(e,t,r)=>{r.d(t,{CZ:()=>n,Hf:()=>c,iW:()=>o,uE:()=>u,Lv:()=>l});let s=require("firebase-admin"),a=(e,t)=>s.apps.find(t=>t?.name===e)||s.initializeApp(t,e),i=()=>a("ttsdoc-v2",{credential:s.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),o=i().firestore(),n=i().auth(),c=i().storage().bucket(),u=a("bim-tracking",{credential:s.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),l=()=>u},39142:(e,t,r)=>{var s,a;r.d(t,{P:()=>a}),function(e){e.NORMAL="NORMAL",e.HIGH="HIGH",e.URGENT="URGENT"}(s||(s={})),function(e){e.PENDING_BIM="PENDING_BIM",e.IN_PROGRESS="IN_PROGRESS",e.PENDING_ACCEPTANCE="PENDING_ACCEPTANCE",e.REVISION_REQUESTED="REVISION_REQUESTED",e.COMPLETED="COMPLETED"}(a||(a={}))}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972],()=>r(62310));module.exports=s})();