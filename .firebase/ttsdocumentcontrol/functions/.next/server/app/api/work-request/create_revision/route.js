"use strict";(()=>{var e={id:6398,ids:[6398]};e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},85346:(e,t,r)=>{r.a(e,(async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>d,requestAsyncStorage:()=>P,routeModule:()=>N,serverHooks:()=>R,staticGenerationAsyncStorage:()=>u});var o=r(49303),a=r(88716),E=r(60670),i=r(81050),n=e([i]);i=(n.then?(await n)():n)[0];const I="",N=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/work-request/create_revision/route",pathname:"/api/work-request/create_revision",filename:"route",bundlePath:"app/api/work-request/create_revision/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\work-request\\create_revision\\route.ts",nextConfigOutput:I,userland:i}),{requestAsyncStorage:P,staticGenerationAsyncStorage:u,serverHooks:R}=N,_="/api/work-request/create_revision/route";function d(){return(0,E.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:u})}s()}catch(c){s(c)}}))},81050:(e,t,r)=>{r.a(e,(async(e,s)=>{try{r.r(t),r.d(t,{POST:()=>P,dynamic:()=>I});var o=r(87070),a=r(40416),E=r(72929),i=r(4458),n=e([E]);E=(n.then?(await n)():n)[0];const I="force-dynamic";async function N(e){const t=(e.headers.get("authorization")||"").match(/^Bearer (.+)$/i);if(!t)return null;try{const e=(0,a.Dh)();return(await e.verifyIdToken(t[1])).uid}catch{return null}}async function P(e){const t=await N(e);if(!t)return o.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});try{const{originalDocId:r,uploadedFiles:s,verifiedTaskId:n,comments:c}=await e.json(),I=(0,a._B)(),N=(0,a.Lv)(),P=(0,a.aj)(),u=await I.collection("users").doc(t).get();if(!u.exists)return o.NextResponse.json({success:!1,error:"User not found"},{status:403});const R=u.data();if(!r||!s||0===s.length||!n)return o.NextResponse.json({success:!1,error:"Missing required fields"},{status:400});const _=I.collection("workRequests").doc(r),d=await I.runTransaction((async e=>{const r=await e.get(_);if(!r.exists)throw new Error("Original document not found");const o=r.data(),a=await I.collection("sites").doc(o.siteId).get();if(!a.exists)throw new Error("Site not found.");const u=a.data(),d=await N.collection("tasks").doc(n).get();if(!d.exists)throw new Error("Verified Task ID not found.");const D={...o.taskData,taskUid:n,taskName:d.data()?.taskName||o.taskName,projectName:u.name},A=(o.revisionNumber||0)+1,p=`${o.documentNumber.split("-REV")[0]}-REV${String(A).padStart(2,"0")}`,l=[];for(const E of s)if(E.filePath&&E.filePath.startsWith("temp/")){const e=`sites/${o.siteId}/work-requests/${p}/${Date.now()}_${E.fileName}`;try{await P.file(E.filePath).move(e),l.push({...E,fileUrl:`https://ttsdoc-cdn.ttthaiii30.workers.dev/${e}`,filePath:e,uploadedAt:(new Date).toISOString(),uploadedBy:t})}catch(m){throw console.error("File move failed",m),new Error("Failed to process file upload.")}}else l.push(E);const M=I.collection("workRequests").doc(),T=i.Ge.PENDING_ACCEPTANCE,O={...o,documentNumber:p,taskData:D,revisionNumber:A,status:T,isLatest:!0,parentWorkRequestId:o.parentWorkRequestId||r.id,createdAt:E.FieldValue.serverTimestamp(),updatedAt:E.FieldValue.serverTimestamp(),files:l,workflow:[...o.workflow,{action:"CREATE_REVISION",status:T,userId:t,userName:R.email,role:R.role,timestamp:(new Date).toISOString(),comments:c||`\u0e2a\u0e23\u0e49\u0e32\u0e07\u0e41\u0e25\u0e30\u0e2a\u0e48\u0e07 Revision ${A}`,files:l}]};return e.set(M,O),e.update(_,{isLatest:!1,status:i.Ge.COMPLETED}),{id:M.id,documentNumber:p}}));return o.NextResponse.json({success:!0,message:"New revision created",newDocumentId:d.id,newDocumentNumber:d.documentNumber},{status:201})}catch(r){return console.error("Revision Error:",r),o.NextResponse.json({success:!1,error:r.message},{status:500})}}s()}catch(c){s(c)}}))},4458:(e,t,r)=>{r.d(t,{$p:()=>n,Ge:()=>I,K$:()=>s,NK:()=>N,c9:()=>i,gf:()=>E,n$:()=>c,oU:()=>a,uc:()=>o});const s={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},o=[s.BIM,s.ME,s.SN,s.SITE_ADMIN,s.ADMIN,s.PM,s.PE,s.OE],a=[s.SITE_ADMIN,s.ADMIN_SITE_2,s.OE,s.PE,s.ADMIN],E=[s.CM,s.ADMIN,s.SITE_ADMIN,s.PM,s.PE,s.OE],i=(s.PM,s.ADMIN,s.SE,s.FM,[s.PE,s.OE,s.ADMIN]),n=[s.PM,s.ADMIN],c=(s.PD,s.SE,s.FM,{PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"}),I={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},N={[c.PENDING_REVIEW]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e2a\u0e2d\u0e1a",[c.PENDING_CM_APPROVAL]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (CM/Approver)",[c.REVISION_REQUIRED]:"\u0e41\u0e01\u0e49\u0e44\u0e02",[c.APPROVED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[c.APPROVED_WITH_COMMENTS]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e44\u0e21\u0e48\u0e41\u0e01\u0e49\u0e44\u0e02)",[c.APPROVED_REVISION_REQUIRED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e15\u0e49\u0e2d\u0e07\u0e41\u0e01\u0e49\u0e44\u0e02)",[c.REJECTED]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[c.PENDING_FINAL_APPROVAL]:"\u0e23\u0e2d SITE \u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e02\u0e31\u0e49\u0e19\u0e2a\u0e38\u0e14\u0e17\u0e49\u0e32\u0e22",[I.DRAFT]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[I.REJECTED_BY_PM]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[I.PENDING_BIM]:"\u0e23\u0e2d BIM \u0e23\u0e31\u0e1a\u0e07\u0e32\u0e19",[I.IN_PROGRESS]:"BIM \u0e01\u0e33\u0e25\u0e31\u0e07\u0e14\u0e33\u0e40\u0e19\u0e34\u0e19\u0e01\u0e32\u0e23",[I.PENDING_ACCEPTANCE]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e23\u0e31\u0e1a (Site)",[I.REVISION_REQUESTED]:"\u0e02\u0e2d\u0e41\u0e01\u0e49\u0e44\u0e02 (WR)",[I.COMPLETED]:"\u0e40\u0e2a\u0e23\u0e47\u0e08\u0e2a\u0e34\u0e49\u0e19"};c.PENDING_REVIEW,c.PENDING_CM_APPROVAL,c.REVISION_REQUIRED,c.APPROVED,c.REJECTED,c.APPROVED_WITH_COMMENTS,c.APPROVED_REVISION_REQUIRED,c.PENDING_FINAL_APPROVAL,I.DRAFT,I.REJECTED_BY_PM,I.PENDING_BIM,I.IN_PROGRESS,I.PENDING_ACCEPTANCE,I.REVISION_REQUESTED,I.COMPLETED},40416:(e,t,r)=>{r.d(t,{CZ:()=>i,Hf:()=>n,iW:()=>E,SI:()=>c,uE:()=>I,Dh:()=>P,aj:()=>u,_B:()=>N,Lv:()=>R});const s=require("firebase-admin"),o=(e,t)=>s.apps.find((t=>t?.name===e))||s.initializeApp(t,e),a=()=>{const e={credential:s.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"};return o("ttsdoc-v2",e)},E=a().firestore(),i=a().auth(),n=a().storage().bucket(),c=a().messaging(),I=(()=>{const e={credential:s.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})};return o("bim-tracking",e)})().firestore(),N=()=>E,P=()=>i,u=()=>n,R=()=>I}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=t.X(0,[9276,5972],(()=>{return e=85346,t(t.s=e);var e}));module.exports=r})();