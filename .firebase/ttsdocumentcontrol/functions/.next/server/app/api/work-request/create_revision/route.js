"use strict";(()=>{var e={};e.id=6398,e.ids=[6398],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},85346:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>I,requestAsyncStorage:()=>c,routeModule:()=>N,serverHooks:()=>P,staticGenerationAsyncStorage:()=>u});var E=r(49303),a=r(88716),i=r(60670),o=r(81050),n=e([o]);o=(n.then?(await n)():n)[0];let N=new E.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/work-request/create_revision/route",pathname:"/api/work-request/create_revision",filename:"route",bundlePath:"app/api/work-request/create_revision/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\work-request\\create_revision\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:c,staticGenerationAsyncStorage:u,serverHooks:P}=N,R="/api/work-request/create_revision/route";function I(){return(0,i.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:u})}s()}catch(e){s(e)}})},81050:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{POST:()=>N,dynamic:()=>c});var E=r(87070),a=r(40416),i=r(72929),o=r(4458),n=e([i]);i=(n.then?(await n)():n)[0];let c="force-dynamic";async function I(e){let t=(e.headers.get("authorization")||"").match(/^Bearer (.+)$/i);if(!t)return null;try{let e=(0,a.Dh)();return(await e.verifyIdToken(t[1])).uid}catch{return null}}async function N(e){let t=await I(e);if(!t)return E.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});try{let{originalDocId:r,uploadedFiles:s,verifiedTaskId:n,comments:I}=await e.json(),N=(0,a._B)(),c=(0,a.Lv)();(0,a.Dh)();let u=await N.collection("users").doc(t).get();if(!u.exists)return E.NextResponse.json({success:!1,error:"User not found"},{status:403});let P=u.data();if(!r||!s||0===s.length||!n)return E.NextResponse.json({success:!1,error:"Missing required fields for revision"},{status:400});let R=N.collection("workRequests").doc(r),_=await N.runTransaction(async e=>{let r=await e.get(R);if(!r.exists)throw Error("Original document not found");let E=r.data(),a=await N.collection("sites").doc(E.siteId).get();if(!a.exists)throw Error(`Site with ID ${E.siteId} not found.`);let u=a.data(),_=await c.collection("tasks").doc(n).get();if(!_.exists)throw Error(`Verified Task ID ${n} not found in BIM Tracking.`);let D=_.data(),d={...E.taskData,taskUid:n,taskName:D?.taskName||E.taskName,projectName:u.name},l=(E.revisionNumber||0)+1,A=E.documentNumber.split("-REV")[0],M=`${A}-REV${String(l).padStart(2,"0")}`,p=s.map(e=>({...e,uploadedAt:new Date().toISOString(),uploadedBy:t})),T=N.collection("workRequests").doc(),O=o.Ge.PENDING_ACCEPTANCE,S={...E,documentNumber:M,taskData:d,revisionNumber:l,status:O,isLatest:!0,parentWorkRequestId:E.parentWorkRequestId||r.id,createdAt:i.FieldValue.serverTimestamp(),updatedAt:i.FieldValue.serverTimestamp(),files:p,workflow:[...E.workflow,{action:"CREATE_REVISION",status:O,userId:t,userName:P.email,role:P.role,timestamp:new Date().toISOString(),comments:I||`สร้างและส่ง Revision ${l}`,files:p}]};return e.set(T,S),e.update(R,{isLatest:!1,status:o.Ge.COMPLETED}),{id:T.id,documentNumber:M}});return E.NextResponse.json({success:!0,message:"New revision created and submitted successfully.",newDocumentId:_.id,newDocumentNumber:_.documentNumber},{status:201})}catch(e){return console.error("Create Work Request Revision Error:",e),E.NextResponse.json({success:!1,error:"Internal Server Error",details:e.message},{status:500})}}s()}catch(e){s(e)}})},4458:(e,t,r)=>{r.d(t,{$p:()=>n,Ge:()=>N,K$:()=>s,NK:()=>c,c9:()=>o,gf:()=>i,n$:()=>I,oU:()=>a,uc:()=>E});let s={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},E=[s.BIM,s.ME,s.SN,s.SITE_ADMIN,s.ADMIN,s.PM,s.PE,s.OE],a=[s.SITE_ADMIN,s.ADMIN_SITE_2,s.OE,s.PE,s.ADMIN],i=[s.CM,s.ADMIN,s.SITE_ADMIN,s.PM,s.PE,s.OE];s.PM,s.ADMIN,s.SE,s.FM;let o=[s.PE,s.OE,s.ADMIN],n=[s.PM,s.ADMIN];s.PD,s.SE,s.FM;let I={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},N={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},c={[I.PENDING_REVIEW]:"รอตรวจสอบ",[I.PENDING_CM_APPROVAL]:"รออนุมัติ (CM/Approver)",[I.REVISION_REQUIRED]:"แก้ไข",[I.APPROVED]:"อนุมัติ",[I.APPROVED_WITH_COMMENTS]:"อนุมัติตามคอมเมนต์ (ไม่แก้ไข)",[I.APPROVED_REVISION_REQUIRED]:"อนุมัติตามคอมเมนต์ (ต้องแก้ไข)",[I.REJECTED]:"ไม่อนุมัติ",[I.PENDING_FINAL_APPROVAL]:"รอ SITE อนุมัติขั้นสุดท้าย",[N.DRAFT]:"รออนุมัติ (PM)",[N.REJECTED_BY_PM]:"ไม่อนุมัติ (PM)",[N.PENDING_BIM]:"รอ BIM รับงาน",[N.IN_PROGRESS]:"BIM กำลังดำเนินการ",[N.PENDING_ACCEPTANCE]:"รอตรวจรับ (Site)",[N.REVISION_REQUESTED]:"ขอแก้ไข (WR)",[N.COMPLETED]:"เสร็จสิ้น"};I.PENDING_REVIEW,I.PENDING_CM_APPROVAL,I.REVISION_REQUIRED,I.APPROVED,I.REJECTED,I.APPROVED_WITH_COMMENTS,I.APPROVED_REVISION_REQUIRED,N.DRAFT,N.REJECTED_BY_PM,N.PENDING_BIM,N.IN_PROGRESS,N.PENDING_ACCEPTANCE,N.REVISION_REQUESTED,N.COMPLETED},40416:(e,t,r)=>{r.d(t,{CZ:()=>o,Hf:()=>n,iW:()=>i,SI:()=>I,uE:()=>N,Dh:()=>u,_B:()=>c,Lv:()=>P});let s=require("firebase-admin"),E=(e,t)=>s.apps.find(t=>t?.name===e)||s.initializeApp(t,e),a=()=>E("ttsdoc-v2",{credential:s.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),i=a().firestore(),o=a().auth(),n=a().storage().bucket(),I=a().messaging(),N=E("bim-tracking",{credential:s.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),c=()=>i,u=()=>o,P=()=>N}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,5972],()=>r(85346));module.exports=s})();