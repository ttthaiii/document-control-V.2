"use strict";(()=>{var e={};e.id=4542,e.ids=[4542],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},79995:(e,t,E)=>{E.a(e,async(e,r)=>{try{E.r(t),E.d(t,{originalPathname:()=>u,patchFetch:()=>I,requestAsyncStorage:()=>R,routeModule:()=>P,serverHooks:()=>_,staticGenerationAsyncStorage:()=>N});var s=E(49303),a=E(88716),i=E(60670),o=E(79133),n=e([o]);o=(n.then?(await n)():n)[0];let P=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/work-request/[id]/update/route",pathname:"/api/work-request/[id]/update",filename:"route",bundlePath:"app/api/work-request/[id]/update/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\work-request\\[id]\\update\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:R,staticGenerationAsyncStorage:N,serverHooks:_}=P,u="/api/work-request/[id]/update/route";function I(){return(0,i.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:N})}r()}catch(e){r(e)}})},79133:(e,t,E)=>{E.a(e,async(e,r)=>{try{E.r(t),E.d(t,{POST:()=>I,dynamic:()=>P});var s=E(87070),a=E(40416),i=E(72929),o=E(4458),n=e([i]);i=(n.then?(await n)():n)[0];let P="force-dynamic";async function I(e,{params:t}){try{let E=e.headers.get("authorization");if(!E?.startsWith("Bearer "))return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let r=E.split("Bearer ")[1],n=(await a.CZ.verifyIdToken(r)).uid,I=await a.iW.collection("users").doc(n).get();if(!I.exists)return s.NextResponse.json({success:!1,error:"User not found"},{status:404});let P=I.data(),R=t.id,{action:N,payload:_}=await e.json(),u=a.iW.collection("workRequests").doc(R),c=await u.get();if(!c.exists)return s.NextResponse.json({success:!1,error:"Document not found"},{status:404});let D=c.data(),A=null,d={},l=!1;switch(N){case"APPROVE_DRAFT":o.$p.includes(P.role)&&D.status===o.Ge.DRAFT&&(l=!0,A=o.Ge.PENDING_BIM);break;case"REJECT_DRAFT":if(o.$p.includes(P.role)&&D.status===o.Ge.DRAFT){if(!_||!_.comments||""===_.comments.trim())return s.NextResponse.json({success:!1,error:"Comment is required when rejecting."},{status:400});l=!0,A=o.Ge.REJECTED_BY_PM}break;case"SUBMIT_WORK":P.role===o.K$.BIM&&D.status===o.Ge.IN_PROGRESS&&(l=!0,A=o.Ge.PENDING_ACCEPTANCE);break;case"REQUEST_REVISION":o.oU.includes(P.role)&&D.status===o.Ge.PENDING_ACCEPTANCE&&(l=!0,A=o.Ge.REVISION_REQUESTED);break;case"COMPLETE":o.oU.includes(P.role)&&D.status===o.Ge.PENDING_ACCEPTANCE&&(l=!0,A=o.Ge.COMPLETED)}if(!l||!A)return console.warn(`Action "${N}" denied for user ${n} (Role: ${P.role}) on doc ${R} (Status: ${D.status})`),s.NextResponse.json({success:!1,error:"Permission denied or invalid action for current status."},{status:403});let M={action:N,status:A,userId:n,userName:P.email,role:P.role,timestamp:new Date().toISOString(),comments:_?.comments||"",files:_?.files||[]};return d.status=A,d.workflow=i.FieldValue.arrayUnion(M),d.updatedAt=i.FieldValue.serverTimestamp(),"SUBMIT_WORK"===N&&_?.files&&Array.isArray(_.files)&&_.files.length>0&&(d.files=i.FieldValue.arrayUnion(..._.files)),await u.update(d),s.NextResponse.json({success:!0,newStatus:A})}catch(E){console.error(`Error updating work request ${t.id}:`,E);let e=E instanceof Error?E.message:"Internal Server Error";return s.NextResponse.json({success:!1,error:e},{status:500})}}r()}catch(e){r(e)}})},4458:(e,t,E)=>{E.d(t,{$p:()=>n,Ge:()=>P,K$:()=>r,NK:()=>R,c9:()=>o,gf:()=>i,n$:()=>I,oU:()=>a,uc:()=>s});let r={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},s=[r.BIM,r.ME,r.SN,r.SITE_ADMIN,r.ADMIN,r.PM,r.PE,r.OE],a=[r.SITE_ADMIN,r.ADMIN_SITE_2,r.OE,r.PE,r.ADMIN],i=[r.CM,r.ADMIN,r.SITE_ADMIN,r.PM,r.PE,r.OE];r.PM,r.ADMIN,r.SE,r.FM;let o=[r.PE,r.OE,r.ADMIN],n=[r.PM,r.ADMIN];r.PD,r.SE,r.FM;let I={PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"},P={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},R={[I.PENDING_REVIEW]:"รอตรวจสอบ",[I.PENDING_CM_APPROVAL]:"รออนุมัติ (CM/Approver)",[I.REVISION_REQUIRED]:"แก้ไข",[I.APPROVED]:"อนุมัติ",[I.APPROVED_WITH_COMMENTS]:"อนุมัติตามคอมเมนต์ (ไม่แก้ไข)",[I.APPROVED_REVISION_REQUIRED]:"อนุมัติตามคอมเมนต์ (ต้องแก้ไข)",[I.REJECTED]:"ไม่อนุมัติ",[I.PENDING_FINAL_APPROVAL]:"รอ SITE อนุมัติขั้นสุดท้าย",[P.DRAFT]:"รออนุมัติ (PM)",[P.REJECTED_BY_PM]:"ไม่อนุมัติ (PM)",[P.PENDING_BIM]:"รอ BIM รับงาน",[P.IN_PROGRESS]:"BIM กำลังดำเนินการ",[P.PENDING_ACCEPTANCE]:"รอตรวจรับ (Site)",[P.REVISION_REQUESTED]:"ขอแก้ไข (WR)",[P.COMPLETED]:"เสร็จสิ้น"};I.PENDING_REVIEW,I.PENDING_CM_APPROVAL,I.REVISION_REQUIRED,I.APPROVED,I.REJECTED,I.APPROVED_WITH_COMMENTS,I.APPROVED_REVISION_REQUIRED,P.DRAFT,P.REJECTED_BY_PM,P.PENDING_BIM,P.IN_PROGRESS,P.PENDING_ACCEPTANCE,P.REVISION_REQUESTED,P.COMPLETED},40416:(e,t,E)=>{E.d(t,{CZ:()=>o,Hf:()=>n,iW:()=>i,SI:()=>I,uE:()=>P,Dh:()=>N,_B:()=>R,Lv:()=>_});let r=require("firebase-admin"),s=(e,t)=>r.apps.find(t=>t?.name===e)||r.initializeApp(t,e),a=()=>s("ttsdoc-v2",{credential:r.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),i=a().firestore(),o=a().auth(),n=a().storage().bucket(),I=a().messaging(),P=s("bim-tracking",{credential:r.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),R=()=>i,N=()=>o,_=()=>P}};var t=require("../../../../../webpack-runtime.js");t.C(e);var E=e=>t(t.s=e),r=t.X(0,[9276,5972],()=>E(79995));module.exports=r})();