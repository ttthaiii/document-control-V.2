"use strict";(()=>{var e={id:4542,ids:[4542]};e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},72929:e=>{e.exports=import("firebase-admin/firestore")},79995:(e,t,r)=>{r.a(e,(async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>D,requestAsyncStorage:()=>N,routeModule:()=>c,serverHooks:()=>u,staticGenerationAsyncStorage:()=>R});var E=r(49303),a=r(88716),o=r(60670),n=r(79133),i=e([n]);n=(i.then?(await i)():i)[0];const P="",c=new E.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/work-request/[id]/update/route",pathname:"/api/work-request/[id]/update",filename:"route",bundlePath:"app/api/work-request/[id]/update/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\work-request\\[id]\\update\\route.ts",nextConfigOutput:P,userland:n}),{requestAsyncStorage:N,staticGenerationAsyncStorage:R,serverHooks:u}=c,_="/api/work-request/[id]/update/route";function D(){return(0,o.patchFetch)({serverHooks:u,staticGenerationAsyncStorage:R})}s()}catch(I){s(I)}}))},79133:(e,t,r)=>{r.a(e,(async(e,s)=>{try{r.r(t),r.d(t,{POST:()=>c,dynamic:()=>P});var E=r(87070),a=r(40416),o=r(72929),n=r(4458),i=e([o]);o=(i.then?(await i)():i)[0];const P="force-dynamic";async function c(e,{params:t}){try{const s=e.headers.get("authorization");if(!s?.startsWith("Bearer "))return E.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});const i=s.split("Bearer ")[1],I=(await a.CZ.verifyIdToken(i)).uid,P=await a.iW.collection("users").doc(I).get();if(!P.exists)return E.NextResponse.json({success:!1,error:"User not found"},{status:404});const c=P.data(),N=t.id,{action:R,payload:u}=await e.json(),_=a.iW.collection("workRequests").doc(N),D=await _.get();if(!D.exists)return E.NextResponse.json({success:!1,error:"Document not found"},{status:404});const A=D.data();let d=null;const p={};let l=!1;switch(R){case"APPROVE_DRAFT":n.$p.includes(c.role)&&A.status===n.Ge.DRAFT&&(l=!0,d=n.Ge.PENDING_BIM);break;case"REJECT_DRAFT":if(n.$p.includes(c.role)&&A.status===n.Ge.DRAFT){if(!u||!u.comments||""===u.comments.trim())return E.NextResponse.json({success:!1,error:"Comment is required when rejecting."},{status:400});l=!0,d=n.Ge.REJECTED_BY_PM}break;case"SUBMIT_WORK":c.role===n.K$.BIM&&A.status===n.Ge.IN_PROGRESS&&(l=!0,d=n.Ge.PENDING_ACCEPTANCE);break;case"REQUEST_REVISION":n.oU.includes(c.role)&&A.status===n.Ge.PENDING_ACCEPTANCE&&(l=!0,d=n.Ge.REVISION_REQUESTED);break;case"COMPLETE":n.oU.includes(c.role)&&A.status===n.Ge.PENDING_ACCEPTANCE&&(l=!0,d=n.Ge.COMPLETED)}if(!l||!d)return E.NextResponse.json({success:!1,error:"Permission denied or invalid action."},{status:403});let M=[];if(u?.files&&Array.isArray(u.files)&&u.files.length>0){const e="https://ttsdoc-cdn.ttthaiii30.workers.dev";for(const t of u.files)if(t.filePath&&t.filePath.startsWith("temp/")){const s=`sites/${A.siteId}/work-requests/${A.documentNumber}/${Date.now()}_${t.fileName}`;try{await a.Hf.file(t.filePath).move(s),M.push({...t,fileUrl:`${e}/${s}`,filePath:s,uploadedAt:(new Date).toISOString(),uploadedBy:I})}catch(r){console.error(`Failed to move file ${t.filePath}:`,r)}}else M.push(t)}const T={action:R,status:d,userId:I,userName:c.email,role:c.role,timestamp:(new Date).toISOString(),comments:u?.comments||"",files:M};return p.status=d,p.workflow=o.FieldValue.arrayUnion(T),p.updatedAt=o.FieldValue.serverTimestamp(),"SUBMIT_WORK"===R&&M.length>0&&(p.files=o.FieldValue.arrayUnion(...M)),await _.update(p),E.NextResponse.json({success:!0,newStatus:d})}catch(s){console.error(`Error updating work request ${t.id}:`,s);const e=s instanceof Error?s.message:"Internal Server Error";return E.NextResponse.json({success:!1,error:e},{status:500})}}s()}catch(I){s(I)}}))},4458:(e,t,r)=>{r.d(t,{$p:()=>i,Ge:()=>P,K$:()=>s,NK:()=>c,c9:()=>n,gf:()=>o,n$:()=>I,oU:()=>a,uc:()=>E});const s={ADMIN:"Admin",BIM:"BIM",SITE_ADMIN:"Site Admin",CM:"CM",ME:"ME",SN:"SN",OE:"OE",PE:"PE",PM:"PM",PD:"PD",SE:"SE",FM:"FM",ADMIN_SITE_2:"Adminsite2"},E=[s.BIM,s.ME,s.SN,s.SITE_ADMIN,s.ADMIN,s.PM,s.PE,s.OE],a=[s.SITE_ADMIN,s.ADMIN_SITE_2,s.OE,s.PE,s.ADMIN],o=[s.CM,s.ADMIN,s.SITE_ADMIN,s.PM,s.PE,s.OE],n=(s.PM,s.ADMIN,s.SE,s.FM,[s.PE,s.OE,s.ADMIN]),i=[s.PM,s.ADMIN],I=(s.PD,s.SE,s.FM,{PENDING_REVIEW:"PENDING_REVIEW",PENDING_CM_APPROVAL:"PENDING_CM_APPROVAL",REVISION_REQUIRED:"REVISION_REQUIRED",APPROVED:"APPROVED",APPROVED_WITH_COMMENTS:"APPROVED_WITH_COMMENTS",APPROVED_REVISION_REQUIRED:"APPROVED_REVISION_REQUIRED",REJECTED:"REJECTED",PENDING_FINAL_APPROVAL:"PENDING_FINAL_APPROVAL"}),P={DRAFT:"DRAFT",REJECTED_BY_PM:"REJECTED_BY_PM",PENDING_BIM:"PENDING_BIM",IN_PROGRESS:"IN_PROGRESS",PENDING_ACCEPTANCE:"PENDING_ACCEPTANCE",REVISION_REQUESTED:"REVISION_REQUESTED",COMPLETED:"COMPLETED"},c={[I.PENDING_REVIEW]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e2a\u0e2d\u0e1a",[I.PENDING_CM_APPROVAL]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (CM/Approver)",[I.REVISION_REQUIRED]:"\u0e41\u0e01\u0e49\u0e44\u0e02",[I.APPROVED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[I.APPROVED_WITH_COMMENTS]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e44\u0e21\u0e48\u0e41\u0e01\u0e49\u0e44\u0e02)",[I.APPROVED_REVISION_REQUIRED]:"\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e15\u0e32\u0e21\u0e04\u0e2d\u0e21\u0e40\u0e21\u0e19\u0e15\u0e4c (\u0e15\u0e49\u0e2d\u0e07\u0e41\u0e01\u0e49\u0e44\u0e02)",[I.REJECTED]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34",[I.PENDING_FINAL_APPROVAL]:"\u0e23\u0e2d SITE \u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34\u0e02\u0e31\u0e49\u0e19\u0e2a\u0e38\u0e14\u0e17\u0e49\u0e32\u0e22",[P.DRAFT]:"\u0e23\u0e2d\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[P.REJECTED_BY_PM]:"\u0e44\u0e21\u0e48\u0e2d\u0e19\u0e38\u0e21\u0e31\u0e15\u0e34 (PM)",[P.PENDING_BIM]:"\u0e23\u0e2d BIM \u0e23\u0e31\u0e1a\u0e07\u0e32\u0e19",[P.IN_PROGRESS]:"BIM \u0e01\u0e33\u0e25\u0e31\u0e07\u0e14\u0e33\u0e40\u0e19\u0e34\u0e19\u0e01\u0e32\u0e23",[P.PENDING_ACCEPTANCE]:"\u0e23\u0e2d\u0e15\u0e23\u0e27\u0e08\u0e23\u0e31\u0e1a (Site)",[P.REVISION_REQUESTED]:"\u0e02\u0e2d\u0e41\u0e01\u0e49\u0e44\u0e02 (WR)",[P.COMPLETED]:"\u0e40\u0e2a\u0e23\u0e47\u0e08\u0e2a\u0e34\u0e49\u0e19"};I.PENDING_REVIEW,I.PENDING_CM_APPROVAL,I.REVISION_REQUIRED,I.APPROVED,I.REJECTED,I.APPROVED_WITH_COMMENTS,I.APPROVED_REVISION_REQUIRED,I.PENDING_FINAL_APPROVAL,P.DRAFT,P.REJECTED_BY_PM,P.PENDING_BIM,P.IN_PROGRESS,P.PENDING_ACCEPTANCE,P.REVISION_REQUESTED,P.COMPLETED},40416:(e,t,r)=>{r.d(t,{CZ:()=>n,Hf:()=>i,iW:()=>o,SI:()=>I,uE:()=>P,Dh:()=>N,aj:()=>R,_B:()=>c,Lv:()=>u});const s=require("firebase-admin"),E=(e,t)=>s.apps.find((t=>t?.name===e))||s.initializeApp(t,e),a=()=>{const e={credential:s.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"};return E("ttsdoc-v2",e)},o=a().firestore(),n=a().auth(),i=a().storage().bucket(),I=a().messaging(),P=(()=>{const e={credential:s.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})};return E("bim-tracking",e)})().firestore(),c=()=>o,N=()=>n,R=()=>i,u=()=>P}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=t.X(0,[9276,5972],(()=>{return e=79995,t(t.s=e);var e}));module.exports=r})();