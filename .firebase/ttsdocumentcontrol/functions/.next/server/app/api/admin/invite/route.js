"use strict";(()=>{var e={id:2777,ids:[2777]};e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72929:e=>{e.exports=import("firebase-admin/firestore")},21364:(e,t,r)=>{r.a(e,(async(e,n)=>{try{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>g,requestAsyncStorage:()=>u,routeModule:()=>p,serverHooks:()=>v,staticGenerationAsyncStorage:()=>m});var i=r(49303),o=r(88716),a=r(60670),s=r(88910),c=e([s]);s=(c.then?(await c)():c)[0];const l="",p=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/invite/route",pathname:"/api/admin/invite",filename:"route",bundlePath:"app/api/admin/invite/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\admin\\invite\\route.ts",nextConfigOutput:l,userland:s}),{requestAsyncStorage:u,staticGenerationAsyncStorage:m,serverHooks:v}=p,x="/api/admin/invite/route";function g(){return(0,a.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:m})}n()}catch(d){n(d)}}))},88910:(e,t,r)=>{r.a(e,(async(e,n)=>{try{r.r(t),r.d(t,{POST:()=>p,dynamic:()=>l});var i=r(87070),o=r(45758),a=r(68561),s=r(40416),c=e([o]);o=(c.then?(await c)():c)[0];const l="force-dynamic";async function p(e){try{const r=e.headers.get("authorization");if(!r?.startsWith("Bearer "))return i.NextResponse.json({error:"Unauthorized"},{status:401});const n=r.split("Bearer ")[1],c=await s.CZ.verifyIdToken(n),d=await s.iW.collection("users").doc(c.uid).get(),l=d.data()?.name||d.data()?.email||"Admin",{email:p,role:u,sites:m,name:v,employeeId:x}=await e.json();if(!p||!u||!m||!v||!x)return i.NextResponse.json({error:"\u0e01\u0e23\u0e38\u0e13\u0e32\u0e01\u0e23\u0e2d\u0e01\u0e02\u0e49\u0e2d\u0e21\u0e39\u0e25\u0e43\u0e2b\u0e49\u0e04\u0e23\u0e1a\u0e16\u0e49\u0e27\u0e19 (\u0e2d\u0e35\u0e40\u0e21\u0e25, \u0e0a\u0e37\u0e48\u0e2d, \u0e23\u0e2b\u0e31\u0e2a\u0e1e\u0e19\u0e31\u0e01\u0e07\u0e32\u0e19, \u0e15\u0e33\u0e41\u0e2b\u0e19\u0e48\u0e07, \u0e42\u0e04\u0e23\u0e07\u0e01\u0e32\u0e23)"},{status:400});const g=s.iW.collection("users");if(!(await g.where("email","==",p).limit(1).get()).empty)return i.NextResponse.json({error:`\u0e2d\u0e35\u0e40\u0e21\u0e25 ${p} \u0e21\u0e35\u0e2d\u0e22\u0e39\u0e48\u0e43\u0e19\u0e23\u0e30\u0e1a\u0e1a\u0e41\u0e25\u0e49\u0e27`},{status:409});if(!(await g.where("employeeId","==",x).limit(1).get()).empty)return i.NextResponse.json({error:`\u0e23\u0e2b\u0e31\u0e2a\u0e1e\u0e19\u0e31\u0e01\u0e07\u0e32\u0e19 ${x} \u0e21\u0e35\u0e2d\u0e22\u0e39\u0e48\u0e43\u0e19\u0e23\u0e30\u0e1a\u0e1a\u0e41\u0e25\u0e49\u0e27`},{status:409});const y=await o.e.createInvitation({email:p,role:u,sites:m,name:v,employeeId:x});try{await(0,a.t)(p,y.invitationUrl,l,{name:v,role:u})}catch(t){return console.error("Failed to send email:",t),i.NextResponse.json({...y,warning:"\u0e2a\u0e23\u0e49\u0e32\u0e07\u0e04\u0e33\u0e40\u0e0a\u0e34\u0e0d\u0e2a\u0e33\u0e40\u0e23\u0e47\u0e08 \u0e41\u0e15\u0e48\u0e23\u0e30\u0e1a\u0e1a\u0e2a\u0e48\u0e07\u0e2d\u0e35\u0e40\u0e21\u0e25\u0e02\u0e31\u0e14\u0e02\u0e49\u0e2d\u0e07 \u0e01\u0e23\u0e38\u0e13\u0e32\u0e2a\u0e48\u0e07\u0e25\u0e34\u0e07\u0e01\u0e4c\u0e14\u0e49\u0e27\u0e22\u0e15\u0e19\u0e40\u0e2d\u0e07"})}return i.NextResponse.json({...y,success:!0})}catch(r){return console.error("Error in invite API:",r),i.NextResponse.json({error:"Failed to create invitation"},{status:500})}}n()}catch(d){n(d)}}))},45758:(e,t,r)=>{r.a(e,(async(e,n)=>{try{r.d(t,{e:()=>c});var i=r(40416),o=r(84770),a=r(72929),s=e([a]);a=(s.then?(await s)():s)[0];class c{static async createInvitation(e){try{const t=(0,o.randomBytes)(32).toString("hex"),r=new Date(Date.now()+6048e5);await i.iW.collection("invitations").doc(t).set({...e,status:"PENDING",createdAt:new Date,expiresAt:r,createdByAdmin:!0});return{success:!0,token:t,invitationUrl:`${"https://ttsdocumentcontrol.web.app"}/accept-invitation?token=${t}`,expiresAt:r}}catch(t){throw console.error("Error creating invitation:",t),new Error("Failed to create invitation")}}static async acceptInvitation(e,t){try{const r=await i.iW.collection("invitations").doc(e).get();if(!r.exists)throw new Error("Invalid or expired invitation token.");const n=r.data();if("PENDING"!==n.status)throw new Error("Invitation has already been used or expired.");const o=await i.CZ.createUser({email:n.email,password:t,emailVerified:!0,displayName:n.name}),s=Array.isArray(n.sites)?n.sites:[n.sites].filter(Boolean);if(await i.iW.collection("users").doc(o.uid).set({email:n.email,name:n.name||"",employeeId:n.employeeId||"",role:n.role,sites:s,status:"ACTIVE",createdFromInvitation:!0,acceptedAt:new Date}),s.length>0){const e=s.map((e=>i.iW.collection("sites").doc(e).update({members:a.FieldValue.arrayUnion(o.uid)}).catch((t=>{console.error(`Warning: Failed to add user to site ${e}`,t)}))));await Promise.all(e)}return await i.iW.collection("invitations").doc(e).update({status:"ACCEPTED",acceptedAt:new Date,acceptedBy:o.uid}),{success:!0,userId:o.uid,message:"Account created successfully! You can now login."}}catch(r){throw console.error("Error accepting invitation:",r),r}}static async getInvitation(e){try{const t=await i.iW.collection("invitations").doc(e).get();if(!t.exists)return{success:!1,error:"Invalid invitation"};const r=t.data();return{success:!0,invitation:{email:r.email,name:r.name,role:r.role,status:r.status,expiresAt:r.expiresAt.toDate()}}}catch(t){return console.error("Error getting invitation:",t),{success:!1,error:"Failed to get invitation"}}}}n()}catch(c){n(c)}}))},40416:(e,t,r)=>{r.d(t,{CZ:()=>s,Hf:()=>c,iW:()=>a,SI:()=>d,uE:()=>l,Dh:()=>u,aj:()=>m,_B:()=>p,Lv:()=>v});const n=require("firebase-admin"),i=(e,t)=>n.apps.find((t=>t?.name===e))||n.initializeApp(t,e),o=()=>{const e={credential:n.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"};return i("ttsdoc-v2",e)},a=o().firestore(),s=o().auth(),c=o().storage().bucket(),d=o().messaging(),l=(()=>{const e={credential:n.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})};return i("bim-tracking",e)})().firestore(),p=()=>a,u=()=>s,m=()=>c,v=()=>l},68561:(e,t,r)=>{r.d(t,{t:()=>i});const n=r(55245).createTransport({host:process.env.SMTP_HOST,port:parseInt(process.env.SMTP_PORT||"587"),secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}});async function i(e,t,r,i){const o="#f97316",a=`\n    <div style="font-family: 'Sarabun', sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">\n      <div style="background-color: ${o}; padding: 20px; text-align: center;">\n        <h2 style="color: white; margin: 0; font-size: 20px;">\u0e22\u0e34\u0e19\u0e14\u0e35\u0e15\u0e49\u0e2d\u0e19\u0e23\u0e31\u0e1a\u0e2a\u0e39\u0e48\u0e23\u0e30\u0e1a\u0e1a TTS Document Control</h2>\n      </div>\n      \n      <div style="padding: 30px; background-color: #ffffff;">\n        <p style="font-size: 16px; color: #374151;">\u0e40\u0e23\u0e35\u0e22\u0e19 \u0e04\u0e38\u0e13 <strong>${i.name}</strong>,</p>\n        \n        <p style="color: #4b5563; line-height: 1.6;">\n          \u0e04\u0e38\u0e13\u0e44\u0e14\u0e49\u0e23\u0e31\u0e1a\u0e40\u0e0a\u0e34\u0e0d\u0e43\u0e2b\u0e49\u0e40\u0e02\u0e49\u0e32\u0e23\u0e48\u0e27\u0e21\u0e23\u0e30\u0e1a\u0e1a\u0e1a\u0e23\u0e34\u0e2b\u0e32\u0e23\u0e08\u0e31\u0e14\u0e01\u0e32\u0e23\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e20\u0e32\u0e22\u0e43\u0e19\u0e42\u0e04\u0e23\u0e07\u0e01\u0e32\u0e23 (TTS Document Control)\n        </p>\n        \n        <div style="background-color: #f3f4f6; padding: 15px; border-radius: 6px; margin: 20px 0;">\n          <table style="width: 100%;">\n            <tr>\n              <td style="color: #6b7280; width: 100px;">\u0e15\u0e33\u0e41\u0e2b\u0e19\u0e48\u0e07:</td>\n              <td style="font-weight: bold; color: #111827;">${i.role}</td>\n            </tr>\n          </table>\n        </div>\n\n        <div style="text-align: center; margin: 30px 0;">\n          <a href="${t}" style="background-color: ${o}; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; font-weight: bold; display: inline-block;">\n            \u0e15\u0e31\u0e49\u0e07\u0e23\u0e2b\u0e31\u0e2a\u0e1c\u0e48\u0e32\u0e19\u0e41\u0e25\u0e30\u0e40\u0e23\u0e34\u0e48\u0e21\u0e43\u0e0a\u0e49\u0e07\u0e32\u0e19\n          </a>\n        </div>\n        \n        <p style="font-size: 14px; color: #6b7280; margin-top: 20px;">\n          \u0e2b\u0e32\u0e01\u0e1b\u0e38\u0e48\u0e21\u0e01\u0e14\u0e44\u0e21\u0e48\u0e44\u0e14\u0e49 \u0e2a\u0e32\u0e21\u0e32\u0e23\u0e16\u0e04\u0e25\u0e34\u0e01\u0e25\u0e34\u0e07\u0e01\u0e4c\u0e14\u0e49\u0e32\u0e19\u0e25\u0e48\u0e32\u0e07:<br>\n          <a href="${t}" style="color: ${o};">${t}</a>\n        </p>\n      </div>\n      \n      <div style="background-color: #f9fafb; padding: 15px; text-align: center; font-size: 12px; color: #9ca3af;">\n        \xa9 TTS Engineering - Automated System\n      </div>\n    </div>\n  `;await n.sendMail({from:process.env.SMTP_FROM,to:e,subject:"\u0e41\u0e08\u0e49\u0e07\u0e40\u0e0a\u0e34\u0e0d\u0e40\u0e02\u0e49\u0e32\u0e23\u0e48\u0e27\u0e21\u0e43\u0e0a\u0e49\u0e07\u0e32\u0e19\u0e23\u0e30\u0e1a\u0e1a\u0e1a\u0e23\u0e34\u0e2b\u0e32\u0e23\u0e08\u0e31\u0e14\u0e01\u0e32\u0e23\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e20\u0e32\u0e22\u0e43\u0e19\u0e42\u0e04\u0e23\u0e07\u0e01\u0e32\u0e23 (TTS Document Control)",html:a})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=t.X(0,[9276,5972,5245],(()=>{return e=21364,t(t.s=e);var e}));module.exports=r})();