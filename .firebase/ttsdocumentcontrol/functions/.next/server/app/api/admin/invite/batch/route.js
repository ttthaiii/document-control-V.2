"use strict";(()=>{var e={};e.id=5202,e.ids=[5202],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72929:e=>{e.exports=import("firebase-admin/firestore")},87659:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>l,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>u});var a=r(49303),o=r(88716),s=r(60670),n=r(90319),c=e([n]);n=(c.then?(await c)():c)[0];let d=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/invite/batch/route",pathname:"/api/admin/invite/batch",filename:"route",bundlePath:"app/api/admin/invite/batch/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\admin\\invite\\batch\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:u,serverHooks:m}=d,v="/api/admin/invite/batch/route";function l(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:u})}i()}catch(e){i(e)}})},90319:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.r(t),r.d(t,{POST:()=>l,dynamic:()=>d});var a=r(87070),o=r(45758),s=r(68561),n=r(40416),c=e([o]);o=(c.then?(await c)():c)[0];let d="force-dynamic";async function l(e){try{let t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return a.NextResponse.json({error:"Unauthorized"},{status:401});let r=t.split("Bearer ")[1],i=await n.CZ.verifyIdToken(r),c=await n.iW.collection("users").doc(i.uid).get(),l=c.data()?.name||"Admin",{users:d,sites:p}=await e.json();if(!Array.isArray(d)||0===d.length||!Array.isArray(p))return a.NextResponse.json({error:"Invalid data format"},{status:400});let u={success:0,failed:0,details:[]},m=n.iW.collection("users");for(let e of d)try{if(!e.email||!e.name||!e.employeeId||!e.role)throw Error(`ข้อมูลไม่ครบ: ${e.email||"Unknown"}`);if(!(await m.where("email","==",e.email).limit(1).get()).empty)throw Error(`อีเมล ${e.email} มีอยู่แล้ว`);if(!(await m.where("employeeId","==",e.employeeId).limit(1).get()).empty)throw Error(`รหัสพนักงาน ${e.employeeId} มีอยู่แล้ว`);let t=await o.e.createInvitation({email:e.email,name:e.name,employeeId:e.employeeId,role:e.role,sites:p});await (0,s.t)(e.email,t.invitationUrl,l,{name:e.name,role:e.role}),u.success++,u.details.push({email:e.email,status:"success"})}catch(t){console.error(`Failed to invite ${e.email}:`,t),u.failed++,u.details.push({email:e.email,status:"error",reason:t.message})}return a.NextResponse.json({success:!0,summary:u})}catch(e){return console.error("Batch invite error:",e),a.NextResponse.json({error:e.message},{status:500})}}i()}catch(e){i(e)}})},45758:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.d(t,{e:()=>c});var a=r(40416),o=r(84770),s=r(72929),n=e([s]);s=(n.then?(await n)():n)[0];class c{static async createInvitation(e){try{let t=(0,o.randomBytes)(32).toString("hex"),r=new Date(Date.now()+6048e5);await a.iW.collection("invitations").doc(t).set({...e,status:"PENDING",createdAt:new Date,expiresAt:r,createdByAdmin:!0});let i=`http://localhost:3000/accept-invitation?token=${t}`;return{success:!0,token:t,invitationUrl:i,expiresAt:r}}catch(e){throw console.error("Error creating invitation:",e),Error("Failed to create invitation")}}static async acceptInvitation(e,t){try{let r=await a.iW.collection("invitations").doc(e).get();if(!r.exists)throw Error("Invalid or expired invitation token.");let i=r.data();if("PENDING"!==i.status)throw Error("Invitation has already been used or expired.");let o=await a.CZ.createUser({email:i.email,password:t,emailVerified:!0,displayName:i.name}),n=Array.isArray(i.sites)?i.sites:[i.sites].filter(Boolean);if(await a.iW.collection("users").doc(o.uid).set({email:i.email,name:i.name||"",employeeId:i.employeeId||"",role:i.role,sites:n,status:"ACTIVE",createdFromInvitation:!0,acceptedAt:new Date}),n.length>0){let e=n.map(e=>a.iW.collection("sites").doc(e).update({members:s.FieldValue.arrayUnion(o.uid)}).catch(t=>{console.error(`Warning: Failed to add user to site ${e}`,t)}));await Promise.all(e)}return await a.iW.collection("invitations").doc(e).update({status:"ACCEPTED",acceptedAt:new Date,acceptedBy:o.uid}),{success:!0,userId:o.uid,message:"Account created successfully! You can now login."}}catch(e){throw console.error("Error accepting invitation:",e),e}}static async getInvitation(e){try{let t=await a.iW.collection("invitations").doc(e).get();if(!t.exists)return{success:!1,error:"Invalid invitation"};let r=t.data();return{success:!0,invitation:{email:r.email,name:r.name,role:r.role,status:r.status,expiresAt:r.expiresAt.toDate()}}}catch(e){return console.error("Error getting invitation:",e),{success:!1,error:"Failed to get invitation"}}}}i()}catch(e){i(e)}})},40416:(e,t,r)=>{r.d(t,{CZ:()=>n,Hf:()=>c,iW:()=>s,SI:()=>l,uE:()=>d,Dh:()=>u,_B:()=>p,Lv:()=>m});let i=require("firebase-admin"),a=(e,t)=>i.apps.find(t=>t?.name===e)||i.initializeApp(t,e),o=()=>a("ttsdoc-v2",{credential:i.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"}),s=o().firestore(),n=o().auth(),c=o().storage().bucket(),l=o().messaging(),d=a("bim-tracking",{credential:i.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})}).firestore(),p=()=>s,u=()=>n,m=()=>d},68561:(e,t,r)=>{r.d(t,{t:()=>a});let i=r(55245).createTransport({host:process.env.SMTP_HOST,port:parseInt(process.env.SMTP_PORT||"587"),secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}});async function a(e,t,r,a){let o="#f97316",s=`
    <div style="font-family: 'Sarabun', sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
      <div style="background-color: ${o}; padding: 20px; text-align: center;">
        <h2 style="color: white; margin: 0; font-size: 20px;">ยินดีต้อนรับสู่ระบบ TTS Document Control</h2>
      </div>
      
      <div style="padding: 30px; background-color: #ffffff;">
        <p style="font-size: 16px; color: #374151;">เรียน คุณ <strong>${a.name}</strong>,</p>
        
        <p style="color: #4b5563; line-height: 1.6;">
          คุณได้รับเชิญให้เข้าร่วมระบบบริหารจัดการเอกสารภายในโครงการ (TTS Document Control)
        </p>
        
        <div style="background-color: #f3f4f6; padding: 15px; border-radius: 6px; margin: 20px 0;">
          <table style="width: 100%;">
            <tr>
              <td style="color: #6b7280; width: 100px;">ตำแหน่ง:</td>
              <td style="font-weight: bold; color: #111827;">${a.role}</td>
            </tr>
          </table>
        </div>

        <div style="text-align: center; margin: 30px 0;">
          <a href="${t}" style="background-color: ${o}; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; font-weight: bold; display: inline-block;">
            ตั้งรหัสผ่านและเริ่มใช้งาน
          </a>
        </div>
        
        <p style="font-size: 14px; color: #6b7280; margin-top: 20px;">
          หากปุ่มกดไม่ได้ สามารถคลิกลิงก์ด้านล่าง:<br>
          <a href="${t}" style="color: ${o};">${t}</a>
        </p>
      </div>
      
      <div style="background-color: #f9fafb; padding: 15px; text-align: center; font-size: 12px; color: #9ca3af;">
        \xa9 TTS Engineering - Automated System
      </div>
    </div>
  `;await i.sendMail({from:process.env.SMTP_FROM,to:e,subject:"แจ้งเชิญเข้าร่วมใช้งานระบบบริหารจัดการเอกสารภายในโครงการ (TTS Document Control)",html:s})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[9276,5972,5245],()=>r(87659));module.exports=i})();