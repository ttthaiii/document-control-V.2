"use strict";(()=>{var e={id:5202,ids:[5202]};e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72929:e=>{e.exports=import("firebase-admin/firestore")},87659:(e,t,r)=>{r.a(e,(async(e,i)=>{try{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>u,routeModule:()=>p,serverHooks:()=>v,staticGenerationAsyncStorage:()=>m});var n=r(49303),a=r(88716),o=r(60670),s=r(90319),c=e([s]);s=(c.then?(await c)():c)[0];const d="",p=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/invite/batch/route",pathname:"/api/admin/invite/batch",filename:"route",bundlePath:"app/api/admin/invite/batch/route"},resolvedPagePath:"D:\\ttsdoc-v2\\src\\app\\api\\admin\\invite\\batch\\route.ts",nextConfigOutput:d,userland:s}),{requestAsyncStorage:u,staticGenerationAsyncStorage:m,serverHooks:v}=p,h="/api/admin/invite/batch/route";function y(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:m})}i()}catch(l){i(l)}}))},90319:(e,t,r)=>{r.a(e,(async(e,i)=>{try{r.r(t),r.d(t,{POST:()=>p,dynamic:()=>d});var n=r(87070),a=r(45758),o=r(68561),s=r(40416),c=e([a]);a=(c.then?(await c)():c)[0];const d="force-dynamic";async function p(e){try{const r=e.headers.get("authorization");if(!r?.startsWith("Bearer "))return n.NextResponse.json({error:"Unauthorized"},{status:401});const i=r.split("Bearer ")[1],c=await s.CZ.verifyIdToken(i),l=await s.iW.collection("users").doc(c.uid).get(),d=l.data()?.name||"Admin",{users:p,sites:u}=await e.json();if(!Array.isArray(p)||0===p.length||!Array.isArray(u))return n.NextResponse.json({error:"Invalid data format"},{status:400});const m={success:0,failed:0,details:[]},v=s.iW.collection("users");for(const e of p)try{if(!e.email||!e.name||!e.employeeId||!e.role)throw new Error(`\u0e02\u0e49\u0e2d\u0e21\u0e39\u0e25\u0e44\u0e21\u0e48\u0e04\u0e23\u0e1a: ${e.email||"Unknown"}`);if(!(await v.where("email","==",e.email).limit(1).get()).empty)throw new Error(`\u0e2d\u0e35\u0e40\u0e21\u0e25 ${e.email} \u0e21\u0e35\u0e2d\u0e22\u0e39\u0e48\u0e41\u0e25\u0e49\u0e27`);if(!(await v.where("employeeId","==",e.employeeId).limit(1).get()).empty)throw new Error(`\u0e23\u0e2b\u0e31\u0e2a\u0e1e\u0e19\u0e31\u0e01\u0e07\u0e32\u0e19 ${e.employeeId} \u0e21\u0e35\u0e2d\u0e22\u0e39\u0e48\u0e41\u0e25\u0e49\u0e27`);const t=await a.e.createInvitation({email:e.email,name:e.name,employeeId:e.employeeId,role:e.role,sites:u});await(0,o.t)(e.email,t.invitationUrl,d,{name:e.name,role:e.role}),m.success++,m.details.push({email:e.email,status:"success"})}catch(t){console.error(`Failed to invite ${e.email}:`,t),m.failed++,m.details.push({email:e.email,status:"error",reason:t.message})}return n.NextResponse.json({success:!0,summary:m})}catch(r){return console.error("Batch invite error:",r),n.NextResponse.json({error:r.message},{status:500})}}i()}catch(l){i(l)}}))},45758:(e,t,r)=>{r.a(e,(async(e,i)=>{try{r.d(t,{e:()=>c});var n=r(40416),a=r(84770),o=r(72929),s=e([o]);o=(s.then?(await s)():s)[0];class c{static async createInvitation(e){try{const t=(0,a.randomBytes)(32).toString("hex"),r=new Date(Date.now()+6048e5);await n.iW.collection("invitations").doc(t).set({...e,status:"PENDING",createdAt:new Date,expiresAt:r,createdByAdmin:!0});return{success:!0,token:t,invitationUrl:`${"https://ttsdocumentcontrol.web.app"}/accept-invitation?token=${t}`,expiresAt:r}}catch(t){throw console.error("Error creating invitation:",t),new Error("Failed to create invitation")}}static async acceptInvitation(e,t){try{const r=await n.iW.collection("invitations").doc(e).get();if(!r.exists)throw new Error("Invalid or expired invitation token.");const i=r.data();if("PENDING"!==i.status)throw new Error("Invitation has already been used or expired.");const a=await n.CZ.createUser({email:i.email,password:t,emailVerified:!0,displayName:i.name}),s=Array.isArray(i.sites)?i.sites:[i.sites].filter(Boolean);if(await n.iW.collection("users").doc(a.uid).set({email:i.email,name:i.name||"",employeeId:i.employeeId||"",role:i.role,sites:s,status:"ACTIVE",createdFromInvitation:!0,acceptedAt:new Date}),s.length>0){const e=s.map((e=>n.iW.collection("sites").doc(e).update({members:o.FieldValue.arrayUnion(a.uid)}).catch((t=>{console.error(`Warning: Failed to add user to site ${e}`,t)}))));await Promise.all(e)}return await n.iW.collection("invitations").doc(e).update({status:"ACCEPTED",acceptedAt:new Date,acceptedBy:a.uid}),{success:!0,userId:a.uid,message:"Account created successfully! You can now login."}}catch(r){throw console.error("Error accepting invitation:",r),r}}static async getInvitation(e){try{const t=await n.iW.collection("invitations").doc(e).get();if(!t.exists)return{success:!1,error:"Invalid invitation"};const r=t.data();return{success:!0,invitation:{email:r.email,name:r.name,role:r.role,status:r.status,expiresAt:r.expiresAt.toDate()}}}catch(t){return console.error("Error getting invitation:",t),{success:!1,error:"Failed to get invitation"}}}}i()}catch(c){i(c)}}))},40416:(e,t,r)=>{r.d(t,{CZ:()=>s,Hf:()=>c,iW:()=>o,SI:()=>l,uE:()=>d,Dh:()=>u,aj:()=>m,_B:()=>p,Lv:()=>v});const i=require("firebase-admin"),n=(e,t)=>i.apps.find((t=>t?.name===e))||i.initializeApp(t,e),a=()=>{const e={credential:i.credential.cert({projectId:process.env.TTSDOC_PROJECT_ID,clientEmail:process.env.TTSDOC_CLIENT_EMAIL,privateKey:process.env.TTSDOC_PRIVATE_KEY?.replace(/\\n/g,"\n")}),storageBucket:"ttsdocumentcontrol.firebasestorage.app"};return n("ttsdoc-v2",e)},o=a().firestore(),s=a().auth(),c=a().storage().bucket(),l=a().messaging(),d=(()=>{const e={credential:i.credential.cert({projectId:process.env.BIM_TRACKING_PROJECT_ID,clientEmail:process.env.BIM_TRACKING_CLIENT_EMAIL,privateKey:process.env.BIM_TRACKING_PRIVATE_KEY?.replace(/\\n/g,"\n")})};return n("bim-tracking",e)})().firestore(),p=()=>o,u=()=>s,m=()=>c,v=()=>d},68561:(e,t,r)=>{r.d(t,{t:()=>n});const i=r(55245).createTransport({host:process.env.SMTP_HOST,port:parseInt(process.env.SMTP_PORT||"587"),secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}});async function n(e,t,r,n){const a="#f97316",o=`\n    <div style="font-family: 'Sarabun', sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">\n      <div style="background-color: ${a}; padding: 20px; text-align: center;">\n        <h2 style="color: white; margin: 0; font-size: 20px;">\u0e22\u0e34\u0e19\u0e14\u0e35\u0e15\u0e49\u0e2d\u0e19\u0e23\u0e31\u0e1a\u0e2a\u0e39\u0e48\u0e23\u0e30\u0e1a\u0e1a TTS Document Control</h2>\n      </div>\n      \n      <div style="padding: 30px; background-color: #ffffff;">\n        <p style="font-size: 16px; color: #374151;">\u0e40\u0e23\u0e35\u0e22\u0e19 \u0e04\u0e38\u0e13 <strong>${n.name}</strong>,</p>\n        \n        <p style="color: #4b5563; line-height: 1.6;">\n          \u0e04\u0e38\u0e13\u0e44\u0e14\u0e49\u0e23\u0e31\u0e1a\u0e40\u0e0a\u0e34\u0e0d\u0e43\u0e2b\u0e49\u0e40\u0e02\u0e49\u0e32\u0e23\u0e48\u0e27\u0e21\u0e23\u0e30\u0e1a\u0e1a\u0e1a\u0e23\u0e34\u0e2b\u0e32\u0e23\u0e08\u0e31\u0e14\u0e01\u0e32\u0e23\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e20\u0e32\u0e22\u0e43\u0e19\u0e42\u0e04\u0e23\u0e07\u0e01\u0e32\u0e23 (TTS Document Control)\n        </p>\n        \n        <div style="background-color: #f3f4f6; padding: 15px; border-radius: 6px; margin: 20px 0;">\n          <table style="width: 100%;">\n            <tr>\n              <td style="color: #6b7280; width: 100px;">\u0e15\u0e33\u0e41\u0e2b\u0e19\u0e48\u0e07:</td>\n              <td style="font-weight: bold; color: #111827;">${n.role}</td>\n            </tr>\n          </table>\n        </div>\n\n        <div style="text-align: center; margin: 30px 0;">\n          <a href="${t}" style="background-color: ${a}; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; font-weight: bold; display: inline-block;">\n            \u0e15\u0e31\u0e49\u0e07\u0e23\u0e2b\u0e31\u0e2a\u0e1c\u0e48\u0e32\u0e19\u0e41\u0e25\u0e30\u0e40\u0e23\u0e34\u0e48\u0e21\u0e43\u0e0a\u0e49\u0e07\u0e32\u0e19\n          </a>\n        </div>\n        \n        <p style="font-size: 14px; color: #6b7280; margin-top: 20px;">\n          \u0e2b\u0e32\u0e01\u0e1b\u0e38\u0e48\u0e21\u0e01\u0e14\u0e44\u0e21\u0e48\u0e44\u0e14\u0e49 \u0e2a\u0e32\u0e21\u0e32\u0e23\u0e16\u0e04\u0e25\u0e34\u0e01\u0e25\u0e34\u0e07\u0e01\u0e4c\u0e14\u0e49\u0e32\u0e19\u0e25\u0e48\u0e32\u0e07:<br>\n          <a href="${t}" style="color: ${a};">${t}</a>\n        </p>\n      </div>\n      \n      <div style="background-color: #f9fafb; padding: 15px; text-align: center; font-size: 12px; color: #9ca3af;">\n        \xa9 TTS Engineering - Automated System\n      </div>\n    </div>\n  `;await i.sendMail({from:process.env.SMTP_FROM,to:e,subject:"\u0e41\u0e08\u0e49\u0e07\u0e40\u0e0a\u0e34\u0e0d\u0e40\u0e02\u0e49\u0e32\u0e23\u0e48\u0e27\u0e21\u0e43\u0e0a\u0e49\u0e07\u0e32\u0e19\u0e23\u0e30\u0e1a\u0e1a\u0e1a\u0e23\u0e34\u0e2b\u0e32\u0e23\u0e08\u0e31\u0e14\u0e01\u0e32\u0e23\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e20\u0e32\u0e22\u0e43\u0e19\u0e42\u0e04\u0e23\u0e07\u0e01\u0e32\u0e23 (TTS Document Control)",html:o})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=t.X(0,[9276,5972,5245],(()=>{return e=87659,t(t.s=e);var e}));module.exports=r})();