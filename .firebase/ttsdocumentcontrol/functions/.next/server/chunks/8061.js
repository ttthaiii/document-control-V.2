"use strict";exports.id=8061,exports.ids=[8061],exports.modules={32933:(e,t,s)=>{s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]])},50949:(e,t,s)=>{s.d(t,{Z:()=>a});let a=(0,s(62881).Z)("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},98061:(e,t,s)=>{s.d(t,{Z:()=>h});var a=s(10326),l=s(17577),r=s(94019),i=s(36283),d=s(32933),o=s(50949),c=s(26107);let n=()=>{let[e,t]=(0,l.useState)(!1),[s,a]=(0,l.useState)(null),{firebaseUser:r}=(0,c.aC)(),i=(0,l.useCallback)(async(e,t)=>{if(!r)throw Error("User not authenticated");let s=await r.getIdToken(),a=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify(t)}),l=await a.json();if(!l.success)throw Error(l.error||"Request failed");return l.data},[r]);return{loading:e,error:s,getProjects:(0,l.useCallback)(async e=>{t(!0),a(null);try{return(await i("/api/google-sheets/projects",e)).projects}catch(e){throw a(e.message),e}finally{t(!1)}},[i]),getCategories:(0,l.useCallback)(async(e,s,l)=>{t(!0),a(null);try{return(await i("/api/google-sheets/categories",{...e,projectName:s,rfaType:l})).categories}catch(e){throw a(e.message),e}finally{t(!1)}},[i]),getTasks:(0,l.useCallback)(async(e,s,l)=>{t(!0),a(null);try{return(await i("/api/google-sheets/tasks",{...e,projectName:s,category:l})).tasks}catch(e){throw a(e.message),e}finally{t(!1)}},[i]),clearError:()=>a(null)}};var m=s(79821),u=s(7619);let x={rfaType:"",categoryId:"",documentNumber:"",title:"",description:"",revisionNumber:"00",uploadedFiles:[],selectedProject:"",selectedCategory:"",selectedTask:null},p={"RFA-SHOP":{title:"RFA-SHOP",subtitle:"Shop Drawing Approval",icon:"\uD83C\uDFD7️",description:"สำหรับการขออนุมัติ Shop Drawing",workflow:"ผู้สร้าง → Site Admin → CM",allowedRoles:[u.K$.BIM,u.K$.ME,u.K$.SN,u.K$.SITE_ADMIN,u.K$.ADMIN],color:"blue"},"RFA-GEN":{title:"RFA-GEN",subtitle:"General Submission",icon:"\uD83D\uDCCB",description:"สำหรับการส่งเอกสารทั่วไป",workflow:"ผู้สร้าง → CM",allowedRoles:[u.K$.BIM,u.K$.SITE_ADMIN,u.K$.ADMIN,u.K$.ME,u.K$.SN],color:"green"},"RFA-MAT":{title:"RFA-MAT",subtitle:"Material Approval",icon:"\uD83E\uDDF1",description:"สำหรับการขออนุมัติวัสดุ",workflow:"Site Admin → CM",allowedRoles:[u.K$.SITE_ADMIN,u.K$.ADMIN],color:"orange"}};function h({onClose:e,isModal:t=!1,userProp:s,presetRfaType:h}){let g=h?2:1,[y,b]=(0,l.useState)(g),[f,N]=(0,l.useState)({...x,rfaType:h||""}),[j,w]=(0,l.useState)(!1),[v,k]=(0,l.useState)({}),[T,C]=(0,l.useState)(!1),[F,I]=(0,l.useState)([]),[S,$]=(0,l.useState)([]),[D,A]=(0,l.useState)([]),[E,M]=(0,l.useState)(""),{firebaseUser:R}=(0,c.aC)(),{loading:P,error:K,getCategories:O,getTasks:Z}=n(),[B,z]=(0,l.useState)(""),[U,G]=(0,l.useState)([]),H=s&&(s.role===u.K$.ME||s.role===u.K$.SN),J=e=>{N(t=>({...t,...e}));let t={...v};Object.keys(e).forEach(e=>delete t[e]),k(t)},_=e=>{let t={};switch(e){case 1:if(f.rfaType){let e=p[f.rfaType];s&&!e.allowedRoles.includes(s.role)&&(t.rfaType=`คุณไม่มีสิทธิ์สร้าง ${f.rfaType}`)}else t.rfaType="กรุณาเลือกประเภท RFA";break;case 2:f.title.trim()||(t.title="กรุณาใส่หัวข้อเอกสาร"),f.revisionNumber.trim()||(t.revisionNumber="กรุณาใส่ Rev. No."),f.documentNumber.trim()||(t.documentNumber="กรุณาใส่เลขที่เอกสาร"),E||(t.site="กรุณาเลือกโครงการ"),H?f.categoryId.trim()||(t.categoryId="กรุณากรอกหมวดงาน"):f.selectedTask||(t.task="กรุณาเลือกงานจาก Google Sheets");break;case 3:0===f.uploadedFiles.filter(e=>"success"===e.status).length&&(t.files="กรุณาอัปโหลดไฟล์ให้สำเร็จก่อน")}return k(t),0===Object.keys(t).length},q=async()=>{if(_(3)){C(!0);try{if(!R)throw Error("กรุณาล็อกอินก่อน");let t=await R.getIdToken(),s=f.uploadedFiles.filter(e=>"success"===e.status&&e.uploadedData);if(0===s.length)throw Error("กรุณาอัปโหลดไฟล์ให้สำเร็จอย่างน้อย 1 ไฟล์");let a=H?f.categoryId:f.selectedTask?.taskCategory,l=H?null:f.selectedTask;if(!a)throw Error("ไม่สามารถระบุ Category ID ได้ กรุณาตรวจสอบข้อมูล");let r={rfaType:f.rfaType,title:f.title,description:f.description,siteId:E,documentNumber:f.documentNumber,revisionNumber:parseInt(f.revisionNumber,10)||0,uploadedFiles:s.map(e=>({fileName:e.uploadedData.fileName,fileUrl:e.uploadedData.fileUrl,filePath:e.uploadedData.filePath,fileSize:e.uploadedData.size,fileType:e.uploadedData.contentType})),categoryId:a,taskData:l},i=await fetch("/api/rfa/create",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({payload:r})}),d=await i.json();if(!i.ok)throw Error(d.error||`HTTP error! status: ${i.status}`);if(d.success)alert(`สร้าง RFA สำเร็จ! หมายเลขเอกสาร: ${d.runningNumber}`),e&&e();else throw Error(d.error||"เกิดข้อผิดพลาดในการสร้างเอกสาร")}catch(e){console.error("Submit Error:",e),k({general:e instanceof Error?e.message:"เกิดข้อผิดพลาดที่ไม่รู้จัก"})}finally{C(!1)}}},L=async e=>{let t={id:`${e.name}-${Date.now()}`,file:e,status:"uploading",progress:0,retryCount:0};try{if(!R)throw Error("User not authenticated");let s=await R.getIdToken(),a=new FormData;a.append("file",e);let l=await fetch("/api/rfa/upload-temp-file",{method:"POST",headers:{Authorization:`Bearer ${s}`},body:a}),r=await l.json();if(r.success)return{...t,status:"success",progress:100,uploadedData:r.fileData};throw Error(r.error||"Upload failed")}catch(e){return{...t,status:"error",error:e instanceof Error?e.message:"Upload error"}}},Q=async e=>{try{if(!R)return;let t=await R.getIdToken();await fetch("/api/rfa/delete-temp-file",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({filePath:e})})}catch(e){console.error("Failed to delete temp file:",e)}},V=async e=>{let t=Array.from(e.target.files||[]);if(!t.length)return;let s=t.map(e=>({id:`${e.name}-${Date.now()}`,file:e,status:"pending",progress:0,retryCount:0}));for(let e of(N(e=>({...e,uploadedFiles:[...e.uploadedFiles,...s]})),s)){N(t=>({...t,uploadedFiles:t.uploadedFiles.map(t=>t.id===e.id?{...t,status:"uploading"}:t)}));let t=await L(e.file);N(s=>({...s,uploadedFiles:s.uploadedFiles.map(s=>s.id===e.id?{...s,...t}:s)}))}e.target.value=""},W=e=>{let t=f.uploadedFiles[e];t.uploadedData?.filePath&&Q(t.uploadedData.filePath),J({uploadedFiles:f.uploadedFiles.filter((t,s)=>s!==e)})},X=async e=>{if(M(e),J({categoryId:"",selectedCategory:"",selectedTask:null}),G([]),$([]),A([]),z(""),!e)return;let t=F.find(t=>t.id===e);if(t){if(H){if(R){w(!0);try{let t=await R.getIdToken(),s=await fetch(`/api/sites/${e}/categories`,{headers:{Authorization:`Bearer ${t}`}}),a=await s.json();a.success&&G(a.categories)}catch(e){console.error("Failed to fetch site categories:",e),k(e=>({...e,site:"ไม่สามารถโหลดหมวดงานได้"}))}finally{w(!1)}}}else{J({selectedProject:t.name});try{let e=await O({sheetId:t.sheetId||""},t.name,f.rfaType);$(e)}catch(e){console.error("Failed to fetch categories from BIM-Tracking:",e),k(e=>({...e,site:"ไม่สามารถโหลดหมวดงานจากระบบ BIM-Tracking ได้"}))}}}},Y=async e=>{J({selectedCategory:e,selectedTask:null}),A([]);let t=F.find(e=>e.id===E);if(t&&f.selectedProject)try{let s=await Z({sheetId:t.sheetId||""},f.selectedProject,e);A(s)}catch(e){console.error(e)}},ee=e=>{J({selectedTask:e,title:`${e.taskName} - RFA`}),z(e.taskName)},et=(0,l.useMemo)(()=>B?D.filter(e=>e.taskName.toLowerCase().includes(B.toLowerCase())):D.slice(0,20),[D,B]);return(0,a.jsxs)("div",{className:`${t?"max-w-4xl w-full mx-auto":""} bg-white rounded-lg shadow-xl flex flex-col h-full max-h-[95vh]`,children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-6 border-b bg-gray-50",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h2",{className:"text-2xl font-bold text-gray-900",children:["สร้าง RFA Document",h&&p[h]&&(0,a.jsxs)("span",{className:"font-medium text-gray-600",children:[" - ",p[h].subtitle]})]}),a.jsx("p",{className:"text-sm text-gray-600 mt-1",children:s&&`โดย ${s.email} (${s.role})`})]}),e&&a.jsx("button",{onClick:e,className:"text-gray-400 hover:text-gray-600",children:a.jsx(r.Z,{})})]}),(0,a.jsxs)("div",{className:"flex-1 p-6 overflow-y-auto",children:[1===y&&a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:Object.entries(p).map(([e,t])=>{let l=!!s&&t.allowedRoles.includes(s.role);return(0,a.jsxs)("div",{onClick:()=>l&&J({rfaType:e}),className:`p-6 border-2 rounded-lg text-center cursor-pointer ${f.rfaType===e?"border-blue-500 bg-blue-50":l?"border-gray-200 hover:border-gray-300":"border-gray-100 bg-gray-50 opacity-60 cursor-not-allowed"}`,children:[a.jsx("div",{className:"text-4xl mb-2",children:t.icon}),a.jsx("h4",{className:"font-semibold",children:t.title}),a.jsx("p",{className:"text-sm text-gray-500 mt-1",children:t.description})]},e)})}),2===y&&(0,a.jsxs)("div",{className:"space-y-6 max-w-2xl mx-auto",children:[(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"โครงการ"}),(0,a.jsxs)("select",{value:E,onChange:e=>X(e.target.value),className:"w-full p-3 border rounded-lg",children:[a.jsx("option",{value:"",children:"-- เลือกโครงการ --"}),F.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]}),v.site&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:v.site})]}),H?(0,a.jsxs)("div",{children:[a.jsx("label",{htmlFor:"category-manual-input",className:"block text-sm font-medium text-gray-700 mb-2",children:"หมวดงาน"}),a.jsx("input",{id:"category-manual-input",type:"text",list:"category-list",value:f.categoryId,onChange:e=>J({categoryId:e.target.value}),placeholder:"พิมพ์เพื่อค้นหา หรือกรอกหมวดงานใหม่",className:"w-full p-3 border rounded-lg",disabled:!E}),a.jsx("datalist",{id:"category-list",children:U.map(e=>a.jsx("option",{value:e.categoryCode},e.id))}),v.categoryId&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:v.categoryId})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-2 flex items-center",children:["หมวดงาน",P&&a.jsx(m.Z,{className:"w-4 h-4 ml-2"})]}),(0,a.jsxs)("select",{value:f.selectedCategory,onChange:e=>Y(e.target.value),className:"w-full p-3 border rounded-lg disabled:bg-gray-100",disabled:!E||P,children:[a.jsx("option",{value:"",children:P?"กำลังโหลด...":"-- เลือกหมวดงาน --"}),S.map(e=>a.jsx("option",{value:e,children:e},e))]}),K&&(0,a.jsxs)("p",{className:"text-red-600 text-sm mt-1",children:["Error: ",K]})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"ค้นหางาน"}),a.jsx("input",{type:"text",placeholder:"ค้นหา...",value:B,onChange:e=>z(e.target.value),className:"w-full p-3 border rounded-lg",disabled:!f.selectedCategory||P}),a.jsx("div",{className:"mt-2 max-h-48 overflow-y-auto border rounded-lg",children:et.map(e=>a.jsx("div",{onClick:()=>ee(e),className:`p-2 cursor-pointer hover:bg-gray-100 ${f.selectedTask?.taskName===e.taskName?"bg-blue-50":""}`,children:e.taskName},e.taskUid||e.taskName))}),v.task&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:v.task})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[(0,a.jsxs)("div",{className:"sm:col-span-2",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"เลขที่เอกสาร"}),a.jsx("input",{type:"text",value:f.documentNumber,onChange:e=>J({documentNumber:e.target.value}),className:"w-full p-3 border rounded-lg"}),v.documentNumber&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:v.documentNumber})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Rev. No."}),a.jsx("input",{type:"text",value:f.revisionNumber,onChange:e=>J({revisionNumber:e.target.value}),className:"w-full p-3 border rounded-lg"}),v.revisionNumber&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:v.revisionNumber})]})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"หัวข้อเอกสาร"}),a.jsx("input",{type:"text",value:f.title,onChange:e=>J({title:e.target.value}),className:"w-full p-3 border rounded-lg"}),v.title&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:v.title})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"รายละเอียด"}),a.jsx("textarea",{value:f.description,onChange:e=>J({description:e.target.value}),rows:3,className:"w-full p-3 border rounded-lg"})]})]}),3===y&&(0,a.jsxs)("div",{className:"space-y-6 max-w-2xl mx-auto",children:[(0,a.jsxs)("div",{className:"border-2 border-dashed rounded-lg p-8 text-center",children:[a.jsx("input",{type:"file",multiple:!0,onChange:V,id:"file-upload",className:"hidden"}),a.jsx("label",{htmlFor:"file-upload",className:"cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg",children:"เลือกไฟล์"})]}),f.uploadedFiles.length>0&&(0,a.jsxs)("div",{children:[a.jsx("h4",{className:"font-medium text-gray-800 mb-2",children:"ไฟล์ที่อัปโหลด"}),a.jsx("div",{className:"space-y-2",children:f.uploadedFiles.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center text-sm p-2 bg-gray-100 rounded",children:[a.jsx(i.Z,{className:"w-4 h-4 mr-3 text-gray-500 flex-shrink-0"}),a.jsx("span",{className:"flex-1 truncate",title:e.file.name,children:e.file.name}),(0,a.jsxs)("div",{className:"flex items-center ml-3",children:["uploading"===e.status&&a.jsx(m.Z,{className:"w-4 h-4"}),"success"===e.status&&a.jsx(d.Z,{className:"w-4 h-4 text-green-500"}),"error"===e.status&&a.jsx("span",{title:e.error,children:a.jsx(o.Z,{className:"w-4 h-4 text-red-500"})}),a.jsx("button",{onClick:()=>W(t),className:"ml-3 text-gray-500 hover:text-red-600",children:a.jsx(r.Z,{size:16})})]})]},e.id))})]}),v.files&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:v.files})]}),4===y&&(0,a.jsxs)("div",{className:"space-y-4 max-w-2xl mx-auto",children:[a.jsx("h3",{className:"text-xl font-semibold text-center text-gray-800",children:"ตรวจสอบข้อมูล"}),(0,a.jsxs)("div",{className:"p-6 bg-gray-50 rounded-lg border border-gray-200 space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2 text-base",children:[(0,a.jsxs)("p",{children:[a.jsx("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"โครงการ:"}),a.jsx("span",{className:"font-semibold text-gray-800",children:F.find(e=>e.id===E)?.name})]}),(0,a.jsxs)("p",{children:[a.jsx("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"ประเภท:"}),a.jsx("span",{className:"font-semibold text-gray-800",children:f.rfaType})]}),(0,a.jsxs)("p",{children:[a.jsx("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"หมวดงาน:"}),a.jsx("span",{className:"font-semibold text-gray-800",children:H?f.categoryId:f.selectedTask?.taskCategory})]}),(0,a.jsxs)("p",{children:[a.jsx("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"เลขที่เอกสาร:"}),a.jsx("span",{className:"font-semibold text-gray-800",children:f.documentNumber})]}),(0,a.jsxs)("p",{children:[a.jsx("strong",{className:"text-gray-500 font-medium w-32 inline-block",children:"Rev.:"}),a.jsx("span",{className:"font-semibold text-gray-800",children:f.revisionNumber})]})]}),(0,a.jsxs)("div",{className:"pt-4 border-t border-gray-200",children:[a.jsx("p",{className:"text-sm text-gray-500",children:"หัวข้อ:"}),a.jsx("p",{className:"text-base font-semibold text-gray-800 mt-1 break-words",children:f.title})]}),(0,a.jsxs)("div",{className:"pt-4 border-t border-gray-200",children:[(0,a.jsxs)("h4",{className:"text-sm font-medium text-gray-500",children:["ไฟล์แนบ (",f.uploadedFiles.filter(e=>"success"===e.status).length," ไฟล์):"]}),a.jsx("ul",{className:"list-disc list-inside mt-2 space-y-1 text-base",children:f.uploadedFiles.filter(e=>"success"===e.status).map(e=>a.jsx("li",{className:"truncate text-gray-800",title:e.file.name,children:e.file.name},e.id))})]})]})]})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center p-6 border-t bg-gray-50",children:[a.jsx("button",{onClick:()=>y>1&&b(y-1),disabled:y===g||T,className:`px-4 py-2 rounded-lg bg-gray-200 disabled:opacity-50 ${y===g?"invisible":"visible"}`,children:"ย้อนกลับ"}),y<4?a.jsx("button",{onClick:()=>y<4&&_(y)&&b(y+1),disabled:T,className:"px-4 py-2 rounded-lg bg-blue-600 text-white disabled:opacity-50",children:"ถัดไป"}):a.jsx("button",{onClick:q,disabled:T||0===f.uploadedFiles.filter(e=>"success"===e.status).length,className:"px-6 py-2 rounded-lg bg-green-600 text-white disabled:bg-gray-300 disabled:cursor-not-allowed",children:T?"กำลังสร้าง...":"สร้างเอกสาร"})]})]})}}};